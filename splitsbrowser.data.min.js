/*!
 *  SplitsBrowser - Orienteering results analysis.
 *  
 *  Copyright (C) 2000-2018 Dave Ryder, Reinhard Balling, Andris Strazdins,
 *                          Ed Nash, Luke Woodward
 *
 *  This program is free software; you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation; either version 2 of the License, or
 *  (at your option) any later version.
 *
 *  This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License along
 *  with this program; if not, write to the Free Software Foundation, Inc.,
 *  51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
 */

var SplitsBrowser={Version:"3.4.4",Model:{},Input:{},Controls:{},Messages:{}};!function(){"use strict";function e(t){this.name="InvalidData",this.message=t}function s(t){this.name="WrongFileFormat",this.message=t}SplitsBrowser.isTrue=function(t){return t},SplitsBrowser.isNotNull=function(t){return null!==t},SplitsBrowser.isNaNStrict=function(t){return t!=t},SplitsBrowser.isNotNullNorNaN=function(t){return null!==t&&t==t},e.prototype.toString=function(){return this.name+": "+this.message},SplitsBrowser.throwInvalidData=function(t){throw new e(t)},s.prototype.toString=function(){return this.name+": "+this.message},SplitsBrowser.throwWrongFileFormat=function(t){throw new s(t)},SplitsBrowser.addIfNotNull=function(t,e){return null===t||null===e?null:t+e},SplitsBrowser.subtractIfNotNull=function(t,e){return null===t||null===e?null:t-e},SplitsBrowser.parseCourseLength=function(t){var e=parseFloat(t.replace(",","."));return isFinite(e)?(500<=e&&(e/=1e3),e):null},SplitsBrowser.parseCourseClimb=function(t){var e=parseInt(t,10);return SplitsBrowser.isNaNStrict(e)?null:e},SplitsBrowser.normaliseLineEndings=function(t){return t.replace(/\r\n/g,"\n").replace(/\r/g,"\n")}}(),function(){"use strict";SplitsBrowser.NULL_TIME_PLACEHOLDER="-----";var o=SplitsBrowser.isNaNStrict;SplitsBrowser.formatTime=function(t,e){if(null===t)return SplitsBrowser.NULL_TIME_PLACEHOLDER;if(o(t))return"???";var s="";t<0&&(s="-",t=-t);var n=Math.floor(t/3600),r=Math.floor(t/60)%60,i=t%60;return 0<n&&(s+=n.toString()+":"),r<10&&(s+="0"),s+=r+":",i<10&&(s+="0"),s+="number"==typeof e?i.toFixed(e):Math.round(100*i)/100},SplitsBrowser.parseTime=function(t){if(t=t.trim(),/^(-?\d+:)?-?\d+:-?\d\d([,.]\d+)?$/.test(t)){var e=t.replace(",",".").split(":"),s=0;return e.forEach(function(t){s=60*s+parseFloat(t)}),s}return null}}(),function(){"use strict";var r="number",t=SplitsBrowser.isNotNull,i=SplitsBrowser.isNaNStrict,n=SplitsBrowser.addIfNotNull,o=SplitsBrowser.subtractIfNotNull,l=SplitsBrowser.throwInvalidData;function a(t){if(!$.isArray(t))throw new TypeError("Cumulative times must be an array - got "+typeof t+" instead");0===t.length?l("Array of cumulative times must not be empty"):0!==t[0]?l("Array of cumulative times must have zero as its first item"):1===t.length&&l("Array of cumulative times must contain more than just a single zero");for(var e=[],s=0;s+1<t.length;s+=1)e.push(o(t[s+1],t[s]));return e}function u(t,e,s,n){typeof t!=r&&l("Result order must be a number, got "+typeof t+" '"+t+"' instead"),typeof e!=r&&null!==e&&l("Start time must be a number, got "+typeof e+" '"+e+"' instead"),this.order=t,this.startTime=e,this.isOKDespiteMissingTimes=!1,this.isNonCompetitive=!1,this.isNonStarter=!1,this.isNonFinisher=!1,this.isDisqualified=!1,this.isOverMaxTime=!1,this.originalSplitTimes=s,this.originalCumTimes=n,this.splitTimes=null,this.cumTimes=null,this.splitRanks=null,this.cumRanks=null,this.timeLosses=null,this.totalTime=null===n||-1<n.indexOf(null)?null:n[n.length-1]}SplitsBrowser.Model.compareResults=function(t,e){return t.isDisqualified!==e.isDisqualified?t.isDisqualified?1:-1:t.totalTime===e.totalTime?t.order-e.order:null===t.totalTime?null===e.totalTime?0:1:null===e.totalTime?-1:t.totalTime-e.totalTime},u.prototype.setOKDespiteMissingTimes=function(){this.isOKDespiteMissingTimes=!0,null!==this.originalCumTimes&&(this.totalTime=this.originalCumTimes[this.originalCumTimes.length-1])},u.prototype.setNonCompetitive=function(){this.isNonCompetitive=!0},u.prototype.setNonStarter=function(){this.isNonStarter=!0},u.prototype.setNonFinisher=function(){this.isNonFinisher=!0},u.prototype.disqualify=function(){this.isDisqualified=!0},u.prototype.setOverMaxTime=function(){this.isOverMaxTime=!0},u.fromOriginalCumTimes=function(t,e,s){return new u(t,e,a(s),s)},u.fromCumTimes=function(t,e,s){var n=u.fromOriginalCumTimes(t,e,s);return n.splitTimes=n.originalSplitTimes,n.cumTimes=n.originalCumTimes,n},u.prototype.setRepairedCumulativeTimes=function(t){this.cumTimes=t,this.splitTimes=a(t)},u.prototype.completed=function(){return null!==this.totalTime&&!this.isDisqualified&&!this.isOverMaxTime},u.prototype.hasAnyTimes=function(){return this.originalCumTimes.slice(1).some(t)},u.prototype.getSplitTimeTo=function(t){return 0===t?0:this.splitTimes[t-1]},u.prototype.getOriginalSplitTimeTo=function(t){return this.isNonStarter?null:0===t?0:this.originalSplitTimes[t-1]},u.prototype.isSplitTimeDubious=function(t){return 0<t&&this.originalSplitTimes[t-1]!==this.splitTimes[t-1]},u.prototype.getCumulativeTimeTo=function(t){return this.cumTimes[t]},u.prototype.getOriginalCumulativeTimeTo=function(t){return this.isNonStarter?null:this.originalCumTimes[t]},u.prototype.isCumulativeTimeDubious=function(t){return this.originalCumTimes[t]!==this.cumTimes[t]},u.prototype.getSplitRankTo=function(t){return null===this.splitRanks||0===t?null:this.splitRanks[t-1]},u.prototype.getCumulativeRankTo=function(t){return null===this.cumRanks||0===t?null:this.cumRanks[t-1]},u.prototype.getTimeLossAt=function(t){return 0===t||null===this.timeLosses?null:this.timeLosses[t-1]},u.prototype.getAllCumulativeTimes=function(){return this.cumTimes},u.prototype.getAllOriginalCumulativeTimes=function(){return this.originalCumTimes},u.prototype.getAllSplitTimes=function(){return this.splitTimes},u.prototype.lacksStartTime=function(){return null===this.startTime&&this.splitTimes.some(t)},u.prototype.setSplitAndCumulativeRanks=function(t,e){this.splitRanks=t,this.cumRanks=e},u.prototype.getCumTimesAdjustedToReference=function(s){return s.length!==this.cumTimes.length?l("Cannot adjust cumulative times because the numbers of times are different ("+this.cumTimes.length+" and "+s.length+")"):-1<s.indexOf(null)&&l("Cannot adjust cumulative times because a null value is in the reference data"),this.cumTimes.map(function(t,e){return o(t,s[e])})},u.prototype.getCumTimesAdjustedToReferenceWithStartAdded=function(t){var e=this.getCumTimesAdjustedToReference(t),s=this.startTime;return e.map(function(t){return n(t,s)})},u.prototype.getSplitPercentsBehindReferenceCumTimes=function(n){n.length!==this.cumTimes.length?l("Cannot determine percentages-behind because the numbers of times are different ("+this.cumTimes.length+" and "+n.length+")"):-1<n.indexOf(null)&&l("Cannot determine percentages-behind because a null value is in the reference data");var r=[0];return this.splitTimes.forEach(function(t,e){if(null===t)r.push(null);else{var s=n[e+1]-n[e];0<s?r.push(100*(t-s)/s):r.push(null)}}),r},u.prototype.determineTimeLosses=function(s){if(this.completed())if(s.length!==this.splitTimes.length?l("Cannot determine time loss with "+this.splitTimes.length+" split times using "+s.length+" fastest splits"):s.some(i)&&l("Cannot determine time loss when there is a NaN value in the fastest splits"),s.some(function(t){return 0===t}))this.timeLosses=this.splitTimes.map(function(){return NaN});else if(this.isOKDespiteMissingTimes||this.splitTimes.some(i))this.timeLosses=this.splitTimes.map(function(){return NaN});else{var n,t=this.splitTimes.map(function(t,e){return t/s[e]});if(t.sort(d3.ascending),t.length%2==1)n=t[(t.length-1)/2];else{var e=t.length/2;n=(t[e-1]+t[e])/2}this.timeLosses=this.splitTimes.map(function(t,e){return Math.round(t-s[e]*n)})}},u.prototype.crosses=function(t){t.cumTimes.length!==this.cumTimes.length&&l("Two results with different numbers of controls cannot cross");for(var e=!1,s=!1,n=0;n<this.cumTimes.length;n+=1)if(null!==this.cumTimes[n]&&null!==t.cumTimes[n]){var r=this.startTime+this.cumTimes[n],i=t.startTime+t.cumTimes[n];r<i?e=!0:i<r&&(s=!0)}return e&&s},u.prototype.isTimeOmitted=function(t){return i(t)||this.isOKDespiteMissingTimes&&null===t},u.prototype.getIndexesAroundOmittedTimes=function(t){for(var e=[],s=1;s+1<t.length;)if(this.isTimeOmitted(t[s])){for(var n=s;n+1<t.length&&this.isTimeOmitted(t[n+1]);)n+=1;n+1<t.length&&null!==t[s-1]&&null!==t[n+1]&&e.push({start:s-1,end:n+1}),s=n+1}else s+=1;return e},u.prototype.getControlIndexesAroundOmittedCumulativeTimes=function(){return this.getIndexesAroundOmittedTimes(this.cumTimes)},u.prototype.getControlIndexesAroundOmittedSplitTimes=function(){return this.getIndexesAroundOmittedTimes([0].concat(this.splitTimes))},SplitsBrowser.Model.Result=u}(),function(){"use strict";var s=SplitsBrowser.Model.compareResults;function t(t,e,s){this.name=t,this.club=e,this.result=s,this.className=null,this.yearOfBirth=null,this.gender=null}SplitsBrowser.Model.compareCompetitors=function(t,e){return s(t.result,e.result)},t.prototype.setClassName=function(t){this.className=t},t.prototype.setYearOfBirth=function(t){this.yearOfBirth=t},t.prototype.setGender=function(t){this.gender=t},SplitsBrowser.Model.Competitor=t}(),function(){"use strict";var i=SplitsBrowser.isNotNullNorNaN,t=SplitsBrowser.throwInvalidData;function e(e,t,s){this.name=e,this.numControls=t,this.competitors=s,this.course=null,this.hasDubiousData=!1,this.competitors.forEach(function(t){t.setClassName(e)})}e.prototype.recordHasDubiousData=function(){this.hasDubiousData=!0},e.prototype.determineTimeLosses=function(){var e=d3.range(1,this.numControls+2).map(function(t){var e=this.getFastestSplitTo(t);return null===e?null:e.split},this);this.competitors.forEach(function(t){t.result.determineTimeLosses(e)})},e.prototype.isEmpty=function(){return 0===this.competitors.length},e.prototype.setCourse=function(t){this.course=t},e.prototype.getFastestSplitTo=function(s){("number"!=typeof s||s<1||s>this.numControls+1)&&t("Cannot return splits to leg '"+s+"' in a course with "+this.numControls+" control(s)");var n=null,r=null;return this.competitors.forEach(function(t){var e=t.result.getSplitTimeTo(s);i(e)&&(null===n||e<n)&&(n=e,r=t)}),null===n?null:{split:n,name:r.name}},e.prototype.getCompetitorsAtControlInTimeRange=function(n,r,i){("number"!=typeof n||isNaN(n)||n<0||n>this.numControls+1)&&t("Control number must be a number between 0 and "+this.numControls+" inclusive");var o=[];return this.competitors.forEach(function(t){var e=t.result.getCumulativeTimeTo(n);if(null!==e&&null!==t.result.startTime){var s=e+t.result.startTime;r<=s&&s<=i&&o.push({name:t.name,time:s})}}),o},SplitsBrowser.Model.CourseClass=e}(),function(){"use strict";var i=SplitsBrowser.throwInvalidData;function t(t,e,s,n,r){this.name=t,this.classes=e,this.length=s,this.climb=n,this.controls=r}var l=t.START="__START__",a=t.FINISH="__FINISH__";t.prototype.getOtherClasses=function(e){var t=this.classes.filter(function(t){return t!==e});if(t.length!==this.classes.length)return t;i("Course.getOtherClasses: given class is not in this course")},t.prototype.getNumClasses=function(){return this.classes.length},t.prototype.hasControls=function(){return null!==this.controls},t.prototype.getControlCode=function(t){return 0===t?l:1<=t&&t<=this.controls.length?this.controls[t-1]:t===this.controls.length+1?a:void i("Cannot get control code of control "+t+" because it is out of range")},t.prototype.usesLeg=function(t,e){return 0<=this.getLegNumber(t,e)},t.prototype.getLegNumber=function(t,e){if(null===this.controls)return-1;if(t===l&&e===a)return 0===this.controls.length?1:-1;if(t===l)return 0<this.controls.length&&this.controls[0]===e?1:-1;if(e===a)return 0<this.controls.length&&this.controls[this.controls.length-1]===t?this.controls.length+1:-1;for(var s=1;s<this.controls.length;s+=1)if(this.controls[s-1]===t&&this.controls[s]===e)return s+1;return-1},t.prototype.getFastestSplitsForLeg=function(t,e){null===this.legs&&i("Cannot determine fastest splits for a leg because leg information is not available");var s=this.getLegNumber(t,e);s<0&&i("Leg from "+((t===l?"start":t)+" to "+(e===a?"end":e))+" not found in course "+this.name);var n=s,r=[];return this.classes.forEach(function(t){var e=t.getFastestSplitTo(n);null!==e&&r.push({name:e.name,className:t.name,split:e.split})}),r},t.prototype.getCompetitorsAtControlInTimeRange=function(t,e,s){if(null===this.controls)return[];if(t===l)return this.getCompetitorsAtControlNumInTimeRange(0,e,s);if(t===a)return this.getCompetitorsAtControlNumInTimeRange(this.controls.length+1,e,s);for(var n=-1,r=[],i=function(t){r.push(t)};;){var o=this.controls.indexOf(t,n+1);if(o<0)return r;this.getCompetitorsAtControlNumInTimeRange(o+1,e,s).forEach(i),n=o}},t.prototype.getCompetitorsAtControlNumInTimeRange=function(t,s,n){var r=[];return this.classes.forEach(function(e){e.getCompetitorsAtControlInTimeRange(t,s,n).forEach(function(t){r.push({name:t.name,time:t.time,className:e.name})})}),r},t.prototype.hasControl=function(t){return null!==this.controls&&-1<this.controls.indexOf(t)},t.prototype.getNextControls=function(t){if(null===this.controls)i("Course has no controls");else if(t===a)i("Cannot fetch next control after the finish");else{if(t===l)return[0===this.controls.length?a:this.controls[0]];for(var e=-1,s=[];;){var n=this.controls.indexOf(t,e+1);if(-1===n)break;n===this.controls.length-1?s.push(a):s.push(this.controls[n+1]),e=n}if(0!==s.length)return s;i("Control '"+t+"' not found on course "+this.name)}},SplitsBrowser.Model.Course=t}(),function(){"use strict";var s=SplitsBrowser.Model.Course;function t(t,e,s){this.classes=t,this.courses=e,this.warnings=s}t.prototype.determineTimeLosses=function(){this.classes.forEach(function(t){t.determineTimeLosses()})},t.prototype.needsRepair=function(){return this.classes.some(function(t){return t.competitors.some(function(t){return null===t.result.getAllCumulativeTimes()})})},t.prototype.getFastestSplitsForLeg=function(e,s){var n=[];return this.courses.forEach(function(t){t.usesLeg(e,s)&&(n=n.concat(t.getFastestSplitsForLeg(e,s)))}),n.sort(function(t,e){return d3.ascending(t.split,e.split)}),n},t.prototype.getCompetitorsAtControlInTimeRange=function(e,s,n){var r=[];return this.courses.forEach(function(t){t.getCompetitorsAtControlInTimeRange(e,s,n).forEach(function(t){r.push(t)})}),r.sort(function(t,e){return d3.ascending(t.time,e.time)}),r},t.prototype.getNextControlsAfter=function(e){var t=this.courses;return e!==s.START&&(t=t.filter(function(t){return t.hasControl(e)})),t.map(function(t){return{course:t,nextControls:t.getNextControls(e)}})},SplitsBrowser.Model.Event=t}(),function(){"use strict";var a=SplitsBrowser.isTrue,u=SplitsBrowser.isNotNull,c=SplitsBrowser.throwInvalidData,m=SplitsBrowser.throwWrongFileFormat,o=SplitsBrowser.normaliseLineEndings,g=SplitsBrowser.parseTime,C=SplitsBrowser.Model.Result.fromCumTimes,v=SplitsBrowser.Model.Competitor,p=SplitsBrowser.Model.compareCompetitors,h=SplitsBrowser.Model.CourseClass,l=SplitsBrowser.Model.Course,f=SplitsBrowser.Model.Event;function d(t,s){var e=t.split(/\r?\n/).filter(a);0===e.length&&c("parseCourseClass got an empty list of lines");var n=e.shift().split(",");if(2===n.length){var r=n.shift(),i=n.shift(),o=parseInt(i,10);if(isNaN(o))c("Could not read control count: '"+i+"'");else{if(!(o<0&&0<e.length)){var l=e.map(function(t,e){return function(t,e,s,n,r){for(var i=e.split(",");i.length>s+5&&i[3].match(/[^0-9.,:-]/);)i[2]+=","+i[3],i.splice(3,1);var o=i.length,l=((i.shift()||"")+" "+(i.shift()||"")).trim()||"<name unknown>";if(o===s+5){var a=i.shift(),u=i.shift(),c=g(u);0===c?c=null:u.match(/^\d+:\d\d:\d\d$/)||(c*=60);var m=[0],p=0;i.map(function(t){var e=g(t);null!==e&&0<e?(p+=e,m.push(p)):m.push(null)});var h=C(t+1,c,m);return 0===p&&h.setNonStarter(),new v(l,a,h)}var f=o-(s+5),d=f<0?-f+" too few":f+" too many";return r.push("Competitor '"+l+"' appears to have the wrong number of split times - "+d+" (row "+(t+1)+" of class '"+n+"')"),null}(e,t,o,r,s)}).filter(u);return l.sort(p),new h(r,o,l)}c("Expected a non-negative control count, got "+o+" instead")}}else m("Expected first line to have two parts (class name and number of controls), got "+n.length+" part(s) instead")}SplitsBrowser.Input.CSV={parseEventData:function(t){/<html/i.test(t)&&m("Cannot parse this file as CSV as it appears to be HTML");var e=(t=(t=o(t)).replace(/,+\n/g,"\n").replace(/,+$/,"")).split(/\n\n/).map(function(t){return t.trim()}).filter(a),s=[],n=e.map(function(t){return d(t,s)});0===(n=n.filter(function(t){return!t.isEmpty()})).length&&c("No competitor data was found");for(var r=n.map(function(t){return new l(t.name,[t],null,null,null)}),i=0;i<n.length;i+=1)n[i].setCourse(r[i]);return new f(n,r,s)}}}(),function(){"use strict";var o=SplitsBrowser.throwInvalidData,r=SplitsBrowser.throwWrongFileFormat,d=SplitsBrowser.isNaNStrict,i=SplitsBrowser.parseCourseLength,l=SplitsBrowser.parseCourseClimb,e=SplitsBrowser.normaliseLineEndings,m=SplitsBrowser.parseTime,g=SplitsBrowser.Model.Result.fromOriginalCumTimes,C=SplitsBrowser.Model.Competitor,s=SplitsBrowser.Model.CourseClass,v=SplitsBrowser.Model.Course,n=SplitsBrowser.Model.Event,a=[";",",","\t","\\"],u={};[44,46,60].forEach(function(t){u[t]={course:t-7,distance:t-6,climb:t-5,controlCount:t-4,placing:t-3,startPunch:t-2,finish:t-1,control1:t}}),[44,46].forEach(function(t){u[t].nonCompetitive=t-38,u[t].startTime=t-37,u[t].time=t-35,u[t].classifier=t-34,u[t].club=t-31,u[t].className=t-28}),u[44].combinedName=3,u[44].yearOfBirth=4,u[46].forename=4,u[46].surname=3,u[46].yearOfBirth=5,u[46].gender=6,u[60].forename=6,u[60].surname=5,u[60].yearOfBirth=7,u[60].gender=8,u[60].combinedName=3,u[60].nonCompetitive=10,u[60].startTime=11,u[60].time=13,u[60].classifier=14,u[60].club=20,u[60].className=26,u[60].classNameFallback=u[60].course,u[60].clubFallback=18;function c(t){return'"'===t[0]&&'"'===t[t.length-1]&&(t=t.substring(1,t.length-1).replace(/""/g,'"').trim()),t}function p(t){this.data=e(t),this.classes=d3.map(),this.courseDetails=d3.map(),this.classCoursePairs=[],this.columnIndexes=null,this.warnings=[]}p.prototype.identifyDelimiter=function(){this.lines.length<=1&&r("No data found to read");for(var t=this.lines[1],e=0;e<a.length;e+=1){var s=a[e];if(37<t.split(s).length)return s}r("Data appears not to be in the OE CSV format")},p.prototype.identifyFormatVariation=function(t){var e=this.lines[1].split(t),s=/^[A-Za-z0-9]+$/;for(var n in u){if(u.hasOwnProperty(n))if((n=parseInt(n,10))<e.length&&s.test(e[n])&&(""===e[n-2].trim()||null!==m(e[n-2]))&&(""===e[n-1].trim()||null!==m(e[n-1])))if(""!==e[u[n].controlCount].trim())return void(this.columnIndexes=u[n])}r("Did not find control 1 at any of the supported indexes")},p.prototype.getClassName=function(t){var e=t[this.columnIndexes.className];return""===e&&this.columnIndexes.hasOwnProperty("classNameFallback")&&(e=t[this.columnIndexes.classNameFallback]),e},p.prototype.getStartTime=function(t){var e=t[this.columnIndexes.startPunch];return""===e&&(e=t[this.columnIndexes.startTime]),m(e)},p.prototype.getNumControls=function(t,e){var s,n=this.getClassName(t);if(""===n.trim())return s=this.getName(t)||"<name unknown>",this.warnings.push("Could not find a class for competitor '"+s+"' (line "+e+")"),null;if(this.classes.has(n))return this.classes.get(n).numControls;var r=parseInt(t[this.columnIndexes.controlCount],10);return isFinite(r)?r:(s=this.getName(t)||"<name unknown>",this.warnings.push("Could not read the control count '"+t[this.columnIndexes.controlCount]+"' for competitor '"+s+"' from line "+e),null)},p.prototype.readCumulativeTimes=function(t,e,s){for(var n=[0],r=0;r<s;r+=1){var i=this.columnIndexes.control1+1+2*r,o=i<t.length?t[i]:null,l=null===o?null:m(o);n.push(l)}var a=m(t[this.columnIndexes.time]);if(null===a){var u=this.getStartTime(t),c=m(t[this.columnIndexes.finish]);null!==u&&null!==c&&(a=c-u)}return n.push(a),n},p.prototype.createClassIfNecessary=function(t,e){var s=this.getClassName(t);this.classes.has(s)||this.classes.set(s,{numControls:e,competitors:[]})},p.prototype.createCourseIfNecessary=function(e,t){var s=e[this.columnIndexes.course];if(!this.courseDetails.has(s)){var n=d3.range(0,t).map(function(t){return e[this.columnIndexes.control1+2*t]},this);this.courseDetails.set(s,{length:i(e[this.columnIndexes.distance]),climb:l(e[this.columnIndexes.climb]),controls:n})}},p.prototype.createClassCoursePairIfNecessary=function(t){var e=this.getClassName(t),s=t[this.columnIndexes.course];this.classCoursePairs.some(function(t){return t[0]===e&&t[1]===s})||this.classCoursePairs.push([e,s])},p.prototype.getName=function(t){var e="";this.columnIndexes.hasOwnProperty("forename")&&this.columnIndexes.hasOwnProperty("surname")&&(e=(t[this.columnIndexes.forename]+" "+t[this.columnIndexes.surname]).trim());return""===e&&this.columnIndexes.hasOwnProperty("combinedName")&&(e=t[this.columnIndexes.combinedName]),e},p.prototype.addCompetitor=function(t,e){var s=this.getClassName(t),n=t[this.columnIndexes.placing],r=t[this.columnIndexes.club];""===r&&this.columnIndexes.hasOwnProperty("clubFallback")&&(r=t[this.columnIndexes.clubFallback]);var i=this.getStartTime(t),o=this.getName(t),l=""!==n&&d(parseInt(n,10));l&&o.substring(o.length-n.length)===n&&(o=o.substring(0,o.length-n.length).trim());var a=this.classes.get(s).competitors.length+1,u=g(a,i,e);("1"===t[this.columnIndexes.nonCompetitive]||l)&&u.completed()&&u.setNonCompetitive();var c=t[this.columnIndexes.classifier];""!==c?"0"===c&&0<=e.indexOf(null)&&null!==e[e.length-1]?u.setOKDespiteMissingTimes():"1"===c?u.setNonStarter():"2"===c?u.setNonFinisher():"4"===c?u.disqualify():"5"===c&&u.setOverMaxTime():u.hasAnyTimes()||u.setNonStarter();var m=new C(o,r,u),p=t[this.columnIndexes.yearOfBirth];if(""!==p){var h=parseInt(p,10);d(h)||m.setYearOfBirth(h)}if(this.columnIndexes.hasOwnProperty("gender")){var f=t[this.columnIndexes.gender];"M"!==f&&"F"!==f||m.setGender(f)}this.classes.get(s).competitors.push(m)},p.prototype.readLine=function(t,e,s){if(""!==t.trim()){var n=t.split(s).map(function(t){return t.trim()}).map(c);n.length<37&&o("Too few items on line "+e+" of the input file: expected at least 37, got "+n.length);var r=this.getNumControls(n,e);if(null!==r){var i=this.readCumulativeTimes(n,e,r);this.createClassIfNecessary(n,r),this.createCourseIfNecessary(n,r),this.createClassCoursePairIfNecessary(n),this.addCompetitor(n,i)}}},p.prototype.getMapsBetweenClassesAndCourses=function(){var n=d3.map(),r=d3.map();return this.classCoursePairs.forEach(function(t){var e=t[0],s=t[1];n.has(e)?n.get(e).push(s):n.set(e,[s]),r.has(s)?r.get(s).push(e):r.set(s,[e])}),{classesToCourses:n,coursesToClasses:r}},p.prototype.createClasses=function(){var t=this.classes.keys();return t.sort(),t.map(function(t){var e=this.classes.get(t);return new s(t,e.numControls,e.competitors)},this)},p.prototype.createCourseFromLinkedClassesAndCourses=function(t,e,s,n){for(var r,i,o=[t],l=[],a=[],u=[];0<o.length||0<l.length;){for(;0<o.length;){r=o.shift();for(var c=e.coursesToClasses.get(r),m=0;m<c.length;m+=1)i=c[m],l.indexOf(i)<0&&u.indexOf(i)<0&&l.push(i);a.push(r)}for(;0<l.length;){i=l.shift();for(var p=e.classesToCourses.get(i),h=0;h<p.length;h+=1)r=p[h],o.indexOf(r)<0&&a.indexOf(r)<0&&o.push(r);u.push(i)}}a.forEach(function(t){s.add(t)});var f=u.map(function(t){return n.get(t)}),d=this.courseDetails.get(t),g=new v(t,f,d.length,d.climb,d.controls);return f.forEach(function(t){t.setCourse(g)}),g},p.prototype.determineCourses=function(t){var s=this.getMapsBetweenClassesAndCourses(),n=d3.set(),r=d3.map();t.forEach(function(t){r.set(t.name,t)});var i=[];return s.coursesToClasses.keys().forEach(function(t){if(!n.has(t)){var e=this.createCourseFromLinkedClassesAndCourses(t,s,n,r);i.push(e)}},this),i},p.prototype.parseEventData=function(){this.warnings=[],this.lines=this.data.split(/\n/);var s=this.identifyDelimiter();this.identifyFormatVariation(s),this.lines.shift(),this.lines.forEach(function(t,e){this.readLine(t,e+1,s)},this);var t=this.createClasses();0===t.length&&0<this.warnings.length&&r("This file may have looked vaguely like an OE CSV file but no data could be read out of it");var e=this.determineCourses(t);return new n(t,e,this.warnings)},SplitsBrowser.Input.OE={},SplitsBrowser.Input.OE.parseEventData=function(t){return new p(t).parseEventData()}}(),function(){"use strict";var h=SplitsBrowser.isNotNull,f=SplitsBrowser.throwInvalidData,n=SplitsBrowser.throwWrongFileFormat,s=SplitsBrowser.parseCourseLength,r=SplitsBrowser.normaliseLineEndings,d=SplitsBrowser.parseTime,i=SplitsBrowser.Model.Result.fromOriginalCumTimes,o=SplitsBrowser.Model.Competitor,a=SplitsBrowser.Model.CourseClass,u=SplitsBrowser.Model.Course,e=SplitsBrowser.Model.Event,l=/<[^>]+>/g,c=/([0-9.,]+)\s*(?:Km|km)/,m=/(\d+)\s*(?:Cm|Hm|hm|m)/;function p(t){return null!==t&&""!==t}function g(t){return""!==(t=t.trim())&&isFinite(t)}function C(t){return t.split(/\s+/g).filter(p)}function v(t){return t.replace(l,"")}function T(t,e){for(var s,n=[];null!==(s=t.exec(e));)n.push(v(s[1]));return n}function w(t){return T(/<font[^>]*>(.*?)<\/font>/g,t)}function S(t){return T(/<td[^>]*>(.*?)<\/td>/g,t).map(function(t){return t.trim()})}function y(t){return S(t).filter(function(t){return""!==t})}function N(t){var e=c.exec(t);return null===e?null:s(e[1])}function b(t){var e=m.exec(t);return null===e?null:parseInt(e[1],10)}function O(t){for(var e=[],s=0;s<t.length;s+=1){var n=t[s],r=n.indexOf("(");if(-1<r&&")"===n[n.length-1]){var i=n.substring(r+1,n.length-1);e.push(i)}else s+1===t.length?e.push(null):f("Unrecognised control header label: '"+n+"'")}return e}function x(t,e){for(;0<e.length&&"*"===e[e.length-1][0];)e.splice(e.length-1,1),t.splice(t.length-1,1)}function I(t,e,s,n,r,i){this.name=t,this.club=e,this.className=s,this.totalTime=n,this.cumTimes=r,this.competitive=i}I.prototype.isContinuation=function(){return""===this.name&&""===this.club&&null===this.className&&""===this.totalTime&&!this.competitive},I.prototype.append=function(t){if(!t.isContinuation())throw new Error("Can only append a continuation CompetitorParseRecord");this.cumTimes=this.cumTimes.concat(t.cumTimes)},I.prototype.toCompetitor=function(t){var e=[0].concat(this.cumTimes),s=i(t,null,e);return s.completed()&&!this.competitive&&s.setNonCompetitive(),s.hasAnyTimes()||s.setNonStarter(),new o(this.name,this.club,s)};function t(){this.precedingColumnCount=null}t.prototype.isTextOfThisFormat=function(t){return 0<=t.indexOf("<pre>")&&0<=t.indexOf("<font")},t.prototype.preprocess=function(t){var e=t.indexOf("<pre>");if(-1===e)throw new Error("Cannot find opening pre tag");var s=t.indexOf("\n",e),n=(t=(t=t.substring(s+1)).replace(/\n{2,}/g,"\n")).lastIndexOf("</pre>");return-1===n&&f("Found opening <pre> but no closing </pre>"),s=t.lastIndexOf("\n",n),(t=t.substring(0,s)).trim()},t.prototype.canIgnoreThisLine=function(t){return""===t},t.prototype.isCourseHeaderLine=function(t){return 2===w(t).length},t.prototype.parseCourseHeaderLine=function(t){var e=w(t);if(2!==e.length)throw new Error("Course header line should have two parts");var s=e[0],n=e[1],r=s.indexOf("("),i=-1<r?s.substring(0,r):s,o=N(n),l=b(n);return{name:i.trim(),distance:o,climb:l}},t.prototype.parseControlsLine=function(t){var e=t.lastIndexOf("</font>");return O(C((-1===e?t:t.substring(e+"</font>".length)).trim()))},t.prototype.readCompetitorSplitDataLine=function(t){for(var e=0;e<this.precedingColumnCount;e+=1){var s=t.indexOf("</font>");t=t.substring(s+"</font>".length)}return C(v(t))},t.prototype.parseCompetitor=function(t,e){var s=w(t),n=w(e);if(null===this.precedingColumnCount){var r=s[1].trim();this.precedingColumnCount=r.match(/^\d*$/)?4:3}var i=g(s[0]),o=s[this.precedingColumnCount-2].trim(),l=s[this.precedingColumnCount-1].trim(),a=n[this.precedingColumnCount-2].trim(),u=this.readCompetitorSplitDataLine(t),c=this.readCompetitorSplitDataLine(e);x(u=u.map(d),c);var m=null;if(null!==o&&""!==o){for(var p=-1,h=0;h<this.precedingColumnCount;h+=1)p=t.indexOf("</font>",p+1);var f=C(t.substring(0,p+"</font>".length).replace(/<font[^>]*>(.*?)<\/font>/g,""));0<f.length&&(m=f[0])}return new I(o,a,m,l,u,i)};function B(){this.timesOffset=null}B.prototype.isTextOfThisFormat=function(t){for(var e=-1,s=0;s<5;s+=1)if(-1===(e=t.indexOf("<table",e+1)))return!1;return!0},B.prototype.preprocess=function(t){var e=t.indexOf("</table>");-1===e&&f("Could not find any closing </table> tags");var s=(t=t.substring(e+"</table>".length)).indexOf("</div>"),n=t.indexOf("<table");return-1<s&&s<n&&(t=t.substring(s+"</div>".length)),(t=(t=(t=(t=(t=(t=t.replace(/>\n+</g,"><").replace(/><tr>/g,">\n<tr>").replace(/<\/tr></g,"</tr>\n<").replace(/><table/g,">\n<table").replace(/<\/table></g,"</table>\n<")).replace(/<\/col[^>]*>/g,"")).replace(/<tr[^>]*><td[^>]*>(?:<nobr>)?&nbsp;?(?:<\/nobr>)?<\/td><\/tr>/g,"")).replace(/<a id="[^"]*"><\/a>/g,"")).replace(/<div id="navigation">[\s\S]*?<\/div>/g,"")).replace("</body></html>","")).trim()},B.prototype.canIgnoreThisLine=function(t){if(-1<t.indexOf("<th>")){var e=function(t){return T(/<th[^>]*>(.*?)<\/th>/g,t).filter(function(t){return""!==t})}(t);return this.timesOffset=e.length,!0}return""===t||-1<t.indexOf("<table")||-1<t.indexOf("</table>")},B.prototype.isCourseHeaderLine=function(t){return-1<t.indexOf('<td id="header"')},B.prototype.parseCourseHeaderLine=function(t){var e=y(t);0===e.length&&f("No parts found in course header line");var s=e[0],n=s.indexOf("(");-1<n&&(s=s.substring(0,n)),s=s.trim();for(var r=null,i=null,o=1;o<e.length;o+=1)null===r&&(r=N(e[o])),null===i&&(i=b(e[o]));return{name:s,distance:r,climb:i}},B.prototype.parseControlsLine=function(t){return O(y(t))},B.prototype.readCompetitorSplitDataLine=function(t){for(var e=S(t),s=this.timesOffset,n=e.length;0<n&&""===e[n-1];)n-=1;return e.slice(s,n).filter(p)},B.prototype.parseCompetitor=function(t,e){var s=S(t),n=S(e),r=g(s[0]),i=3===this.timesOffset?1:2,o=s[i],l=s[this.timesOffset-1],a=n[i],u=5===this.timesOffset&&""!==o?s[3]:null,c=this.readCompetitorSplitDataLine(t),m=this.readCompetitorSplitDataLine(e);x(c=c.map(d),m);var p=c.filter(h).length;return p!==m.length&&f("Cumulative and split times do not have the same length: "+p+" cumulative times, "+m.length+" split times"),new I(o,a,u,l,c,r)};function L(){this.usesClasses=!1}function D(t,e,s){this.name=t,this.distance=e,this.climb=s,this.controls=[],this.competitors=[]}function F(t){this.recognizer=t,this.courses=[],this.currentCourse=null,this.lines=null,this.linePos=-1,this.currentCompetitor=null}L.prototype.isTextOfThisFormat=function(t){var e=t.indexOf("<table");if(0<=e){var s=t.indexOf("<table",e+1);if(0<=s)if(t.indexOf("<table",s+1)<0)return!0}return!1},L.prototype.preprocess=function(t){var e=t.indexOf("</table>");return-1===e&&f("Could not find any closing </table> tags"),0<=t.indexOf('<td colspan="25">')&&(this.usesClasses=!0),(t=(t=(t=(t=t.substring(e+"</table>".length)).replace(/<tr[^>]*><td colspan=[^>]*>&nbsp;<\/td><\/tr>/g,"")).replace(/\n{2,}/g,"\n")).replace("</body>","").replace("</html>","")).trim()},L.prototype.canIgnoreThisLine=function(t){return""===t||-1<t.indexOf("<table")||-1<t.indexOf("</table>")||-1<t.indexOf("<hr>")},L.prototype.isCourseHeaderLine=function(t){return-1<t.indexOf('<tr class="clubName"')},L.prototype.parseCourseHeaderLine=function(t){var e=y(t);0===e.length&&f("No parts found in course header line");var s,n,r,i=e[0],o=/^(.*?)\s+\((\d+)m,\s*(\d+)m\)$/.exec(i);return r=null===o?(s=i,n=null):(s=o[1],n=parseInt(o[2],10)/1e3,parseInt(o[3],10)),{name:s.trim(),distance:n,climb:r}},L.prototype.parseControlsLine=function(t){return y(t).map(function(t){var e=t.indexOf("-");return-1===e?null:t.substring(e+1)})},L.prototype.readCompetitorSplitDataLine=function(t){for(var e=this.usesClasses?5:4,s=t.length;0<s&&""===t[s-1];)s-=1;for(var n=[],r=e;r<s;r+=2){var i=t[r];p(i)&&n.push(i)}return n},L.prototype.parseCompetitor=function(t,e){for(var s=S(t),n=S(e),r=g(s[0]),i=s[2],o=s[this.usesClasses?4:3],l=this.usesClasses&&""!==i?s[3]:null,a=n[2],u=this.usesClasses?5:4;u<s.length&&u<n.length;u+=2)""!==s[u]&&""===n[u]&&(n[u]="----");var c=this.readCompetitorSplitDataLine(s),m=this.readCompetitorSplitDataLine(n);return x(c=c.map(d),m),c.length!==m.length&&f("Cumulative and split times do not have the same length: "+c.length+" cumulative times, "+m.length+" split times"),new I(i,a,l,o,c,r)},D.prototype.addControls=function(t){this.controls=this.controls.concat(t)},D.prototype.hasAllControls=function(){return 0<this.controls.length&&null===this.controls[this.controls.length-1]},D.prototype.addCompetitor=function(t){if(t.competitive||t.cumTimes.length!==this.controls.length-1||t.cumTimes.push(null),null===d(t.totalTime)&&0===t.cumTimes.length)for(;t.cumTimes.length<this.controls.length;)t.cumTimes.push(null);t.cumTimes.length===this.controls.length?this.competitors.push(t):f("Competitor '"+t.name+"' should have "+this.controls.length+" cumulative times, but has "+t.cumTimes.length+" times")},F.prototype.tryGetLine=function(){return this.linePos+1<this.lines.length?(this.linePos+=1,this.lines[this.linePos]):null},F.prototype.addCurrentCompetitorIfNecessary=function(){null!==this.currentCompetitor&&(this.currentCourse.addCompetitor(this.currentCompetitor),
this.currentCompetitor=null)},F.prototype.addCurrentCompetitorAndCourseIfNecessary=function(){this.addCurrentCompetitorIfNecessary(),null!==this.currentCourse&&this.courses.push(this.currentCourse)},F.prototype.readCompetitorLines=function(t){var e=this.tryGetLine();null===e&&f("Hit end of input data unexpectedly while parsing competitor: first line was '"+t+"'");var s=this.recognizer.parseCompetitor(t,e);s.isContinuation()?null===this.currentCompetitor?f("First row of competitor data has no name nor time"):this.currentCompetitor.append(s):(this.addCurrentCompetitorIfNecessary(),this.currentCompetitor=s)},F.prototype.areClassesUniqueWithinCourses=function(){for(var t=d3.map(),e=0;e<this.courses.length;e+=1)for(var s=this.courses[e],n=0;n<s.competitors.length;n+=1){var r=s.competitors[n];if(t.has(r.className)){if(t.get(r.className)!==s.name)return!1}else t.set(r.className,s.name)}return!0},F.prototype.createOverallEventObject=function(){var s=this.areClassesUniqueWithinCourses(),t=[],l=[],n=this.courses.every(function(t){return t.competitors.every(function(t){return h(t.className)})});return this.courses.forEach(function(r){var i=d3.map();r.competitors.forEach(function(t){var e=n&&s?t.className:r.name;i.has(e)?i.get(e).push(t):i.set(e,[t])});var o=[];i.keys().forEach(function(t){var e=r.controls.length-1,s=i.get(t).map(function(t,e){return t.toCompetitor(e+1)}),n=new a(t,e,s);o.push(n),l.push(n)},this);var e=new u(r.name,o,r.distance,r.climb,r.controls.slice(0,r.controls.length-1));t.push(e),o.forEach(function(t){t.setCourse(e)})},this),new e(l,t,[])},F.prototype.parse=function(t){for(this.lines=t.split("\n");;){var e=this.tryGetLine();if(null===e)break;if(this.recognizer.canIgnoreThisLine(e));else if(this.recognizer.isCourseHeaderLine(e)){this.addCurrentCompetitorAndCourseIfNecessary();var s=this.recognizer.parseCourseHeaderLine(e);this.currentCourse=new D(s.name,s.distance,s.climb)}else if(null===this.currentCourse);else if(this.currentCourse.hasAllControls())this.readCompetitorLines(e);else{var n=this.recognizer.parseControlsLine(e);this.currentCourse.addControls(n)}}return this.addCurrentCompetitorAndCourseIfNecessary(),0===this.courses.length&&f("No competitor data was found"),this.createOverallEventObject()};var E=[t,B,L];SplitsBrowser.Input.Html={},SplitsBrowser.Input.Html.parseEventData=function(t){t=r(t);for(var e=0;e<E.length;e+=1){var s=new E[e];if(s.isTextOfThisFormat(t))return t=s.preprocess(t),new F(s).parse(t)}n("No HTML recognizers recognised this as HTML they could parse")}}(),function(){"use strict";var i=SplitsBrowser.throwWrongFileFormat,o=SplitsBrowser.normaliseLineEndings,p=SplitsBrowser.parseTime,u=SplitsBrowser.parseCourseLength,c=SplitsBrowser.parseCourseClimb,h=SplitsBrowser.Model.Result.fromOriginalCumTimes,f=SplitsBrowser.Model.Competitor,l=SplitsBrowser.Model.CourseClass,n=SplitsBrowser.Model.Course,a=SplitsBrowser.Model.Event,e={controlsOffset:38,step:3,name:3,club:5,courseName:7,startTime:8,length:null,climb:null,placing:null,finishTime:null,allowMultipleCompetitorNames:!0},r=[",",";"],m=/^[A-Za-z0-9]+$/;function d(t){for(var e=t.length-1;0<=e&&""===t[e];)e-=1;t.splice(e+1,t.length-e-1)}function s(t){this.format=t,this.classes=d3.map(),this.delimiter=null,this.hasAnyStarters=!1,this.warnings=[],this.controlsTerminationOffset=null===t.finishTime?t.step:0}s.prototype.determineDelimiter=function(t){for(var e=0;e<r.length;e+=1){var s=r[e],n=t.split(s);if(d(n),n.length>this.format.controlsOffset)return s}return null},s.prototype.adjustLinePartsForMultipleCompetitors=function(t){if(this.format.allowMultipleCompetitorNames)for(;t.length>this.format.name+1&&t[this.format.name+1].match(/^\s\S/);)t[this.format.name]+=","+t[this.format.name+1],t.splice(this.format.name+1,1)},s.prototype.checkControlCodesAlphaNumeric=function(t){var e=t.split(this.delimiter);d(e),this.adjustLinePartsForMultipleCompetitors(e,this.format);for(var s=this.format.controlsOffset;s+this.controlsTerminationOffset<e.length;s+=this.format.step)m.test(e[s])||i("Data appears not to be in an alternative CSV format - data in cell "+s+" of the first row ('"+e[s]+"') is not an number")},s.prototype.addCompetitorToCourse=function(t,e,s){if(this.classes.has(e)){var n=this.classes.get(e),r=t.result.getAllOriginalCumulativeTimes();r.length-1!==n.controls.length+1?this.warnings.push("Competitor '"+t.name+"' has the wrong number of splits for course '"+e+"': expected "+(n.controls.length+1)+", actual "+(r.length-1)):n.competitors.push(t)}else{for(var i=[],o=this.format.controlsOffset;o+this.controlsTerminationOffset<s.length;o+=this.format.step)i.push(s[o]);var l=null===this.format.length?null:u(s[this.format.length]),a=null===this.format.climb?null:c(s[this.format.climb]);this.classes.set(e,{length:l,climb:a,controls:i,competitors:[t]})}},s.prototype.readDataRow=function(t){var e=t.split(this.delimiter);if(d(e),this.adjustLinePartsForMultipleCompetitors(e),!(e.length<this.format.controlsOffset)){for(;(e.length-this.format.controlsOffset)%this.format.step!=0;)e.push("");for(var s=e[this.format.name],n=e[this.format.club],r=e[this.format.courseName],i=p(e[this.format.startTime]),o=[0],l=this.format.controlsOffset+1;l<e.length;l+=this.format.step)o.push(p(e[l]));if(null!==this.format.finishTime){var a=p(e[this.format.finishTime]),u=null===i||null===a?null:a-i;o.push(u)}if(1!==o.length){var c=this.classes.has(r)?this.classes.get(r).competitors.length+1:1,m=h(c,i,o);if(null!==this.format.placing&&m.completed())e[this.format.placing].match(/^\d*$/)||m.setNonCompetitive();m.hasAnyTimes()?this.hasAnyStarters=!0:m.setNonStarter(),this.addCompetitorToCourse(new f(s,n,m),r,e)}else""!==s&&this.warnings.push("Competitor '"+s+"' on course '"+(""===r?"(unnamed)":r)+"' has no times recorded")}},s.prototype.createClassesAndCourses=function(){var i=[],o=d3.map();this.classes.entries().forEach(function(t){var e=t.key,s=t.value,n=new l(e,s.controls.length,s.competitors);i.push(n);var r=s.controls.join(",");o.has(r)?o.get(r).classes.push(n):o.set(r,{name:e,classes:[n],length:s.length,climb:s.climb,controls:s.controls})});var s=[];return o.values().forEach(function(t){var e=new n(t.name,t.classes,t.length,t.climb,t.controls);t.classes.forEach(function(t){t.setCourse(e)}),s.push(e)}),{classes:i,courses:s}},s.prototype.parseEventData=function(t){this.warnings=[];var e=(t=o(t)).split(/\n/);e.length<2&&i("Data appears not to be in an alternative CSV format - too few lines");var s=e[1];this.delimiter=this.determineDelimiter(s),null===this.delimiter&&i("Data appears not to be in an alternative CSV format - first data line has fewer than "+this.format.controlsOffset+" parts when separated by any recognised delimiter"),this.checkControlCodesAlphaNumeric(s);for(var n=1;n<e.length;n+=1)this.readDataRow(e[n]);var r=this.createClassesAndCourses();return this.hasAnyStarters||i("Data appears not to be in an alternative CSV format - data apparently could be read but everyone was a non-starter"),new a(r.classes,r.courses,this.warnings)},SplitsBrowser.Input.AlternativeCSV={parseTripleColumnEventData:function(t){return new s(e).parseEventData(t)}}}(),function(){"use strict";var r=SplitsBrowser.throwInvalidData,c=SplitsBrowser.throwWrongFileFormat,m=SplitsBrowser.isNaNStrict,n=SplitsBrowser.parseTime,w=SplitsBrowser.Model.Result.fromOriginalCumTimes,S=SplitsBrowser.Model.Competitor,p=SplitsBrowser.Model.CourseClass,h=SplitsBrowser.Model.Course,f=SplitsBrowser.Model.Event;function a(t){return void 0===t}var y=/^\d{4}/,t={isOfThisVersion:function(t){return 0<=t.indexOf("IOFdata.dtd")},checkVersion:function(t){var e=$("> IOFVersion",t);if(0===e.length)c("Could not find IOFVersion element");else{var s=e.attr("version");a(s)?c("Version attribute missing from IOFVersion element"):"2.0.3"!==s&&c("Found unrecognised IOF XML data format '"+s+"'")}var n=t.attr("status");a(n)||"complete"===n.toLowerCase()||r("Only complete IOF data supported; snapshot and delta are not supported")},readClassName:function(t){return $("> ClassShortName",t).text()},readCourseFromClass:function(t,e){var s=$("> ClassShortName",t).text(),n=$("> PersonResult > Result",t).first(),r=null;if(0<n.length){var i=$("> CourseLength",n),o=i.text();if(0<o.length)if(r=parseFloat(o),isFinite(r)){var l=i.attr("unit");a(l)||"m"===l?r/=1e3:"km"===l||("ft"===l?r/=3280:(e.push("Course '"+s+"' gives its length in a unit '"+l+"', but this unit was not recognised"),r=null))}else e.push("Course '"+s+"' specifies a course length that was not understood: '"+o+"'"),r=null}return{id:null,name:s,length:r,climb:null,numberOfControls:null}},getCompetitorNameElement:function(t){return $("> Person > PersonName",t)},readClubName:function(t){return $("> Club > ShortName",t).text()},readDateOfBirth:function(t){return $("> Person > BirthDate > Date",t).text()},readStartTime:function(t){var e=$("> StartTime > Clock",t).text();return""===e?null:n(e)},readTotalTime:function(t){var e=$("> Time",t).text();return""===e?null:n(e)},getStatus:function(t){var e=$("> CompetitorStatus",t);return 1===e.length?e.attr("value"):""},StatusNonCompetitive:"NotCompeting",StatusNonStarter:"DidNotStart",StatusNonFinisher:"DidNotFinish",StatusDisqualified:"Disqualified",StatusOverMaxTime:"OverTime",isAdditional:function(){return!1},readSplitTime:function(t){var e=$("> ControlCode",t).text();""===e&&(e=$("> Control > ControlCode",t).text()),""===e&&r("Control code missing for control");var s=$("> Time",t).text();return{code:e,time:""===s?null:n(s)}}},i=/^\d\d\d\d-?\d\d-?\d\dT?(\d\d):?(\d\d)(?::?(\d\d))?/,o={isOfThisVersion:function(t){return 0<=t.indexOf("http://www.orienteering.org/datastandard/3.0")},checkVersion:function(t){var e=t.attr("iofVersion");a(e)?c("Could not find IOF version number"):"3.0"!==e&&c("Found unrecognised IOF XML data format '"+e+"'");var s=t.attr("status");a(s)||"complete"===s.toLowerCase()||r("Only complete IOF data supported; snapshot and delta are not supported")},readClassName:function(t){return $("> Class > Name",t).text()},readCourseFromClass:function(t,e){var s,n=$("> Course",t),r=$("> Id",n).text()||null,i=$("> Name",n).text(),o=$("> Length",n).text();""===o?s=null:(s=parseInt(o,10),m(s)?(e.push("Course '"+i+"' specifies a course length that was not understood: '"+o+"'"),s=null):s/=1e3);var l=$("> NumberOfControls",n).text(),a=parseInt(l,10);m(a)&&(a=null);var u=$("> Climb",n).text(),c=parseInt(u,10);return m(c)&&(c=null),{id:r,name:i,length:s,climb:c,numberOfControls:a}},getCompetitorNameElement:function(t){return $("> Person > Name",t)},readClubName:function(t){return $("> Organisation > ShortName",t).text()},readDateOfBirth:function(t){var e=$("> Person > BirthDate",t).text(),s=y.exec(e);return null===s?null:parseInt(s[0],10)},readStartTime:function(t){var e=$("> StartTime",t).text(),s=i.exec(e);return null===s?null:60*parseInt(s[1],10)*60+60*parseInt(s[2],10)+(a(s[3])?0:parseInt(s[3],10))},readTime:function(t){var e=parseFloat(t);return isFinite(e)?e:null},readTotalTime:function(t){var e=$("> Time",t).text();return o.readTime(e)},getStatus:function(t){return $("> Status",t).text()},StatusNonCompetitive:"NotCompeting",StatusNonStarter:"DidNotStart",StatusNonFinisher:"DidNotFinish",StatusDisqualified:"Disqualified",StatusOverMaxTime:"OverTime",isAdditional:function(t){return"Additional"===t.attr("status")},readSplitTime:function(t){var e,s=$("> ControlCode",t).text();if(""===s&&r("Control code missing for control"),"Missing"===t.attr("status"))e=null;else{var n=$("> Time",t).text();e=""===n?null:o.readTime(n)}return{code:s,time:e}}},d=[t,o];function g(t,e,s,n){var r=$(t),i=function(t){var e=$("> Given",t).text(),s=$("> Family",t).text();return""===e?s:""===s?e:e+" "+s}(s.getCompetitorNameElement(r));if(""===i)return n.push("Could not find a name for a competitor"),null;var o=s.readClubName(r),l=s.readDateOfBirth(r),a=y.exec(l),u=null===a?null:parseInt(a[0],10),c=$("> Person",r).attr("sex"),m=$("Result",r);if(0===m.length)return n.push("Could not find any result information for competitor '"+i+"'"),null;var p=s.readStartTime(m),h=s.readTotalTime(m),f=$("> SplitTime",m).toArray().filter(function(t){return!s.isAdditional($(t))}).map(function(t){return s.readSplitTime($(t))}),d=f.map(function(t){return t.code}),g=f.map(function(t){return t.time});g.unshift(0),g.push(h);var C=w(e,p,g),v=s.getStatus(m);"OK"===v&&null!==h&&0<=g.indexOf(null)?C.setOKDespiteMissingTimes():v===s.StatusNonCompetitive?C.setNonCompetitive():v===s.StatusNonStarter?C.setNonStarter():v===s.StatusNonFinisher?C.setNonFinisher():v===s.StatusDisqualified?C.disqualify():v===s.StatusOverMaxTime&&C.setOverMaxTime();var T=new S(i,o,C);return null!==u&&T.setYearOfBirth(u),"M"!==c&&"F"!==c||T.setGender(c),{competitor:T,controls:d}}SplitsBrowser.Input.IOFXml={parseEventData:function(t){var i=function(t){for(var e=0;e<d.length;e+=1){var s=d[e];if(s.isOfThisVersion(t))return s}c("Data apparently not of any recognised IOF XML format")}(t),e=function(t){var e;try{e=$.parseXML(t)}catch(t){r("XML data not well-formed")}return 0===$("> *",$(e)).length&&r("XML data not well-formed: "+t),e}(t);!function(t,e){var s=$("> *",t),n=s.prop("tagName");"ResultList"!==n&&c("Root element of XML document does not have expected name 'ResultList', got '"+n+"'"),e.checkVersion(s)}(e,i);var s=$("> ResultList > ClassResult",$(e)).toArray();0===s.length&&r("No class result elements found");var o=[],l=[],a=d3.map(),u=[];s.forEach(function(t){var e=function(t,e,s){var n=$(t),r={name:null,competitors:[],controls:[],course:null};r.course=e.readCourseFromClass(n,s);var i=e.readClassName(n);""===i&&(i="<unnamed class>"),r.name=i;var o=$("> PersonResult",n);if(0===o.length)return s.push("Class '"+i+"' has no competitors"),null;for(var l=0;l<o.length;l+=1){var a=g(o[l],l+1,e,s);if(null!==a){var u=a.competitor,c=a.controls;0!==r.competitors.length||u.isNonStarter&&0===c.length||(r.controls=c,null===r.course.numberOfControls&&(r.course.numberOfControls=r.controls.length));var m=u.result.getAllOriginalCumulativeTimes().length-2,p=null;if(u.result.isNonStarter&&0==m);else if(m!==r.course.numberOfControls)p="Competitor '"+u.name+"' in class '"+i+"' has an unexpected number of controls: expected "+r.course.numberOfControls+", actual "+m;else for(var h=0;h<m;h+=1)if(r.controls[h]!==c[h]){p="Competitor '"+u.name+"' has an unexpected control code at control "+(h+1)+": expected '"+r.controls[h]+"', actual '"+c[h]+"'";break}null===p?r.competitors.push(u):s.push(p)}}return null===r.course.id&&0<r.controls.length&&(r.course.id=r.controls.join(",")),r}(t,i,u);if(null!==e){var s=new p(e.name,e.controls.length,e.competitors);o.push(s);var n=e.course,r=n.id+","+e.controls.join(",");null!==n.id&&a.has(r)?a.get(r).classes.push(s):(n.classes=[s],n.controls=e.controls,l.push(n),null!==n.id&&a.set(r,n))}});var n=l.map(function(t){var e=new h(t.name,t.classes,t.length,t.climb,t.controls);return t.classes.forEach(function(t){t.setCourse(e)}),e});return new f(o,n,u)}}}(),function(){"use strict";var n=[SplitsBrowser.Input.CSV.parseEventData,SplitsBrowser.Input.OE.parseEventData,SplitsBrowser.Input.Html.parseEventData,SplitsBrowser.Input.AlternativeCSV.parseTripleColumnEventData,SplitsBrowser.Input.IOFXml.parseEventData];SplitsBrowser.Input.parseEventData=function(t){for(var e=0;e<n.length;e+=1){var s=n[e];try{return s(t)}catch(t){if("WrongFileFormat"!==t.name)throw t}}return null}}();