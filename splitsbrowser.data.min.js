/*!
 *  SplitsBrowser - Orienteering results analysis.
 *  
 *  Copyright (C) 2000-2015 Dave Ryder, Reinhard Balling, Andris Strazdins,
 *                          Ed Nash, Luke Woodward
 *
 *  This program is free software; you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation; either version 2 of the License, or
 *  (at your option) any later version.
 *
 *  This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License along
 *  with this program; if not, write to the Free Software Foundation, Inc.,
 *  51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
 */
var SplitsBrowser={Version:"3.3.9",Model:{},Input:{},Controls:{},Messages:{}};!function(){"use strict";function a(a){this.name="InvalidData",this.message=a}function b(a){this.name="WrongFileFormat",this.message=a}var c=500;SplitsBrowser.isTrue=function(a){return a},SplitsBrowser.isNotNull=function(a){return null!==a},SplitsBrowser.isNaNStrict=function(a){return a!==a},SplitsBrowser.isNotNullNorNaN=function(a){return null!==a&&a===a},a.prototype.toString=function(){return this.name+": "+this.message},SplitsBrowser.throwInvalidData=function(b){throw new a(b)},b.prototype.toString=function(){return this.name+": "+this.message},SplitsBrowser.throwWrongFileFormat=function(a){throw new b(a)},SplitsBrowser.parseCourseLength=function(a){var b=parseFloat(a.replace(",","."));return isFinite(b)?(b>=c&&(b/=1e3),b):null},SplitsBrowser.parseCourseClimb=function(a){var b=parseInt(a,10);return SplitsBrowser.isNaNStrict(b)?null:b},SplitsBrowser.normaliseLineEndings=function(a){return a.replace(/\r\n/g,"\n").replace(/\r/g,"\n")}}(),function(){"use strict";SplitsBrowser.NULL_TIME_PLACEHOLDER="-----";var a=SplitsBrowser.isNaNStrict;SplitsBrowser.formatTime=function(b,c){if(null===b)return SplitsBrowser.NULL_TIME_PLACEHOLDER;if(a(b))return"???";var d="";0>b&&(d="-",b=-b);var e=Math.floor(b/3600),f=Math.floor(b/60)%60,g=b%60;return e>0&&(d+=e.toString()+":"),10>f&&(d+="0"),d+=f+":",10>g&&(d+="0"),d+="number"==typeof c?g.toFixed(c):Math.round(100*g)/100},SplitsBrowser.parseTime=function(a){if(a=a.trim(),/^(\d+:)?\d+:\d\d([,.]\d+)?$/.test(a)){var b=a.replace(",",".").split(":"),c=0;return b.forEach(function(a){c=60*c+parseFloat(a)}),c}return null}}(),function(){"use strict";function a(a,b){return null===a||null===b?null:a+b}function b(a,b){return null===a||null===b?null:a-b}function c(a){if(!$.isArray(a))throw new TypeError("Cumulative times must be an array - got "+typeof a+" instead");0===a.length?i("Array of cumulative times must not be empty"):0!==a[0]?i("Array of cumulative times must have zero as its first item"):1===a.length&&i("Array of cumulative times must contain more than just a single zero");for(var c=[],d=0;d+1<a.length;d+=1)c.push(b(a[d+1],a[d]));return c}function d(a,b,c,d,e,g){typeof a!==f&&i("Competitor order must be a number, got "+typeof a+" '"+a+"' instead"),this.order=a,this.name=b,this.club=c,this.startTime=d,this.isNonCompetitive=!1,this.isNonStarter=!1,this.isNonFinisher=!1,this.isDisqualified=!1,this.isOverMaxTime=!1,this.className=null,this.yearOfBirth=null,this.gender=null,this.originalSplitTimes=e,this.originalCumTimes=g,this.splitTimes=null,this.cumTimes=null,this.splitRanks=null,this.cumRanks=null,this.timeLosses=null,this.totalTime=null===g||g.indexOf(null)>-1?null:g[g.length-1]}function e(a){for(var b=[],c=1;c+1<a.length;)if(h(a[c])){for(var d=c;d+1<a.length&&h(a[d+1]);)d+=1;d+1<a.length&&null!==a[c-1]&&null!==a[d+1]&&b.push({start:c-1,end:d+1}),c=d+1}else c+=1;return b}var f="number",g=SplitsBrowser.isNotNull,h=SplitsBrowser.isNaNStrict,i=SplitsBrowser.throwInvalidData;SplitsBrowser.Model.compareCompetitors=function(a,b){return a.isDisqualified!==b.isDisqualified?a.isDisqualified?1:-1:a.totalTime===b.totalTime?a.order-b.order:null===a.totalTime?null===b.totalTime?0:1:null===b.totalTime?-1:a.totalTime-b.totalTime},d.prototype.setNonCompetitive=function(){this.isNonCompetitive=!0},d.prototype.setNonStarter=function(){this.isNonStarter=!0},d.prototype.setNonFinisher=function(){this.isNonFinisher=!0},d.prototype.disqualify=function(){this.isDisqualified=!0},d.prototype.setOverMaxTime=function(){this.isOverMaxTime=!0},d.prototype.setClassName=function(a){this.className=a},d.prototype.setYearOfBirth=function(a){this.yearOfBirth=a},d.prototype.setGender=function(a){this.gender=a},d.fromOriginalCumTimes=function(a,b,e,f,g){var h=c(g);return new d(a,b,e,f,h,g)},d.fromCumTimes=function(a,b,c,e,f){var g=d.fromOriginalCumTimes(a,b,c,e,f);return g.splitTimes=g.originalSplitTimes,g.cumTimes=g.originalCumTimes,g},d.prototype.setRepairedCumulativeTimes=function(a){this.cumTimes=a,this.splitTimes=c(a)},d.prototype.completed=function(){return null!==this.totalTime&&!this.isDisqualified&&!this.isOverMaxTime},d.prototype.hasAnyTimes=function(){return this.originalCumTimes.slice(1).some(g)},d.prototype.getSplitTimeTo=function(a){return 0===a?0:this.splitTimes[a-1]},d.prototype.getOriginalSplitTimeTo=function(a){return 0===a?0:this.originalSplitTimes[a-1]},d.prototype.isSplitTimeDubious=function(a){return a>0&&this.originalSplitTimes[a-1]!==this.splitTimes[a-1]},d.prototype.getCumulativeTimeTo=function(a){return this.cumTimes[a]},d.prototype.getOriginalCumulativeTimeTo=function(a){return this.originalCumTimes[a]},d.prototype.isCumulativeTimeDubious=function(a){return this.originalCumTimes[a]!==this.cumTimes[a]},d.prototype.getSplitRankTo=function(a){return null===this.splitRanks||0===a?null:this.splitRanks[a-1]},d.prototype.getCumulativeRankTo=function(a){return null===this.cumRanks||0===a?null:this.cumRanks[a-1]},d.prototype.getTimeLossAt=function(a){return 0===a||null===this.timeLosses?null:this.timeLosses[a-1]},d.prototype.getAllCumulativeTimes=function(){return this.cumTimes},d.prototype.getAllOriginalCumulativeTimes=function(){return this.originalCumTimes},d.prototype.lacksStartTime=function(){return null===this.startTime&&this.splitTimes.some(g)},d.prototype.setSplitAndCumulativeRanks=function(a,b){this.splitRanks=a,this.cumRanks=b},d.prototype.getCumTimesAdjustedToReference=function(a){a.length!==this.cumTimes.length?i("Cannot adjust competitor times because the numbers of times are different ("+this.cumTimes.length+" and "+a.length+")"):a.indexOf(null)>-1&&i("Cannot adjust competitor times because a null value is in the reference data");var c=this.cumTimes.map(function(c,d){return b(c,a[d])});return c},d.prototype.getCumTimesAdjustedToReferenceWithStartAdded=function(b){var c=this.getCumTimesAdjustedToReference(b),d=this.startTime;return c.map(function(b){return a(b,d)})},d.prototype.getSplitPercentsBehindReferenceCumTimes=function(a){a.length!==this.cumTimes.length?i("Cannot determine percentages-behind because the numbers of times are different ("+this.cumTimes.length+" and "+a.length+")"):a.indexOf(null)>-1&&i("Cannot determine percentages-behind because a null value is in the reference data");var b=[0];return this.splitTimes.forEach(function(c,d){if(null===c)b.push(null);else{var e=a[d+1]-a[d];e>0?b.push(100*(c-e)/e):b.push(null)}}),b},d.prototype.determineTimeLosses=function(a){if(this.completed())if(a.length!==this.splitTimes.length?i("Cannot determine time loss of competitor with "+this.splitTimes.length+" split times using "+a.length+" fastest splits"):a.some(h)&&i("Cannot determine time loss of competitor when there is a NaN value in the fastest splits"),a.some(function(a){return 0===a}))this.timeLosses=this.splitTimes.map(function(){return 0/0});else if(this.splitTimes.some(h))this.timeLosses=this.splitTimes.map(function(){return 0/0});else{var b=this.splitTimes.map(function(b,c){return b/a[c]});b.sort(d3.ascending);var c;if(1===b.length%2)c=b[(b.length-1)/2];else{var d=b.length/2;c=(b[d-1]+b[d])/2}this.timeLosses=this.splitTimes.map(function(b,d){return Math.round(b-a[d]*c)})}},d.prototype.crosses=function(a){a.cumTimes.length!==this.cumTimes.length&&i("Two competitors with different numbers of controls cannot cross");for(var b=!1,c=!1,d=0;d<this.cumTimes.length;d+=1)if(null!==this.cumTimes[d]&&null!==a.cumTimes[d]){var e=this.startTime+this.cumTimes[d],f=a.startTime+a.cumTimes[d];f>e?b=!0:e>f&&(c=!0)}return b&&c},d.prototype.getControlIndexesAroundDubiousCumulativeTimes=function(){return e(this.cumTimes)},d.prototype.getControlIndexesAroundDubiousSplitTimes=function(){return e([0].concat(this.splitTimes))},SplitsBrowser.Model.Competitor=d}(),function(){"use strict";function a(a,b,c){this.name=a,this.numControls=b,this.competitors=c,this.course=null,this.hasDubiousData=!1,this.competitors.forEach(function(b){b.setClassName(a)})}var b=SplitsBrowser.isNotNullNorNaN,c=SplitsBrowser.throwInvalidData;a.prototype.recordHasDubiousData=function(){this.hasDubiousData=!0},a.prototype.determineTimeLosses=function(){var a=d3.range(1,this.numControls+2).map(function(a){var b=this.getFastestSplitTo(a);return null===b?null:b.split},this);this.competitors.forEach(function(b){b.determineTimeLosses(a)})},a.prototype.isEmpty=function(){return 0===this.competitors.length},a.prototype.setCourse=function(a){this.course=a},a.prototype.getFastestSplitTo=function(a){("number"!=typeof a||1>a||a>this.numControls+1)&&c("Cannot return splits to leg '"+a+"' in a course with "+this.numControls+" control(s)");var d=null,e=null;return this.competitors.forEach(function(c){var f=c.getSplitTimeTo(a);b(f)&&(null===d||d>f)&&(d=f,e=c)}),null===d?null:{split:d,name:e.name}},a.prototype.getCompetitorsAtControlInTimeRange=function(a,b,d){("number"!=typeof a||isNaN(a)||0>a||a>this.numControls+1)&&c("Control number must be a number between 0 and "+this.numControls+" inclusive");var e=[];return this.competitors.forEach(function(c){var f=c.getCumulativeTimeTo(a);if(null!==f&&null!==c.startTime){var g=f+c.startTime;g>=b&&d>=g&&e.push({name:c.name,time:g})}}),e},SplitsBrowser.Model.CourseClass=a}(),function(){"use strict";function a(a,b,c,d,e){this.name=a,this.classes=b,this.length=c,this.climb=d,this.controls=e}var b=SplitsBrowser.throwInvalidData;a.START="__START__",a.FINISH="__FINISH__";var c=a.START,d=a.FINISH;a.prototype.getOtherClasses=function(a){var c=this.classes.filter(function(b){return b!==a});return c.length!==this.classes.length?c:(b("Course.getOtherClasses: given class is not in this course"),void 0)},a.prototype.getNumClasses=function(){return this.classes.length},a.prototype.hasControls=function(){return null!==this.controls},a.prototype.getControlCode=function(a){return 0===a?c:a>=1&&a<=this.controls.length?this.controls[a-1]:a===this.controls.length+1?d:(b("Cannot get control code of control "+a+" because it is out of range"),void 0)},a.prototype.usesLeg=function(a,b){return this.getLegNumber(a,b)>=0},a.prototype.getLegNumber=function(a,b){if(null===this.controls)return-1;if(a===c&&b===d)return 0===this.controls.length?1:-1;if(a===c)return this.controls.length>0&&this.controls[0]===b?1:-1;if(b===d)return this.controls.length>0&&this.controls[this.controls.length-1]===a?this.controls.length+1:-1;for(var e=1;e<this.controls.length;e+=1)if(this.controls[e-1]===a&&this.controls[e]===b)return e+1;return-1},a.prototype.getFastestSplitsForLeg=function(a,e){null===this.legs&&b("Cannot determine fastest splits for a leg because leg information is not available");var f=this.getLegNumber(a,e);if(0>f){var g=(a===c?"start":a)+" to "+(e===d?"end":e);b("Leg from "+g+" not found in course "+this.name)}var h=f,i=[];return this.classes.forEach(function(a){var b=a.getFastestSplitTo(h);null!==b&&i.push({name:b.name,className:a.name,split:b.split})}),i},a.prototype.getCompetitorsAtControlInTimeRange=function(a,b,e){if(null===this.controls)return[];if(a===c)return this.getCompetitorsAtControlNumInTimeRange(0,b,e);if(a===d)return this.getCompetitorsAtControlNumInTimeRange(this.controls.length+1,b,e);var f=this.controls.indexOf(a);return f>=0?this.getCompetitorsAtControlNumInTimeRange(f+1,b,e):[]},a.prototype.getCompetitorsAtControlNumInTimeRange=function(a,b,c){var d=[];return this.classes.forEach(function(e){e.getCompetitorsAtControlInTimeRange(a,b,c).forEach(function(a){d.push({name:a.name,time:a.time,className:e.name})})}),d},a.prototype.hasControl=function(a){return null!==this.controls&&this.controls.indexOf(a)>-1},a.prototype.getNextControls=function(a){if(null===this.controls)b("Course has no controls");else if(a===d)b("Cannot fetch next control after the finish");else{if(a===c)return[0===this.controls.length?d:this.controls[0]];for(var e=-1,f=[];;){var g=this.controls.indexOf(a,e+1);if(-1===g)break;g===this.controls.length-1?f.push(d):f.push(this.controls[g+1]),e=g}if(0!==f.length)return f;b("Control '"+a+"' not found on course "+this.name)}},SplitsBrowser.Model.Course=a}(),function(){"use strict";function a(a,b){this.classes=a,this.courses=b}var b=SplitsBrowser.Model.Course;a.prototype.determineTimeLosses=function(){this.classes.forEach(function(a){a.determineTimeLosses()})},a.prototype.needsRepair=function(){return this.classes.some(function(a){return a.competitors.some(function(a){return null===a.getAllCumulativeTimes()})})},a.prototype.getFastestSplitsForLeg=function(a,b){var c=[];return this.courses.forEach(function(d){d.usesLeg(a,b)&&(c=c.concat(d.getFastestSplitsForLeg(a,b)))}),c.sort(function(a,b){return d3.ascending(a.split,b.split)}),c},a.prototype.getCompetitorsAtControlInTimeRange=function(a,b,c){var d=[];return this.courses.forEach(function(e){e.getCompetitorsAtControlInTimeRange(a,b,c).forEach(function(a){d.push(a)})}),d.sort(function(a,b){return d3.ascending(a.time,b.time)}),d},a.prototype.getNextControlsAfter=function(a){var c=this.courses;return a!==b.START&&(c=c.filter(function(b){return b.hasControl(a)})),c.map(function(b){return{course:b,nextControls:b.getNextControls(a)}})},SplitsBrowser.Model.Event=a}(),function(){"use strict";function a(a,b,c){var d=b.split(",");if(d.length===c+5){var f=d.shift(),g=d.shift(),j=d.shift(),k=d.shift(),l=h(k);0===l?l=null:k.match(/^\d+:\d\d:\d\d$/)||(l*=60);var m=[0],n=0;d.map(function(a){var b=h(a);null!==b&&b>0?(n+=b,m.push(n)):m.push(null)});var o=i.fromCumTimes(a+1,f+" "+g,j,l,m);return 0===n&&o.setNonStarter(),o}e("Expected "+(c+5)+" items in row for competitor in class with "+c+" controls, got "+d.length+" instead.")}function b(b){var c=b.split(/\r?\n/).filter(d);0===c.length&&e("parseCourseClass got an empty list of lines");var g=c.shift().split(",");if(2===g.length){var h=g.shift(),i=g.shift(),l=parseInt(i,10);if(isNaN(l))e("Could not read control count: '"+i+"'");else{if(!(0>l&&c.length>0)){var m=c.map(function(b,c){return a(c,b,l)});return m.sort(j),new k(h,l,m)}e("Expected a non-negative control count, got "+l+" instead")}}else f("Expected first line to have two parts (class name and number of controls), got "+g.length+" part(s) instead")}function c(a){/<html/i.test(a)&&f("Cannot parse this file as CSV as it appears to be HTML"),a=g(a),a=a.replace(/,+\n/g,"\n").replace(/,+$/,"");var c=a.split(/\n\n/).map(function(a){return a.trim()}).filter(d),h=c.map(b);h=h.filter(function(a){return!a.isEmpty()}),0===h.length&&e("No competitor data was found");for(var i=h.map(function(a){return new l(a.name,[a],null,null,null)}),j=0;j<h.length;j+=1)h[j].setCourse(i[j]);return new m(h,i)}var d=SplitsBrowser.isTrue,e=SplitsBrowser.throwInvalidData,f=SplitsBrowser.throwWrongFileFormat,g=SplitsBrowser.normaliseLineEndings,h=SplitsBrowser.parseTime,i=SplitsBrowser.Model.Competitor,j=SplitsBrowser.Model.compareCompetitors,k=SplitsBrowser.Model.CourseClass,l=SplitsBrowser.Model.Course,m=SplitsBrowser.Model.Event;SplitsBrowser.Input.CSV={parseEventData:c}}(),function(){"use strict";function a(a){return'"'===a[0]&&'"'===a[a.length-1]&&(a=a.substring(1,a.length-1).replace(/""/g,'"').trim()),a}function b(a){this.data=h(a),this.classes=d3.map(),this.courseDetails=d3.map(),this.classCoursePairs=[],this.columnIndexes=null}var c=SplitsBrowser.throwInvalidData,d=SplitsBrowser.throwWrongFileFormat,e=SplitsBrowser.isNaNStrict,f=SplitsBrowser.parseCourseLength,g=SplitsBrowser.parseCourseClimb,h=SplitsBrowser.normaliseLineEndings,i=SplitsBrowser.parseTime,j=SplitsBrowser.Model.Competitor.fromOriginalCumTimes,k=SplitsBrowser.Model.CourseClass,l=SplitsBrowser.Model.Course,m=SplitsBrowser.Model.Event,n=[";",",","	","\\"],o={};[44,46,60].forEach(function(a){o[a]={course:a-7,distance:a-6,climb:a-5,controlCount:a-4,placing:a-3,startPunch:a-2,finish:a-1,control1:a}}),[44,46].forEach(function(a){o[a].nonCompetitive=a-38,o[a].startTime=a-37,o[a].time=a-35,o[a].classifier=a-34,o[a].club=a-31,o[a].className=a-28}),o[44].combinedName=3,o[44].yearOfBirth=4,o[46].forename=4,o[46].surname=3,o[46].yearOfBirth=5,o[46].gender=6,o[60].forename=6,o[60].surname=5,o[60].yearOfBirth=7,o[60].gender=8,o[60].combinedName=3,o[60].nonCompetitive=10,o[60].startTime=11,o[60].time=13,o[60].classifier=14,o[60].club=20,o[60].className=26,o[60].classNameFallback=o[60].course,o[60].clubFallback=18;var p=37;b.prototype.identifyDelimiter=function(){this.lines.length<=1&&d("No data found to read");for(var a=this.lines[1],b=0;b<n.length;b+=1){var c=n[b];if(a.split(c).length>p)return c}d("Data appears not to be in the OE CSV format")},b.prototype.identifyFormatVariation=function(a){var b=this.lines[1].split(a),c=/^[A-Za-z0-9]+$/;for(var e in o)if(o.hasOwnProperty(e)&&(e=parseInt(e,10),e<b.length&&c.test(b[e])&&(""===b[e-2].trim()||null!==i(b[e-2]))&&(""===b[e-1].trim()||null!==i(b[e-1])))){var f=o[e].controlCount;if(""!==b[f].trim())return this.columnIndexes=o[e],void 0}d("Did not find control 1 at any of the supported indexes")},b.prototype.getClassName=function(a){var b=a[this.columnIndexes.className];return""===b&&this.columnIndexes.hasOwnProperty("classNameFallback")&&(b=a[this.columnIndexes.classNameFallback]),b},b.prototype.getStartTime=function(a){var b=a[this.columnIndexes.startPunch];return""===b&&(b=a[this.columnIndexes.startTime]),i(b)},b.prototype.getNumControls=function(a,b){var d=this.getClassName(a);if(""===d.trim())c("Line "+b+" does not contain a class for the competitor");else{if(this.classes.has(d))return this.classes.get(d).numControls;var e=parseInt(a[this.columnIndexes.controlCount],10);if(isFinite(e))return e;c("Could not read control count '"+a[this.columnIndexes.controlCount]+"' from line "+b)}},b.prototype.readCumulativeTimes=function(a,b,c){for(var d=[0],e=0;c>e;e+=1){var f=this.columnIndexes.control1+1+2*e,g=f<a.length?a[f]:null,h=null===g?null:i(g);d.push(h)}var j=i(a[this.columnIndexes.time]);if(null===j){var k=this.getStartTime(a),l=i(a[this.columnIndexes.finish]);null!==k&&null!==l&&(j=l-k)}return d.push(j),d},b.prototype.createClassIfNecessary=function(a,b){var c=this.getClassName(a);this.classes.has(c)||this.classes.set(c,{numControls:b,competitors:[]})},b.prototype.createCourseIfNecessary=function(a,b){var c=a[this.columnIndexes.course];if(!this.courseDetails.has(c)){var d=d3.range(0,b).map(function(b){return a[this.columnIndexes.control1+2*b]},this);this.courseDetails.set(c,{length:f(a[this.columnIndexes.distance]),climb:g(a[this.columnIndexes.climb]),controls:d})}},b.prototype.createClassCoursePairIfNecessary=function(a){var b=this.getClassName(a),c=a[this.columnIndexes.course];this.classCoursePairs.some(function(a){return a[0]===b&&a[1]===c})||this.classCoursePairs.push([b,c])},b.prototype.addCompetitor=function(a,b){var c=this.getClassName(a),d=a[this.columnIndexes.placing],f=a[this.columnIndexes.club];""===f&&this.columnIndexes.hasOwnProperty("clubFallback")&&(f=a[this.columnIndexes.clubFallback]);var g=this.getStartTime(a),h=""!==d&&e(parseInt(d,10)),i="";if(this.columnIndexes.hasOwnProperty("forename")&&this.columnIndexes.hasOwnProperty("surname")){var k=a[this.columnIndexes.forename],l=a[this.columnIndexes.surname];h&&l.substring(l.length-d.length)===d&&(l=l.substring(0,l.length-d.length).trim()),i=(k+" "+l).trim()}""===i&&this.columnIndexes.hasOwnProperty("combinedName")&&(i=a[this.columnIndexes.combinedName],h&&i.substring(i.length-d.length)===d&&(i=i.substring(0,i.length-d.length).trim()));var m=this.classes.get(c).competitors.length+1,n=j(m,i,f,g,b);("1"===a[this.columnIndexes.nonCompetitive]||h)&&n.completed()&&n.setNonCompetitive();var o=a[this.columnIndexes.classifier];""!==o&&"0"!==o?"1"===o?n.setNonStarter():"2"===o?n.setNonFinisher():"4"===o?n.disqualify():"5"===o&&n.setOverMaxTime():n.hasAnyTimes()||n.setNonStarter();var p=a[this.columnIndexes.yearOfBirth];if(""!==p){var q=parseInt(p,10);e(q)||n.setYearOfBirth(q)}if(this.columnIndexes.hasOwnProperty("gender")){var r=a[this.columnIndexes.gender];("M"===r||"F"===r)&&n.setGender(r)}this.classes.get(c).competitors.push(n)},b.prototype.readLine=function(b,d,e){if(""!==b.trim()){var f=b.split(e).map(function(a){return a.trim()}).map(a);f.length<p&&c("Too few items on line "+d+" of the input file: expected at least "+p+", got "+f.length);var g=this.getNumControls(f,d),h=this.readCumulativeTimes(f,d,g);this.createClassIfNecessary(f,g),this.createCourseIfNecessary(f,g),this.createClassCoursePairIfNecessary(f),this.addCompetitor(f,h)}},b.prototype.getMapsBetweenClassesAndCourses=function(){var a=d3.map(),b=d3.map();return this.classCoursePairs.forEach(function(c){var d=c[0],e=c[1];a.has(d)?a.get(d).push(e):a.set(d,[e]),b.has(e)?b.get(e).push(d):b.set(e,[d])}),{classesToCourses:a,coursesToClasses:b}},b.prototype.createClasses=function(){var a=this.classes.keys();return a.sort(),a.map(function(a){var b=this.classes.get(a);return new k(a,b.numControls,b.competitors)},this)},b.prototype.createCourseFromLinkedClassesAndCourses=function(a,b,c,d){for(var e,f,g=[a],h=[],i=[],j=[];g.length>0||h.length>0;){for(;g.length>0;){e=g.shift();for(var k=b.coursesToClasses.get(e),m=0;m<k.length;m+=1)f=k[m],h.indexOf(f)<0&&j.indexOf(f)<0&&h.push(f);i.push(e)}for(;h.length>0;){f=h.shift();for(var n=b.classesToCourses.get(f),o=0;o<n.length;o+=1)e=n[o],g.indexOf(e)<0&&i.indexOf(e)<0&&g.push(e);j.push(f)}}i.forEach(function(a){c.add(a)});var p=j.map(function(a){return d.get(a)}),q=this.courseDetails.get(a),r=new l(a,p,q.length,q.climb,q.controls);return p.forEach(function(a){a.setCourse(r)}),r},b.prototype.determineCourses=function(a){var b=this.getMapsBetweenClassesAndCourses(),c=d3.set(),d=d3.map();a.forEach(function(a){d.set(a.name,a)});var e=[];return b.coursesToClasses.keys().forEach(function(a){if(!c.has(a)){var f=this.createCourseFromLinkedClassesAndCourses(a,b,c,d);e.push(f)}},this),e},b.prototype.parseEventData=function(){this.lines=this.data.split(/\n/);var a=this.identifyDelimiter();this.identifyFormatVariation(a),this.lines.shift(),this.lines.forEach(function(b,c){this.readLine(b,c+1,a)},this);var b=this.createClasses(),c=this.determineCourses(b);return new m(b,c)},SplitsBrowser.Input.OE={},SplitsBrowser.Input.OE.parseEventData=function(a){var c=new b(a);return c.parseEventData()}}(),function(){"use strict";function a(a){return null!==a&&""!==a}function b(a){return a=a.trim(),""!==a&&isFinite(a)}function c(b){return b.split(/\s+/g).filter(a)}function d(a){return a.replace(A,"")}function e(a,b){for(var c,e=[];;){if(c=a.exec(b),null===c)break;e.push(d(c[1]))}return e}function f(a){return e(/<font[^>]*>(.*?)<\/font>/g,a)}function g(a){return e(/<td[^>]*>(.*?)<\/td>/g,a).map(function(a){return a.trim()})}function h(a){return g(a).filter(function(a){return""!==a})}function i(a){var b=e(/<th[^>]*>(.*?)<\/th>/g,a);return b.filter(function(a){return""!==a})}function j(a){var b=B.exec(a);return null===b?null:t(b[1])}function k(a){var b=C.exec(a);return null===b?null:parseInt(b[1],10)}function l(a){for(var b=[],c=0;c<a.length;c+=1){var d=a[c],e=d.indexOf("(");if(e>-1&&")"===d[d.length-1]){var f=d.substring(e+1,d.length-1);b.push(f)}else c+1===a.length?b.push(null):r("Unrecognised control header label: '"+d+"'")}return b}function m(a,b){for(;b.length>0&&"*"===b[b.length-1][0];)b.splice(b.length-1,1),a.splice(a.length-1,1)}function n(a,b,c,d,e,f){this.name=a,this.club=b,this.className=c,this.totalTime=d,this.cumTimes=e,this.competitive=f}function o(a,b,c){this.name=a,this.distance=b,this.climb=c,this.controls=[],this.competitors=[]}function p(a){this.recognizer=a,this.courses=[],this.currentCourse=null,this.lines=null,this.linePos=-1,this.currentCompetitor=null}var q=SplitsBrowser.isNotNull,r=SplitsBrowser.throwInvalidData,s=SplitsBrowser.throwWrongFileFormat,t=SplitsBrowser.parseCourseLength,u=SplitsBrowser.normaliseLineEndings,v=SplitsBrowser.parseTime,w=SplitsBrowser.Model.Competitor.fromOriginalCumTimes,x=SplitsBrowser.Model.CourseClass,y=SplitsBrowser.Model.Course,z=SplitsBrowser.Model.Event,A=/<[^>]+>/g,B=/([0-9.,]+)\s*(?:Km|km)/,C=/(\d+)\s*(?:Cm|Hm|hm|m)/;n.prototype.isContinuation=function(){return""===this.name&&""===this.club&&null===this.className&&""===this.totalTime&&!this.competitive},n.prototype.append=function(a){if(!a.isContinuation())throw new Error("Can only append a continuation CompetitorParseRecord");this.cumTimes=this.cumTimes.concat(a.cumTimes)},n.prototype.toCompetitor=function(a){var b=[0].concat(this.cumTimes),c=w(a,this.name,this.club,null,b);return c.completed()&&!this.competitive&&c.setNonCompetitive(),c.hasAnyTimes()||c.setNonStarter(),c};var D=function(){this.precedingColumnCount=null};D.prototype.isTextOfThisFormat=function(a){return a.indexOf("<pre>")>=0&&a.indexOf("<font")>=0},D.prototype.preprocess=function(a){var b=a.indexOf("<pre>");if(-1===b)throw new Error("Cannot find opening pre tag");var c=a.indexOf("\n",b);a=a.substring(c+1);var d=a.lastIndexOf("</pre>");return-1===d&&r("Found opening <pre> but no closing </pre>"),c=a.lastIndexOf("\n",d),a=a.substring(0,c),a.trim()},D.prototype.canIgnoreThisLine=function(a){return""===a},D.prototype.isCourseHeaderLine=function(a){return 2===f(a).length},D.prototype.parseCourseHeaderLine=function(a){var b=f(a);if(2!==b.length)throw new Error("Course header line should have two parts");var c=b[0],d=b[1],e=c.indexOf("("),g=e>-1?c.substring(0,e):c,h=j(d),i=k(d);return{name:g.trim(),distance:h,climb:i}},D.prototype.parseControlsLine=function(a){var b=a.lastIndexOf("</font>"),d=-1===b?a:a.substring(b+"</font>".length),e=c(d.trim());return l(e)},D.prototype.readCompetitorSplitDataLine=function(a){for(var b=0;b<this.precedingColumnCount;b+=1){var e=a.indexOf("</font>");a=a.substring(e+"</font>".length)}var f=c(d(a));return f},D.prototype.parseCompetitor=function(a,d){var e=f(a),g=f(d);if(null===this.precedingColumnCount){var h=e[1].trim();this.precedingColumnCount=h.match(/^\d*$/)?4:3}var i=b(e[0]),j=e[this.precedingColumnCount-2].trim(),k=e[this.precedingColumnCount-1].trim(),l=g[this.precedingColumnCount-2].trim(),o=this.readCompetitorSplitDataLine(a),p=this.readCompetitorSplitDataLine(d);o=o.map(v),m(o,p);var q=null;if(null!==j&&""!==j){for(var r=-1,s=0;s<this.precedingColumnCount;s+=1)r=a.indexOf("</font>",r+1);var t=a.substring(0,r+"</font>".length),u=t.replace(/<font[^>]*>(.*?)<\/font>/g,""),w=c(u);w.length>0&&(q=w[0])}return new n(j,l,q,k,o,i)};var E=function(){this.currentCourseHasClass=!1};E.prototype.isTextOfThisFormat=function(a){for(var b=-1,c=0;5>c;c+=1)if(b=a.indexOf("<table",b+1),-1===b)return!1;return!0},E.prototype.preprocess=function(a){var b=a.indexOf("</table>");-1===b&&r("Could not find any closing </table> tags"),a=a.substring(b+"</table>".length);var c=a.indexOf("</div>"),d=a.indexOf("<table");return c>-1&&d>c&&(a=a.substring(c+"</div>".length)),a=a.replace(/>\n</g,"><").replace(/><tr>/g,">\n<tr>").replace(/<\/tr></g,"</tr>\n<").replace(/><table/g,">\n<table").replace(/<\/table></g,"</table>\n<"),a=a.replace(/<\/col[^>]*>/g,""),a=a.replace(/<tr[^>]*><td[^>]*>(?:<nobr>)?&nbsp;?(?:<\/nobr>)?<\/td><\/tr>/g,""),a=a.replace("</body></html>",""),a.trim()},E.prototype.canIgnoreThisLine=function(a){if(a.indexOf("<th>")>-1){var b=i(a);return this.currentCourseHasClass=5===b.length,!0}return""===a||a.indexOf("<table")>-1||a.indexOf("</table>")>-1},E.prototype.isCourseHeaderLine=function(a){return a.indexOf('<td id="header"')>-1},E.prototype.parseCourseHeaderLine=function(a){var b=h(a);0===b.length&&r("No parts found in course header line");var c=b[0],d=c.indexOf("(");d>-1&&(c=c.substring(0,d)),c=c.trim();for(var e=null,f=null,g=1;g<b.length;g+=1)null===e&&(e=j(b[g])),null===f&&(f=k(b[g]));return{name:c,distance:e,climb:f}},E.prototype.parseControlsLine=function(a){var b=h(a);return l(b)},E.prototype.readCompetitorSplitDataLine=function(b){for(var c=g(b),d=this.currentCourseHasClass?5:4,e=c.length;e>0&&""===c[e-1];)e-=1;return c.slice(d,e).filter(a)},E.prototype.parseCompetitor=function(a,c){var d=g(a),e=g(c),f=b(d[0]),h=d[2],i=d[this.currentCourseHasClass?4:3],j=e[2],k=this.currentCourseHasClass&&""!==h?d[3]:null,l=this.readCompetitorSplitDataLine(a),o=this.readCompetitorSplitDataLine(c);l=l.map(v),m(l,o);var p=l.filter(q).length;return p!==o.length&&r("Cumulative and split times do not have the same length: "+p+" cumulative times, "+o.length+" split times"),new n(h,j,k,i,l,f)};var F=function(){this.usesClasses=!1};F.prototype.isTextOfThisFormat=function(a){var b=a.indexOf("<table");if(b>=0){var c=a.indexOf("<table",b+1);if(c>=0){var d=a.indexOf("<table",c+1);if(0>d)return!0}}return!1},F.prototype.preprocess=function(a){var b=a.indexOf("</table>");return-1===b&&r("Could not find any closing </table> tags"),a.indexOf('<td colspan="25">')>=0&&(this.usesClasses=!0),a=a.substring(b+"</table>".length),a=a.replace(/<tr[^>]*><td colspan=[^>]*>&nbsp;<\/td><\/tr>/g,""),a=a.replace("</body>","").replace("</html>",""),a.trim()},F.prototype.canIgnoreThisLine=function(a){return""===a||a.indexOf("<table")>-1||a.indexOf("</table>")>-1||a.indexOf("<hr>")>-1},F.prototype.isCourseHeaderLine=function(a){return a.indexOf('<tr class="clubName"')>-1},F.prototype.parseCourseHeaderLine=function(a){var b=h(a);0===b.length&&r("No parts found in course header line");var c,d,e,f=b[0],g=/^(.*?)\s+\((\d+)m,\s*(\d+)m\)$/.exec(f);return null===g?(c=f,d=null,e=null):(c=g[1],d=parseInt(g[2],10)/1e3,e=parseInt(g[3],10)),{name:c.trim(),distance:d,climb:e}},F.prototype.parseControlsLine=function(a){var b=h(a);return b.map(function(a){var b=a.indexOf("-");return-1===b?null:a.substring(b+1)})},F.prototype.readCompetitorSplitDataLine=function(b){for(var c=this.usesClasses?5:4,d=b.length;d>0&&""===b[d-1];)d-=1;for(var e=[],f=c;d>f;f+=2){var g=b[f];a(g)&&e.push(g)}return e},F.prototype.parseCompetitor=function(a,c){for(var d=g(a),e=g(c),f=b(d[0]),h=d[2],i=d[this.usesClasses?4:3],j=this.usesClasses&&""!==h?d[3]:null,k=e[2],l=this.usesClasses?5:4;l<d.length&&l<e.length;l+=2)""!==d[l]&&""===e[l]&&(e[l]="----");var o=this.readCompetitorSplitDataLine(d),p=this.readCompetitorSplitDataLine(e);return o=o.map(v),m(o,p),o.length!==p.length&&r("Cumulative and split times do not have the same length: "+o.length+" cumulative times, "+p.length+" split times"),new n(h,k,j,i,o,f)},o.prototype.addControls=function(a){this.controls=this.controls.concat(a)},o.prototype.hasAllControls=function(){return this.controls.length>0&&null===this.controls[this.controls.length-1]},o.prototype.addCompetitor=function(a){a.competitive||a.cumTimes.length!==this.controls.length-1||a.cumTimes.push(null),a.cumTimes.length===this.controls.length?this.competitors.push(a):r("Competitor '"+a.name+"' should have "+this.controls.length+" cumulative times, but has "+a.cumTimes.length+" times")},p.prototype.tryGetLine=function(){return this.linePos+1<this.lines.length?(this.linePos+=1,this.lines[this.linePos]):null},p.prototype.addCurrentCompetitorIfNecessary=function(){null!==this.currentCompetitor&&(this.currentCourse.addCompetitor(this.currentCompetitor),this.currentCompetitor=null)},p.prototype.addCurrentCompetitorAndCourseIfNecessary=function(){this.addCurrentCompetitorIfNecessary(),null!==this.currentCourse&&this.courses.push(this.currentCourse)},p.prototype.readCompetitorLines=function(a){var b=this.tryGetLine();null===b&&r("Hit end of input data unexpectedly while parsing competitor: first line was '"+a+"'");var c=this.recognizer.parseCompetitor(a,b);c.isContinuation()?null===this.currentCompetitor?r("First row of competitor data has no name nor time"):this.currentCompetitor.append(c):(this.addCurrentCompetitorIfNecessary(),this.currentCompetitor=c)},p.prototype.areClassesUniqueWithinCourses=function(){for(var a=d3.map(),b=0;b<this.courses.length;b+=1)for(var c=this.courses[b],d=0;d<c.competitors.length;d+=1){var e=c.competitors[d];if(a.has(e.className)){if(a.get(e.className)!==c.name)return!1}else a.set(e.className,c.name)}return!0},p.prototype.createOverallEventObject=function(){var a=this.areClassesUniqueWithinCourses(),b=[],c=[],d=this.courses.every(function(a){return a.competitors.every(function(a){return q(a.className)})});return this.courses.forEach(function(e){var f=d3.map();
e.competitors.forEach(function(b){var c=d&&a?b.className:e.name;f.has(c)?f.get(c).push(b):f.set(c,[b])});var g=[];f.keys().forEach(function(a){var b=e.controls.length-1,d=f.get(a),h=d.map(function(a,b){return a.toCompetitor(b+1)}),i=new x(a,b,h);g.push(i),c.push(i)},this);var h=new y(e.name,g,e.distance,e.climb,e.controls.slice(0,e.controls.length-1));b.push(h),g.forEach(function(a){a.setCourse(h)})},this),new z(c,b)},p.prototype.parse=function(a){for(this.lines=a.split("\n");;){var b=this.tryGetLine();if(null===b)break;if(this.recognizer.canIgnoreThisLine(b));else if(this.recognizer.isCourseHeaderLine(b)){this.addCurrentCompetitorAndCourseIfNecessary();var c=this.recognizer.parseCourseHeaderLine(b);this.currentCourse=new o(c.name,c.distance,c.climb)}else if(null===this.currentCourse);else if(this.currentCourse.hasAllControls())this.readCompetitorLines(b);else{var d=this.recognizer.parseControlsLine(b);this.currentCourse.addControls(d)}}this.addCurrentCompetitorAndCourseIfNecessary(),0===this.courses.length&&r("No competitor data was found");var e=this.createOverallEventObject();return e};var G=[D,E,F];SplitsBrowser.Input.Html={},SplitsBrowser.Input.Html.parseEventData=function(a){a=u(a);for(var b=0;b<G.length;b+=1){var c=G[b],d=new c;if(d.isTextOfThisFormat(a)){a=d.preprocess(a);var e=new p(d),f=e.parse(a);return f}}s("No HTML recognizers recognised this as HTML they could parse")}}(),function(){"use strict";function a(a){for(var b=a.length-1;b>=0&&""===a[b];)b-=1;a.splice(b+1,a.length-b-1)}function b(a){this.format=a,this.classes=d3.map(),this.delimiter=null,this.controlsTerminationOffset=null===a.finishTime?a.step:0}var c=SplitsBrowser.isNaNStrict,d=SplitsBrowser.throwInvalidData,e=SplitsBrowser.throwWrongFileFormat,f=SplitsBrowser.normaliseLineEndings,g=SplitsBrowser.parseTime,h=SplitsBrowser.parseCourseLength,i=SplitsBrowser.parseCourseClimb,j=SplitsBrowser.Model.Competitor.fromOriginalCumTimes,k=SplitsBrowser.Model.CourseClass,l=SplitsBrowser.Model.Course,m=SplitsBrowser.Model.Event,n={controlsOffset:38,step:3,name:3,club:5,courseName:7,startTime:8,length:null,climb:null,controlCount:null,placing:null,finishTime:null,allowMultipleCompetitorNames:!0},o=[",",";"],p=/^[A-Za-z0-9]+$/;b.prototype.determineDelimiter=function(b){for(var c=0;c<o.length;c+=1){var d=o[c],e=b.split(d);if(a(e),e.length>this.format.controlsOffset)return d}return null},b.prototype.adjustLinePartsForMultipleCompetitors=function(a){if(this.format.allowMultipleCompetitorNames)for(;a.length>this.format.name+1&&a[this.format.name+1].match(/^\s\S/);)a[this.format.name]+=","+a[this.format.name+1],a.splice(this.format.name+1,1)},b.prototype.checkControlCodesAlphaNumeric=function(b){var c=b.split(this.delimiter);a(c),this.adjustLinePartsForMultipleCompetitors(c,this.format);for(var d=this.format.controlsOffset;d+this.controlsTerminationOffset<c.length;d+=this.format.step)p.test(c[d])||e("Data appears not to be in an alternative CSV format - data in cell "+d+" of the first row ('"+c[d]+"') is not an number")},b.prototype.checkRowLength=function(a,b){if(null!==this.format.controlCount){var e=parseInt(a[this.format.controlCount],10);c(e)&&d("Control count '"+a[this.format.controlCount]+"' is not a valid number");var f=this.format.controlsOffset+e*this.format.step;a.length<f?d("Data in row "+b+" should have at least "+f+" parts (for "+e+" controls) but only has "+a.length):a.length>f&&a.splice(f,a.length-f)}},b.prototype.addCompetitorToCourse=function(a,b,c){if(this.classes.has(b)){var e=this.classes.get(b),f=a.getAllOriginalCumulativeTimes();f.length-1!==e.controls.length+1&&d("Competitor '"+a.name+"' has the wrong number of splits for course '"+b+"': "+"expected "+(e.controls.length+1)+", actual "+(f.length-1)),e.competitors.push(a)}else{for(var g=[],j=this.format.controlsOffset;j+this.controlsTerminationOffset<c.length;j+=this.format.step)g.push(c[j]);var k=null===this.format.length?null:h(c[this.format.length]),l=null===this.format.climb?null:i(c[this.format.climb]);this.classes.set(b,{length:k,climb:l,controls:g,competitors:[a]})}},b.prototype.readDataRow=function(b,c){var d=b.split(this.delimiter);if(a(d),this.adjustLinePartsForMultipleCompetitors(d),!(d.length<this.format.controlsOffset)){for(;0!==(d.length-this.format.controlsOffset)%this.format.step;)d.push("");this.checkRowLength(d,c);for(var e=d[this.format.name],f=d[this.format.club],h=d[this.format.courseName],i=g(d[this.format.startTime]),k=[0],l=this.format.controlsOffset+1;l<d.length;l+=this.format.step)k.push(g(d[l]));if(null!==this.format.finishTime){var m=g(d[this.format.finishTime]),n=null===i||null===m?null:m-i;k.push(n)}var o=this.classes.has(h)?this.classes.get(h).competitors.length+1:1,p=j(o,e,f,i,k);if(null!==this.format.placing&&p.completed()){var q=d[this.format.placing];q.match(/^\d*$/)||p.setNonCompetitive()}p.hasAnyTimes()||p.setNonStarter(),this.addCompetitorToCourse(p,h,d)}},b.prototype.createClassesAndCourses=function(){var a=[],b=d3.map();this.classes.entries().forEach(function(c){var d=c.key,e=c.value,f=new k(d,e.controls.length,e.competitors);a.push(f);var g=e.controls.join(",");b.has(g)?b.get(g).classes.push(f):b.set(g,{name:d,classes:[f],length:e.length,climb:e.climb,controls:e.controls})});var c=[];return b.values().forEach(function(a){var b=new l(a.name,a.classes,a.length,a.climb,a.controls);a.classes.forEach(function(a){a.setCourse(b)}),c.push(b)}),{classes:a,courses:c}},b.prototype.parseEventData=function(a){a=f(a);var b=a.split(/\n/);b.length<2&&e("Data appears not to be in an alternative CSV format - too few lines");var c=b[1];this.delimiter=this.determineDelimiter(c),null===this.delimiter&&e("Data appears not to be in an alternative CSV format - first data line has fewer than "+this.format.controlsOffset+" parts when separated by any recognised delimiter"),this.checkControlCodesAlphaNumeric(c);for(var d=1;d<b.length;d+=1)this.readDataRow(b[d],d);var g=this.createClassesAndCourses();return new m(g.classes,g.courses)},SplitsBrowser.Input.AlternativeCSV={parseTripleColumnEventData:function(a){var c=new b(n);return c.parseEventData(a)}}}(),function(){"use strict";function a(a){return"undefined"==typeof a}function b(a){var b;try{b=$.parseXML(a)}catch(c){i("XML data not well-formed")}return 0===$("> *",$(b)).length&&i("XML data not well-formed: "+a),b}function c(a){var b=$("> Given",a).text(),c=$("> Family",a).text();return""!==b||""!==c?""===b?c:""===c?b:b+" "+c:(i("Cannot read competitor's name"),void 0)}function d(a,b){var c=$("> *",a),d=c.prop("tagName");"ResultList"!==d&&j("Root element of XML document does not have expected name 'ResultList', got '"+d+"'"),b.checkVersion(c)}function e(a,b,d){var e=$(a),f=d.getCompetitorNameElement(e),g=c(f),h=d.readClubName(e),j=d.readDateOfBirth(e),k=r.exec(j),l=null===k?null:parseInt(k[0],10),n=$("> Person",e).attr("sex"),o=$("Result",e);0===o.length&&i("No result found for competitor '"+g+"'");var p=d.readStartTime(o),q=d.readTotalTime(o),s=$("> SplitTime",o).toArray(),t=s.filter(function(a){return!d.isAdditional($(a))}).map(function(a){return d.readSplitTime($(a))}),u=t.map(function(a){return a.code}),v=t.map(function(a){return a.time});v.splice(0,0,0),v.push(q);var w=m(b,g,h,p,v);null!==l&&w.setYearOfBirth(l),("M"===n||"F"===n)&&w.setGender(n);var x=d.getStatus(o);return x===d.StatusNonCompetitive?w.setNonCompetitive():x===d.StatusNonStarter?w.setNonStarter():x===d.StatusNonFinisher?w.setNonFinisher():x===d.StatusDisqualified?w.disqualify():x===d.StatusOverMaxTime&&w.setOverMaxTime(),{competitor:w,controls:u}}function f(a,b){var c=$(a),d={name:null,competitors:[],controls:[],course:null};d.course=b.readCourseFromClass(c,b);var f=b.readClassName(c);""===f&&i("Missing class name"),d.name=f;var g=$("> PersonResult",c);0===g.length&&i("Class '"+f+"' has no competitors");for(var h=0;h<g.length;h+=1){var j=e(g[h],h+1,b),k=j.competitor,l=j.controls;0===d.competitors.length&&(d.controls=l,null===d.course.numberOfControls&&(d.course.numberOfControls=d.controls.length));var m=k.getAllOriginalCumulativeTimes().length-2;m!==d.course.numberOfControls&&i("Unexpected number of controls for competitor '"+k.name+"' in class '"+f+"': expected "+d.course.numberOfControls+", actual "+m);for(var n=0;m>n;n+=1)d.controls[n]!==l[n]&&i("Unexpected control code for competitor '"+k.name+"' at control "+(n+1)+": expected '"+d.controls[n]+"', actual '"+l[n]+"'");d.competitors.push(k)}return null===d.course.id&&d.controls.length>0&&(d.course.id=d.controls.join(",")),d}function g(a){for(var b=0;b<v.length;b+=1){var c=v[b];if(c.isOfThisVersion(a))return c}j("Data apparently not of any recognised IOF XML format")}function h(a){var c=g(a),e=b(a);d(e,c);var h=$("> ResultList > ClassResult",$(e)).toArray();0===h.length&&i("No class result elements found");var j=[],k=[],l=d3.map();h.forEach(function(a){var b=f(a,c),d=new n(b.name,b.controls.length,b.competitors);j.push(d);var e=b.course,g=e.id+","+b.controls.join(",");null!==e.id&&l.has(g)?l.get(g).classes.push(d):(e.classes=[d],e.controls=b.controls,k.push(e),null!==e.id&&l.set(g,e))});var m=k.map(function(a){var b=new o(a.name,a.classes,a.length,a.climb,a.controls);return a.classes.forEach(function(a){a.setCourse(b)}),b});return new p(j,m)}var i=SplitsBrowser.throwInvalidData,j=SplitsBrowser.throwWrongFileFormat,k=SplitsBrowser.isNaNStrict,l=SplitsBrowser.parseTime,m=SplitsBrowser.Model.Competitor.fromOriginalCumTimes,n=SplitsBrowser.Model.CourseClass,o=SplitsBrowser.Model.Course,p=SplitsBrowser.Model.Event,q=3280,r=/^\d{4}/,s={};s.isOfThisVersion=function(a){return a.indexOf("IOFdata.dtd")>=0},s.checkVersion=function(b){var c=$("> IOFVersion",b);if(0===c.length)j("Could not find IOFVersion element");else{var d=c.attr("version");a(d)?j("Version attribute missing from IOFVersion element"):"2.0.3"!==d&&j("Found unrecognised IOF XML data format '"+d+"'")}var e=b.attr("status");a(e)||"complete"===e.toLowerCase()||i("Only complete IOF data supported; snapshot and delta are not supported")},s.readClassName=function(a){return $("> ClassShortName",a).text()},s.readCourseFromClass=function(b){var c=$("> ClassShortName",b).text(),d=$("> PersonResult > Result",b).first(),e=null;if(d.length>0){var f=$("> CourseLength",d),g=f.text();if(g.length>0)if(e=parseFloat(g),isFinite(e)){var h=f.attr("unit");a(h)||"m"===h?e/=1e3:"km"===h||("ft"===h?e/=q:i("Unrecognised course-length unit: '"+h+"'"))}else i("Invalid course length: '"+g+"'")}return{id:null,name:c,length:e,climb:null,numberOfControls:null}},s.getCompetitorNameElement=function(a){return $("> Person > PersonName",a)},s.readClubName=function(a){return $("> Club > ShortName",a).text()},s.readDateOfBirth=function(a){return $("> Person > BirthDate > Date",a).text()},s.readStartTime=function(a){var b=$("> StartTime > Clock",a).text(),c=""===b?null:l(b);return c},s.readTotalTime=function(a){var b=$("> Time",a).text(),c=""===b?null:l(b);return c},s.getStatus=function(a){var b=$("> CompetitorStatus",a);return 1===b.length?b.attr("value"):""},s.StatusNonCompetitive="NotCompeting",s.StatusNonStarter="DidNotStart",s.StatusNonFinisher="DidNotFinish",s.StatusDisqualified="Disqualified",s.StatusOverMaxTime="OverTime",s.isAdditional=function(){return!1},s.readSplitTime=function(a){var b=$("> ControlCode",a).text();""===b&&(b=$("> Control > ControlCode",a).text()),""===b&&i("Control code missing for control");var c=$("> Time",a).text(),d=""===c?null:l(c);return{code:b,time:d}};var t=/^\d\d\d\d-?\d\d-?\d\dT?(\d\d):?(\d\d)(?::?(\d\d))?/,u={};u.isOfThisVersion=function(a){return a.indexOf("http://www.orienteering.org/datastandard/3.0")>=0},u.checkVersion=function(b){var c=b.attr("iofVersion");a(c)?j("Could not find IOF version number"):"3.0"!==c&&j("Found unrecognised IOF XML data format '"+c+"'");var d=b.attr("status");a(d)||"complete"===d.toLowerCase()||i("Only complete IOF data supported; snapshot and delta are not supported")},u.readClassName=function(a){return $("> Class > Name",a).text()},u.readCourseFromClass=function(a){var b,c=$("> Course",a),d=$("> Id",c).text()||null,e=$("> Name",c).text(),f=$("> Length",c).text();""===f?b=null:(b=parseInt(f,10),k(b)?i("Unrecognised course length: '"+f+"'"):b/=1e3);var g=$("> NumberOfControls",c).text(),h=parseInt(g,10);k(h)&&(h=null);var j=$("> Climb",c).text(),l=parseInt(j,10);return k(l)&&(l=null),{id:d,name:e,length:b,climb:l,numberOfControls:h}},u.getCompetitorNameElement=function(a){return $("> Person > Name",a)},u.readClubName=function(a){return $("> Organisation > ShortName",a).text()},u.readDateOfBirth=function(a){var b=$("> Person > BirthDate",a).text(),c=r.exec(b);return null===c?null:parseInt(c[0],10)},u.readStartTime=function(b){var c=$("> StartTime",b).text(),d=t.exec(c);if(null===d)return null;var e=parseInt(d[1],10),f=parseInt(d[2],10),g=a(d[3])?0:parseInt(d[3],10);return 60*60*e+60*f+g},u.readTime=function(a){var b=parseFloat(a);return isFinite(b)?b:null},u.readTotalTime=function(a){var b=$("> Time",a).text();return u.readTime(b)},u.getStatus=function(a){return $("> Status",a).text()},u.StatusNonCompetitive="NotCompeting",u.StatusNonStarter="DidNotStart",u.StatusNonFinisher="DidNotFinish",u.StatusDisqualified="Disqualified",u.StatusOverMaxTime="OverTime",u.isAdditional=function(a){return"Additional"===a.attr("status")},u.readSplitTime=function(a){var b=$("> ControlCode",a).text();""===b&&i("Control code missing for control");var c;if("Missing"===a.attr("status"))c=null;else{var d=$("> Time",a).text();c=""===d?null:u.readTime(d)}return{code:b,time:c}};var v=[s,u];SplitsBrowser.Input.IOFXml={parseEventData:h}}(),function(){"use strict";var a=[SplitsBrowser.Input.CSV.parseEventData,SplitsBrowser.Input.OE.parseEventData,SplitsBrowser.Input.Html.parseEventData,SplitsBrowser.Input.AlternativeCSV.parseTripleColumnEventData,SplitsBrowser.Input.IOFXml.parseEventData];SplitsBrowser.Input.parseEventData=function(b){for(var c=0;c<a.length;c+=1){var d=a[c];try{return d(b)}catch(e){if("WrongFileFormat"!==e.name)throw e}}return null}}();