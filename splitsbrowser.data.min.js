/*!
 *  SplitsBrowser - Orienteering results analysis.
 *  
 *  Copyright (C) 2000-2018 Dave Ryder, Reinhard Balling, Andris Strazdins,
 *                          Ed Nash, Luke Woodward
 *
 *  This program is free software; you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation; either version 2 of the License, or
 *  (at your option) any later version.
 *
 *  This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License along
 *  with this program; if not, write to the Free Software Foundation, Inc.,
 *  51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
 */

var SplitsBrowser={Version:"3.4.4",Model:{},Input:{},Controls:{},Messages:{}};!function(){"use strict";function e(t){this.name="InvalidData",this.message=t}function n(t){this.name="WrongFileFormat",this.message=t}SplitsBrowser.isTrue=function(t){return t},SplitsBrowser.isNotNull=function(t){return null!==t},SplitsBrowser.isNaNStrict=function(t){return t!=t},SplitsBrowser.isNotNullNorNaN=function(t){return null!==t&&t==t},e.prototype.toString=function(){return this.name+": "+this.message},SplitsBrowser.throwInvalidData=function(t){throw new e(t)},n.prototype.toString=function(){return this.name+": "+this.message},SplitsBrowser.throwWrongFileFormat=function(t){throw new n(t)},SplitsBrowser.parseCourseLength=function(t){var e=parseFloat(t.replace(",","."));return isFinite(e)?(500<=e&&(e/=1e3),e):null},SplitsBrowser.parseCourseClimb=function(t){var e=parseInt(t,10);return SplitsBrowser.isNaNStrict(e)?null:e},SplitsBrowser.normaliseLineEndings=function(t){return t.replace(/\r\n/g,"\n").replace(/\r/g,"\n")}}(),function(){"use strict";SplitsBrowser.NULL_TIME_PLACEHOLDER="-----";var o=SplitsBrowser.isNaNStrict;SplitsBrowser.formatTime=function(t,e){if(null===t)return SplitsBrowser.NULL_TIME_PLACEHOLDER;if(o(t))return"???";var n="";t<0&&(n="-",t=-t);var r=Math.floor(t/3600),s=Math.floor(t/60)%60,i=t%60;return 0<r&&(n+=r.toString()+":"),s<10&&(n+="0"),n+=s+":",i<10&&(n+="0"),n+="number"==typeof e?i.toFixed(e):Math.round(100*i)/100},SplitsBrowser.parseTime=function(t){if(t=t.trim(),/^(\d+:)?\d+:\d\d([,.]\d+)?$/.test(t)){var e=t.replace(",",".").split(":"),n=0;return e.forEach(function(t){n=60*n+parseFloat(t)}),n}return null}}(),function(){"use strict";var t=SplitsBrowser.isNotNull,s=SplitsBrowser.isNaNStrict,o=SplitsBrowser.throwInvalidData;function r(t,e){return null===t||null===e?null:t-e}function i(t){if(!$.isArray(t))throw new TypeError("Cumulative times must be an array - got "+typeof t+" instead");0===t.length?o("Array of cumulative times must not be empty"):0!==t[0]?o("Array of cumulative times must have zero as its first item"):1===t.length&&o("Array of cumulative times must contain more than just a single zero");for(var e=[],n=0;n+1<t.length;n+=1)e.push(r(t[n+1],t[n]));return e}function a(t,e,n,r,s,i){"number"!=typeof t&&o("Competitor order must be a number, got "+typeof t+" '"+t+"' instead"),this.order=t,this.name=e,this.club=n,this.startTime=r,this.isNonCompetitive=!1,this.isNonStarter=!1,this.isNonFinisher=!1,this.isDisqualified=!1,this.isOverMaxTime=!1,this.className=null,this.yearOfBirth=null,this.gender=null,this.originalSplitTimes=s,this.originalCumTimes=i,this.splitTimes=null,this.cumTimes=null,this.splitRanks=null,this.cumRanks=null,this.timeLosses=null,this.totalTime=null===i||-1<i.indexOf(null)?null:i[i.length-1]}function e(t){for(var e=[],n=1;n+1<t.length;)if(s(t[n])){for(var r=n;r+1<t.length&&s(t[r+1]);)r+=1;r+1<t.length&&null!==t[n-1]&&null!==t[r+1]&&e.push({start:n-1,end:r+1}),n=r+1}else n+=1;return e}SplitsBrowser.Model.compareCompetitors=function(t,e){return t.isDisqualified!==e.isDisqualified?t.isDisqualified?1:-1:t.totalTime===e.totalTime?t.order-e.order:null===t.totalTime?null===e.totalTime?0:1:null===e.totalTime?-1:t.totalTime-e.totalTime},a.prototype.setNonCompetitive=function(){this.isNonCompetitive=!0},a.prototype.setNonStarter=function(){this.isNonStarter=!0},a.prototype.setNonFinisher=function(){this.isNonFinisher=!0},a.prototype.disqualify=function(){this.isDisqualified=!0},a.prototype.setOverMaxTime=function(){this.isOverMaxTime=!0},a.prototype.setClassName=function(t){this.className=t},a.prototype.setYearOfBirth=function(t){this.yearOfBirth=t},a.prototype.setGender=function(t){this.gender=t},a.fromOriginalCumTimes=function(t,e,n,r,s){return new a(t,e,n,r,i(s),s)},a.fromCumTimes=function(t,e,n,r,s){var i=a.fromOriginalCumTimes(t,e,n,r,s);return i.splitTimes=i.originalSplitTimes,i.cumTimes=i.originalCumTimes,i},a.prototype.setRepairedCumulativeTimes=function(t){this.cumTimes=t,this.splitTimes=i(t)},a.prototype.completed=function(){return null!==this.totalTime&&!this.isDisqualified&&!this.isOverMaxTime},a.prototype.hasAnyTimes=function(){return this.originalCumTimes.slice(1).some(t)},a.prototype.getSplitTimeTo=function(t){return 0===t?0:this.splitTimes[t-1]},a.prototype.getOriginalSplitTimeTo=function(t){return this.isNonStarter?null:0===t?0:this.originalSplitTimes[t-1]},a.prototype.isSplitTimeDubious=function(t){return 0<t&&this.originalSplitTimes[t-1]!==this.splitTimes[t-1]},a.prototype.getCumulativeTimeTo=function(t){return this.cumTimes[t]},a.prototype.getOriginalCumulativeTimeTo=function(t){return this.isNonStarter?null:this.originalCumTimes[t]},a.prototype.isCumulativeTimeDubious=function(t){return this.originalCumTimes[t]!==this.cumTimes[t]},a.prototype.getSplitRankTo=function(t){return null===this.splitRanks||0===t?null:this.splitRanks[t-1]},a.prototype.getCumulativeRankTo=function(t){return null===this.cumRanks||0===t?null:this.cumRanks[t-1]},a.prototype.getTimeLossAt=function(t){return 0===t||null===this.timeLosses?null:this.timeLosses[t-1]},a.prototype.getAllCumulativeTimes=function(){return this.cumTimes},a.prototype.getAllOriginalCumulativeTimes=function(){return this.originalCumTimes},a.prototype.lacksStartTime=function(){return null===this.startTime&&this.splitTimes.some(t)},a.prototype.setSplitAndCumulativeRanks=function(t,e){this.splitRanks=t,this.cumRanks=e},a.prototype.getCumTimesAdjustedToReference=function(n){return n.length!==this.cumTimes.length?o("Cannot adjust competitor times because the numbers of times are different ("+this.cumTimes.length+" and "+n.length+")"):-1<n.indexOf(null)&&o("Cannot adjust competitor times because a null value is in the reference data"),this.cumTimes.map(function(t,e){return r(t,n[e])})},a.prototype.getCumTimesAdjustedToReferenceWithStartAdded=function(t){var e=this.getCumTimesAdjustedToReference(t),n=this.startTime;return e.map(function(t){return function(t,e){return null===t||null===e?null:t+e}(t,n)})},a.prototype.getSplitPercentsBehindReferenceCumTimes=function(r){r.length!==this.cumTimes.length?o("Cannot determine percentages-behind because the numbers of times are different ("+this.cumTimes.length+" and "+r.length+")"):-1<r.indexOf(null)&&o("Cannot determine percentages-behind because a null value is in the reference data");var s=[0];return this.splitTimes.forEach(function(t,e){if(null===t)s.push(null);else{var n=r[e+1]-r[e];0<n?s.push(100*(t-n)/n):s.push(null)}}),s},a.prototype.determineTimeLosses=function(n){if(this.completed())if(n.length!==this.splitTimes.length?o("Cannot determine time loss of competitor with "+this.splitTimes.length+" split times using "+n.length+" fastest splits"):n.some(s)&&o("Cannot determine time loss of competitor when there is a NaN value in the fastest splits"),n.some(function(t){return 0===t}))this.timeLosses=this.splitTimes.map(function(){return NaN});else if(this.splitTimes.some(s))this.timeLosses=this.splitTimes.map(function(){return NaN});else{var r,t=this.splitTimes.map(function(t,e){return t/n[e]});if(t.sort(d3.ascending),t.length%2==1)r=t[(t.length-1)/2];else{var e=t.length/2;r=(t[e-1]+t[e])/2}this.timeLosses=this.splitTimes.map(function(t,e){return Math.round(t-n[e]*r)})}},a.prototype.crosses=function(t){t.cumTimes.length!==this.cumTimes.length&&o("Two competitors with different numbers of controls cannot cross");for(var e=!1,n=!1,r=0;r<this.cumTimes.length;r+=1)if(null!==this.cumTimes[r]&&null!==t.cumTimes[r]){var s=this.startTime+this.cumTimes[r],i=t.startTime+t.cumTimes[r];s<i?e=!0:i<s&&(n=!0)}return e&&n},a.prototype.getControlIndexesAroundDubiousCumulativeTimes=function(){return e(this.cumTimes)},a.prototype.getControlIndexesAroundDubiousSplitTimes=function(){return e([0].concat(this.splitTimes))},SplitsBrowser.Model.Competitor=a}(),function(){"use strict";var i=SplitsBrowser.isNotNullNorNaN,t=SplitsBrowser.throwInvalidData;function e(e,t,n){this.name=e,this.numControls=t,this.competitors=n,this.course=null,this.hasDubiousData=!1,this.competitors.forEach(function(t){t.setClassName(e)})}e.prototype.recordHasDubiousData=function(){this.hasDubiousData=!0},e.prototype.determineTimeLosses=function(){var e=d3.range(1,this.numControls+2).map(function(t){var e=this.getFastestSplitTo(t);return null===e?null:e.split},this);this.competitors.forEach(function(t){t.determineTimeLosses(e)})},e.prototype.isEmpty=function(){return 0===this.competitors.length},e.prototype.setCourse=function(t){this.course=t},e.prototype.getFastestSplitTo=function(n){("number"!=typeof n||n<1||n>this.numControls+1)&&t("Cannot return splits to leg '"+n+"' in a course with "+this.numControls+" control(s)");var r=null,s=null;return this.competitors.forEach(function(t){var e=t.getSplitTimeTo(n);i(e)&&(null===r||e<r)&&(r=e,s=t)}),null===r?null:{split:r,name:s.name}},e.prototype.getCompetitorsAtControlInTimeRange=function(r,s,i){("number"!=typeof r||isNaN(r)||r<0||r>this.numControls+1)&&t("Control number must be a number between 0 and "+this.numControls+" inclusive");var o=[];return this.competitors.forEach(function(t){var e=t.getCumulativeTimeTo(r);if(null!==e&&null!==t.startTime){var n=e+t.startTime;s<=n&&n<=i&&o.push({name:t.name,time:n})}}),o},SplitsBrowser.Model.CourseClass=e}(),function(){"use strict";var i=SplitsBrowser.throwInvalidData;function t(t,e,n,r,s){this.name=t,this.classes=e,this.length=n,this.climb=r,this.controls=s}var a=t.START="__START__",l=t.FINISH="__FINISH__";t.prototype.getOtherClasses=function(e){var t=this.classes.filter(function(t){return t!==e});if(t.length!==this.classes.length)return t;i("Course.getOtherClasses: given class is not in this course")},t.prototype.getNumClasses=function(){return this.classes.length},t.prototype.hasControls=function(){return null!==this.controls},t.prototype.getControlCode=function(t){return 0===t?a:1<=t&&t<=this.controls.length?this.controls[t-1]:t===this.controls.length+1?l:void i("Cannot get control code of control "+t+" because it is out of range")},t.prototype.usesLeg=function(t,e){return 0<=this.getLegNumber(t,e)},t.prototype.getLegNumber=function(t,e){if(null===this.controls)return-1;if(t===a&&e===l)return 0===this.controls.length?1:-1;if(t===a)return 0<this.controls.length&&this.controls[0]===e?1:-1;if(e===l)return 0<this.controls.length&&this.controls[this.controls.length-1]===t?this.controls.length+1:-1;for(var n=1;n<this.controls.length;n+=1)if(this.controls[n-1]===t&&this.controls[n]===e)return n+1;return-1},t.prototype.getFastestSplitsForLeg=function(t,e){null===this.legs&&i("Cannot determine fastest splits for a leg because leg information is not available");var n=this.getLegNumber(t,e);n<0&&i("Leg from "+((t===a?"start":t)+" to "+(e===l?"end":e))+" not found in course "+this.name);var r=n,s=[];return this.classes.forEach(function(t){var e=t.getFastestSplitTo(r);null!==e&&s.push({name:e.name,className:t.name,split:e.split})}),s},t.prototype.getCompetitorsAtControlInTimeRange=function(t,e,n){if(null===this.controls)return[];if(t===a)return this.getCompetitorsAtControlNumInTimeRange(0,e,n);if(t===l)return this.getCompetitorsAtControlNumInTimeRange(this.controls.length+1,e,n);for(var r=-1,s=[],i=function(t){s.push(t)};;){var o=this.controls.indexOf(t,r+1);if(o<0)return s;this.getCompetitorsAtControlNumInTimeRange(o+1,e,n).forEach(i),r=o}},t.prototype.getCompetitorsAtControlNumInTimeRange=function(t,n,r){var s=[];return this.classes.forEach(function(e){e.getCompetitorsAtControlInTimeRange(t,n,r).forEach(function(t){s.push({name:t.name,time:t.time,className:e.name})})}),s},t.prototype.hasControl=function(t){return null!==this.controls&&-1<this.controls.indexOf(t)},t.prototype.getNextControls=function(t){if(null===this.controls)i("Course has no controls");else if(t===l)i("Cannot fetch next control after the finish");else{if(t===a)return[0===this.controls.length?l:this.controls[0]];for(var e=-1,n=[];;){var r=this.controls.indexOf(t,e+1);if(-1===r)break;r===this.controls.length-1?n.push(l):n.push(this.controls[r+1]),e=r}if(0!==n.length)return n;i("Control '"+t+"' not found on course "+this.name)}},SplitsBrowser.Model.Course=t}(),function(){"use strict";var n=SplitsBrowser.Model.Course;function t(t,e,n){this.classes=t,this.courses=e,this.warnings=n}t.prototype.determineTimeLosses=function(){this.classes.forEach(function(t){t.determineTimeLosses()})},t.prototype.needsRepair=function(){return this.classes.some(function(t){return t.competitors.some(function(t){return null===t.getAllCumulativeTimes()})})},t.prototype.getFastestSplitsForLeg=function(e,n){var r=[];return this.courses.forEach(function(t){t.usesLeg(e,n)&&(r=r.concat(t.getFastestSplitsForLeg(e,n)))}),r.sort(function(t,e){return d3.ascending(t.split,e.split)}),r},t.prototype.getCompetitorsAtControlInTimeRange=function(e,n,r){var s=[];return this.courses.forEach(function(t){t.getCompetitorsAtControlInTimeRange(e,n,r).forEach(function(t){s.push(t)})}),s.sort(function(t,e){return d3.ascending(t.time,e.time)}),s},t.prototype.getNextControlsAfter=function(e){var t=this.courses;return e!==n.START&&(t=t.filter(function(t){return t.hasControl(e)})),t.map(function(t){return{course:t,nextControls:t.getNextControls(e)}})},SplitsBrowser.Model.Event=t}(),function(){"use strict";var l=SplitsBrowser.isTrue,u=SplitsBrowser.isNotNull,c=SplitsBrowser.throwInvalidData,m=SplitsBrowser.throwWrongFileFormat,o=SplitsBrowser.normaliseLineEndings,g=SplitsBrowser.parseTime,C=SplitsBrowser.Model.Competitor,h=SplitsBrowser.Model.compareCompetitors,p=SplitsBrowser.Model.CourseClass,a=SplitsBrowser.Model.Course,f=SplitsBrowser.Model.Event;function d(t,n){var e=t.split(/\r?\n/).filter(l);0===e.length&&c("parseCourseClass got an empty list of lines");var r=e.shift().split(",");if(2===r.length){var s=r.shift(),i=r.shift(),o=parseInt(i,10);if(isNaN(o))c("Could not read control count: '"+i+"'");else{if(!(o<0&&0<e.length)){var a=e.map(function(t,e){return function(t,e,n,r,s){for(var i=e.split(",");i.length>n+5&&i[3].match(/[^0-9.,:-]/);)i[2]+=","+i[3],i.splice(3,1);var o=i.length,a=((i.shift()||"")+" "+(i.shift()||"")).trim()||"<name unknown>";if(o===n+5){var l=i.shift(),u=i.shift(),c=g(u);0===c?c=null:u.match(/^\d+:\d\d:\d\d$/)||(c*=60);var m=[0],h=0;i.map(function(t){var e=g(t);null!==e&&0<e?(h+=e,m.push(h)):m.push(null)});var p=C.fromCumTimes(t+1,a,l,c,m);return 0===h&&p.setNonStarter(),p}var f=o-(n+5),d=f<0?-f+" too few":f+" too many";return s.push("Competitor '"+a+"' appears to have the wrong number of split times - "+d+" (row "+(t+1)+" of class '"+r+"')"),null}(e,t,o,s,n)}).filter(u);return a.sort(h),new p(s,o,a)}c("Expected a non-negative control count, got "+o+" instead")}}else m("Expected first line to have two parts (class name and number of controls), got "+r.length+" part(s) instead")}SplitsBrowser.Input.CSV={parseEventData:function(t){/<html/i.test(t)&&m("Cannot parse this file as CSV as it appears to be HTML");var e=(t=(t=o(t)).replace(/,+\n/g,"\n").replace(/,+$/,"")).split(/\n\n/).map(function(t){return t.trim()}).filter(l),n=[],r=e.map(function(t){return d(t,n)});0===(r=r.filter(function(t){return!t.isEmpty()})).length&&c("No competitor data was found");for(var s=r.map(function(t){return new a(t.name,[t],null,null,null)}),i=0;i<r.length;i+=1)r[i].setCourse(s[i]);return new f(r,s,n)}}}(),function(){"use strict";var o=SplitsBrowser.throwInvalidData,s=SplitsBrowser.throwWrongFileFormat,f=SplitsBrowser.isNaNStrict,i=SplitsBrowser.parseCourseLength,a=SplitsBrowser.parseCourseClimb,e=SplitsBrowser.normaliseLineEndings,m=SplitsBrowser.parseTime,d=SplitsBrowser.Model.Competitor.fromOriginalCumTimes,n=SplitsBrowser.Model.CourseClass,C=SplitsBrowser.Model.Course,r=SplitsBrowser.Model.Event,l=[";",",","\t","\\"],u={};[44,46,60].forEach(function(t){u[t]={course:t-7,distance:t-6,climb:t-5,controlCount:t-4,placing:t-3,startPunch:t-2,finish:t-1,control1:t}}),[44,46].forEach(function(t){u[t].nonCompetitive=t-38,u[t].startTime=t-37,u[t].time=t-35,u[t].classifier=t-34,u[t].club=t-31,u[t].className=t-28}),u[44].combinedName=3,u[44].yearOfBirth=4,u[46].forename=4,u[46].surname=3,u[46].yearOfBirth=5,u[46].gender=6,u[60].forename=6,u[60].surname=5,u[60].yearOfBirth=7,u[60].gender=8,u[60].combinedName=3,u[60].nonCompetitive=10,u[60].startTime=11,u[60].time=13,u[60].classifier=14,u[60].club=20,u[60].className=26,u[60].classNameFallback=u[60].course,u[60].clubFallback=18;function c(t){return'"'===t[0]&&'"'===t[t.length-1]&&(t=t.substring(1,t.length-1).replace(/""/g,'"').trim()),t}function h(t){this.data=e(t),this.classes=d3.map(),this.courseDetails=d3.map(),this.classCoursePairs=[],this.columnIndexes=null,this.warnings=[]}h.prototype.identifyDelimiter=function(){this.lines.length<=1&&s("No data found to read");for(var t=this.lines[1],e=0;e<l.length;e+=1){var n=l[e];if(37<t.split(n).length)return n}s("Data appears not to be in the OE CSV format")},h.prototype.identifyFormatVariation=function(t){var e=this.lines[1].split(t),n=/^[A-Za-z0-9]+$/;for(var r in u){if(u.hasOwnProperty(r))if((r=parseInt(r,10))<e.length&&n.test(e[r])&&(""===e[r-2].trim()||null!==m(e[r-2]))&&(""===e[r-1].trim()||null!==m(e[r-1])))if(""!==e[u[r].controlCount].trim())return void(this.columnIndexes=u[r])}s("Did not find control 1 at any of the supported indexes")},h.prototype.getClassName=function(t){var e=t[this.columnIndexes.className];return""===e&&this.columnIndexes.hasOwnProperty("classNameFallback")&&(e=t[this.columnIndexes.classNameFallback]),e},h.prototype.getStartTime=function(t){var e=t[this.columnIndexes.startPunch];return""===e&&(e=t[this.columnIndexes.startTime]),m(e)},h.prototype.getNumControls=function(t,e){var n,r=this.getClassName(t);if(""===r.trim())return n=this.getName(t)||"<name unknown>",this.warnings.push("Could not find a class for competitor '"+n+"' (line "+e+")"),null;if(this.classes.has(r))return this.classes.get(r).numControls;var s=parseInt(t[this.columnIndexes.controlCount],10);return isFinite(s)?s:(n=this.getName(t)||"<name unknown>",this.warnings.push("Could not read the control count '"+t[this.columnIndexes.controlCount]+"' for competitor '"+n+"' from line "+e),null)},h.prototype.readCumulativeTimes=function(t,e,n){for(var r=[0],s=0;s<n;s+=1){var i=this.columnIndexes.control1+1+2*s,o=i<t.length?t[i]:null,a=null===o?null:m(o);r.push(a)}var l=m(t[this.columnIndexes.time]);if(null===l){var u=this.getStartTime(t),c=m(t[this.columnIndexes.finish]);null!==u&&null!==c&&(l=c-u)}return r.push(l),r},h.prototype.createClassIfNecessary=function(t,e){var n=this.getClassName(t);this.classes.has(n)||this.classes.set(n,{numControls:e,competitors:[]})},h.prototype.createCourseIfNecessary=function(e,t){var n=e[this.columnIndexes.course];if(!this.courseDetails.has(n)){var r=d3.range(0,t).map(function(t){return e[this.columnIndexes.control1+2*t]},this);this.courseDetails.set(n,{length:i(e[this.columnIndexes.distance]),climb:a(e[this.columnIndexes.climb]),controls:r})}},h.prototype.createClassCoursePairIfNecessary=function(t){var e=this.getClassName(t),n=t[this.columnIndexes.course];this.classCoursePairs.some(function(t){return t[0]===e&&t[1]===n})||this.classCoursePairs.push([e,n])},h.prototype.getName=function(t){var e="";this.columnIndexes.hasOwnProperty("forename")&&this.columnIndexes.hasOwnProperty("surname")&&(e=(t[this.columnIndexes.forename]+" "+t[this.columnIndexes.surname]).trim());return""===e&&this.columnIndexes.hasOwnProperty("combinedName")&&(e=t[this.columnIndexes.combinedName]),e},h.prototype.addCompetitor=function(t,e){var n=this.getClassName(t),r=t[this.columnIndexes.placing],s=t[this.columnIndexes.club];""===s&&this.columnIndexes.hasOwnProperty("clubFallback")&&(s=t[this.columnIndexes.clubFallback]);var i=this.getStartTime(t),o=this.getName(t),a=""!==r&&f(parseInt(r,10));a&&o.substring(o.length-r.length)===r&&(o=o.substring(0,o.length-r.length).trim());var l=this.classes.get(n).competitors.length+1,u=d(l,o,s,i,e);("1"===t[this.columnIndexes.nonCompetitive]||a)&&u.completed()&&u.setNonCompetitive();var c=t[this.columnIndexes.classifier];""!==c&&"0"!==c?"1"===c?u.setNonStarter():"2"===c?u.setNonFinisher():"4"===c?u.disqualify():"5"===c&&u.setOverMaxTime():u.hasAnyTimes()||u.setNonStarter();var m=t[this.columnIndexes.yearOfBirth];if(""!==m){var h=parseInt(m,10);f(h)||u.setYearOfBirth(h)}if(this.columnIndexes.hasOwnProperty("gender")){var p=t[this.columnIndexes.gender];"M"!==p&&"F"!==p||u.setGender(p)}this.classes.get(n).competitors.push(u)},h.prototype.readLine=function(t,e,n){if(""!==t.trim()){var r=t.split(n).map(function(t){return t.trim()}).map(c);r.length<37&&o("Too few items on line "+e+" of the input file: expected at least 37, got "+r.length);var s=this.getNumControls(r,e);if(null!==s){var i=this.readCumulativeTimes(r,e,s);this.createClassIfNecessary(r,s),this.createCourseIfNecessary(r,s),this.createClassCoursePairIfNecessary(r),this.addCompetitor(r,i)}}},h.prototype.getMapsBetweenClassesAndCourses=function(){var r=d3.map(),s=d3.map();return this.classCoursePairs.forEach(function(t){var e=t[0],n=t[1];r.has(e)?r.get(e).push(n):r.set(e,[n]),s.has(n)?s.get(n).push(e):s.set(n,[e])}),{classesToCourses:r,coursesToClasses:s}},h.prototype.createClasses=function(){var t=this.classes.keys();return t.sort(),t.map(function(t){var e=this.classes.get(t);return new n(t,e.numControls,e.competitors)},this)},h.prototype.createCourseFromLinkedClassesAndCourses=function(t,e,n,r){for(var s,i,o=[t],a=[],l=[],u=[];0<o.length||0<a.length;){for(;0<o.length;){s=o.shift();for(var c=e.coursesToClasses.get(s),m=0;m<c.length;m+=1)i=c[m],a.indexOf(i)<0&&u.indexOf(i)<0&&a.push(i);l.push(s)}for(;0<a.length;){i=a.shift();for(var h=e.classesToCourses.get(i),p=0;p<h.length;p+=1)s=h[p],o.indexOf(s)<0&&l.indexOf(s)<0&&o.push(s);u.push(i)}}l.forEach(function(t){n.add(t)});var f=u.map(function(t){return r.get(t)}),d=this.courseDetails.get(t),g=new C(t,f,d.length,d.climb,d.controls);return f.forEach(function(t){t.setCourse(g)}),g},h.prototype.determineCourses=function(t){var n=this.getMapsBetweenClassesAndCourses(),r=d3.set(),s=d3.map();t.forEach(function(t){s.set(t.name,t)});var i=[];return n.coursesToClasses.keys().forEach(function(t){if(!r.has(t)){var e=this.createCourseFromLinkedClassesAndCourses(t,n,r,s);i.push(e)}},this),i},h.prototype.parseEventData=function(){this.warnings=[],this.lines=this.data.split(/\n/);var n=this.identifyDelimiter();this.identifyFormatVariation(n),this.lines.shift(),this.lines.forEach(function(t,e){this.readLine(t,e+1,n)},this);var t=this.createClasses();0===t.length&&0<this.warnings.length&&s("This file may have looked vaguely like an OE CSV file but no data could be read out of it");var e=this.determineCourses(t);return new r(t,e,this.warnings)},SplitsBrowser.Input.OE={},SplitsBrowser.Input.OE.parseEventData=function(t){return new h(t).parseEventData()}}(),function(){"use strict";var p=SplitsBrowser.isNotNull,f=SplitsBrowser.throwInvalidData,r=SplitsBrowser.throwWrongFileFormat,n=SplitsBrowser.parseCourseLength,s=SplitsBrowser.normaliseLineEndings,d=SplitsBrowser.parseTime,i=SplitsBrowser.Model.Competitor.fromOriginalCumTimes,l=SplitsBrowser.Model.CourseClass,u=SplitsBrowser.Model.Course,e=SplitsBrowser.Model.Event,o=/<[^>]+>/g,a=/([0-9.,]+)\s*(?:Km|km)/,c=/(\d+)\s*(?:Cm|Hm|hm|m)/;function m(t){return null!==t&&""!==t}function g(t){return""!==(t=t.trim())&&isFinite(t)}function C(t){return t.split(/\s+/g).filter(m)}function h(t){return t.replace(o,"")}function v(t,e){for(var n,r=[];null!==(n=t.exec(e));)r.push(h(n[1]));return r}function T(t){return v(/<font[^>]*>(.*?)<\/font>/g,t)}function y(t){return v(/<td[^>]*>(.*?)<\/td>/g,t).map(function(t){return t.trim()})}function S(t){return y(t).filter(function(t){return""!==t})}function w(t){var e=a.exec(t);return null===e?null:n(e[1])}function N(t){var e=c.exec(t);return null===e?null:parseInt(e[1],10)}function b(t){for(var e=[],n=0;n<t.length;n+=1){var r=t[n],s=r.indexOf("(");if(-1<s&&")"===r[r.length-1]){var i=r.substring(s+1,r.length-1);e.push(i)}else n+1===t.length?e.push(null):f("Unrecognised control header label: '"+r+"'")}return e}function O(t,e){for(;0<e.length&&"*"===e[e.length-1][0];)e.splice(e.length-1,1),t.splice(t.length-1,1)}function x(t,e,n,r,s,i){this.name=t,this.club=e,this.className=n,this.totalTime=r,this.cumTimes=s,this.competitive=i}x.prototype.isContinuation=function(){return""===this.name&&""===this.club&&null===this.className&&""===this.totalTime&&!this.competitive},x.prototype.append=function(t){if(!t.isContinuation())throw new Error("Can only append a continuation CompetitorParseRecord");this.cumTimes=this.cumTimes.concat(t.cumTimes)},x.prototype.toCompetitor=function(t){var e=[0].concat(this.cumTimes),n=i(t,this.name,this.club,null,e);return n.completed()&&!this.competitive&&n.setNonCompetitive(),n.hasAnyTimes()||n.setNonStarter(),n};function t(){this.precedingColumnCount=null}t.prototype.isTextOfThisFormat=function(t){return 0<=t.indexOf("<pre>")&&0<=t.indexOf("<font")},t.prototype.preprocess=function(t){var e=t.indexOf("<pre>");if(-1===e)throw new Error("Cannot find opening pre tag");var n=t.indexOf("\n",e),r=(t=(t=t.substring(n+1)).replace(/\n{2,}/g,"\n")).lastIndexOf("</pre>");return-1===r&&f("Found opening <pre> but no closing </pre>"),n=t.lastIndexOf("\n",r),(t=t.substring(0,n)).trim()},t.prototype.canIgnoreThisLine=function(t){return""===t},t.prototype.isCourseHeaderLine=function(t){return 2===T(t).length},t.prototype.parseCourseHeaderLine=function(t){var e=T(t);if(2!==e.length)throw new Error("Course header line should have two parts");var n=e[0],r=e[1],s=n.indexOf("("),i=-1<s?n.substring(0,s):n,o=w(r),a=N(r);return{name:i.trim(),distance:o,climb:a}},t.prototype.parseControlsLine=function(t){var e=t.lastIndexOf("</font>");return b(C((-1===e?t:t.substring(e+"</font>".length)).trim()))},t.prototype.readCompetitorSplitDataLine=function(t){for(var e=0;e<this.precedingColumnCount;e+=1){var n=t.indexOf("</font>");t=t.substring(n+"</font>".length)}return C(h(t))},t.prototype.parseCompetitor=function(t,e){var n=T(t),r=T(e);if(null===this.precedingColumnCount){var s=n[1].trim();this.precedingColumnCount=s.match(/^\d*$/)?4:3}var i=g(n[0]),o=n[this.precedingColumnCount-2].trim(),a=n[this.precedingColumnCount-1].trim(),l=r[this.precedingColumnCount-2].trim(),u=this.readCompetitorSplitDataLine(t),c=this.readCompetitorSplitDataLine(e);O(u=u.map(d),c);var m=null;if(null!==o&&""!==o){for(var h=-1,p=0;p<this.precedingColumnCount;p+=1)h=t.indexOf("</font>",h+1);var f=C(t.substring(0,h+"</font>".length).replace(/<font[^>]*>(.*?)<\/font>/g,""));0<f.length&&(m=f[0])}return new x(o,l,m,a,u,i)};function I(){this.timesOffset=null}I.prototype.isTextOfThisFormat=function(t){for(var e=-1,n=0;n<5;n+=1)if(-1===(e=t.indexOf("<table",e+1)))return!1;return!0},I.prototype.preprocess=function(t){var e=t.indexOf("</table>");-1===e&&f("Could not find any closing </table> tags");var n=(t=t.substring(e+"</table>".length)).indexOf("</div>"),r=t.indexOf("<table");return-1<n&&n<r&&(t=t.substring(n+"</div>".length)),(t=(t=(t=(t=(t=(t=t.replace(/>\n+</g,"><").replace(/><tr>/g,">\n<tr>").replace(/<\/tr></g,"</tr>\n<").replace(/><table/g,">\n<table").replace(/<\/table></g,"</table>\n<")).replace(/<\/col[^>]*>/g,"")).replace(/<tr[^>]*><td[^>]*>(?:<nobr>)?&nbsp;?(?:<\/nobr>)?<\/td><\/tr>/g,"")).replace(/<a id="[^"]*"><\/a>/g,"")).replace(/<div id="navigation">[\s\S]*?<\/div>/g,"")).replace("</body></html>","")).trim()},I.prototype.canIgnoreThisLine=function(t){if(-1<t.indexOf("<th>")){var e=function(t){return v(/<th[^>]*>(.*?)<\/th>/g,t).filter(function(t){return""!==t})}(t);return this.timesOffset=e.length,!0}return""===t||-1<t.indexOf("<table")||-1<t.indexOf("</table>")},I.prototype.isCourseHeaderLine=function(t){return-1<t.indexOf('<td id="header"')},I.prototype.parseCourseHeaderLine=function(t){var e=S(t);0===e.length&&f("No parts found in course header line");var n=e[0],r=n.indexOf("(");-1<r&&(n=n.substring(0,r)),n=n.trim();for(var s=null,i=null,o=1;o<e.length;o+=1)null===s&&(s=w(e[o])),null===i&&(i=N(e[o]));return{name:n,distance:s,climb:i}},I.prototype.parseControlsLine=function(t){return b(S(t))},I.prototype.readCompetitorSplitDataLine=function(t){for(var e=y(t),n=this.timesOffset,r=e.length;0<r&&""===e[r-1];)r-=1;return e.slice(n,r).filter(m)},I.prototype.parseCompetitor=function(t,e){var n=y(t),r=y(e),s=g(n[0]),i=3===this.timesOffset?1:2,o=n[i],a=n[this.timesOffset-1],l=r[i],u=5===this.timesOffset&&""!==o?n[3]:null,c=this.readCompetitorSplitDataLine(t),m=this.readCompetitorSplitDataLine(e);O(c=c.map(d),m);var h=c.filter(p).length;return h!==m.length&&f("Cumulative and split times do not have the same length: "+h+" cumulative times, "+m.length+" split times"),new x(o,l,u,a,c,s)};function B(){this.usesClasses=!1}function L(t,e,n){this.name=t,this.distance=e,this.climb=n,this.controls=[],this.competitors=[]}function F(t){this.recognizer=t,this.courses=[],this.currentCourse=null,this.lines=null,this.linePos=-1,this.currentCompetitor=null}B.prototype.isTextOfThisFormat=function(t){var e=t.indexOf("<table");if(0<=e){var n=t.indexOf("<table",e+1);if(0<=n)if(t.indexOf("<table",n+1)<0)return!0}return!1},B.prototype.preprocess=function(t){var e=t.indexOf("</table>");return-1===e&&f("Could not find any closing </table> tags"),0<=t.indexOf('<td colspan="25">')&&(this.usesClasses=!0),(t=(t=(t=(t=t.substring(e+"</table>".length)).replace(/<tr[^>]*><td colspan=[^>]*>&nbsp;<\/td><\/tr>/g,"")).replace(/\n{2,}/g,"\n")).replace("</body>","").replace("</html>","")).trim()},B.prototype.canIgnoreThisLine=function(t){return""===t||-1<t.indexOf("<table")||-1<t.indexOf("</table>")||-1<t.indexOf("<hr>")},B.prototype.isCourseHeaderLine=function(t){return-1<t.indexOf('<tr class="clubName"')},B.prototype.parseCourseHeaderLine=function(t){var e=S(t);0===e.length&&f("No parts found in course header line");var n,r,s,i=e[0],o=/^(.*?)\s+\((\d+)m,\s*(\d+)m\)$/.exec(i);return s=null===o?(n=i,r=null):(n=o[1],r=parseInt(o[2],10)/1e3,parseInt(o[3],10)),{name:n.trim(),distance:r,climb:s}},B.prototype.parseControlsLine=function(t){return S(t).map(function(t){var e=t.indexOf("-");return-1===e?null:t.substring(e+1)})},B.prototype.readCompetitorSplitDataLine=function(t){for(var e=this.usesClasses?5:4,n=t.length;0<n&&""===t[n-1];)n-=1;for(var r=[],s=e;s<n;s+=2){var i=t[s];m(i)&&r.push(i)}return r},B.prototype.parseCompetitor=function(t,e){for(var n=y(t),r=y(e),s=g(n[0]),i=n[2],o=n[this.usesClasses?4:3],a=this.usesClasses&&""!==i?n[3]:null,l=r[2],u=this.usesClasses?5:4;u<n.length&&u<r.length;u+=2)""!==n[u]&&""===r[u]&&(r[u]="----");var c=this.readCompetitorSplitDataLine(n),m=this.readCompetitorSplitDataLine(r);return O(c=c.map(d),m),c.length!==m.length&&f("Cumulative and split times do not have the same length: "+c.length+" cumulative times, "+m.length+" split times"),new x(i,l,a,o,c,s)},L.prototype.addControls=function(t){this.controls=this.controls.concat(t)},L.prototype.hasAllControls=function(){return 0<this.controls.length&&null===this.controls[this.controls.length-1]},L.prototype.addCompetitor=function(t){if(t.competitive||t.cumTimes.length!==this.controls.length-1||t.cumTimes.push(null),null===d(t.totalTime)&&0===t.cumTimes.length)for(;t.cumTimes.length<this.controls.length;)t.cumTimes.push(null);t.cumTimes.length===this.controls.length?this.competitors.push(t):f("Competitor '"+t.name+"' should have "+this.controls.length+" cumulative times, but has "+t.cumTimes.length+" times")},F.prototype.tryGetLine=function(){return this.linePos+1<this.lines.length?(this.linePos+=1,this.lines[this.linePos]):null},F.prototype.addCurrentCompetitorIfNecessary=function(){null!==this.currentCompetitor&&(this.currentCourse.addCompetitor(this.currentCompetitor),this.currentCompetitor=null)},F.prototype.addCurrentCompetitorAndCourseIfNecessary=function(){this.addCurrentCompetitorIfNecessary(),null!==this.currentCourse&&this.courses.push(this.currentCourse)},F.prototype.readCompetitorLines=function(t){var e=this.tryGetLine();null===e&&f("Hit end of input data unexpectedly while parsing competitor: first line was '"+t+"'");var n=this.recognizer.parseCompetitor(t,e);n.isContinuation()?null===this.currentCompetitor?f("First row of competitor data has no name nor time"):this.currentCompetitor.append(n):(this.addCurrentCompetitorIfNecessary(),this.currentCompetitor=n)},F.prototype.areClassesUniqueWithinCourses=function(){for(var t=d3.map(),e=0;e<this.courses.length;e+=1)for(var n=this.courses[e],r=0;r<n.competitors.length;r+=1){var s=n.competitors[r];if(t.has(s.className)){if(t.get(s.className)!==n.name)return!1}else t.set(s.className,n.name)}return!0},F.prototype.createOverallEventObject=function(){var n=this.areClassesUniqueWithinCourses(),t=[],a=[],r=this.courses.every(function(t){return t.competitors.every(function(t){return p(t.className)})});return this.courses.forEach(function(s){
var i=d3.map();s.competitors.forEach(function(t){var e=r&&n?t.className:s.name;i.has(e)?i.get(e).push(t):i.set(e,[t])});var o=[];i.keys().forEach(function(t){var e=s.controls.length-1,n=i.get(t).map(function(t,e){return t.toCompetitor(e+1)}),r=new l(t,e,n);o.push(r),a.push(r)},this);var e=new u(s.name,o,s.distance,s.climb,s.controls.slice(0,s.controls.length-1));t.push(e),o.forEach(function(t){t.setCourse(e)})},this),new e(a,t,[])},F.prototype.parse=function(t){for(this.lines=t.split("\n");;){var e=this.tryGetLine();if(null===e)break;if(this.recognizer.canIgnoreThisLine(e));else if(this.recognizer.isCourseHeaderLine(e)){this.addCurrentCompetitorAndCourseIfNecessary();var n=this.recognizer.parseCourseHeaderLine(e);this.currentCourse=new L(n.name,n.distance,n.climb)}else if(null===this.currentCourse);else if(this.currentCourse.hasAllControls())this.readCompetitorLines(e);else{var r=this.recognizer.parseControlsLine(e);this.currentCourse.addControls(r)}}return this.addCurrentCompetitorAndCourseIfNecessary(),0===this.courses.length&&f("No competitor data was found"),this.createOverallEventObject()};var D=[t,I,B];SplitsBrowser.Input.Html={},SplitsBrowser.Input.Html.parseEventData=function(t){t=s(t);for(var e=0;e<D.length;e+=1){var n=new D[e];if(n.isTextOfThisFormat(t))return t=n.preprocess(t),new F(n).parse(t)}r("No HTML recognizers recognised this as HTML they could parse")}}(),function(){"use strict";var i=SplitsBrowser.throwWrongFileFormat,o=SplitsBrowser.normaliseLineEndings,h=SplitsBrowser.parseTime,u=SplitsBrowser.parseCourseLength,c=SplitsBrowser.parseCourseClimb,p=SplitsBrowser.Model.Competitor.fromOriginalCumTimes,a=SplitsBrowser.Model.CourseClass,r=SplitsBrowser.Model.Course,l=SplitsBrowser.Model.Event,e={controlsOffset:38,step:3,name:3,club:5,courseName:7,startTime:8,length:null,climb:null,placing:null,finishTime:null,allowMultipleCompetitorNames:!0},s=[",",";"],m=/^[A-Za-z0-9]+$/;function f(t){for(var e=t.length-1;0<=e&&""===t[e];)e-=1;t.splice(e+1,t.length-e-1)}function n(t){this.format=t,this.classes=d3.map(),this.delimiter=null,this.hasAnyStarters=!1,this.warnings=[],this.controlsTerminationOffset=null===t.finishTime?t.step:0}n.prototype.determineDelimiter=function(t){for(var e=0;e<s.length;e+=1){var n=s[e],r=t.split(n);if(f(r),r.length>this.format.controlsOffset)return n}return null},n.prototype.adjustLinePartsForMultipleCompetitors=function(t){if(this.format.allowMultipleCompetitorNames)for(;t.length>this.format.name+1&&t[this.format.name+1].match(/^\s\S/);)t[this.format.name]+=","+t[this.format.name+1],t.splice(this.format.name+1,1)},n.prototype.checkControlCodesAlphaNumeric=function(t){var e=t.split(this.delimiter);f(e),this.adjustLinePartsForMultipleCompetitors(e,this.format);for(var n=this.format.controlsOffset;n+this.controlsTerminationOffset<e.length;n+=this.format.step)m.test(e[n])||i("Data appears not to be in an alternative CSV format - data in cell "+n+" of the first row ('"+e[n]+"') is not an number")},n.prototype.addCompetitorToCourse=function(t,e,n){if(this.classes.has(e)){var r=this.classes.get(e),s=t.getAllOriginalCumulativeTimes();s.length-1!==r.controls.length+1?this.warnings.push("Competitor '"+t.name+"' has the wrong number of splits for course '"+e+"': expected "+(r.controls.length+1)+", actual "+(s.length-1)):r.competitors.push(t)}else{for(var i=[],o=this.format.controlsOffset;o+this.controlsTerminationOffset<n.length;o+=this.format.step)i.push(n[o]);var a=null===this.format.length?null:u(n[this.format.length]),l=null===this.format.climb?null:c(n[this.format.climb]);this.classes.set(e,{length:a,climb:l,controls:i,competitors:[t]})}},n.prototype.readDataRow=function(t){var e=t.split(this.delimiter);if(f(e),this.adjustLinePartsForMultipleCompetitors(e),!(e.length<this.format.controlsOffset)){for(;(e.length-this.format.controlsOffset)%this.format.step!=0;)e.push("");for(var n=e[this.format.name],r=e[this.format.club],s=e[this.format.courseName],i=h(e[this.format.startTime]),o=[0],a=this.format.controlsOffset+1;a<e.length;a+=this.format.step)o.push(h(e[a]));if(null!==this.format.finishTime){var l=h(e[this.format.finishTime]),u=null===i||null===l?null:l-i;o.push(u)}if(1!==o.length){var c=this.classes.has(s)?this.classes.get(s).competitors.length+1:1,m=p(c,n,r,i,o);if(null!==this.format.placing&&m.completed())e[this.format.placing].match(/^\d*$/)||m.setNonCompetitive();m.hasAnyTimes()?this.hasAnyStarters=!0:m.setNonStarter(),this.addCompetitorToCourse(m,s,e)}else""!==n&&this.warnings.push("Competitor '"+n+"' on course '"+(""===s?"(unnamed)":s)+"' has no times recorded")}},n.prototype.createClassesAndCourses=function(){var i=[],o=d3.map();this.classes.entries().forEach(function(t){var e=t.key,n=t.value,r=new a(e,n.controls.length,n.competitors);i.push(r);var s=n.controls.join(",");o.has(s)?o.get(s).classes.push(r):o.set(s,{name:e,classes:[r],length:n.length,climb:n.climb,controls:n.controls})});var n=[];return o.values().forEach(function(t){var e=new r(t.name,t.classes,t.length,t.climb,t.controls);t.classes.forEach(function(t){t.setCourse(e)}),n.push(e)}),{classes:i,courses:n}},n.prototype.parseEventData=function(t){this.warnings=[];var e=(t=o(t)).split(/\n/);e.length<2&&i("Data appears not to be in an alternative CSV format - too few lines");var n=e[1];this.delimiter=this.determineDelimiter(n),null===this.delimiter&&i("Data appears not to be in an alternative CSV format - first data line has fewer than "+this.format.controlsOffset+" parts when separated by any recognised delimiter"),this.checkControlCodesAlphaNumeric(n);for(var r=1;r<e.length;r+=1)this.readDataRow(e[r]);var s=this.createClassesAndCourses();return this.hasAnyStarters||i("Data appears not to be in an alternative CSV format - data apparently could be read but everyone was a non-starter"),new l(s.classes,s.courses,this.warnings)},SplitsBrowser.Input.AlternativeCSV={parseTripleColumnEventData:function(t){return new n(e).parseEventData(t)}}}(),function(){"use strict";var s=SplitsBrowser.throwInvalidData,c=SplitsBrowser.throwWrongFileFormat,m=SplitsBrowser.isNaNStrict,r=SplitsBrowser.parseTime,T=SplitsBrowser.Model.Competitor.fromOriginalCumTimes,h=SplitsBrowser.Model.CourseClass,p=SplitsBrowser.Model.Course,f=SplitsBrowser.Model.Event;function l(t){return void 0===t}var y=/^\d{4}/,t={isOfThisVersion:function(t){return 0<=t.indexOf("IOFdata.dtd")},checkVersion:function(t){var e=$("> IOFVersion",t);if(0===e.length)c("Could not find IOFVersion element");else{var n=e.attr("version");l(n)?c("Version attribute missing from IOFVersion element"):"2.0.3"!==n&&c("Found unrecognised IOF XML data format '"+n+"'")}var r=t.attr("status");l(r)||"complete"===r.toLowerCase()||s("Only complete IOF data supported; snapshot and delta are not supported")},readClassName:function(t){return $("> ClassShortName",t).text()},readCourseFromClass:function(t,e){var n=$("> ClassShortName",t).text(),r=$("> PersonResult > Result",t).first(),s=null;if(0<r.length){var i=$("> CourseLength",r),o=i.text();if(0<o.length)if(s=parseFloat(o),isFinite(s)){var a=i.attr("unit");l(a)||"m"===a?s/=1e3:"km"===a||("ft"===a?s/=3280:(e.push("Course '"+n+"' gives its length in a unit '"+a+"', but this unit was not recognised"),s=null))}else e.push("Course '"+n+"' specifies a course length that was not understood: '"+o+"'"),s=null}return{id:null,name:n,length:s,climb:null,numberOfControls:null}},getCompetitorNameElement:function(t){return $("> Person > PersonName",t)},readClubName:function(t){return $("> Club > ShortName",t).text()},readDateOfBirth:function(t){return $("> Person > BirthDate > Date",t).text()},readStartTime:function(t){var e=$("> StartTime > Clock",t).text();return""===e?null:r(e)},readTotalTime:function(t){var e=$("> Time",t).text();return""===e?null:r(e)},getStatus:function(t){var e=$("> CompetitorStatus",t);return 1===e.length?e.attr("value"):""},StatusNonCompetitive:"NotCompeting",StatusNonStarter:"DidNotStart",StatusNonFinisher:"DidNotFinish",StatusDisqualified:"Disqualified",StatusOverMaxTime:"OverTime",isAdditional:function(){return!1},readSplitTime:function(t){var e=$("> ControlCode",t).text();""===e&&(e=$("> Control > ControlCode",t).text()),""===e&&s("Control code missing for control");var n=$("> Time",t).text();return{code:e,time:""===n?null:r(n)}}},i=/^\d\d\d\d-?\d\d-?\d\dT?(\d\d):?(\d\d)(?::?(\d\d))?/,o={isOfThisVersion:function(t){return 0<=t.indexOf("http://www.orienteering.org/datastandard/3.0")},checkVersion:function(t){var e=t.attr("iofVersion");l(e)?c("Could not find IOF version number"):"3.0"!==e&&c("Found unrecognised IOF XML data format '"+e+"'");var n=t.attr("status");l(n)||"complete"===n.toLowerCase()||s("Only complete IOF data supported; snapshot and delta are not supported")},readClassName:function(t){return $("> Class > Name",t).text()},readCourseFromClass:function(t,e){var n,r=$("> Course",t),s=$("> Id",r).text()||null,i=$("> Name",r).text(),o=$("> Length",r).text();""===o?n=null:(n=parseInt(o,10),m(n)?(e.push("Course '"+i+"' specifies a course length that was not understood: '"+o+"'"),n=null):n/=1e3);var a=$("> NumberOfControls",r).text(),l=parseInt(a,10);m(l)&&(l=null);var u=$("> Climb",r).text(),c=parseInt(u,10);return m(c)&&(c=null),{id:s,name:i,length:n,climb:c,numberOfControls:l}},getCompetitorNameElement:function(t){return $("> Person > Name",t)},readClubName:function(t){return $("> Organisation > ShortName",t).text()},readDateOfBirth:function(t){var e=$("> Person > BirthDate",t).text(),n=y.exec(e);return null===n?null:parseInt(n[0],10)},readStartTime:function(t){var e=$("> StartTime",t).text(),n=i.exec(e);return null===n?null:60*parseInt(n[1],10)*60+60*parseInt(n[2],10)+(l(n[3])?0:parseInt(n[3],10))},readTime:function(t){var e=parseFloat(t);return isFinite(e)?e:null},readTotalTime:function(t){var e=$("> Time",t).text();return o.readTime(e)},getStatus:function(t){return $("> Status",t).text()},StatusNonCompetitive:"NotCompeting",StatusNonStarter:"DidNotStart",StatusNonFinisher:"DidNotFinish",StatusDisqualified:"Disqualified",StatusOverMaxTime:"OverTime",isAdditional:function(t){return"Additional"===t.attr("status")},readSplitTime:function(t){var e,n=$("> ControlCode",t).text();if(""===n&&s("Control code missing for control"),"Missing"===t.attr("status"))e=null;else{var r=$("> Time",t).text();e=""===r?null:o.readTime(r)}return{code:n,time:e}}},d=[t,o];function g(t,e,n,r){var s=$(t),i=function(t){var e=$("> Given",t).text(),n=$("> Family",t).text();return""===e?n:""===n?e:e+" "+n}(n.getCompetitorNameElement(s));if(""===i)return r.push("Could not find a name for a competitor"),null;var o=n.readClubName(s),a=n.readDateOfBirth(s),l=y.exec(a),u=null===l?null:parseInt(l[0],10),c=$("> Person",s).attr("sex"),m=$("Result",s);if(0===m.length)return r.push("Could not find any result information for competitor '"+i+"'"),null;var h=n.readStartTime(m),p=n.readTotalTime(m),f=$("> SplitTime",m).toArray().filter(function(t){return!n.isAdditional($(t))}).map(function(t){return n.readSplitTime($(t))}),d=f.map(function(t){return t.code}),g=f.map(function(t){return t.time});g.unshift(0),g.push(p);var C=T(e,i,o,h,g);null!==u&&C.setYearOfBirth(u),"M"!==c&&"F"!==c||C.setGender(c);var v=n.getStatus(m);return v===n.StatusNonCompetitive?C.setNonCompetitive():v===n.StatusNonStarter?C.setNonStarter():v===n.StatusNonFinisher?C.setNonFinisher():v===n.StatusDisqualified?C.disqualify():v===n.StatusOverMaxTime&&C.setOverMaxTime(),{competitor:C,controls:d}}SplitsBrowser.Input.IOFXml={parseEventData:function(t){var i=function(t){for(var e=0;e<d.length;e+=1){var n=d[e];if(n.isOfThisVersion(t))return n}c("Data apparently not of any recognised IOF XML format")}(t),e=function(t){var e;try{e=$.parseXML(t)}catch(t){s("XML data not well-formed")}return 0===$("> *",$(e)).length&&s("XML data not well-formed: "+t),e}(t);!function(t,e){var n=$("> *",t),r=n.prop("tagName");"ResultList"!==r&&c("Root element of XML document does not have expected name 'ResultList', got '"+r+"'"),e.checkVersion(n)}(e,i);var n=$("> ResultList > ClassResult",$(e)).toArray();0===n.length&&s("No class result elements found");var o=[],a=[],l=d3.map(),u=[];n.forEach(function(t){var e=function(t,e,n){var r=$(t),s={name:null,competitors:[],controls:[],course:null};s.course=e.readCourseFromClass(r,n);var i=e.readClassName(r);""===i&&(i="<unnamed class>"),s.name=i;var o=$("> PersonResult",r);if(0===o.length)return n.push("Class '"+i+"' has no competitors"),null;for(var a=0;a<o.length;a+=1){var l=g(o[a],a+1,e,n);if(null!==l){var u=l.competitor,c=l.controls;0!==s.competitors.length||u.isNonStarter&&0===c.length||(s.controls=c,null===s.course.numberOfControls&&(s.course.numberOfControls=s.controls.length));var m=u.getAllOriginalCumulativeTimes().length-2,h=null;if(u.isNonStarter&&0==m);else if(m!==s.course.numberOfControls)h="Competitor '"+u.name+"' in class '"+i+"' has an unexpected number of controls: expected "+s.course.numberOfControls+", actual "+m;else for(var p=0;p<m;p+=1)if(s.controls[p]!==c[p]){h="Competitor '"+u.name+"' has an unexpected control code at control "+(p+1)+": expected '"+s.controls[p]+"', actual '"+c[p]+"'";break}null===h?s.competitors.push(u):n.push(h)}}return null===s.course.id&&0<s.controls.length&&(s.course.id=s.controls.join(",")),s}(t,i,u);if(null!==e){var n=new h(e.name,e.controls.length,e.competitors);o.push(n);var r=e.course,s=r.id+","+e.controls.join(",");null!==r.id&&l.has(s)?l.get(s).classes.push(n):(r.classes=[n],r.controls=e.controls,a.push(r),null!==r.id&&l.set(s,r))}});var r=a.map(function(t){var e=new p(t.name,t.classes,t.length,t.climb,t.controls);return t.classes.forEach(function(t){t.setCourse(e)}),e});return new f(o,r,u)}}}(),function(){"use strict";var r=[SplitsBrowser.Input.CSV.parseEventData,SplitsBrowser.Input.OE.parseEventData,SplitsBrowser.Input.Html.parseEventData,SplitsBrowser.Input.AlternativeCSV.parseTripleColumnEventData,SplitsBrowser.Input.IOFXml.parseEventData];SplitsBrowser.Input.parseEventData=function(t){for(var e=0;e<r.length;e+=1){var n=r[e];try{return n(t)}catch(t){if("WrongFileFormat"!==t.name)throw t}}return null}}();