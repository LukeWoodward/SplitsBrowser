/*!
 *  SplitsBrowser - Orienteering results analysis.
 *  
 *  Copyright (C) 2000-2022 Dave Ryder, Reinhard Balling, Andris Strazdins,
 *                          Ed Nash, Luke Woodward
 *
 *  This program is free software; you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation; either version 2 of the License, or
 *  (at your option) any later version.
 *
 *  This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License along
 *  with this program; if not, write to the Free Software Foundation, Inc.,
 *  51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
 */
var SplitsBrowser={Version:"3.5.3",Model:{},Input:{},Controls:{},Messages:{}};!function(){"use strict";function e(t){this.name="InvalidData",this.message=t}function s(t){this.name="WrongFileFormat",this.message=t}SplitsBrowser.isTrue=function(t){return t},SplitsBrowser.isNotNull=function(t){return null!==t},SplitsBrowser.isNaNStrict=function(t){return t!=t},SplitsBrowser.isNotNullNorNaN=function(t){return null!==t&&t==t},e.prototype.toString=function(){return this.name+": "+this.message},SplitsBrowser.throwInvalidData=function(t){throw new e(t)},s.prototype.toString=function(){return this.name+": "+this.message},SplitsBrowser.throwWrongFileFormat=function(t){throw new s(t)},SplitsBrowser.hasProperty=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},SplitsBrowser.addIfNotNull=function(t,e){return null===t||null===e?null:t+e},SplitsBrowser.subtractIfNotNull=function(t,e){return null===t||null===e?null:t-e},SplitsBrowser.parseCourseLength=function(t){t=parseFloat(t.replace(",","."));return isFinite(t)?(500<=t&&(t/=1e3),t):null},SplitsBrowser.parseCourseClimb=function(t){t=parseInt(t,10);return SplitsBrowser.isNaNStrict(t)?null:t},SplitsBrowser.normaliseLineEndings=function(t){return t.replace(/\r\n/g,"\n").replace(/\r/g,"\n")}}(),function(){"use strict";SplitsBrowser.NULL_TIME_PLACEHOLDER="-----";var i=SplitsBrowser.isNaNStrict;function o(t){return t<10?"0"+t:t.toString()}SplitsBrowser.formatTime=function(t,e){if(null===t)return SplitsBrowser.NULL_TIME_PLACEHOLDER;if(i(t))return"???";var s="",n=(t<0&&(s="-",t=-t),Math.floor(t/3600)),r=Math.floor(t/60)%60,t=t%60;return 0<n&&(s+=n.toString()+":"),s+=o(r)+":",t<10&&(s+="0"),s+="number"==typeof e?t.toFixed(e):Math.round(100*t)/100},SplitsBrowser.formatTimeOfDay=function(t){var e=Math.floor(t/3600%24),s=Math.floor(t/60)%60,t=Math.floor(t%60);return o(e)+":"+o(s)+":"+o(t)},SplitsBrowser.parseTime=function(t){var e;return t=t.trim(),/^(-?\d+:)?-?\d+:-?\d\d([,.]\d{1,10})?$/.test(t)?(t=t.replace(",",".").split(":"),e=0,t.forEach(function(t){e=60*e+parseFloat(t)}),e):null}}(),function(){"use strict";var i="number",t=SplitsBrowser.isNotNull,r=SplitsBrowser.isNaNStrict,e=SplitsBrowser.hasProperty,l=SplitsBrowser.addIfNotNull,n=SplitsBrowser.subtractIfNotNull,u=SplitsBrowser.throwInvalidData;function m(t){if(!$.isArray(t))throw new TypeError("Cumulative times must be an array - got "+typeof t+" instead");0===t.length?u("Array of cumulative times must not be empty"):0!==t[0]?u("Array of cumulative times must have zero as its first item"):1===t.length&&u("Array of cumulative times must contain more than just a single zero");for(var e=[],s=0;s+1<t.length;s+=1)e.push(n(t[s+1],t[s]));return e}function a(t,e,s,n,r){typeof t!=i&&u("Result order must be a number, got "+typeof t+" '"+t+"' instead"),typeof e!=i&&null!==e&&u("Start time must be a number, got "+typeof e+" '"+e+"' instead"),this.order=t,this.startTime=e,this.owner=r,this.isOKDespiteMissingTimes=!1,this.isNonCompetitive=!1,this.isNonStarter=!1,this.isNonFinisher=!1,this.isDisqualified=!1,this.isOverMaxTime=!1,this.originalSplitTimes=s,this.originalCumTimes=n,this.splitTimes=null,this.cumTimes=null,this.splitRanks=null,this.cumRanks=null,this.timeLosses=null,this.className=null,this.offsets=null,this.totalTime=null===n||-1<n.indexOf(null)?null:n[n.length-1]}function h(t,e,s){for(var n=[0],r=0;r<t.length;r+=1)for(var i=s(t[r]),o=1;o<i.length;o+=1)n.push(l(e[r],i[o]));return n}SplitsBrowser.Model.compareResults=function(t,e){return t.isDisqualified!==e.isDisqualified?t.isDisqualified?1:-1:t.totalTime===e.totalTime?t.order-e.order:null===t.totalTime?null===e.totalTime?0:1:null===e.totalTime?-1:t.totalTime-e.totalTime},a.prototype.setOKDespiteMissingTimes=function(){this.isOKDespiteMissingTimes=!0,null!==this.originalCumTimes&&(this.totalTime=this.originalCumTimes[this.originalCumTimes.length-1])},a.prototype.setNonCompetitive=function(){this.isNonCompetitive=!0},a.prototype.setNonStarter=function(){this.isNonStarter=!0},a.prototype.setNonFinisher=function(){this.isNonFinisher=!0},a.prototype.disqualify=function(){this.isDisqualified=!0},a.prototype.setOverMaxTime=function(){this.isOverMaxTime=!0},a.prototype.setClassName=function(t){this.className=t},a.prototype.setOffsets=function(t){this.offsets=t},a.fromOriginalCumTimes=function(t,e,s,n){return new a(t,e,m(s),s,n)},a.fromCumTimes=function(t,e,s,n){t=a.fromOriginalCumTimes(t,e,s,n);return t.splitTimes=t.originalSplitTimes,t.cumTimes=t.originalCumTimes,t},a.prototype.setRepairedCumulativeTimes=function(t){this.cumTimes=t,this.splitTimes=m(t)},a.prototype.completed=function(){return null!==this.totalTime&&!this.isDisqualified&&!this.isOverMaxTime},a.prototype.hasAnyTimes=function(){return this.originalCumTimes.slice(1).some(t)},a.prototype.getSplitTimeTo=function(t){return 0===t?0:this.splitTimes[t-1]},a.prototype.getOriginalSplitTimeTo=function(t){return this.isNonStarter?null:0===t?0:this.originalSplitTimes[t-1]},a.prototype.isSplitTimeDubious=function(t){return 0<t&&this.originalSplitTimes[t-1]!==this.splitTimes[t-1]},a.prototype.getCumulativeTimeTo=function(t){return this.cumTimes[t]},a.prototype.getOriginalCumulativeTimeTo=function(t){return this.isNonStarter?null:this.originalCumTimes[t]},a.prototype.isCumulativeTimeDubious=function(t){return this.originalCumTimes[t]!==this.cumTimes[t]},a.prototype.getSplitRankTo=function(t){return null===this.splitRanks?null:this.splitRanks[t]},a.prototype.getCumulativeRankTo=function(t){return null===this.cumRanks?null:this.cumRanks[t]},a.prototype.getTimeLossAt=function(t){return 0===t||null===this.timeLosses?null:this.timeLosses[t-1]},a.prototype.getAllCumulativeTimes=function(){return this.cumTimes},a.prototype.getAllOriginalCumulativeTimes=function(){return this.originalCumTimes},a.prototype.getAllSplitTimes=function(){return this.splitTimes},a.prototype.lacksStartTime=function(){return null===this.startTime&&this.splitTimes.some(t)},a.prototype.setSplitAndCumulativeRanks=function(t,e){null===t[0]&&null===e[0]||u("Split and cumulative ranks arrays must both start with null"),this.splitRanks=t,this.cumRanks=e},a.prototype.getCumTimesAdjustedToReference=function(s){return s.length!==this.cumTimes.length?u("Cannot adjust cumulative times because the numbers of times are different ("+this.cumTimes.length+" and "+s.length+")"):-1<s.indexOf(null)&&u("Cannot adjust cumulative times because a null value is in the reference data"),this.cumTimes.map(function(t,e){return n(t,s[e])})},a.prototype.getCumTimesAdjustedToReferenceWithStartAdded=function(t,e){var s,t=this.getCumTimesAdjustedToReference(t);return s=null===e||0===e?this.startTime:(e=this.offsets[e],this.startTime+this.cumTimes[e]-t[e]),t.map(function(t){return l(t,s)})},a.prototype.getSplitPercentsBehindReferenceCumTimes=function(s){s.length!==this.cumTimes.length?u("Cannot determine percentages-behind because the numbers of times are different ("+this.cumTimes.length+" and "+s.length+")"):-1<s.indexOf(null)&&u("Cannot determine percentages-behind because a null value is in the reference data");var n=[0];return this.splitTimes.forEach(function(t,e){null!==t&&0<(e=s[e+1]-s[e])?n.push(100*(t-e)/e):n.push(null)}),n},a.prototype.determineTimeLosses=function(s){var t,e,n;this.completed()&&(s.length!==this.splitTimes.length?u("Cannot determine time loss with "+this.splitTimes.length+" split times using "+s.length+" fastest splits"):s.some(r)&&u("Cannot determine time loss when there is a NaN value in the fastest splits"),s.some(function(t){return 0===t})||this.isOKDespiteMissingTimes||this.splitTimes.some(r)?this.timeLosses=this.splitTimes.map(function(){return NaN}):((t=this.splitTimes.map(function(t,e){return t/s[e]})).sort(d3.ascending),n=t.length%2==1?t[(t.length-1)/2]:(t[(e=t.length/2)-1]+t[e])/2,this.timeLosses=this.splitTimes.map(function(t,e){return Math.round(t-s[e]*n)})))},a.prototype.crosses=function(t,e){t.cumTimes.length!==this.cumTimes.length&&u("Two results with different numbers of controls cannot cross");for(var s,n,r,i=!1,o=!1,l=null===e||null===this.offsets?(s=0,this.cumTimes.length):(s=this.offsets[e],e+1===this.offsets.length?this.cumTimes.length:this.offsets[e+1]+1),a=s;a<l;a+=1)null!==this.cumTimes[a]&&null!==t.cumTimes[a]&&((n=this.startTime+this.cumTimes[a])<(r=t.startTime+t.cumTimes[a])?i=!0:r<n&&(o=!0));return i&&o},a.prototype.isTimeOmitted=function(t){return r(t)||this.isOKDespiteMissingTimes&&null===t},a.prototype.getIndexesAroundOmittedTimes=function(t){for(var e=[],s=1;s+1<t.length;)if(this.isTimeOmitted(t[s])){for(var n=s;n+1<t.length&&this.isTimeOmitted(t[n+1]);)n+=1;n+1<t.length&&null!==t[s-1]&&null!==t[n+1]&&e.push({start:s-1,end:n+1}),s=n+1}else s+=1;return e},a.prototype.getControlIndexesAroundOmittedCumulativeTimes=function(){return this.getIndexesAroundOmittedTimes(this.cumTimes)},a.prototype.getControlIndexesAroundOmittedSplitTimes=function(){return this.getIndexesAroundOmittedTimes([0].concat(this.splitTimes))},a.prototype.getOwnerNameForLeg=function(t){return(e(this.owner,"members")&&null!==t?this.owner.members[t]:this.owner).name},a.prototype.determineAggregateStatus=function(t){if(t.some(function(t){return t.isDisqualified}))this.isDisqualified=!0;else if(t.every(function(t){return t.isNonStarter}))this.isNonStarter=!0;else{for(var e=-1;e+1<t.length;e+=1){var s=t[e+1];if(s.isNonStarter||s.isNonFinisher||!s.completed())break}for(var n=t.length;0<n;--n)if(!t[n-1].isNonStarter)break;if(e<t.length-1){if(e+1===n)return void(this.isNonFinisher=!0);if(e+2===n&&t[e+1].isNonFinisher)return void(this.isNonFinisher=!0)}t.some(function(t){return t.isOverMaxTime})?this.isOverMaxTime=!0:(t.some(function(t){return t.isNonCompetitive})&&(this.isNonCompetitive=!0),t.some(function(t){return t.isOKDespiteMissingTimes})&&this.setOKDespiteMissingTimes())}},a.prototype.restrictToCommonControls=function(t,e){t.length!==e.length&&u("Should have two equal-length arrays of common controls");for(var s=[0],n=1,r=0;r<t.length;r+=1){for(var i=t[r],o=e[r],l=0,a=0;a<i.length;a+=1)l<o.length&&i[a]===o[l]&&(n>=this.originalCumTimes.length&&u("Attempt to read too many original controls: likely that the wrong list of controls has been passed"),s.push(this.originalCumTimes[n]),l+=1),n+=1;l<o.length&&u("Did not reach end of common controls: likely that they are not a subset of the controls"),n>=this.originalCumTimes.length&&u("Attempt to read too many original controls: likely that the wrong list of controls has been passed"),s.push(this.originalCumTimes[n]),n+=1}n<this.originalCumTimes.length&&u("Did not reach end of original controls: likely that a wrong list of controls has been passed"),this.originalCumTimes=s,this.originalSplitTimes=m(s)},a.createTeamResult=function(t,e,s){e.length<2&&u("Team results can only be created from at least two other results");r=[0],(n=e).forEach(function(t,e){var s=r[r.length-1],e=e+1<n.length?n[e+1]:null,s=null!==s&&null!==t.totalTime?s+t.totalTime:null!==e&&null!==e.startTime&&null!==n[0].startTime?e.startTime-n[0].startTime:null;r.push(s)});var n,r,i=r.slice(0,r.length-1),o=(s.setMembers(e.map(function(t){return t.owner})),h(e,i,function(t){return t.originalCumTimes})),t=a.fromOriginalCumTimes(t,e[0].startTime,o,s);return e.every(function(t){return null!==t.cumTimes})&&(t.cumTimes=h(e,i,function(t){return t.cumTimes}),t.splitTimes=m(t.cumTimes)),t.determineAggregateStatus(e),t},SplitsBrowser.Model.Result=a}(),function(){"use strict";function t(t,e){this.name=t,this.club=e,this.yearOfBirth=null,this.gender=null}t.prototype.setYearOfBirth=function(t){this.yearOfBirth=t},t.prototype.setGender=function(t){this.gender=t},SplitsBrowser.Model.Competitor=t}(),function(){"use strict";function t(t,e){this.name=t,this.club=e}t.prototype.setMembers=function(t){this.members=t},SplitsBrowser.Model.Team=t}(),function(){var u=SplitsBrowser.throwInvalidData;SplitsBrowser.COMMON_CONTROLS_MODE="commonControls",SplitsBrowser.determineCommonControls=function(t,e){for(var s=d3.map(),n=(0===t.length&&u("Cannot determine the list of common controls of an empty array"),t.forEach(function(t){var e=d3.set();t.forEach(function(t){e.has(t)||(e.add(t),s.has(t)?s.set(t,s.get(t)+1):s.set(t,1))})}),t.length),r=t[0].filter(function(t){return s.get(t)===n}),i=1;i<n;i+=1){var o=t[i].filter(function(t){return s.get(t)===n}),l=d3.set();o.forEach(function(t){l.has(t)?u("Cannot determine common controls because "+e+" contains duplicated control "+t):l.add(t)}),o.length!==r.length&&u("Unexpectedly didn't get the same number of common controls for all competitors");for(var a=0;a<r.length;a+=1)r[a]!==o[a]&&u("Inconsistent ordering for control "+r[a]+" in "+e)}return r}}(),function(){"use strict";var i=SplitsBrowser.isNotNullNorNaN,t=SplitsBrowser.throwInvalidData;function e(e,t,s){this.name=e,this.numControls=t,this.numbersOfControls=null,this.offsets=null,this.results=s,this.course=null,this.hasDubiousData=!1,this.isTeamClass=!1,this.results.forEach(function(t){t.setClassName(e)})}e.prototype.recordHasDubiousData=function(){this.hasDubiousData=!0},e.prototype.setIsTeamClass=function(t){this.isTeamClass=!0,this.numbersOfControls=t,this.offsets=[0];for(var e=1;e<t.length;e+=1)this.offsets.push(this.offsets[e-1]+t[e-1]+1);this.results.forEach(function(t){t.setOffsets(this.offsets)},this)},e.prototype.determineTimeLosses=function(){var e=d3.range(1,this.numControls+2).map(function(t){t=this.getFastestSplitTo(t);return null===t?null:t.split},this);this.results.forEach(function(t){t.determineTimeLosses(e)})},e.prototype.isEmpty=function(){return 0===this.results.length},e.prototype.setCourse=function(t){this.course=t},e.prototype.getFastestSplitTo=function(s){("number"!=typeof s||s<1||s>this.numControls+1)&&t("Cannot return splits to leg '"+s+"' in a course with "+this.numControls+" control(s)");var n=null,r=null;return this.results.forEach(function(t){var e=t.getSplitTimeTo(s);i(e)&&(null===n||e<n)&&(n=e,r=t)}),null===n?null:{split:n,name:r.owner.name}},e.prototype.getResultsAtControlInTimeRange=function(s,n,r){("number"!=typeof s||isNaN(s)||s<0||s>this.numControls+1)&&t("Control number must be a number between 0 and "+this.numControls+" inclusive");var i=[];return this.results.forEach(function(t){var e=t.getCumulativeTimeTo(s);null!==e&&null!==t.startTime&&(e=e+t.startTime,n<=e&&e<=r&&i.push({name:t.owner.name,time:e}))}),i},SplitsBrowser.Model.CourseClass=e}(),function(){"use strict";var i=SplitsBrowser.throwInvalidData;function t(t,e,s,n,r){this.name=t,this.classes=e,this.length=s,this.climb=n,this.controls=r}var l=t.START="__START__",a=t.FINISH="__FINISH__",o=t.INTERMEDIATE="__INTERMEDIATE__";t.prototype.getOtherClasses=function(e){var t=this.classes.filter(function(t){return t!==e});if(t.length!==this.classes.length)return t;i("Course.getOtherClasses: given class is not in this course")},t.prototype.getNumClasses=function(){return this.classes.length},t.prototype.hasControls=function(){return null!==this.controls},t.prototype.getControlCode=function(t){return 0===t?l:1<=t&&t<=this.controls.length?this.controls[t-1]:t===this.controls.length+1?a:void i("Cannot get control code of control "+t+" because it is out of range")},t.prototype.usesLeg=function(t,e){return 0<=this.getLegNumber(t,e)},t.prototype.getLegNumber=function(t,e){if(null===this.controls)return-1;if(t===l&&e===a)return 0===this.controls.length?1:-1;if(t===l)return 0<this.controls.length&&this.controls[0]===e?1:-1;if(e===a)return 0<this.controls.length&&this.controls[this.controls.length-1]===t?this.controls.length+1:-1;for(var s=1;s<this.controls.length;s+=1)if(this.controls[s-1]===t&&this.controls[s]===e)return s+1;return-1},t.prototype.getFastestSplitsForLeg=function(t,e){null===this.legs&&i("Cannot determine fastest splits for a leg because leg information is not available");var s=this.getLegNumber(t,e),n=(s<0&&i("Leg from "+((t===l||t===o?"start":t)+" to "+(e===a||e===o?"end":e))+" not found in course "+this.name),s),r=[];return this.classes.forEach(function(t){var e=t.getFastestSplitTo(n);null!==e&&r.push({name:e.name,className:t.name,split:e.split})}),r},t.prototype.getResultsAtControlInTimeRange=function(t,e,s){if(null===this.controls)return[];if(t===l)return this.getResultsAtControlNumInTimeRange(0,e,s);if(t===a)return this.getResultsAtControlNumInTimeRange(this.controls.length+1,e,s);for(var n=-1,r=[],i=function(t){r.push(t)};;){var o=this.controls.indexOf(t,n+1);if(o<0)return r;this.getResultsAtControlNumInTimeRange(o+1,e,s).forEach(i),n=o}},t.prototype.getResultsAtControlNumInTimeRange=function(t,s,n){var r=[];return this.classes.forEach(function(e){e.getResultsAtControlInTimeRange(t,s,n).forEach(function(t){r.push({name:t.name,time:t.time,className:e.name})})}),r},t.prototype.hasControl=function(t){return null!==this.controls&&-1<this.controls.indexOf(t)},t.prototype.getNextControls=function(t){if(null===this.controls)i("Course has no controls");else if(t===a)i("Cannot fetch next control after the finish");else{if(t===l)return[0===this.controls.length?a:this.controls[0]];for(var e=-1,s=[];;){var n=this.controls.indexOf(t,e+1);if(-1===n)break;n===this.controls.length-1?s.push(a):s.push(this.controls[n+1]),e=n}if(0!==s.length)return s;i("Control '"+t+"' not found on course "+this.name)}},SplitsBrowser.Model.Course=t}(),function(){"use strict";var s=SplitsBrowser.Model.Course;function t(t,e,s){this.classes=t,this.courses=e,this.warnings=s}t.prototype.determineTimeLosses=function(){this.classes.forEach(function(t){t.determineTimeLosses()})},t.prototype.needsRepair=function(){return this.classes.some(function(t){return t.results.some(function(t){return null===t.getAllCumulativeTimes()})})},t.prototype.getFastestSplitsForLeg=function(e,s){var n=[];return this.courses.forEach(function(t){t.usesLeg(e,s)&&(n=n.concat(t.getFastestSplitsForLeg(e,s)))}),n.sort(function(t,e){return d3.ascending(t.split,e.split)}),n},t.prototype.getResultsAtControlInTimeRange=function(e,s,n){var r=[];return this.courses.forEach(function(t){t.getResultsAtControlInTimeRange(e,s,n).forEach(function(t){r.push(t)})}),r.sort(function(t,e){return d3.ascending(t.time,e.time)}),r},t.prototype.getNextControlsAfter=function(e){var t=this.courses;return(t=e!==s.START?t.filter(function(t){return t.hasControl(e)}):t).map(function(t){return{course:t,nextControls:t.getNextControls(e)}})},SplitsBrowser.Model.Event=t}(),function(){"use strict";var i=SplitsBrowser.isTrue,n=SplitsBrowser.isNotNull,o=SplitsBrowser.throwInvalidData,l=SplitsBrowser.throwWrongFileFormat,a=SplitsBrowser.normaliseLineEndings,d=SplitsBrowser.parseTime,g=SplitsBrowser.Model.Result.fromCumTimes,C=SplitsBrowser.Model.Competitor,r=SplitsBrowser.Model.compareResults,u=SplitsBrowser.Model.CourseClass,m=SplitsBrowser.Model.Course,h=SplitsBrowser.Model.Event;function c(t,c){var t=t.split(/\r?\n/).filter(i),e=(0===t.length&&o("parseCourseClass got an empty list of lines"),t.shift().split(","));if(2===e.length){var p=e.shift(),s=e.shift(),f=parseInt(s,10);if(isNaN(f))o("Could not read control count: '"+s+"'");else{if(!(f<0&&0<t.length))return(s=t.map(function(t,e){for(var s=f,n=p,r=c,i=(t=t).split(",");i.length>s+5&&i[3].match(/[^0-9.,:-]/);)i[2]+=","+i[3],i.splice(3,1);var o,l,a,u,m,t=i.length,h=((i.shift()||"")+" "+(i.shift()||"")).trim()||"<name unknown>";return t===s+5?(o=i.shift(),u=i.shift(),0===(m=d(u))?m=null:u.match(/^\d{1,10}:\d\d:\d\d$/)||(m*=60),l=[0],a=0,i.map(function(t){t=d(t);null!==t&&0<t?(a+=t,l.push(a)):l.push(null)}),u=g(e+1,m,l,new C(h,o)),0===a&&u.setNonStarter(),u):(r.push("Competitor '"+h+"' appears to have the wrong number of split times - "+((m=t-(s+5))<0?-m+" too few":m+" too many")+" (row "+(e+1)+" of class '"+n+"')"),null)}).filter(n)).sort(r),new u(p,f,s);o("Expected a non-negative control count, got "+f+" instead")}}else l("Expected first line to have two parts (class name and number of controls), got "+e.length+" part(s) instead")}SplitsBrowser.Input.CSV={parseEventData:function(t){/<html/i.test(t)&&l("Cannot parse this file as CSV as it appears to be HTML");var t=(t=(t=a(t)).replace(/,{1,100}\n/g,"\n").replace(/,{1,100}$/,"")).split(/\n\n/).map(function(t){return t.trim()}).filter(i),e=[],s=t.map(function(t){return c(t,e)});0===(s=s.filter(function(t){return!t.isEmpty()})).length&&o("No competitor data was found");for(var n=s.map(function(t){return new m(t.name,[t],null,null,null)}),r=0;r<s.length;r+=1)s[r].setCourse(n[r]);return new h(s,n,e)}}}(),function(){"use strict";var n=SplitsBrowser.throwInvalidData,r=SplitsBrowser.throwWrongFileFormat,a=SplitsBrowser.isNaNStrict,u=SplitsBrowser.hasProperty,i=SplitsBrowser.parseCourseLength,o=SplitsBrowser.parseCourseClimb,e=SplitsBrowser.normaliseLineEndings,m=SplitsBrowser.parseTime,h=SplitsBrowser.Model.Result.fromOriginalCumTimes,c=SplitsBrowser.Model.Competitor,s=SplitsBrowser.Model.CourseClass,C=SplitsBrowser.Model.Course,l=SplitsBrowser.Model.Event,p=[";",",","\t","\\"],f={};[44,46,60].forEach(function(t){f[t]={course:t-7,distance:t-6,climb:t-5,controlCount:t-4,placing:t-3,startPunch:t-2,finish:t-1,control1:t}}),[44,46].forEach(function(t){f[t].nonCompetitive=t-38,f[t].startTime=t-37,f[t].time=t-35,f[t].classifier=t-34,f[t].club=t-31,f[t].className=t-28}),f[44].combinedName=3,f[44].yearOfBirth=4,f[46].forename=4,f[46].surname=3,f[46].yearOfBirth=5,f[46].gender=6,f[60].forename=6,f[60].surname=5,f[60].yearOfBirth=7,f[60].gender=8,f[60].combinedName=3,f[60].nonCompetitive=10,f[60].startTime=11,f[60].time=13,f[60].classifier=14,f[60].club=20,f[60].className=26,f[60].classNameFallback=f[60].course,f[60].clubFallback=18;function d(t){return t='"'===t[0]&&'"'===t[t.length-1]?t.substring(1,t.length-1).replace(/""/g,'"').trim():t}function g(t){this.data=e(t),this.classes=d3.map(),this.courseDetails=d3.map(),this.classCoursePairs=[],this.columnIndexes=null,this.warnings=[]}g.prototype.identifyDelimiter=function(){this.lines.length<=1&&r("No data found to read");for(var t=this.lines[1],e=0;e<p.length;e+=1){var s=p[e];if(37<t.split(s).length)return s}r("Data appears not to be in the OE CSV format")},g.prototype.identifyFormatVariation=function(t){var e=this.lines[1].split(t),s=/^[A-Za-z0-9]{1,10}$/;for(n in f)if(u(f,n)){var n=parseInt(n,10);if(n<e.length&&s.test(e[n])&&(""===e[n-2].trim()||null!==m(e[n-2]))&&(""===e[n-1].trim()||null!==m(e[n-1])))if(""!==e[f[n].controlCount].trim())return void(this.columnIndexes=f[n])}r("Did not find control 1 at any of the supported indexes")},g.prototype.getClassName=function(t){var e=t[this.columnIndexes.className];return e=""===e&&u(this.columnIndexes,"classNameFallback")?t[this.columnIndexes.classNameFallback]:e},g.prototype.getStartTime=function(t){var e=t[this.columnIndexes.startPunch];return""===e&&(e=t[this.columnIndexes.startTime]),m(e)},g.prototype.getNumControls=function(t,e){var s,n=this.getClassName(t);return""===n.trim()?(s=this.getName(t)||"<name unknown>",this.warnings.push("Could not find a class for competitor '"+s+"' (line "+e+")"),null):this.classes.has(n)?this.classes.get(n).numControls:(n=parseInt(t[this.columnIndexes.controlCount],10),isFinite(n)?n:(s=this.getName(t)||"<name unknown>",this.warnings.push("Could not read the control count '"+t[this.columnIndexes.controlCount]+"' for competitor '"+s+"' from line "+e),null))},g.prototype.readCumulativeTimes=function(t,e,s){for(var n=[0],r=0;r<s;r+=1){var i=this.columnIndexes.control1+1+2*r,i=i<t.length?t[i]:null,i=null===i?null:m(i);n.push(i)}var o,l,a=m(t[this.columnIndexes.time]);return null===a&&(o=this.getStartTime(t),l=m(t[this.columnIndexes.finish]),null!==o&&null!==l&&(a=l-o)),n.push(a),n},g.prototype.createClassIfNecessary=function(t,e){t=this.getClassName(t);this.classes.has(t)||this.classes.set(t,{numControls:e,results:[]})},g.prototype.createCourseIfNecessary=function(e,t){var s=e[this.columnIndexes.course];this.courseDetails.has(s)||(t=d3.range(0,t).map(function(t){return e[this.columnIndexes.control1+2*t]},this),this.courseDetails.set(s,{length:i(e[this.columnIndexes.distance]),climb:o(e[this.columnIndexes.climb]),controls:t}))},g.prototype.createClassCoursePairIfNecessary=function(t){var e=this.getClassName(t),s=t[this.columnIndexes.course];this.classCoursePairs.some(function(t){return t[0]===e&&t[1]===s})||this.classCoursePairs.push([e,s])},g.prototype.getName=function(t){var e="";return e=""===(e=u(this.columnIndexes,"forename")&&u(this.columnIndexes,"surname")?(t[this.columnIndexes.forename]+" "+t[this.columnIndexes.surname]).trim():e)&&u(this.columnIndexes,"combinedName")?t[this.columnIndexes.combinedName]:e},g.prototype.addCompetitor=function(t,e){var s=this.getClassName(t),n=t[this.columnIndexes.placing],r=t[this.columnIndexes.club],i=(""===r&&u(this.columnIndexes,"clubFallback")&&(r=t[this.columnIndexes.clubFallback]),this.getStartTime(t)),o=this.getName(t),l=""!==n&&a(parseInt(n,10)),n=(l&&o.substring(o.length-n.length)===n&&(o=o.substring(0,o.length-n.length).trim()),this.classes.get(s).results.length+1),o=new c(o,r),r=t[this.columnIndexes.yearOfBirth],r=(""!==r&&(r=parseInt(r,10),a(r)||o.setYearOfBirth(r)),!u(this.columnIndexes,"gender")||"M"!==(r=t[this.columnIndexes.gender])&&"F"!==r||o.setGender(r),h(n,i,e,o)),n=(("1"===t[this.columnIndexes.nonCompetitive]||l)&&r.completed()&&r.setNonCompetitive(),t[this.columnIndexes.classifier]);""!==n?"0"===n&&0<=e.indexOf(null)&&null!==e[e.length-1]?r.setOKDespiteMissingTimes():"1"===n?r.setNonStarter():"2"===n?r.setNonFinisher():"4"===n?r.disqualify():"5"===n&&r.setOverMaxTime():r.hasAnyTimes()||r.setNonStarter(),this.classes.get(s).results.push(r)},g.prototype.readLine=function(t,e,s){""!==t.trim()&&((t=t.split(s).map(function(t){return t.trim()}).map(d)).length<37&&n("Too few items on line "+e+" of the input file: expected at least 37, got "+t.length),null!==(s=this.getNumControls(t,e))&&(e=this.readCumulativeTimes(t,e,s),this.createClassIfNecessary(t,s),this.createCourseIfNecessary(t,s),this.createClassCoursePairIfNecessary(t),this.addCompetitor(t,e)))},g.prototype.getMapsBetweenClassesAndCourses=function(){var s=d3.map(),n=d3.map();return this.classCoursePairs.forEach(function(t){var e=t[0],t=t[1];s.has(e)?s.get(e).push(t):s.set(e,[t]),n.has(t)?n.get(t).push(e):n.set(t,[e])}),{classesToCourses:s,coursesToClasses:n}},g.prototype.createClasses=function(){var t=this.classes.keys();return t.sort(),t.map(function(t){var e=this.classes.get(t);return new s(t,e.numControls,e.results)},this)},g.prototype.createCourseFromLinkedClassesAndCourses=function(t,e,s,n){for(var r=[t],i=[],o=[],l=[];0<r.length||0<i.length;){for(;0<r.length;){for(var a=r.shift(),u=e.coursesToClasses.get(a),m=0;m<u.length;m+=1)h=u[m],i.indexOf(h)<0&&l.indexOf(h)<0&&i.push(h);o.push(a)}for(;0<i.length;){for(var h=i.shift(),c=e.classesToCourses.get(h),p=0;p<c.length;p+=1)a=c[p],r.indexOf(a)<0&&o.indexOf(a)<0&&r.push(a);l.push(h)}}o.forEach(function(t){s.add(t)});var f=l.map(function(t){return n.get(t)}),d=this.courseDetails.get(t),g=new C(t,f,d.length,d.climb,d.controls);return f.forEach(function(t){t.setCourse(g)}),g},g.prototype.determineCourses=function(t){var e=this.getMapsBetweenClassesAndCourses(),s=d3.set(),n=d3.map(),r=(t.forEach(function(t){n.set(t.name,t)}),[]);return e.coursesToClasses.keys().forEach(function(t){s.has(t)||(t=this.createCourseFromLinkedClassesAndCourses(t,e,s,n),r.push(t))},this),r},g.prototype.parseEventData=function(){this.warnings=[],this.lines=this.data.split(/\n/);var s=this.identifyDelimiter(),t=(this.identifyFormatVariation(s),this.lines.shift(),this.lines.forEach(function(t,e){this.readLine(t,e+1,s)},this),this.createClasses()),e=(0===t.length&&0<this.warnings.length&&r("This file may have looked vaguely like an OE CSV file but no data could be read out of it"),this.determineCourses(t));return new l(t,e,this.warnings)},SplitsBrowser.Input.OE={},SplitsBrowser.Input.OE.parseEventData=function(t){return new g(t).parseEventData()}}(),function(){"use strict";var a=SplitsBrowser.isNotNull,m=SplitsBrowser.throwInvalidData,n=SplitsBrowser.throwWrongFileFormat,e=SplitsBrowser.parseCourseLength,r=SplitsBrowser.normaliseLineEndings,h=SplitsBrowser.parseTime,s=SplitsBrowser.Model.Result.fromOriginalCumTimes,i=SplitsBrowser.Model.Competitor,u=SplitsBrowser.Model.CourseClass,c=SplitsBrowser.Model.Course,p=SplitsBrowser.Model.Event,o=/<[^>]{1,200}>/g,l=/([0-9.,]{1,10})\s{0,10}(?:Km|km)/,f=/(\d{1,10})\s{0,10}(?:Cm|Hm|hm|m)/;function d(t){return null!==t&&""!==t}function g(t){return""!==(t=t.trim())&&isFinite(t)}function C(t){return t.split(/\s+/g).filter(d)}function v(t){return t.replace(o,"")}function T(t,e){for(var s,n=[];null!==(s=t.exec(e));)n.push(v(s[1]));return n}function w(t){return T(/<font[^>]{0,100}>(.{0,100}?)<\/font>/g,t)}function S(t){return T(/<td[^>]{0,100}>(.{0,100}?)<\/td>/g,t).map(function(t){return t.trim()})}function y(t){return S(t).filter(function(t){return""!==t})}function N(t){t=l.exec(t);return null===t?null:e(t[1])}function b(t){t=f.exec(t);return null===t?null:parseInt(t[1],10)}function O(t){for(var e=[],s=0;s<t.length;s+=1){var n=t[s],r=n.indexOf("(");-1<r&&")"===n[n.length-1]?(r=n.substring(r+1,n.length-1),e.push(r)):s+1===t.length?e.push(null):m("Unrecognised control header label: '"+n+"'")}return e}function x(t,e){for(;0<e.length&&"*"===e[e.length-1][0];)e.splice(e.length-1,1),t.splice(t.length-1,1)}function I(t,e,s,n,r,i){this.name=t,this.club=e,this.className=s,this.totalTime=n,this.cumTimes=r,this.competitive=i}I.prototype.isContinuation=function(){return""===this.name&&""===this.club&&null===this.className&&""===this.totalTime&&!this.competitive},I.prototype.append=function(t){if(!t.isContinuation())throw new Error("Can only append a continuation CompetitorParseRecord");this.cumTimes=this.cumTimes.concat(t.cumTimes)},I.prototype.toResult=function(t){var e=[0].concat(this.cumTimes),t=s(t,null,e,new i(this.name,this.club));return t.completed()&&!this.competitive&&t.setNonCompetitive(),t.hasAnyTimes()||t.setNonStarter(),t};function t(){this.precedingColumnCount=null}function B(){this.timesOffset=null}function D(){this.usesClasses=!1}t.prototype.isTextOfThisFormat=function(t){return 0<=t.indexOf("<pre>")&&0<=t.indexOf("<font")},t.prototype.preprocess=function(t){var e=t.indexOf("<pre>");if(-1===e)throw new Error("Cannot find opening pre tag");var e=t.indexOf("\n",e),s=(t=(t=t.substring(e+1)).replace(/\n{2,}/g,"\n")).lastIndexOf("</pre>");return-1===s&&m("Found opening <pre> but no closing </pre>"),e=t.lastIndexOf("\n",s),(t=t.substring(0,e)).trim()},t.prototype.canIgnoreThisLine=function(t){return""===t},t.prototype.isCourseHeaderLine=function(t){return 2===w(t).length},t.prototype.parseCourseHeaderLine=function(t){t=w(t);if(2!==t.length)throw new Error("Course header line should have two parts");var e=t[0],t=t[1],s=e.indexOf("("),s=-1<s?e.substring(0,s):e,e=N(t),t=b(t);return{name:s.trim(),distance:e,climb:t}},t.prototype.parseControlsLine=function(t){var e=t.lastIndexOf("</font>");return O(C((-1===e?t:t.substring(e+"</font>".length)).trim()))},t.prototype.readCompetitorSplitDataLine=function(t){for(var e=0;e<this.precedingColumnCount;e+=1){var s=t.indexOf("</font>");t=t.substring(s+"</font>".length)}return C(v(t))},t.prototype.parseCompetitor=function(t,e){var s=w(t),n=w(e),r=(null===this.precedingColumnCount&&(r=s[1].trim(),this.precedingColumnCount=r.match(/^\d{0,10}$/)?4:3),g(s[0])),i=s[this.precedingColumnCount-2].trim(),s=s[this.precedingColumnCount-1].trim(),n=n[this.precedingColumnCount-2].trim(),o=this.readCompetitorSplitDataLine(t),e=this.readCompetitorSplitDataLine(e),e=(x(o=o.map(h),e),null);if(null!==i&&""!==i){for(var l=-1,a=0;a<this.precedingColumnCount;a+=1)l=t.indexOf("</font>",l+1);var u=C(t.substring(0,l+"</font>".length).replace(/<font[^>]{0,100}>(.{0,100}?)<\/font>/g,""));0<u.length&&(e=u[0])}return new I(i,n,e,s,o,r)},B.prototype.isTextOfThisFormat=function(t){for(var e=-1,s=0;s<5;s+=1)if(-1===(e=t.indexOf("<table",e+1)))return!1;return!0},B.prototype.preprocess=function(t){var e=t.indexOf("</table>"),e=(-1===e&&m("Could not find any closing </table> tags"),(t=t.substring(e+"</table>".length)).indexOf("</div>")),s=t.indexOf("<table"),s=(t=(t=(t=(t=(t=-1<e&&e<s?t.substring(e+"</div>".length):t).replace(/>\n{1,100}</g,"><").replace(/><tr>/g,">\n<tr>").replace(/<\/tr></g,"</tr>\n<").replace(/><table/g,">\n<table").replace(/<\/table></g,"</table>\n<")).replace(/<\/col[^>]{0,100}>/g,"")).replace(/<tr[^>]{0,100}><td[^>]{0,100}>(?:<nobr>)?&nbsp;?(?:<\/nobr>)?<\/td><\/tr>/g,"")).replace(/<a id="[^"]{0,100}"><\/a>/g,"")).indexOf('<div id="navigation">');return 0<=s&&(0<=(e=t.indexOf("</div>",s))&&(t=t.substring(0,s)+t.substring(e+6))),(t=t.replace("</body></html>","")).trim()},B.prototype.canIgnoreThisLine=function(t){var e;return-1<t.indexOf("<th>")?(e=T(/<th[^>]{0,100}>(.{0,100}?)<\/th>/g,t).filter(function(t){return""!==t}),
this.timesOffset=e.length,!0):""===t||-1<t.indexOf("<table")||-1<t.indexOf("</table>")},B.prototype.isCourseHeaderLine=function(t){return-1<t.indexOf('<td id="header"')},B.prototype.parseCourseHeaderLine=function(t){for(var e=y(t),t=(0===e.length&&m("No parts found in course header line"),e[0]),s=t.indexOf("("),n=(t=(t=-1<s?t.substring(0,s):t).trim(),null),r=null,i=1;i<e.length;i+=1)null===n&&(n=N(e[i])),null===r&&(r=b(e[i]));return{name:t,distance:n,climb:r}},B.prototype.parseControlsLine=function(t){return O(y(t))},B.prototype.readCompetitorSplitDataLine=function(t){for(var e=S(t),t=this.timesOffset,s=e.length;0<s&&""===e[s-1];)--s;return e.slice(t,s).filter(d)},B.prototype.parseCompetitor=function(t,e){var s=S(t),n=S(e),r=g(s[0]),i=3===this.timesOffset?1:2,o=s[i],l=s[this.timesOffset-1],n=n[i],i=5===this.timesOffset&&""!==o?s[3]:null,s=this.readCompetitorSplitDataLine(t),t=this.readCompetitorSplitDataLine(e),e=(x(s=s.map(h),t),s.filter(a).length);return e!==t.length&&m("Cumulative and split times do not have the same length: "+e+" cumulative times, "+t.length+" split times"),new I(o,n,i,l,s,r)};function M(t,e,s){this.name=t,this.distance=e,this.climb=s,this.controls=[],this.competitors=[]}function E(t){this.recognizer=t,this.courses=[],this.currentCourse=null,this.lines=null,this.linePos=-1,this.currentCompetitor=null}D.prototype.isTextOfThisFormat=function(t){var e=t.indexOf("<table");if(0<=e){e=t.indexOf("<table",e+1);if(0<=e)if(t.indexOf("<table",e+1)<0)return!0}return!1},D.prototype.preprocess=function(t){var e=t.indexOf("</table>");return-1===e&&m("Could not find any closing </table> tags"),0<=t.indexOf('<td colspan="25">')&&(this.usesClasses=!0),(t=(t=(t=(t=t.substring(e+"</table>".length)).replace(/<tr[^>]{0,100}><td colspan=[^>]{0,100}>&nbsp;<\/td><\/tr>/g,"")).replace(/\n{2,}/g,"\n")).replace("</body>","").replace("</html>","")).trim()},D.prototype.canIgnoreThisLine=function(t){return""===t||-1<t.indexOf("<table")||-1<t.indexOf("</table>")||-1<t.indexOf("<hr>")},D.prototype.isCourseHeaderLine=function(t){return-1<t.indexOf('<tr class="clubName"')},D.prototype.parseCourseHeaderLine=function(t){var e,s,t=y(t),t=(0===t.length&&m("No parts found in course header line"),t[0]),n=/^(.{0,100}?)\s{1,10}\((\d{1,10})m,\s{0,10}(\d{1,10})m\)$/.exec(t),t=null===n?(e=t,s=null):(e=n[1],s=parseInt(n[2],10)/1e3,parseInt(n[3],10));return{name:e.trim(),distance:s,climb:t}},D.prototype.parseControlsLine=function(t){return y(t).map(function(t){var e=t.indexOf("-");return-1===e?null:t.substring(e+1)})},D.prototype.readCompetitorSplitDataLine=function(t){for(var e=this.usesClasses?5:4,s=t.length;0<s&&""===t[s-1];)--s;for(var n=[],r=e;r<s;r+=2){var i=t[r];d(i)&&n.push(i)}return n},D.prototype.parseCompetitor=function(t,e){for(var s=S(t),n=S(e),t=g(s[0]),e=s[2],r=s[this.usesClasses?4:3],i=this.usesClasses&&""!==e?s[3]:null,o=n[2],l=this.usesClasses?5:4;l<s.length&&l<n.length;l+=2)""!==s[l]&&""===n[l]&&(n[l]="----");var a=this.readCompetitorSplitDataLine(s),u=this.readCompetitorSplitDataLine(n);return x(a=a.map(h),u),a.length!==u.length&&m("Cumulative and split times do not have the same length: "+a.length+" cumulative times, "+u.length+" split times"),new I(e,o,i,r,a,t)},M.prototype.addControls=function(t){this.controls=this.controls.concat(t)},M.prototype.hasAllControls=function(){return 0<this.controls.length&&null===this.controls[this.controls.length-1]},M.prototype.addCompetitor=function(t){if(t.competitive||t.cumTimes.length!==this.controls.length-1||t.cumTimes.push(null),null===h(t.totalTime)&&0===t.cumTimes.length)for(;t.cumTimes.length<this.controls.length;)t.cumTimes.push(null);t.cumTimes.length===this.controls.length?this.competitors.push(t):m("Competitor '"+t.name+"' should have "+this.controls.length+" cumulative times, but has "+t.cumTimes.length+" times")},E.prototype.tryGetLine=function(){return this.linePos+1<this.lines.length?(this.linePos+=1,this.lines[this.linePos]):null},E.prototype.addCurrentCompetitorIfNecessary=function(){null!==this.currentCompetitor&&(this.currentCourse.addCompetitor(this.currentCompetitor),this.currentCompetitor=null)},E.prototype.addCurrentCompetitorAndCourseIfNecessary=function(){this.addCurrentCompetitorIfNecessary(),null!==this.currentCourse&&this.courses.push(this.currentCourse)},E.prototype.readCompetitorLines=function(t){var e=this.tryGetLine(),t=(null===e&&m("Hit end of input data unexpectedly while parsing competitor: first line was '"+t+"'"),this.recognizer.parseCompetitor(t,e));t.isContinuation()?null===this.currentCompetitor?m("First row of competitor data has no name nor time"):this.currentCompetitor.append(t):(this.addCurrentCompetitorIfNecessary(),this.currentCompetitor=t)},E.prototype.areClassesUniqueWithinCourses=function(){for(var t=d3.map(),e=0;e<this.courses.length;e+=1)for(var s=this.courses[e],n=0;n<s.competitors.length;n+=1){var r=s.competitors[n];if(t.has(r.className)){if(t.get(r.className)!==s.name)return!1}else t.set(r.className,s.name)}return!0},E.prototype.createOverallEventObject=function(){var s=this.areClassesUniqueWithinCourses(),t=[],o=[],l=this.courses.every(function(t){return t.competitors.every(function(t){return a(t.className)})});return this.courses.forEach(function(n){var r=d3.map(),i=(n.competitors.forEach(function(t){var e=l&&s?t.className:n.name;r.has(e)?r.get(e).push(t):r.set(e,[t])}),[]),e=(r.keys().forEach(function(t){var e=n.controls.length-1,s=r.get(t).map(function(t,e){return t.toResult(e+1)}),t=new u(t,e,s);i.push(t),o.push(t)},this),new c(n.name,i,n.distance,n.climb,n.controls.slice(0,n.controls.length-1)));t.push(e),i.forEach(function(t){t.setCourse(e)})},this),new p(o,t,[])},E.prototype.parse=function(t){for(this.lines=t.split("\n");;){var e,s=this.tryGetLine();if(null===s)break;this.recognizer.canIgnoreThisLine(s)||(this.recognizer.isCourseHeaderLine(s)?(this.addCurrentCompetitorAndCourseIfNecessary(),e=this.recognizer.parseCourseHeaderLine(s),this.currentCourse=new M(e.name,e.distance,e.climb)):null!==this.currentCourse&&(this.currentCourse.hasAllControls()?this.readCompetitorLines(s):(e=this.recognizer.parseControlsLine(s),this.currentCourse.addControls(e))))}return this.addCurrentCompetitorAndCourseIfNecessary(),0===this.courses.length&&m("No competitor data was found"),this.createOverallEventObject()};var L=[t,B,D];SplitsBrowser.Input.Html={},SplitsBrowser.Input.Html.parseEventData=function(t){t=r(t);for(var e=0;e<L.length;e+=1){var s=new L[e];if(s.isTextOfThisFormat(t))return t=s.preprocess(t),new E(s).parse(t)}n("No HTML recognizers recognised this as HTML they could parse")}}(),function(){"use strict";var n=SplitsBrowser.throwWrongFileFormat,r=SplitsBrowser.normaliseLineEndings,a=SplitsBrowser.parseTime,l=SplitsBrowser.parseCourseLength,u=SplitsBrowser.parseCourseClimb,m=SplitsBrowser.Model.Result.fromOriginalCumTimes,h=SplitsBrowser.Model.Competitor,o=SplitsBrowser.Model.CourseClass,c=SplitsBrowser.Model.Course,i=SplitsBrowser.Model.Event,e={controlsOffset:38,step:3,name:3,club:5,courseName:7,startTime:8,length:null,climb:null,placing:null,finishTime:null,allowMultipleCompetitorNames:!0},p=[",",";"],f=/^[A-Za-z0-9]{1,10}$/;function d(t){for(var e=t.length-1;0<=e&&""===t[e];)--e;t.splice(e+1,t.length-e-1)}function s(t){this.format=t,this.classes=d3.map(),this.delimiter=null,this.hasAnyStarters=!1,this.warnings=[],this.controlsTerminationOffset=null===t.finishTime?t.step:0}s.prototype.determineDelimiter=function(t){for(var e=0;e<p.length;e+=1){var s=p[e],n=t.split(s);if(d(n),n.length>this.format.controlsOffset)return s}return null},s.prototype.adjustLinePartsForMultipleCompetitors=function(t){if(this.format.allowMultipleCompetitorNames)for(;t.length>this.format.name+1&&t[this.format.name+1].match(/^\s\S/);)t[this.format.name]+=","+t[this.format.name+1],t.splice(this.format.name+1,1)},s.prototype.checkControlCodesAlphaNumeric=function(t){var e=t.split(this.delimiter);d(e),this.adjustLinePartsForMultipleCompetitors(e,this.format);for(var s=this.format.controlsOffset;s+this.controlsTerminationOffset<e.length;s+=this.format.step)f.test(e[s])||n("Data appears not to be in an alternative CSV format - data in cell "+s+" of the first row ('"+e[s]+"') is not an number")},s.prototype.addResultToCourse=function(t,e,s){if(this.classes.has(e)){var n=this.classes.get(e),r=t.getAllOriginalCumulativeTimes();r.length-1!==n.controls.length+1?this.warnings.push("Competitor '"+t.owner.name+"' has the wrong number of splits for course '"+e+"': expected "+(n.controls.length+1)+", actual "+(r.length-1)):n.results.push(t)}else{for(var i=[],o=this.format.controlsOffset;o+this.controlsTerminationOffset<s.length;o+=this.format.step)i.push(s[o]);r=null===this.format.length?null:l(s[this.format.length]),n=null===this.format.climb?null:u(s[this.format.climb]);this.classes.set(e,{length:r,climb:n,controls:i,results:[t]})}},s.prototype.readDataRow=function(t){var e=t.split(this.delimiter);if(d(e),this.adjustLinePartsForMultipleCompetitors(e),!(e.length<this.format.controlsOffset)){for(;(e.length-this.format.controlsOffset)%this.format.step!=0;)e.push("");for(var s,t=e[this.format.name],n=e[this.format.club],r=e[this.format.courseName],i=a(e[this.format.startTime]),o=[0],l=this.format.controlsOffset+1;l<e.length;l+=this.format.step)o.push(a(e[l]));null!==this.format.finishTime&&(s=a(e[this.format.finishTime]),o.push(null===i||null===s?null:s-i)),1===o.length?""!==t&&this.warnings.push("Competitor '"+t+"' on course '"+(""===r?"(unnamed)":r)+"' has no times recorded"):(s=this.classes.has(r)?this.classes.get(r).results.length+1:1,s=m(s,i,o,new h(t,n)),null!==this.format.placing&&s.completed()&&!e[this.format.placing].match(/^\d{1,10}$/)&&s.setNonCompetitive(),s.hasAnyTimes()?this.hasAnyStarters=!0:s.setNonStarter(),this.addResultToCourse(s,r,e))}},s.prototype.createClassesAndCourses=function(){var r=[],i=d3.map(),s=(this.classes.entries().forEach(function(t){var e=t.key,t=t.value,s=new o(e,t.controls.length,t.results),n=(r.push(s),t.controls.join(","));i.has(n)?i.get(n).classes.push(s):i.set(n,{name:e,classes:[s],length:t.length,climb:t.climb,controls:t.controls})}),[]);return i.values().forEach(function(t){var e=new c(t.name,t.classes,t.length,t.climb,t.controls);t.classes.forEach(function(t){t.setCourse(e)}),s.push(e)}),{classes:r,courses:s}},s.prototype.parseEventData=function(t){this.warnings=[];var e=(t=r(t)).split(/\n/),t=(e.length<2&&n("Data appears not to be in an alternative CSV format - too few lines"),e[1]);this.delimiter=this.determineDelimiter(t),null===this.delimiter&&n("Data appears not to be in an alternative CSV format - first data line has fewer than "+this.format.controlsOffset+" parts when separated by any recognised delimiter"),this.checkControlCodesAlphaNumeric(t);for(var s=1;s<e.length;s+=1)this.readDataRow(e[s]);t=this.createClassesAndCourses();return this.hasAnyStarters||n("Data appears not to be in an alternative CSV format - data apparently could be read but everyone was a non-starter"),new i(t.classes,t.courses,this.warnings)},SplitsBrowser.Input.AlternativeCSV={parseTripleColumnEventData:function(t){return new s(e).parseEventData(t)}}}(),function(){"use strict";var B=SplitsBrowser.throwInvalidData,r=SplitsBrowser.throwWrongFileFormat,D=SplitsBrowser.COMMON_CONTROLS_MODE,M=SplitsBrowser.determineCommonControls,o=SplitsBrowser.isNaNStrict,s=SplitsBrowser.parseTime,h=SplitsBrowser.Model.Result.fromOriginalCumTimes,E=SplitsBrowser.Model.Result.createTeamResult,c=SplitsBrowser.Model.Competitor,L=SplitsBrowser.Model.Team,p=SplitsBrowser.Model.CourseClass,F=SplitsBrowser.Model.Course,f=SplitsBrowser.Model.Event;function i(t){return void 0===t}var d=/^\d{4}/,t={isOfThisVersion:function(t){return 0<=t.indexOf("IOFdata.dtd")},checkVersion:function(t){var e=$("> IOFVersion",t),e=(0===e.length?r("Could not find IOFVersion element"):i(e=e.attr("version"))?r("Version attribute missing from IOFVersion element"):"2.0.3"!==e&&r("Found unrecognised IOF XML data format '"+e+"'"),t.attr("status"));i(e)||"complete"===e.toLowerCase()||B("Only complete IOF data supported; snapshot and delta are not supported")},readClassName:function(t){return $("> ClassShortName",t).text()},readTeamName:function(t){return $("> TeamName",t).text()},readTeamMemberResults:function(t){return $("> PersonResult",t)},readCourseFromClass:function(t,e){var s,n=$("> ClassShortName",t).text(),t=$("> PersonResult > Result",t).first(),r=null;return 0<t.length&&(0<(s=(t=$("> CourseLength",t)).text()).length&&(r=parseFloat(s),isFinite(r)?i(t=t.attr("unit"))||"m"===t?r/=1e3:"km"!==t&&("ft"===t?r/=3280:(e.push("Course '"+n+"' gives its length in a unit '"+t+"', but this unit was not recognised"),r=null)):(e.push("Course '"+n+"' specifies a course length that was not understood: '"+s+"'"),r=null))),{id:null,name:n,length:r,climb:null,numberOfControls:null}},getCompetitorNameElement:function(t){return $("> Person > PersonName",t)},readClubName:function(t){var e=$("> Club > ShortName",t).text();return""===e?$("> Club > Name",t).text():e},readDateOfBirth:function(t){return $("> Person > BirthDate > Date",t).text()},readStartTime:function(t){t=$("> StartTime > Clock",t).text();return""===t?null:s(t)},readTotalTime:function(t){t=$("> Time",t).text();return""===t?null:s(t)},getStatus:function(t){t=$("> CompetitorStatus",t);return 1===t.length?t.attr("value"):""},StatusNonCompetitive:"NotCompeting",StatusNonStarter:"DidNotStart",StatusNonFinisher:"DidNotFinish",StatusDisqualified:"Disqualified",StatusOverMaxTime:"OverTime",isAdditional:function(){return!1},readSplitTime:function(t){var e=$("> ControlCode",t).text(),t=(""===(e=""===e?$("> Control > ControlCode",t).text():e)&&B("Control code missing for control"),$("> Time",t).text());return{code:e,time:""===t?null:s(t)}}},e=/^\d\d\d\d-?\d\d-?\d\dT?(\d\d):?(\d\d)(?::?(\d\d))?/,n={isOfThisVersion:function(t){return 0<=t.indexOf("http://www.orienteering.org/datastandard/3.0")},checkVersion:function(t){var e=t.attr("iofVersion"),e=(i(e)?r("Could not find IOF version number"):"3.0"!==e&&r("Found unrecognised IOF XML data format '"+e+"'"),t.attr("status"));i(e)||"complete"===e.toLowerCase()||B("Only complete IOF data supported; snapshot and delta are not supported")},readClassName:function(t){return $("> Class > Name",t).text()},readTeamName:function(t){return $("> Name",t).text()},readTeamMemberResults:function(t){return $("> TeamMemberResult",t)},readCourseFromClass:function(t,e){var s,t=$("> Course",t),n=$("> Id",t).text()||null,r=$("> Name",t).text(),i=$("> Length",t).text(),e=(""===i?s=null:(s=parseInt(i,10),o(s)?(e.push("Course '"+r+"' specifies a course length that was not understood: '"+i+"'"),s=null):s/=1e3),$("> NumberOfControls",t).text()),i=parseInt(e,10),e=(o(i)&&(i=null),$("> Climb",t).text()),t=parseInt(e,10);return{id:n,name:r,length:s,climb:t=o(t)?null:t,numberOfControls:i}},getCompetitorNameElement:function(t){return $("> Person > Name",t)},readClubName:function(t){var e=$("> Organisation > ShortName",t).text();return""===e?$("> Organisation > Name",t).text():e},readDateOfBirth:function(t){t=$("> Person > BirthDate",t).text(),t=d.exec(t);return null===t?null:parseInt(t[0],10)},readStartTime:function(t){t=$("> StartTime",t).text(),t=e.exec(t);return null===t?null:60*parseInt(t[1],10)*60+60*parseInt(t[2],10)+(i(t[3])?0:parseInt(t[3],10))},readTime:function(t){t=parseFloat(t);return isFinite(t)?t:null},readTotalTime:function(t){t=$("> Time",t).text();return n.readTime(t)},getStatus:function(t){return $("> Status",t).text()},StatusNonCompetitive:"NotCompeting",StatusNonStarter:"DidNotStart",StatusNonFinisher:"DidNotFinish",StatusDisqualified:"Disqualified",StatusOverMaxTime:"OverTime",isAdditional:function(t){return"Additional"===t.attr("status")},readSplitTime:function(t){var e=$("> ControlCode",t).text();return""===e&&B("Control code missing for control"),{code:e,time:"Missing"===t.attr("status")||""===(e=$("> Time",t).text())?null:n.readTime(e)}}},g=[t,n];function R(t,e,s,n){var t=$(t),r=s.getCompetitorNameElement(t),i=(r=r,i=$("> Given",r).text(),r=$("> Family",r).text(),""===i?r:""===r?i:i+" "+r);if(""===i)return n.push("Could not find a name for a competitor"),null;var r=s.readClubName(t),o=s.readDateOfBirth(t),o=d.exec(o),o=null===o?null:parseInt(o[0],10),l=$("> Person",t).attr("sex"),t=$("Result",t);if(0===t.length)return n.push("Could not find any result information for competitor '"+i+"'"),null;var n=s.readStartTime(t),a=s.readTotalTime(t),u=s.getStatus(t),t=$("> SplitTime",t).toArray().filter(function(t){return!s.isAdditional($(t))}).map(function(t){return s.readSplitTime($(t))}),m=t.map(function(t){return t.code}),t=t.map(function(t){return t.time}),i=(t.unshift(0),t.push(u===s.StatusNonStarter?null:a),new c(i,r)),r=(null!==o&&i.setYearOfBirth(o),"M"!==l&&"F"!==l||i.setGender(l),h(e,n,t,i));return"OK"===u&&null!==a&&0<=t.indexOf(null)?r.setOKDespiteMissingTimes():u===s.StatusNonCompetitive?r.setNonCompetitive():u===s.StatusNonStarter?r.setNonStarter():u===s.StatusNonFinisher?r.setNonFinisher():u===s.StatusDisqualified?r.disqualify():u===s.StatusOverMaxTime&&r.setOverMaxTime(),{result:r,controls:m}}function C(t,e,s,n){var t=$(t),r={name:null,results:[],teamSize:null,controls:[],course:null},i=(r.course=e.readCourseFromClass(t,n),e.readClassName(t)),o=(r.name=i=""===i?"<unnamed class>":i,r.course.numbersOfControls=null,$("> PersonResult",t)),l=$("> TeamResult",t);if(0<o.length&&0<l.length)return n.push("Class '"+i+"' has a combination of relay teams and individual results"),null;if(0<o.length)for(var a=0;a<o.length;a+=1){v=C=g=d=f=u=p=c=h=m=u=void 0;var u=o[a],m=a+1,h=r,c=e,p=n;if(null!==(u=R(u,m,c,p))){var f=u.result,d=u.controls,g=(0!==h.results.length||f.isNonStarter&&0===d.length||(h.controls=d,null===h.course.numberOfControls&&(h.course.numberOfControls=h.controls.length)),f.getAllOriginalCumulativeTimes().length-2),C=null;if(!f.isNonStarter||0!=g)if(g!==h.course.numberOfControls)C="Competitor '"+f.owner.name+"' in class '"+h.name+"' has an unexpected number of controls: expected "+h.course.numberOfControls+", actual "+g;else for(var v=0;v<g;v+=1)if(h.controls[v]!==d[v]){C="Competitor '"+f.owner.name+"' has an unexpected control code at control "+(v+1)+": expected '"+h.controls[v]+"', actual '"+d[v]+"'";break}null===C?h.results.push(f):p.push(C)}}else{if(!(0<l.length))return n.push("Class '"+i+"' has no competitors"),null;for(var T=[],w=0;w<l.length;w+=1)!function(t,e,s,n,r,i,o){var l=n.readTeamName(t),a=n.readClubName(t),u=n.readTeamMemberResults(t);if(0===u.length)i.push("Ignoring team "+(""===l?"(unnamed team)":l)+" with no members");else if(0===s.results.length&&1===u.length)i.push("Ignoring team "+(""===l?"(unnamed team)":l)+" with only a single member");else{for(var m=[],h=[],c=0;c<u.length;c+=1){var p=R(u[c],e,n,i);if(null===p)return;m.push(p.result),h.push(p.controls)}for(c=1;c<u.length;c+=1){var f=$("> Result > FinishTime",u[c-1]).text(),d=$("> Result > StartTime",u[c]).text();if(!m[c].isNonStarter&&f!==d)return i.push("In team "+(""===l?"(unnamed team)":l)+" in class '"+s.name+"', "+m[c-1].owner.name+" does not finish at the same time as "+m[c].owner.name+" starts")}t=h.map(function(t){return t.length});if(0===s.results.length&&(s.teamSize=m.length,null===s.course.numbersOfControls&&(s.course.numbersOfControls=t)),m.length!==s.teamSize)i.push("Team "+(""===l?"(unnamed team)":"'"+l+"'")+" in class '"+s.name+"' has an unexpected number of members: expected "+s.teamSize+" but was actually "+m.length);else{var g=null,t=E(e,m,new L(l,a));if(r!==D)for(var C=0;C<m.length;C+=1){var v=s.course.numbersOfControls[C],T=m[C],w=T.getAllOriginalCumulativeTimes().length-2;if(w!==v){g="Competitor '"+T.owner.name+"' in team '"+l+"' in class '"+s.name+"' has an unexpected number of controls: expected "+v+", actual "+w;break}}null===g?(s.results.push(t),r===D&&o.push(h)):i.push(g)}}}(l[w],w+1,r,e,s,n,T);if(s===D){var S=r,y=T;S.results.length!==y.length&&B("Different number of results and all-controls lists"),0===y.length&&B("Unexpected empty list of results for processing common controls");for(var N=y[0].length,b=[],O=0;O<N;O+=1)b.push(M(y.map(function(t){return t[O]}),"leg "+O+" of class "+S.name));for(var x=0;x<S.results.length;x+=1)S.results[x].restrictToCommonControls(y[x],b);for(var I=[],O=0;O<b.length;O+=1)I=I.concat(b[O]),O<b.length-1&&I.push(F.INTERMEDIATE);S.controls=I,S.course.numbersOfControls=b.map(function(t){return t.length})}}return null===r.course.id&&0<r.controls.length&&(r.course.id=r.controls.join(",")),r}SplitsBrowser.Input.IOFXml={parseEventData:function(t,i){var e,o=function(t){for(var e=0;e<g.length;e+=1){var s=g[e];if(s.isOfThisVersion(t))return s}r("Data apparently not of any recognised IOF XML format")}(t),t=function(t){try{return $.parseXML(t)}catch(t){B("XML data not well-formed")}}(t),s=(e=t,n=o,"ResultList"!==(s=(e=$("> *",t)).prop("tagName"))&&r("Root element of XML document does not have expected name 'ResultList', got '"+s+"'"),n.checkVersion(e),$("> ResultList > ClassResult",$(t)).toArray()),l=(0===s.length&&B("No class result elements found"),[]),a=[],u=d3.map(),m=[],n=(s.forEach(function(t){var e,s,n,r,t=C(t,o,i,m);null!==t&&(e=t.course,n=null!==t.teams&&null!==t.course.numbersOfControls&&0<t.course.numbersOfControls.length?(r=t.course.numbersOfControls.reduce(function(t,e){return t+e},0)+t.teamSize-1,i!==D&&(t.controls=null),!(s=null)):(r=t.controls.length,s=e.id+","+t.controls.join(","),!1),r=new p(t.name,r,t.results),n&&r.setIsTeamClass(t.course.numbersOfControls),l.push(r),null!==e.id&&null!==s&&u.has(s)?u.get(s).classes.push(r):(e.classes=[r],e.controls=t.controls,a.push(e),null!==e.id&&u.set(s,e)))}),a.map(function(t){var e=new F(t.name,t.classes,t.length,t.climb,t.controls);return t.classes.forEach(function(t){t.setCourse(e)}),e}));return new f(l,n,m)}}}(),function(){"use strict";var r=[SplitsBrowser.Input.CSV.parseEventData,SplitsBrowser.Input.OE.parseEventData,SplitsBrowser.Input.Html.parseEventData,SplitsBrowser.Input.AlternativeCSV.parseTripleColumnEventData,SplitsBrowser.Input.IOFXml.parseEventData];SplitsBrowser.Input.parseEventData=function(t,e){for(var s=0;s<r.length;s+=1){var n=r[s];try{return n(t,e)}catch(t){if("WrongFileFormat"!==t.name)throw t}}return null}}();