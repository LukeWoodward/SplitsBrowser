/*!
 *  SplitsBrowser - Orienteering results analysis.
 *  
 *  Copyright (C) 2000-2013 Dave Ryder, Reinhard Balling, Andris Strazdins,
 *                          Ed Nash, Luke Woodward
 *
 *  This program is free software; you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation; either version 2 of the License, or
 *  (at your option) any later version.
 *
 *  This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License along
 *  with this program; if not, write to the Free Software Foundation, Inc.,
 *  51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
 */
var SplitsBrowser={Version:"3.2.5",Model:{},Input:{},Controls:{}};!function(){"use strict";function a(a){b||(c(a),b=!0)}var b=!1,c=function(a){window.alert(a)};SplitsBrowser.setMessageAlerter=function(a){c=a},SplitsBrowser.tryGetMessage=function(a,b){return SplitsBrowser.Messages&&SplitsBrowser.Messages.hasOwnProperty(a)?SplitsBrowser.getMessage(a):b},SplitsBrowser.getMessage=function(b){return SplitsBrowser.hasOwnProperty("Messages")?SplitsBrowser.Messages.hasOwnProperty(b)?SplitsBrowser.Messages[b]:(a("Message not found for key '"+b+"'"),"?????"):(a("No messages found.  Has a language file been loaded?"),"?????")},SplitsBrowser.getMessageWithFormatting=function(a,b){var c=SplitsBrowser.getMessage(a);for(var d in b)if(b.hasOwnProperty(d)){var e=d.replace(/([.+*?|{}()^$\[\]\\])/g,"\\$1");c=c.replace(new RegExp(e,"g"),b[d])}return c}}(),function(){"use strict";var a=500;SplitsBrowser.isTrue=function(a){return a},SplitsBrowser.isNotNull=function(a){return null!==a},SplitsBrowser.isNaNStrict=function(a){return a!==a},SplitsBrowser.isNotNullNorNaN=function(a){return null!==a&&a===a};var b=function(a){this.name="InvalidData",this.message=a};b.prototype.toString=function(){return this.name+": "+this.message},SplitsBrowser.throwInvalidData=function(a){throw new b(a)};var c=function(a){this.name="WrongFileFormat",this.message=a};c.prototype.toString=function(){return this.name+": "+this.message},SplitsBrowser.throwWrongFileFormat=function(a){throw new c(a)},SplitsBrowser.parseCourseLength=function(b){var c=parseFloat(b.replace(",","."));return c>=a&&(c/=1e3),c},SplitsBrowser.normaliseLineEndings=function(a){return a.replace(/\r\n/g,"\n").replace(/\r/g,"\n")}}(),function(){"use strict";SplitsBrowser.NULL_TIME_PLACEHOLDER="-----";var a=SplitsBrowser.isNaNStrict;SplitsBrowser.formatTime=function(b){if(null===b)return SplitsBrowser.NULL_TIME_PLACEHOLDER;if(a(b))return"???";var c="";0>b&&(c="-",b=-b);var d=Math.floor(b/3600),e=Math.floor(b/60)%60,f=b%60;return d>0&&(c+=d.toString()+":"),10>e&&(c+="0"),c+=e+":",10>f&&(c+="0"),c+=Math.round(f)},SplitsBrowser.parseTime=function(a){return a.match(/^\d+:\d\d$/)?60*parseInt(a.substring(0,a.length-3),10)+parseInt(a.substring(a.length-2),10):a.match(/^\d+:\d\d:\d\d$/)?3600*parseInt(a.substring(0,a.length-6),10)+60*parseInt(a.substring(a.length-5,a.length-3),10)+parseInt(a.substring(a.length-2),10):null}}(),function(){"use strict";function a(a,b){return null===a||null===b?null:a+b}function b(a,b){return null===a||null===b?null:a-b}function c(b){if(!$.isArray(b))throw new TypeError("Split times must be an array - got "+typeof b+" instead");0===b.length&&i("Array of split times must not be empty");for(var c=[0],d=0;d<b.length;d+=1)c.push(a(c[d],b[d]));return c}function d(a){if(!$.isArray(a))throw new TypeError("Cumulative times must be an array - got "+typeof a+" instead");0===a.length?i("Array of cumulative times must not be empty"):0!==a[0]?i("Array of cumulative times must have zero as its first item"):1===a.length&&i("Array of cumulative times must contain more than just a single zero");for(var c=[],d=0;d+1<a.length;d+=1)c.push(b(a[d+1],a[d]));return c}function e(a){for(var b=[],c=1;c+1<a.length;)if(h(a[c])){for(var d=c;d+1<a.length&&h(a[d+1]);)d+=1;d+1<a.length&&null!==a[c-1]&&null!==a[d+1]&&b.push({start:c-1,end:d+1}),c=d+1}else c+=1;return b}var f="number",g=SplitsBrowser.isNotNull,h=SplitsBrowser.isNaNStrict,i=SplitsBrowser.throwInvalidData,j=SplitsBrowser.getMessage;SplitsBrowser.Model.compareCompetitors=function(a,b){return a.totalTime===b.totalTime?a.order-b.order:null===a.totalTime?null===b.totalTime?0:1:null===b.totalTime?-1:a.totalTime-b.totalTime};var k=function(a,b,c,d,e,g){typeof a!==f&&i("Competitor order must be a number, got "+typeof a+" '"+a+"' instead"),this.order=a,this.name=b,this.club=c,this.startTime=d,this.isNonCompetitive=!1,this.className=null,this.originalSplitTimes=e,this.originalCumTimes=g,this.splitTimes=null,this.cumTimes=null,this.splitRanks=null,this.cumRanks=null,this.timeLosses=null,this.totalTime=null===g||g.indexOf(null)>-1?null:g[g.length-1]};k.prototype.setNonCompetitive=function(){this.isNonCompetitive=!0},k.prototype.setClassName=function(a){this.className=a},k.fromSplitTimes=function(a,b,d,e,f){var g=c(f),h=new k(a,b,d,e,f,g);return h.splitTimes=f,h.cumTimes=g,h},k.fromOriginalCumTimes=function(a,b,c,e,f){var g=d(f);return new k(a,b,c,e,g,f)},k.fromCumTimes=function(a,b,c,d,e){var f=k.fromOriginalCumTimes(a,b,c,d,e);return f.splitTimes=f.originalSplitTimes,f.cumTimes=f.originalCumTimes,f},k.prototype.setRepairedCumulativeTimes=function(a){this.cumTimes=a,this.splitTimes=d(a)},k.prototype.completed=function(){return null!==this.totalTime},k.prototype.getSuffix=function(){return this.completed()?this.isNonCompetitive?j("NonCompetitiveShort"):"":j("MispunchedShort")},k.prototype.getSplitTimeTo=function(a){return 0===a?0:this.splitTimes[a-1]},k.prototype.getOriginalSplitTimeTo=function(a){return 0===a?0:this.originalSplitTimes[a-1]},k.prototype.isSplitTimeDubious=function(a){return a>0&&this.originalSplitTimes[a-1]!==this.splitTimes[a-1]},k.prototype.getCumulativeTimeTo=function(a){return this.cumTimes[a]},k.prototype.getOriginalCumulativeTimeTo=function(a){return this.originalCumTimes[a]},k.prototype.isCumulativeTimeDubious=function(a){return this.originalCumTimes[a]!==this.cumTimes[a]},k.prototype.getSplitRankTo=function(a){return 0===a?null:this.splitRanks[a-1]},k.prototype.getCumulativeRankTo=function(a){return 0===a?null:this.cumRanks[a-1]},k.prototype.getTimeLossAt=function(a){return 0===a||null===this.timeLosses?null:this.timeLosses[a-1]},k.prototype.getAllCumulativeTimes=function(){return this.cumTimes},k.prototype.getAllOriginalCumulativeTimes=function(){return this.originalCumTimes},k.prototype.lacksStartTime=function(){return null===this.startTime&&this.splitTimes.some(g)},k.prototype.setSplitAndCumulativeRanks=function(a,b){this.splitRanks=a,this.cumRanks=b},k.prototype.getCumTimesAdjustedToReference=function(a){a.length!==this.cumTimes.length?i("Cannot adjust competitor times because the numbers of times are different ("+this.cumTimes.length+" and "+a.length+")"):a.indexOf(null)>-1&&i("Cannot adjust competitor times because a null value is in the reference data");var c=this.cumTimes.map(function(c,d){return b(c,a[d])});return c},k.prototype.getCumTimesAdjustedToReferenceWithStartAdded=function(b){var c=this.getCumTimesAdjustedToReference(b),d=this.startTime;return c.map(function(b){return a(b,d)})},k.prototype.getSplitPercentsBehindReferenceCumTimes=function(a){a.length!==this.cumTimes.length?i("Cannot determine percentages-behind because the numbers of times are different ("+this.cumTimes.length+" and "+a.length+")"):a.indexOf(null)>-1&&i("Cannot determine percentages-behind because a null value is in the reference data");var b=[0];return this.splitTimes.forEach(function(c,d){if(null===c)b.push(null);else{var e=a[d+1]-a[d];e>0?b.push(100*(c-e)/e):b.push(null)}}),b},k.prototype.determineTimeLosses=function(a){if(this.completed())if(a.length!==this.splitTimes.length?i("Cannot determine time loss of competitor with "+this.splitTimes.length+" split times using "+a.length+" fastest splits"):a.some(h)&&i("Cannot determine time loss of competitor when there is a NaN value in the fastest splits"),a.some(function(a){return 0===a}))this.timeLosses=this.splitTimes.map(function(){return 0/0});else if(this.splitTimes.some(h))this.timeLosses=this.splitTimes.map(function(){return 0/0});else{var b=this.splitTimes.map(function(b,c){return b/a[c]});b.sort(d3.ascending);var c;if(1===b.length%2)c=b[(b.length-1)/2];else{var d=b.length/2;c=(b[d-1]+b[d])/2}this.timeLosses=this.splitTimes.map(function(b,d){return Math.round(b-a[d]*c)})}},k.prototype.crosses=function(a){a.cumTimes.length!==this.cumTimes.length&&i("Two competitors with different numbers of controls cannot cross");for(var b=!1,c=!1,d=0;d<this.cumTimes.length;d+=1)if(null!==this.cumTimes[d]&&null!==a.cumTimes[d]){var e=this.startTime+this.cumTimes[d],f=a.startTime+a.cumTimes[d];f>e?b=!0:e>f&&(c=!0)}return b&&c},k.prototype.getControlIndexesAroundDubiousCumulativeTimes=function(){return e(this.cumTimes)},k.prototype.getControlIndexesAroundDubiousSplitTimes=function(){return e([0].concat(this.splitTimes))},SplitsBrowser.Model.Competitor=k}(),function(){"use strict";var a=SplitsBrowser.isNotNullNorNaN,b=SplitsBrowser.throwInvalidData,c=function(a,b,c){this.name=a,this.numControls=b,this.competitors=c,this.course=null,this.hasDubiousData=!1,this.competitors.forEach(function(b){b.setClassName(a)})};c.prototype.recordHasDubiousData=function(){this.hasDubiousData=!0},c.prototype.determineTimeLosses=function(){var a=d3.range(1,this.numControls+2).map(function(a){var b=this.getFastestSplitTo(a);return null===b?null:b.split},this);this.competitors.forEach(function(b){b.determineTimeLosses(a)})},c.prototype.isEmpty=function(){return 0===this.competitors.length},c.prototype.setCourse=function(a){this.course=a},c.prototype.getFastestSplitTo=function(c){("number"!=typeof c||1>c||c>this.numControls+1)&&b("Cannot return splits to leg '"+c+"' in a course with "+this.numControls+" control(s)");var d=null,e=null;return this.competitors.forEach(function(b){var f=b.getSplitTimeTo(c);a(f)&&(null===d||d>f)&&(d=f,e=b)}),null===d?null:{split:d,name:e.name}},c.prototype.getCompetitorsAtControlInTimeRange=function(a,c,d){("number"!=typeof a||isNaN(a)||0>a||a>this.numControls+1)&&b("Control number must be a number between 0 and "+this.numControls+" inclusive");var e=[];return this.competitors.forEach(function(b){var f=b.getCumulativeTimeTo(a);if(null!==f&&null!==b.startTime){var g=f+b.startTime;g>=c&&d>=g&&e.push({name:b.name,time:g})}}),e},SplitsBrowser.Model.AgeClass=c}(),function(){"use strict";function a(a){0===a.length&&g("Cannot create an AgeClassSet from an empty set of competitors");var b=[],c=a[0].numControls;return a.forEach(function(a){a.numControls!==c&&g("Cannot merge age classes with "+c+" and "+a.numControls+" controls"),a.competitors.forEach(function(a){b.push(a)})}),b.sort(h),b}function b(a){var b=a.filter(f);b.sort(d3.ascending);var c=new d3.map;b.forEach(function(a,b){c.has(a)||c.set(a,b+1)});var d=a.map(function(a){return f(a)?c.get(a):a});return d}function c(a){for(var b=[],c=1;c+1<a.length;)if(f(a[c]))c+=1;else{for(var d=c;d+1<a.length&&!f(a[d+1]);)d+=1;d+1<a.length&&b.push({start:c-1,end:d+1}),c=d+1}return b}var d=SplitsBrowser.isNotNull,e=SplitsBrowser.isNaNStrict,f=SplitsBrowser.isNotNullNorNaN,g=SplitsBrowser.throwInvalidData,h=SplitsBrowser.Model.compareCompetitors,i=function(b){this.allCompetitors=a(b),this.ageClasses=b,this.numControls=b[0].numControls,this.computeRanks()};i.prototype.isEmpty=function(){return 0===this.allCompetitors.length},i.prototype.getCourse=function(){return this.ageClasses[0].course},i.prototype.getPrimaryClassName=function(){return this.ageClasses[0].name},i.prototype.getNumClasses=function(){return this.ageClasses.length},i.prototype.hasDubiousData=function(){return this.ageClasses.some(function(a){return a.hasDubiousData})};var j=function(a){a=a.slice(0);for(var b=c(a),d=0;d<b.length;d+=1)for(var f=b[d],g=a[f.start],h=a[f.end],i=(h-g)/(f.end-f.start),j=f.start+1;j<f.end;j+=1)a[j]=g+(j-f.start)*i;for(var k=a.length;k>=0&&e(a[k-1]);)k-=1;if(k>0)for(var l=k;l<a.length;l+=1)a[l]=a[l-1]+(l===a.length-1?60:180);return a};i.prototype.getWinnerCumTimes=function(){if(0===this.allCompetitors.length)return null;var a=this.allCompetitors[0];return a.completed()?j(a.cumTimes):null},i.prototype.getFastestCumTimes=function(){return this.getFastestCumTimesPlusPercentage(0)},i.prototype.getFastestCumTimesPlusPercentage=function(a){var b=1+a/100,e=new Array(this.numControls+1);e[0]=0;for(var g=1;g<=this.numControls+1;g+=1){for(var h=null,i=0;i<this.allCompetitors.length;i+=1){var j=this.allCompetitors[i].getSplitTimeTo(g);f(j)&&(null===h||h>j)&&(h=j)}e[g]=h}if(!e.every(d)){var k=c(e),l=[];this.allCompetitors.forEach(function(a){var b=c(a.getAllCumulativeTimes());b.forEach(function(b){l.push({start:b.start,end:b.end,size:b.end-b.start,overallSplit:a.getCumulativeTimeTo(b.end)-a.getCumulativeTimeTo(b.start)})})}),k.forEach(function(a){var b=l.filter(function(b){return b.start<=a.start&&a.end<=b.end+1}),c=null,d=null;if(b.forEach(function(a){(null===c||a.size<c)&&(c=a.size,d=null),(null===d||a.overallSplit<d)&&(d=a.overallSplit)}),null!==c&&null!==d)for(var f=a.start+1;f<a.end;f+=1)e[f]=d/c})}if(!e.every(d))for(var m=0;m<e.length;m+=1)null===e[m]&&(e[m]=m===e.length-1?60:180);var n=new Array(this.numControls+1);return e.forEach(function(a,c){n[c]=0===c?0:n[c-1]+a*b}),n},i.prototype.getCumulativeTimesForCompetitor=function(a){return j(this.allCompetitors[a].getAllCumulativeTimes())},i.prototype.computeRanks=function(){var a=[],c=[];this.allCompetitors.forEach(function(){a.push([]),c.push([])}),d3.range(1,this.numControls+2).forEach(function(c){var d=this.allCompetitors.map(function(a){return a.getSplitTimeTo(c)}),e=b(d);this.allCompetitors.forEach(function(b,c){a[c].push(e[c])})},this),d3.range(1,this.numControls+2).forEach(function(a){var d=this.allCompetitors.map(function(b,d){return a>1&&null===c[d][a-1-1]?null:b.getCumulativeTimeTo(a)}),e=b(d);this.allCompetitors.forEach(function(a,b){c[b].push(e[b])})},this),this.allCompetitors.forEach(function(b,d){b.setSplitAndCumulativeRanks(a[d],c[d])})},i.prototype.getFastestSplitsTo=function(a,b){if("number"!=typeof a||0>=a)g("The number of splits must be a positive integer");else{if(!("number"!=typeof b||0>=b||b>this.numControls+1)){var c=function(a,c){var d=a.getSplitTimeTo(b),e=c.getSplitTimeTo(b);return d===e?d3.ascending(a.totalTime,c.totalTime):d3.ascending(d,e)},d=this.allCompetitors.filter(function(a){return a.completed()&&!e(a.getSplitTimeTo(b))});d.sort(c);for(var f=[],h=0;h<d.length&&a>h;h+=1)f.push({name:d[h].name,split:d[h].getSplitTimeTo(b)});return f}g("Control "+b+" out of range")}},i.prototype.getChartData=function(a,b,c){if(this.isEmpty())g("Cannot return chart data when there is no data");else{if("undefined"==typeof a)throw new TypeError("referenceCumTimes undefined or missing");if("undefined"==typeof b)throw new TypeError("currentIndexes undefined or missing");if("undefined"==typeof c)throw new TypeError("chartType undefined or missing")}var d,e,f=this.allCompetitors.map(function(b){return c.dataSelector(b,a)}),h=b.map(function(a){return f[a]}),i=d3.min(a),j=d3.max(a);if(0===b.length){var k=f[0];d=d3.min(k),e=d3.max(k)}else d=d3.min(h.map(function(a){return d3.min(a)})),e=d3.max(h.map(function(a){return d3.max(a)}));e===d&&(e=d+1);var l=c.skipStart?1:0,m=b.map(function(a){var b=c.indexesAroundDubiousTimesFunc(this.allCompetitors[a]);return b.filter(function(a){return a.start>=l}).map(function(a){return{start:a.start-l,end:a.end-l}})},this),n=d3.transpose(h),o=c.skipStart?a.slice(1):a,p=d3.zip(o,n),q=b.map(function(a){return this.allCompetitors[a].name},this);return{dataColumns:p.map(function(a){return{x:a[0],ys:a[1]}}),competitorNames:q,numControls:this.numControls,xExtent:[i,j],yExtent:[d,e],dubiousTimesInfo:m}},SplitsBrowser.Model.AgeClassSet=i}(),function(){"use strict";var a=SplitsBrowser.throwInvalidData,b=function(a,b,c,d,e){this.name=a,this.classes=b,this.length=c,this.climb=d,this.controls=e};b.START="__START__",b.FINISH="__FINISH__";var c=b.START,d=b.FINISH;b.prototype.getOtherClasses=function(b){var c=this.classes.filter(function(a){return a!==b});return c.length!==this.classes.length?c:(a("Course.getOtherClasses: given class is not in this course"),void 0)},b.prototype.getNumClasses=function(){return this.classes.length},b.prototype.hasControls=function(){return null!==this.controls},b.prototype.getControlCode=function(b){return 0===b?c:b>=1&&b<=this.controls.length?this.controls[b-1]:b===this.controls.length+1?d:(a("Cannot get control code of control "+b+" because it is out of range"),void 0)},b.prototype.usesLeg=function(a,b){return this.getLegNumber(a,b)>=0},b.prototype.getLegNumber=function(a,b){if(null===this.controls)return-1;if(null===a&&null===b)return 0===this.controls.length?1:-1;if(a===c)return this.controls.length>0&&this.controls[0]===b?1:-1;if(b===d)return this.controls.length>0&&this.controls[this.controls.length-1]===a?this.controls.length+1:-1;for(var e=1;e<this.controls.length;e+=1)if(this.controls[e-1]===a&&this.controls[e]===b)return e+1;return-1},b.prototype.getFastestSplitsForLeg=function(b,e){null===this.legs&&a("Cannot determine fastest splits for a leg because leg information is not available");var f=this.getLegNumber(b,e);if(0>f){var g=(b===c?"start":b)+" to "+(e===d?"end":e);a("Leg from "+g+" not found in course "+this.name)}var h=f,i=[];return this.classes.forEach(function(a){var b=a.getFastestSplitTo(h);null!==b&&i.push({name:b.name,className:a.name,split:b.split})}),i},b.prototype.getCompetitorsAtControlInTimeRange=function(a,b,e){if(null===this.controls)return[];if(a===c)return this.getCompetitorsAtControlNumInTimeRange(0,b,e);if(a===d)return this.getCompetitorsAtControlNumInTimeRange(this.controls.length+1,b,e);var f=this.controls.indexOf(a);return f>=0?this.getCompetitorsAtControlNumInTimeRange(f+1,b,e):[]},b.prototype.getCompetitorsAtControlNumInTimeRange=function(a,b,c){var d=[];return this.classes.forEach(function(e){e.getCompetitorsAtControlInTimeRange(a,b,c).forEach(function(a){d.push({name:a.name,time:a.time,className:e.name})})}),d},b.prototype.hasControl=function(a){return null!==this.controls&&this.controls.indexOf(a)>-1},b.prototype.getNextControls=function(b){if(null===this.controls)a("Course has no controls");else if(b===d)a("Cannot fetch next control after the finish");else{if(b===c)return[this.controls[0]];for(var e=-1,f=[];;){var g=this.controls.indexOf(b,e+1);if(-1===g)break;g===this.controls.length-1?f.push(d):f.push(this.controls[g+1]),e=g}if(0!==f.length)return f;a("Control '"+b+"' not found on course "+this.name)}},SplitsBrowser.Model.Course=b}(),function(){"use strict";var a=SplitsBrowser.Model.Course,b=function(a,b){this.classes=a,this.courses=b};b.prototype.determineTimeLosses=function(){this.classes.forEach(function(a){a.determineTimeLosses()})},b.prototype.needsRepair=function(){return this.classes.some(function(a){return a.competitors.some(function(a){return null===a.getAllCumulativeTimes()})})},b.prototype.getFastestSplitsForLeg=function(a,b){var c=[];return this.courses.forEach(function(d){d.usesLeg(a,b)&&(c=c.concat(d.getFastestSplitsForLeg(a,b)))}),c.sort(function(a,b){return d3.ascending(a.split,b.split)}),c},b.prototype.getCompetitorsAtControlInTimeRange=function(a,b,c){var d=[];return this.courses.forEach(function(e){e.getCompetitorsAtControlInTimeRange(a,b,c).forEach(function(a){d.push(a)})}),d.sort(function(a,b){return d3.ascending(a.time,b.time)}),d},b.prototype.getNextControlsAfter=function(b){var c=this.courses;return b!==a.START&&(c=c.filter(function(a){return a.hasControl(b)})),c.map(function(a){return{course:a,nextControls:a.getNextControls(b)}})},SplitsBrowser.Model.Event=b}(),function(){function a(a){return null===a?null:a/60}function b(a){return a.getControlIndexesAroundDubiousCumulativeTimes()}function c(a){return a.getControlIndexesAroundDubiousSplitTimes()}SplitsBrowser.Model.ChartTypes={SplitsGraph:{nameKey:"SplitsGraphChartType",dataSelector:function(b,c){return b.getCumTimesAdjustedToReference(c).map(a)},skipStart:!1,yAxisLabelKey:"SplitsGraphYAxisLabel",isRaceGraph:!1,isResultsTable:!1,minViewableControl:1,indexesAroundDubiousTimesFunc:b},RaceGraph:{nameKey:"RaceGraphChartType",dataSelector:function(b,c){return b.getCumTimesAdjustedToReferenceWithStartAdded(c).map(a)},skipStart:!1,yAxisLabelKey:"RaceGraphYAxisLabel",isRaceGraph:!0,isResultsTable:!1,minViewableControl:0,indexesAroundDubiousTimesFunc:b},PositionAfterLeg:{nameKey:"PositionAfterLegChartType",dataSelector:function(a){return a.cumRanks},skipStart:!0,yAxisLabelKey:"PositionYAxisLabel",isRaceGraph:!1,isResultsTable:!1,minViewableControl:1,indexesAroundDubiousTimesFunc:b},SplitPosition:{nameKey:"SplitPositionChartType",dataSelector:function(a){return a.splitRanks},skipStart:!0,yAxisLabelKey:"PositionYAxisLabel",isRaceGraph:!1,isResultsTable:!1,minViewableControl:1,indexesAroundDubiousTimesFunc:c},PercentBehind:{nameKey:"PercentBehindChartType",dataSelector:function(a,b){return a.getSplitPercentsBehindReferenceCumTimes(b)},skipStart:!1,yAxisLabelKey:"PercentBehindYAxisLabel",isRaceGraph:!1,isResultsTable:!1,minViewableControl:1,indexesAroundDubiousTimesFunc:c},ResultsTable:{nameKey:"ResultsTableChartType",dataSelector:null,skipStart:!1,yAxisLabelKey:null,isRaceGraph:!1,isResultsTable:!0,minViewableControl:1,indexesAroundDubiousTimesFunc:null}}}(),function(){"use strict";var a="number",b=SplitsBrowser.throwInvalidData,c=function(c){typeof c!==a?b("Competitor count must be a number"):0>c&&b("Competitor count must be a non-negative number"),this.count=c,this.currentIndexes=[],this.changeHandlers=[]};c.prototype.isSelected=function(a){return this.currentIndexes.indexOf(a)>-1},c.prototype.isSingleRunnerSelected=function(){return 1===this.currentIndexes.length},c.prototype.selectCrossingRunners=function(a){if(this.isSingleRunnerSelected()){var b=a[this.currentIndexes[0]];a.forEach(function(a,c){a.crosses(b)&&this.currentIndexes.push(c)},this),this.currentIndexes.sort(d3.ascending),this.fireChangeHandlers()}},c.prototype.fireChangeHandlers=function(){this.changeHandlers.forEach(function(a){a(this.currentIndexes.slice(0))},this)},c.prototype.selectAll=function(){this.currentIndexes=d3.range(this.count),this.fireChangeHandlers()},c.prototype.selectNone=function(){this.currentIndexes=[],this.fireChangeHandlers()},c.prototype.registerChangeHandler=function(a){-1===this.changeHandlers.indexOf(a)&&this.changeHandlers.push(a)},c.prototype.deregisterChangeHandler=function(a){var b=this.changeHandlers.indexOf(a);b>-1&&this.changeHandlers.splice(b,1)},c.prototype.toggle=function(c){if(typeof c===a)if(c>=0&&c<this.count){var d=this.currentIndexes.indexOf(c);-1===d?(this.currentIndexes.push(c),this.currentIndexes.sort(d3.ascending)):this.currentIndexes.splice(d,1),this.fireChangeHandlers()}else b("Index '"+c+"' is out of range");else b("Index is not a number")},c.prototype.migrate=function(a,c){$.isArray(a)?$.isArray(c)?a.length!==this.count?b("CompetitorSelection.migrate: oldCompetitors list must have the same length as the current count"):0===c.length&&b("CompetitorSelection.migrate: newCompetitors list must not be empty"):b("CompetitorSelection.migrate: newCompetitors not an array"):b("CompetitorSelection.migrate: oldCompetitors not an array");var d=this.currentIndexes.map(function(b){return a[b]});this.count=c.length,this.currentIndexes=[],c.forEach(function(a,b){d.indexOf(a)>=0&&this.currentIndexes.push(b)},this),this.fireChangeHandlers()},SplitsBrowser.Model.CompetitorSelection=c}(),function(){"use strict";function a(a){(0===a.length||0!==a[0])&&e("cumulative times array does not start with a zero cumulative time");for(var b=0,c=1;c<a.length;c+=1){var f=a[c];if(d(f)){if(f<=a[b])return{first:b,second:c};b=c}}return null}function b(a){var b=new g;b.repairEventData(a)}function c(a){a.classes.forEach(function(a){a.competitors.forEach(function(a){a.setRepairedCumulativeTimes(a.getAllOriginalCumulativeTimes())})})}var d=SplitsBrowser.isNotNullNorNaN,e=SplitsBrowser.throwInvalidData,f=5,g=function(){this.madeAnyChanges=!1};g.prototype.removeCumulativeTimesEqualToPrevious=function(a){for(var b=a[0],c=1;c+1<a.length;c+=1)null!==a[c]&&a[c]===b?(a[c]=0/0,this.madeAnyChanges=!0):b=a[c]},g.prototype.removeCumulativeTimesCausingNegativeSplits=function(b){for(var c=a(b);null!==c&&c.second+1<b.length;){for(var e=c.first,f=c.second,g=!1,h=1;3>=h;h+=1){var i=b.slice();if(3!==h||1!==e&&d(b[e-1])){1===h?i[f]=0/0:2===h?i[e]=0/0:3===h&&(i[e]=0/0,i[e-1]=0/0);var j=a(i);if(null===j||j.first>f){g=!0,b=i,this.madeAnyChanges=!0,c=j;break}}else;}if(!g)break}return b},g.prototype.removeFinishTimeIfAbsurd=function(a){var b=a[a.length-1],c=a[a.length-2];d(b)&&d(c)&&c-60*f>=b&&(a[a.length-1]=0/0,this.madeAnyChanges=!0)},g.prototype.repairCompetitor=function(a){var b=a.originalCumTimes.slice(0);this.removeCumulativeTimesEqualToPrevious(b),b=this.removeCumulativeTimesCausingNegativeSplits(b),a.completed()||this.removeFinishTimeIfAbsurd(b),a.setRepairedCumulativeTimes(b)},g.prototype.repairAgeClass=function(a){this.madeAnyChanges=!1,a.competitors.forEach(function(a){this.repairCompetitor(a)},this),this.madeAnyChanges&&a.recordHasDubiousData()},g.prototype.repairEventData=function(a){a.classes.forEach(function(a){this.repairAgeClass(a)},this)},SplitsBrowser.DataRepair={repairEventData:b,transferCompetitorData:c}}(),function(){"use strict";function a(a,b,c){var d=b.split(",");if(d.length===c+5){var f=d.shift(),g=d.shift(),j=d.shift(),k=d.shift(),l=h(k);k.match(/^\d+:\d\d:\d\d$/)||(l*=60);var m=d.map(h);return i.fromSplitTimes(a+1,f+" "+g,j,l,m)}e("Expected "+(c+5)+" items in row for competitor in class with "+c+" controls, got "+d.length+" instead.")}function b(b){var c=b.split(/\r?\n/).filter(d);0===c.length&&e("parseAgeClass got an empty list of lines");var g=c.shift().split(",");if(2===g.length){var h=g.shift(),i=g.shift(),l=parseInt(i,10);if(isNaN(l))e("Could not read control count: '"+i+"'");else{if(!(0>l)){var m=c.map(function(b,c){return a(c,b,l)});return m.sort(j),new k(h,l,m)}e("Expected a positive control count, got "+l+" instead")}}else f("Expected first line to have two parts (class name and number of controls), got "+g.length+" part(s) instead")}function c(a){a=g(a),a=a.replace(/,+\n/g,"\n").replace(/,+$/,"");var c=a.split(/\n\n/).map($.trim).filter(d),f=c.map(b);f=f.filter(function(a){return!a.isEmpty()}),0===f.length&&e("No competitor data was found");for(var h=f.map(function(a){return new l(a.name,[a],null,null,null)}),i=0;i<f.length;i+=1)f[i].setCourse(h[i]);return new m(f,h)}var d=SplitsBrowser.isTrue,e=SplitsBrowser.throwInvalidData,f=SplitsBrowser.throwWrongFileFormat,g=SplitsBrowser.normaliseLineEndings,h=SplitsBrowser.parseTime,i=SplitsBrowser.Model.Competitor,j=SplitsBrowser.Model.compareCompetitors,k=SplitsBrowser.Model.AgeClass,l=SplitsBrowser.Model.Course,m=SplitsBrowser.Model.Event;SplitsBrowser.Input.CSV={parseEventData:c}}(),function(){"use strict";var a=SplitsBrowser.throwInvalidData,b=SplitsBrowser.throwWrongFileFormat,c=SplitsBrowser.parseCourseLength,d=SplitsBrowser.normaliseLineEndings,e=SplitsBrowser.parseTime,f=SplitsBrowser.Model.Competitor.fromOriginalCumTimes,g=SplitsBrowser.Model.AgeClass,h=SplitsBrowser.Model.Course,i=SplitsBrowser.Model.Event,j=[";",",","	","\\"],k={TIME:-35,CLUB:-31,AGE_CLASS:-28,COURSE:-7,DISTANCE:-6,CLIMB:-5,CONTROL_COUNT:-4,PLACING:-3,START:-2},l=37,m=function(a){this.data=d(a),this.ageClasses=d3.map(),this.courseDetails=d3.map(),this.classCoursePairs=[],this.anyCompetitors=!1,this.control1Index=null};m.prototype.identifyDelimiter=function(){this.lines.length<=1&&b("No data found to read");for(var a=this.lines[1],c=0;c<j.length;c+=1){var d=j[c];if(a.split(d).length>l)return d}b("Data appears not to be in the SI CSV format")},m.prototype.identifyFormatVariation=function(a){for(var c=this.lines[1].split(a),d=c.length-1;d>0&&""===$.trim(c[d]);)d-=1;var e,f=/^[A-Za-z0-9]+$/;for(f.test(c[d-1])?e=d-1:f.test(c[d])?e=d:b("Could not find control number in last two columns of first data line");e>=2&&f.test(c[e-2]);)e-=2;this.control1Index=e;var g=[44,46];null===this.control1Index?b("Unable to find index of control 1 in SI CSV data"):g.indexOf(this.control1Index)<0&&b("Unsupported index of control 1: "+this.control1Index)},m.prototype.getNumControls=function(b,c){var d=b[this.control1Index+k.AGE_CLASS];return""!==$.trim(d)?this.ageClasses.has(d)?this.ageClasses.get(d).numControls:parseInt(b[this.control1Index+k.CONTROL_COUNT],10):(a("Line "+c+" does not contain a class for the competitor"),void 0)},m.prototype.readCumulativeTimes=function(a,b,c){for(var d=[0],f=0;c>f;f+=1){var g=this.control1Index+1+2*f,h=g<a.length?a[g]:null,i=null===h?null:e(h);d.push(i)}var j=e(a[this.control1Index+k.TIME]);return d.push(j),d},m.prototype.createAgeClassIfNecessary=function(a,b){var c=a[this.control1Index+k.AGE_CLASS];this.ageClasses.has(c)||this.ageClasses.set(c,{numControls:b,competitors:[]})},m.prototype.createCourseIfNecessary=function(a,b){var d=a[this.control1Index+k.COURSE];if(!this.courseDetails.has(d)){var e=d3.range(0,b).map(function(b){return a[this.control1Index+2*b]},this);this.courseDetails.set(d,{length:c(a[this.control1Index+k.DISTANCE])||null,climb:parseInt(a[this.control1Index+k.CLIMB],10)||null,controls:e})}},m.prototype.createClassCoursePairIfNecessary=function(a){var b=a[this.control1Index+k.AGE_CLASS],c=a[this.control1Index+k.COURSE];this.classCoursePairs.some(function(a){return a[0]===b&&a[1]===c})||this.classCoursePairs.push([b,c])},m.prototype.addCompetitor=function(a,b){var c,d=a[this.control1Index+k.AGE_CLASS],g=a[this.control1Index+k.PLACING],h=a[this.control1Index+k.CLUB],i=e(a[this.control1Index+k.START]),j=""!==g&&isNaN(parseInt(g,10));if(46===this.control1Index){var l=a[4],m=a[3];j&&m.substring(m.length-g.length)===g&&(m=$.trim(m.substring(0,m.length-g.length))),c=l+" "+m}else{if(44!==this.control1Index)throw new Error("Unrecognised control-1 index: "+this.control1Index);c=a[3]}var n=this.ageClasses.get(d).competitors.length+1,o=f(n,c,h,i,b);j&&o.completed()&&o.setNonCompetitive(),this.ageClasses.get(d).competitors.push(o)},m.prototype.readLine=function(b,c,d){if(""!==$.trim(b)){var e=b.split(d);e.length<l&&a("Too few items on line "+c+" of the input file: expected at least "+l+", got "+e.length);var f=this.getNumControls(e,c),g=this.readCumulativeTimes(e,c,f);this.anyCompetitors=!0,this.createAgeClassIfNecessary(e,f),this.createCourseIfNecessary(e,f),this.createClassCoursePairIfNecessary(e),this.addCompetitor(e,g)}},m.prototype.getMapsBetweenClassesAndCourses=function(){var a=d3.map(),b=d3.map();return this.classCoursePairs.forEach(function(c){var d=c[0],e=c[1];a.has(d)?a.get(d).push(e):a.set(d,[e]),b.has(e)?b.get(e).push(d):b.set(e,[d])}),{classesToCourses:a,coursesToClasses:b}},m.prototype.createAgeClasses=function(){var a=this.ageClasses.keys();return a.sort(),a.map(function(a){var b=this.ageClasses.get(a);return new g(a,b.numControls,b.competitors)},this)},m.prototype.createCourseFromLinkedClassesAndCourses=function(a,b,c,d){for(var e,f,g=[a],i=[],j=[],k=[];g.length>0||i.length>0;){for(;g.length>0;){e=g.shift();for(var l=b.coursesToClasses.get(e),m=0;m<l.length;m+=1)f=l[m],i.indexOf(f)<0&&k.indexOf(f)<0&&i.push(f);j.push(e)}for(;i.length>0;){f=i.shift();for(var n=b.classesToCourses.get(f),o=0;o<n.length;o+=1)e=n[o],g.indexOf(e)<0&&j.indexOf(e)<0&&g.push(e);k.push(f)}}j.forEach(function(a){c.add(a)});var p=k.map(function(a){return d.get(a)}),q=this.courseDetails.get(a),r=new h(a,p,q.length,q.climb,q.controls);return p.forEach(function(a){a.setCourse(r)}),r},m.prototype.determineCourses=function(a){var b=this.getMapsBetweenClassesAndCourses(),c=d3.set(),d=d3.map();a.forEach(function(a){d.set(a.name,a)});var e=[];return b.coursesToClasses.keys().forEach(function(a){if(!c.has(a)){var f=this.createCourseFromLinkedClassesAndCourses(a,b,c,d);e.push(f)}},this),e},m.prototype.parseEventData=function(){this.lines=this.data.split(/\n/);var b=this.identifyDelimiter();this.identifyFormatVariation(b),this.lines.shift(),this.lines.forEach(function(a,c){this.readLine(a,c+1,b)},this),this.anyCompetitors||a("No competitors' data were found");var c=this.createAgeClasses(),d=this.determineCourses(c);return new i(c,d)},SplitsBrowser.Input.SI={},SplitsBrowser.Input.SI.parseEventData=function(a){var b=new m(a);return b.parseEventData()}}(),function(){"use strict";function a(a){return null!==a&&""!==a}function b(a){return a=$.trim(a),""!==a&&isFinite(a)}function c(b){return b.split(/\s+/g).filter(a)}function d(a){return a.replace(x,"")}function e(a,b){for(var c,e=[];;){if(c=a.exec(b),null===c)break;e.push(d(c[1]))}return e}function f(a){return e(/<font[^>]*>(.*?)<\/font>/g,a)
}function g(a){return e(/<td[^>]*>(.*?)<\/td>/g,a).map($.trim)}function h(a){return g(a).filter(function(a){return""!==a})}function i(a){var b=e(/<th[^>]*>(.*?)<\/th>/g,a);return b.filter(function(a){return""!==a})}function j(a){var b=y.exec(a);return null===b?null:q(b[1])}function k(a){var b=z.exec(a);return null===b?null:parseInt(b[1],10)}function l(a){for(var b=[],c=0;c<a.length;c+=1){var d=a[c],e=d.indexOf("(");if(e>-1&&")"===d[d.length-1]){var f=d.substring(e+1,d.length-1);b.push(f)}else c+1===a.length?b.push(null):o("Unrecognised control header label: '"+d+"'")}return b}function m(a,b){for(;b.length>0&&"*"===b[b.length-1][0];)b.splice(b.length-1,1),a.splice(a.length-1,1)}var n=SplitsBrowser.isNotNull,o=SplitsBrowser.throwInvalidData,p=SplitsBrowser.throwWrongFileFormat,q=SplitsBrowser.parseCourseLength,r=SplitsBrowser.normaliseLineEndings,s=SplitsBrowser.parseTime,t=SplitsBrowser.Model.Competitor.fromOriginalCumTimes,u=SplitsBrowser.Model.AgeClass,v=SplitsBrowser.Model.Course,w=SplitsBrowser.Model.Event,x=/<[^>]+>/g,y=/([0-9.,]+)\s*(?:Km|km)/,z=/(\d+)\s*(?:Cm|Hm|hm|m)/,A=function(a,b,c,d,e,f){this.name=a,this.club=b,this.className=c,this.totalTime=d,this.cumTimes=e,this.competitive=f};A.prototype.isContinuation=function(){return""===this.name&&""===this.club&&null===this.className&&""===this.totalTime&&!this.competitive},A.prototype.append=function(a){if(!a.isContinuation())throw new Error("Can only append a continuation CompetitorParseRecord");this.cumTimes=this.cumTimes.concat(a.cumTimes)},A.prototype.toCompetitor=function(a){var b=[0].concat(this.cumTimes),c=t(a,this.name,this.club,null,b);return c.completed()&&!this.competitive&&c.setNonCompetitive(),c};var B=function(){this.precedingColumnCount=null};B.prototype.isTextOfThisFormat=function(a){return a.indexOf("<pre>")>=0},B.prototype.preprocess=function(a){var b=a.indexOf("<pre>");if(-1===b)throw new Error("Cannot find opening pre tag");var c=a.indexOf("\n",b);a=a.substring(c+1);var d=a.lastIndexOf("</pre>");return-1===d&&o("Found opening <pre> but no closing </pre>"),c=a.lastIndexOf("\n",d),a=a.substring(0,c),$.trim(a)},B.prototype.canIgnoreThisLine=function(a){return""===a},B.prototype.isCourseHeaderLine=function(a){return 2===f(a).length},B.prototype.parseCourseHeaderLine=function(a){var b=f(a);if(2!==b.length)throw new Error("Course header line should have two parts");var c=b[0],d=b[1],e=c.indexOf("("),g=e>-1?c.substring(0,e):c,h=j(d),i=k(d);return{name:$.trim(g),distance:h,climb:i}},B.prototype.parseControlsLine=function(a){var b=a.lastIndexOf("</font>"),d=-1===b?a:a.substring(b+"</font>".length),e=c($.trim(d));return l(e)},B.prototype.readCompetitorSplitDataLine=function(a){for(var b=0;b<this.precedingColumnCount;b+=1){var e=a.indexOf("</font>");a=a.substring(e+"</font>".length)}var f=c(d(a));return f},B.prototype.parseCompetitor=function(a,d){var e=f(a),g=f(d);if(null===this.precedingColumnCount){var h=$.trim(e[1]);this.precedingColumnCount=h.match(/^\d*$/)?4:3}var i=b(e[0]),j=$.trim(e[this.precedingColumnCount-2]),k=$.trim(e[this.precedingColumnCount-1]),l=$.trim(g[this.precedingColumnCount-2]),n=this.readCompetitorSplitDataLine(a),o=this.readCompetitorSplitDataLine(d);n=n.map(s),m(n,o);var p=null;if(null!==j&&""!==j){for(var q=-1,r=0;r<this.precedingColumnCount;r+=1)q=a.indexOf("</font>",q+1);var t=a.substring(0,q+"</font>".length),u=t.replace(/<font[^>]*>(.*?)<\/font>/g,""),v=c(u);v.length>0&&(p=v[0])}return new A(j,l,p,k,n,i)};var C=function(){this.currentCourseHasClass=!1};C.prototype.isTextOfThisFormat=function(a){for(var b=-1,c=0;5>c;c+=1)if(b=a.indexOf("<table",b+1),-1===b)return!1;return!0},C.prototype.preprocess=function(a){var b=a.indexOf("</table>");-1===b&&o("Could not find any closing </table> tags"),a=a.substring(b+"</table>".length);var c=a.indexOf("</div>"),d=a.indexOf("<table");return c>-1&&d>c&&(a=a.substring(c+"</div>".length)),a=a.replace(/>\n</g,"><").replace(/><tr>/g,">\n<tr>").replace(/<\/tr></g,"</tr>\n<").replace(/><table/g,">\n<table").replace(/<\/table></g,"</table>\n<"),a=a.replace(/<\/col[^>]*>/g,""),a=a.replace(/<tr[^>]*><td[^>]*>(?:<nobr>)?&nbsp;?(?:<\/nobr>)?<\/td><\/tr>/g,""),a=a.replace("</body></html>",""),$.trim(a)},C.prototype.canIgnoreThisLine=function(a){if(a.indexOf("<th>")>-1){var b=i(a);return this.currentCourseHasClass=5===b.length,!0}return""===a||a.indexOf("<table")>-1||a.indexOf("</table>")>-1},C.prototype.isCourseHeaderLine=function(a){return a.indexOf('<td id="header"')>-1},C.prototype.parseCourseHeaderLine=function(a){var b=h(a);0===b.length&&o("No parts found in course header line");var c=b[0],d=c.indexOf("(");d>-1&&(c=c.substring(0,d)),c=$.trim(c);for(var e=null,f=null,g=1;g<b.length;g+=1)null===e&&(e=j(b[g])),null===f&&(f=k(b[g]));return{name:c,distance:e,climb:f}},C.prototype.parseControlsLine=function(a){var b=h(a);return l(b)},C.prototype.readCompetitorSplitDataLine=function(b){for(var c=g(b),d=this.currentCourseHasClass?5:4,e=c.length;e>0&&""===c[e-1];)e-=1;return c.slice(d,e).filter(a)},C.prototype.parseCompetitor=function(a,c){var d=g(a),e=g(c),f=b(d[0]),h=d[2],i=d[this.currentCourseHasClass?4:3],j=e[2],k=this.currentCourseHasClass&&""!==h?d[3]:null,l=this.readCompetitorSplitDataLine(a),p=this.readCompetitorSplitDataLine(c);l=l.map(s),m(l,p);var q=l.filter(n).length;return q!==p.length&&o("Cumulative and split times do not have the same length: "+q+" cumulative times, "+p.length+" split times"),new A(h,j,k,i,l,f)};var D=function(){this.usesClasses=!1};D.prototype.isTextOfThisFormat=function(a){var b=a.indexOf("<table");if(b>=0){var c=a.indexOf("<table",b+1);if(c>=0){var d=a.indexOf("<table",c+1);if(0>d)return!0}}return!1},D.prototype.preprocess=function(a){var b=a.indexOf("</table>");return-1===b&&o("Could not find any closing </table> tags"),a.indexOf('<td colspan="25">')>=0&&(this.usesClasses=!0),a=a.substring(b+"</table>".length),a=a.replace(/<tr[^>]*><td colspan=[^>]*>&nbsp;<\/td><\/tr>/g,""),a=a.replace("</body>","").replace("</html>",""),$.trim(a)},D.prototype.canIgnoreThisLine=function(a){return""===a||a.indexOf("<table")>-1||a.indexOf("</table>")>-1||a.indexOf("<hr>")>-1},D.prototype.isCourseHeaderLine=function(a){return a.indexOf('<tr class="clubName"')>-1},D.prototype.parseCourseHeaderLine=function(a){var b=h(a);0===b.length&&o("No parts found in course header line");var c,d,e,f=b[0],g=/^(.*?)\s+\((\d+)m,\s*(\d+)m\)$/.exec(f);return null===g?(c=f,d=null,e=null):(c=g[1],d=parseInt(g[2],10)/1e3,e=parseInt(g[3],10)),{name:$.trim(c),distance:d,climb:e}},D.prototype.parseControlsLine=function(a){var b=h(a);return b.map(function(a){var b=a.indexOf("-");return-1===b?null:a.substring(b+1)})},D.prototype.readCompetitorSplitDataLine=function(b){for(var c=this.usesClasses?5:4,d=b.length;d>0&&""===b[d-1];)d-=1;for(var e=[],f=c;d>f;f+=2){var g=b[f];a(g)&&e.push(g)}return e},D.prototype.parseCompetitor=function(a,c){for(var d=g(a),e=g(c),f=b(d[0]),h=d[2],i=d[this.usesClasses?4:3],j=this.usesClasses&&""!==h?d[3]:null,k=e[2],l=this.usesClasses?5:4;l<d.length&&l<e.length;l+=2)""!==d[l]&&""===e[l]&&(e[l]="----");var n=this.readCompetitorSplitDataLine(d),p=this.readCompetitorSplitDataLine(e);return n=n.map(s),m(n,p),n.length!==p.length&&o("Cumulative and split times do not have the same length: "+n.length+" cumulative times, "+p.length+" split times"),new A(h,k,j,i,n,f)};var E=function(a,b,c){this.name=a,this.distance=b,this.climb=c,this.controls=[],this.competitors=[]};E.prototype.addControls=function(a){this.controls=this.controls.concat(a)},E.prototype.hasAllControls=function(){return this.controls.length>0&&null===this.controls[this.controls.length-1]},E.prototype.addCompetitor=function(a){a.competitive||a.cumTimes.length!==this.controls.length-1||a.cumTimes.push(null),a.cumTimes.length===this.controls.length?this.competitors.push(a):o("Competitor '"+a.name+"' should have "+this.controls.length+" cumulative times, but has "+a.cumTimes.length+" times")};var F=function(a){this.recognizer=a,this.courses=[],this.currentCourse=null,this.lines=null,this.linePos=-1,this.currentCompetitor=null};F.prototype.tryGetLine=function(){return this.linePos+1<this.lines.length?(this.linePos+=1,this.lines[this.linePos]):null},F.prototype.addCurrentCompetitorIfNecessary=function(){null!==this.currentCompetitor&&(this.currentCourse.addCompetitor(this.currentCompetitor),this.currentCompetitor=null)},F.prototype.addCurrentCompetitorAndCourseIfNecessary=function(){this.addCurrentCompetitorIfNecessary(),null!==this.currentCourse&&this.courses.push(this.currentCourse)},F.prototype.readCompetitorLines=function(a){var b=this.tryGetLine();null===b&&o("Hit end of input data unexpectedly while parsing competitor: first line was '"+a+"'");var c=this.recognizer.parseCompetitor(a,b);c.isContinuation()?null===this.currentCompetitor?o("First row of competitor data has no name nor time"):this.currentCompetitor.append(c):(this.addCurrentCompetitorIfNecessary(),this.currentCompetitor=c)},F.prototype.areAgeClassesUniqueWithinCourses=function(){for(var a=d3.map(),b=0;b<this.courses.length;b+=1)for(var c=this.courses[b],d=0;d<c.competitors.length;d+=1){var e=c.competitors[d];if(a.has(e.className)){if(a.get(e.className)!==c.name)return!1}else a.set(e.className,c.name)}return!0},F.prototype.createOverallEventObject=function(){var a=this.areAgeClassesUniqueWithinCourses(),b=[],c=[],d=this.courses.every(function(a){return a.competitors.every(function(a){return n(a.className)})});return this.courses.forEach(function(e){var f=d3.map();e.competitors.forEach(function(b){var c=d&&a?b.className:e.name;f.has(c)?f.get(c).push(b):f.set(c,[b])});var g=[];f.keys().forEach(function(a){var b=e.controls.length-1,d=f.get(a),h=d.map(function(a,b){return a.toCompetitor(b+1)}),i=new u(a,b,h);g.push(i),c.push(i)},this);var h=new v(e.name,g,e.distance,e.climb,e.controls.slice(0,e.controls.length-1));b.push(h),g.forEach(function(a){a.setCourse(h)})},this),new w(c,b)},F.prototype.parse=function(a){for(this.lines=a.split("\n");;){var b=this.tryGetLine();if(null===b)break;if(this.recognizer.canIgnoreThisLine(b));else if(this.recognizer.isCourseHeaderLine(b)){this.addCurrentCompetitorAndCourseIfNecessary();var c=this.recognizer.parseCourseHeaderLine(b);this.currentCourse=new E(c.name,c.distance,c.climb)}else if(null===this.currentCourse);else if(this.currentCourse.hasAllControls())this.readCompetitorLines(b);else{var d=this.recognizer.parseControlsLine(b);this.currentCourse.addControls(d)}}this.addCurrentCompetitorAndCourseIfNecessary();var e=this.createOverallEventObject();return e};var G=[B,C,D];SplitsBrowser.Input.SIHtml={},SplitsBrowser.Input.SIHtml.parseEventData=function(a){a=r(a);for(var b=0;b<G.length;b+=1){var c=G[b],d=new c;if(d.isTextOfThisFormat(a)){a=d.preprocess(a);var e=new F(d),f=e.parse(a);return f}}p("No HTML recognizers recognised this as HTML they could parse")}}(),function(){"use strict";function a(a){for(var b=a.length-1;b>=0&&""===a[b];)b-=1;a.splice(b+1,a.length-b-1)}function b(a,b){if(b.allowMultipleCompetitorNames)for(;a.length>b.name+1&&a[b.name+1].match(/^\s\S/);)a[b.name]+=","+a[b.name+1],a.splice(b.name+1,1)}function c(b,c){for(var d=0;d<r.length;d+=1){var e=r[d],f=b.split(e);if(a(f),f.length>c.controlsOffset)return e}return null}function d(d,o){d=h(d);var p=d.split(/\n/);p.length<2&&g("Data appears not to be in an alternative CSV format - too few lines");var q=c(p[1],o);null===q&&g("Data appears not to be in an alternative CSV format - first data line has fewer than "+o.controlsOffset+" parts when separated by any recognised delimiter");var r=p[1].split(q);a(r),b(r,o);for(var s=/^[A-Za-z0-9]+$/,t=null===o.finishTime?o.step:0,u=o.controlsOffset;u+t<r.length;u+=o.step)s.test(r[u])||g("Data appears not to be in an alternative CSV format - data in cell "+u+" of the first row ('"+r[u]+"') is not an number");for(var v=d3.map(),w=1;w<p.length;w+=1){var x=p[w].split(q);if(a(x),b(x,o),!(x.length<o.controlsOffset)){for(;0!==(x.length-o.controlsOffset)%o.step;)x.push("");var y,z=x[o.name],A=x[o.club],B=x[o.courseName],C=i(x[o.startTime]);if(null===o.controlCount)y=x.length;else{var D=parseInt(x[o.controlCount],10);e(D)&&f("Control count '"+D+"' is not a valid number"),y=o.controlsOffset+x[o.controlCount]*o.step,x.length<y&&f("Data in row "+w+" should have at least "+y+" parts but only has "+x.length)}for(var E=null===o.length?null:j(x[o.length])||null,F=null===o.climb?null:parseInt(x[o.climb],10)||null,G=[0],H=o.controlsOffset+1;y>H;H+=o.step)G.push(i(x[H]));if(null!==o.finishTime){var I=i(x[o.finishTime]),J=null===C||null===I?null:I-C;G.push(J)}var K=v.has(B)?v.get(B).competitors.length+1:1,L=k(K,z,A,C,G);if(null!==o.placing&&L.completed()){var M=x[o.placing];M.match(/^\d*$/)||L.setNonCompetitive()}if(v.has(B)){var N=v.get(B);G.length-1!==N.controls.length+1&&f("Competitor '"+z+"' has the wrong number of splits for course '"+B+"': "+"expected "+(N.controls.length+1)+", actual "+(G.length-1)),N.competitors.push(L)}else{for(var O=[],P=o.controlsOffset;y>P+t;P+=o.step)O.push(x[P]);v.set(B,{length:E,climb:F,controls:O,competitors:[L]})}}}var Q=[],R=[];return v.keys().forEach(function(a){var b=v.get(a),c=new l(a,b.controls.length,b.competitors),d=new m(a,[c],b.length,b.climb,b.controls);c.setCourse(d),Q.push(c),R.push(d)}),new n(Q,R)}var e=SplitsBrowser.isNaNStrict,f=SplitsBrowser.throwInvalidData,g=SplitsBrowser.throwWrongFileFormat,h=SplitsBrowser.normaliseLineEndings,i=SplitsBrowser.parseTime,j=SplitsBrowser.parseCourseLength,k=SplitsBrowser.Model.Competitor.fromOriginalCumTimes,l=SplitsBrowser.Model.AgeClass,m=SplitsBrowser.Model.Course,n=SplitsBrowser.Model.Event,o={controlsOffset:38,step:3,name:3,club:5,courseName:7,startTime:8,length:null,climb:null,controlCount:null,placing:null,finishTime:null,allowMultipleCompetitorNames:!0},p=60,q={controlsOffset:p,step:2,name:3,club:18,courseName:p-7,startTime:11,length:p-6,climb:p-5,controlCount:p-4,placing:p-3,finishTime:p-1,allowMultipleCompetitorNames:!1},r=[",",";"];SplitsBrowser.Input.AlternativeCSV={parseTripleColumnEventData:function(a){return d(a,o)},parseNamelessEventData:function(a){return d(a,q)}}}(),function(){"use strict";function a(a){return"undefined"==typeof a}function b(a){var b;try{b=$.parseXML(a)}catch(c){g("XML data not well-formed: "+c.message)}return 0===$("> *",$(b)).length&&g("XML data not well-formed: "+a),b}function c(b){var c=$("> *",b),d=c.prop("tagName");"ResultList"!==d&&h("Root element of XML document does not have expected name 'ResultList', got '"+d+"'");var e=$("> IOFVersion",c);if(0===e.length)h("Could not find IOFVersion element");else{var f=e.attr("version");a(f)?h("Version attribute missing from IOFVersion element"):"2.0.3"!==f&&h("IOF data format version 2.0.3 is the only format supported: found '"+f+"'")}var i=c.attr("status");a(i)||"complete"===i||g("Only complete IOF data supported; snapshot and delta are not supported")}function d(b,c){var d,e=$(b),f=$("> Person > PersonName > Given",e).text(),h=$("> Person > PersonName > Family",e).text();if(""===f&&""===h){var l=$("> PersonId",e).text();""===l?g("Cannot read person name nor ID"):d=l}else d=f,""!==f&&""!==h&&(d+=" "),d+=h;var m=$("> Club > ShortName",e).text(),n=$("Result",e);0===n.length&&g("No result found for competitor '"+d+"'");var p,q=$("> StartTime > Clock",n).text(),r=""===q?null:j(q),s=$("> Time",n).text(),t=""===s?null:j(s),u=$("> CourseLength",n),v=u.text();if(""===v)p=null;else{p=parseInt(v,10),i(p)&&g("Invalid course length '"+v+"'");var w=u.attr("unit");a(w)||"m"===w?p/=1e3:"km"===w||("ft"===w?p/=o:g("Unrecognised course-length unit: '"+w+"'"))}var x=!1,y=$("> CompetitorStatus",n);1===y.length&&"NotCompeting"===y.attr("value")&&(x=!0);for(var z=$("> SplitTime",n),A=[],B=0;B<z.length;B+=1){var C,D=$(z[B]),E=D.attr("sequence");a(E)?g("Missing sequence number for control"):(C=parseInt(E,10),i(C)&&g("Sequence number '"+E+"' is not numeric"));var F=$("> ControlCode",D).text();""===F&&(F=$("> Control",D).text()),""===F&&g("Cannot read control code of control with sequence number "+C);var G=$("> Time",D).text();""===G&&g("Cannot read time of control with sequence number "+C),A.push({sequenceNumber:C,code:F,time:j(G)})}A.sort(function(a,b){return d3.ascending(a.sequenceNumber,b.sequenceNumber)});var H=A.map(function(a){return a.code}),I=A.map(function(a){return a.time});I.splice(0,0,0),I.push(t);var J=k(c,d,m,r,I);return x&&J.setNonCompetitive(),{competitor:J,controls:H,length:p}}function e(a){var b=$(a),c={name:null,competitors:[],controls:[],length:null},e=$("> ClassShortName",b).text();""===e&&g("Missing class name"),c.name=e;var f=$("> PersonResult",b);0===f.length&&g("Class '"+e+"' has no competitors");for(var h=0;h<f.length;h+=1){var i=d(f[h],h+1);if(0===c.competitors.length)c.controls=i.controls,c.length=i.length;else{var j=i.competitor.getAllOriginalCumulativeTimes().length-2;j!==c.controls.length&&g("Inconsistent numbers of controls on course '"+e+"': "+c.controls.length+" and "+j)}c.competitors.push(i.competitor)}return c}function f(a){a.indexOf("IOFdata.dtd")<0&&h("Data apparently not of the IOF XML format");var d=b(a);c(d);var f=$("> ResultList > ClassResult",$(d));0===f.length&&g("No class result elements found");for(var i=[],j=[],k=0;k<f.length;k+=1){var o=e(f[k]),p=new l(o.name,o.controls.length,o.competitors),q=new m(o.name,[p],o.length,null,o.controls);p.setCourse(q),i.push(p),j.push(q)}return new n(i,j)}var g=SplitsBrowser.throwInvalidData,h=SplitsBrowser.throwWrongFileFormat,i=SplitsBrowser.isNaNStrict,j=SplitsBrowser.parseTime,k=SplitsBrowser.Model.Competitor.fromOriginalCumTimes,l=SplitsBrowser.Model.AgeClass,m=SplitsBrowser.Model.Course,n=SplitsBrowser.Model.Event,o=3280;SplitsBrowser.Input.IOFXml={parseEventData:f}}(),function(){"use strict";var a=[SplitsBrowser.Input.CSV.parseEventData,SplitsBrowser.Input.SI.parseEventData,SplitsBrowser.Input.SIHtml.parseEventData,SplitsBrowser.Input.AlternativeCSV.parseTripleColumnEventData,SplitsBrowser.Input.AlternativeCSV.parseNamelessEventData,SplitsBrowser.Input.IOFXml.parseEventData];SplitsBrowser.Input.parseEventData=function(b){for(var c=0;c<a.length;c+=1){var d=a[c];try{return d(b)}catch(e){if("WrongFileFormat"!==e.name)throw e}}return null}}(),function(){"use strict";var a="competitorList",b=function(b){this.parent=b,this.handler=null,this.competitorSelection=null,this.listDiv=d3.select(b).append("div").attr("id",a)};b.prototype.width=function(){return $(this.listDiv.node()).width()},b.prototype.selectionChanged=function(){var a=this;this.listDiv.selectAll("div.competitor").data(d3.range(this.competitorSelection.count)).classed("selected",function(b,c){return a.competitorSelection.isSelected(c)})},b.prototype.toggleCompetitor=function(a){this.competitorSelection.toggle(a)},b.prototype.setCompetitorList=function(a,b){$("div.competitor").off("click");var c=this.listDiv.selectAll("div.competitor").data(a);c.enter().append("div").classed("competitor",!0),c.selectAll("span").remove(),b&&c.append("span").classed("competitorClassLabel",!0).text(function(a){return a.className}),c.append("span").classed("nonfinisher",function(a){return!a.completed()}).text(function(a){return a.completed()?a.name:"* "+a.name}),c.exit().remove();var d=this;$("div.competitor").each(function(a,b){$(b).on("click",function(){d.toggleCompetitor(a)})})},b.prototype.setSelection=function(a){null!==this.competitorSelection&&this.competitorSelection.deregisterChangeHandler(this.handler);var b=this;this.competitorSelection=a,this.handler=function(a){b.selectionChanged(a)},this.competitorSelection.registerChangeHandler(this.handler),this.selectionChanged(d3.range(a.count))},SplitsBrowser.Controls.CompetitorListBox=b}(),function(){"use strict";var a=SplitsBrowser.throwInvalidData,b=SplitsBrowser.getMessage,c=function(a){this.changeHandlers=[],this.otherClassesEnabled=!0;var c=d3.select(a).append("div").style("float","left");c.text(b("ClassSelectorLabel"));var d=this;this.dropDown=c.append("select").node(),$(this.dropDown).bind("change",function(){d.updateOtherClasses(),d.onSelectionChanged()}),this.otherClassesCombiningLabel=c.append("span").classed("otherClassCombining",!0).style("display","none").text(b("AdditionalClassSelectorLabel")),this.otherClassesSelector=c.append("div").classed("otherClassSelector",!0).style("display","none"),this.otherClassesSpan=this.otherClassesSelector.append("span"),this.otherClassesList=d3.select(a).append("div").classed("otherClassList",!0).style("position","absolute").style("display","none"),this.otherClassesSelector.on("click",function(){d.showHideClassSelector()}),this.setClasses([]),this.selectedOtherClassIndexes=d3.set(),$(document).click(function(a){var b=d.otherClassesList.node();if("none"!==b.style.display){var c=$("div.otherClassList,div.otherClassSelector");c.is(a.target)||0!==c.has(a.target).length||(b.style.display="none")}}),$(document).keydown(function(a){27===a.which&&d.otherClassesList.style("display","none")})};c.prototype.setOtherClassesEnabled=function(a){this.otherClassesCombiningLabel.classed("disabled",!a),this.otherClassesSelector.classed("disabled",!a),this.otherClassesEnabled=a},c.prototype.setClasses=function(c){if($.isArray(c)){this.classes=c;var d;0===c.length?(this.dropDown.disabled=!0,d=[b("NoClassesLoadedPlaceholder")]):(this.dropDown.disabled=!1,d=c.map(function(a){return a.name}));var e=d3.select(this.dropDown).selectAll("option").data(d);e.enter().append("option"),e.attr("value",function(a,b){return b.toString()}).text(function(a){return a}),e.exit().remove(),this.updateOtherClasses()}else a("ClassSelector.setClasses: classes is not an array")},c.prototype.registerChangeHandler=function(a){-1===this.changeHandlers.indexOf(a)&&this.changeHandlers.push(a)},c.prototype.onSelectionChanged=function(){var a=[this.dropDown.selectedIndex];this.selectedOtherClassIndexes.forEach(function(b){a.push(parseInt(b,10))}),this.changeHandlers.forEach(function(b){b(a)})},c.prototype.updateOtherClassText=function(){var a=this.selectedOtherClassIndexes.values();a.sort(d3.ascending);var c;c=0===a.length?b("NoAdditionalClassesSelectedPlaceholder"):a.map(function(a){return this.classes[a].name},this).join(", "),this.otherClassesSpan.text(c)},c.prototype.updateOtherClasses=function(){this.otherClassesList.style("display","none"),this.selectedOtherClassIndexes=d3.set(),this.updateOtherClassText(),$("div.otherClassItem").off("click");var a,b=this;if(this.classes.length>0){var c=this.classes[this.dropDown.selectedIndex];a=c.course.getOtherClasses(c)}else a=[];var d=a.map(function(a){return this.classes.indexOf(a)},this),e=this.otherClassesList.selectAll("div").data(d);e.enter().append("div").classed("otherClassItem",!0),e.attr("id",function(a){return"ageClassIdx_"+a}).classed("selected",!1).text(function(a){return b.classes[a].name}),e.exit().remove(),d.length>0?(this.otherClassesSelector.style("display","inline-block"),this.otherClassesCombiningLabel.style("display",null)):(this.otherClassesSelector.style("display","none"),this.otherClassesCombiningLabel.style("display","none"));var f=$(this.otherClassesSelector.node()).offset(),g=$(this.otherClassesSelector.node()).outerHeight();this.otherClassesList.style("left",f.left+"px").style("top",f.top+g+"px"),$("div.otherClassItem").each(function(a,c){$(c).on("click",function(){b.toggleOtherClass(d[a])})})},c.prototype.showHideClassSelector=function(){this.otherClassesEnabled&&this.otherClassesList.style("display","none"===this.otherClassesList.style("display")?null:"none")},c.prototype.toggleOtherClass=function(a){this.selectedOtherClassIndexes.has(a)?this.selectedOtherClassIndexes.remove(a):this.selectedOtherClassIndexes.add(a),d3.select("div#ageClassIdx_"+a).classed("selected",this.selectedOtherClassIndexes.has(a)),this.updateOtherClassText(),this.onSelectionChanged()},SplitsBrowser.Controls.ClassSelector=c}(),function(){"use strict";var a=SplitsBrowser.getMessage,b=SplitsBrowser.getMessageWithFormatting,c=[{nameKey:"CompareWithWinner",selector:function(a){return a.getWinnerCumTimes()},requiresWinner:!0,percentage:""},{nameKey:"CompareWithFastestTime",selector:function(a){return a.getFastestCumTimes()},requiresWinner:!1,percentage:""}],d=[5,25,50,100];d.forEach(function(a){c.push({nameKey:"CompareWithFastestTimePlusPercentage",selector:function(b){return b.getFastestCumTimesPlusPercentage(a)},requiresWinner:!1,percentage:a})}),c.push({nameKey:"CompareWithAnyRunner",selector:null,requiresWinner:!0,percentage:""});var e=1,f="comparisonSelector",g="runnerSelector",h=function(d,h){this.changeHandlers=[],this.classes=null,this.currentRunnerIndex=null,this.previousCompetitorList=null,this.parent=d,this.alerter=h,this.hasWinner=!1,this.previousSelectedIndex=-1;var i=d3.select(d).append("div").attr("id","comparisonSelectorContainer");i.append("span").classed("comparisonSelectorLabel",!0).text(a("ComparisonSelectorLabel"));var j=this;this.dropDown=i.append("select").attr("id",f).node(),$(this.dropDown).bind("change",function(){j.onSelectionChanged()});var k=d3.select(this.dropDown).selectAll("option").data(c);k.enter().append("option"),k.attr("value",function(a,b){return b.toString()}).text(function(a){return b(a.nameKey,{$$PERCENT$$:a.percentage})}),k.exit().remove(),this.runnerDiv=d3.select(d).append("div").attr("id","runnerSelectorContainer").style("display","none").style("padding-left","20px"),this.runnerDiv.append("span").classed("comparisonSelectorLabel",!0).text(a("CompareWithAnyRunnerLabel")),this.runnerDropDown=this.runnerDiv.append("select").attr("id",g).node(),$(this.runnerDropDown).bind("change",function(){j.onSelectionChanged()}),this.dropDown.selectedIndex=e,this.previousSelectedIndex=e};h.prototype.registerChangeHandler=function(a){-1===this.changeHandlers.indexOf(a)&&this.changeHandlers.push(a)},h.prototype.isAnyRunnerSelected=function(){return this.dropDown.selectedIndex===c.length-1},h.prototype.setAgeClassSet=function(a){this.ageClassSet=a,this.setRunners()},h.prototype.setRunners=function(){var a=this.ageClassSet.allCompetitors,b=d3.range(a.length).filter(function(b){return a[b].completed()}),c=a.filter(function(a){return a.completed()});this.hasWinner=c.length>0;var d=d3.select(this.runnerDropDown).selectAll("option").data(c);if(d.enter().append("option"),d.attr("value",function(a,c){return b[c].toString()}).text(function(a){return a.name}),d.exit().remove(),null===this.previousCompetitorList)this.currentRunnerIndex=0;else{var e=this.previousCompetitorList[this.currentRunnerIndex],f=this.ageClassSet.allCompetitors.indexOf(e);this.currentRunnerIndex=Math.max(f,0)}this.runnerDropDown.selectedIndex=this.currentRunnerIndex,this.previousCompetitorList=this.ageClassSet.allCompetitors},h.prototype.setEnabled=function(a){d3.select(this.parent).selectAll("span.comparisonSelectorLabel").classed("disabled",!a),this.dropDown.disabled=!a,this.runnerDropDown.disabled=!a},h.prototype.getComparisonFunction=function(){if(this.isAnyRunnerSelected()){var a=this;return function(b){return b.getCumulativeTimesForCompetitor(a.currentRunnerIndex)}}return c[this.dropDown.selectedIndex].selector},h.prototype.onSelectionChanged=function(){var d=Math.max(this.runnerDropDown.selectedIndex,0),e=c[this.dropDown.selectedIndex];!this.hasWinner&&e.requiresWinner?(this.alerter(b("CannotCompareAsNoWinner",{$$OPTION$$:a(e.nameKey)})),this.dropDown.selectedIndex=this.previousSelectedIndex):(this.runnerDiv.style("display",this.isAnyRunnerSelected()?null:"none"),this.currentRunnerIndex=0===this.runnerDropDown.options.length?0:parseInt(this.runnerDropDown.options[d].value,10),this.previousSelectedIndex=this.dropDown.selectedIndex,this.changeHandlers.forEach(function(a){a(this.getComparisonFunction())},this))},SplitsBrowser.Controls.ComparisonSelector=h}(),function(){"use strict";var a=SplitsBrowser.getMessage,b="statisticSelector",c="statisticCheckbox",d=["TotalTime","SplitTime","BehindFastest","TimeLoss"],e=["StatisticsTotalTime","StatisticsSplitTime","StatisticsBehindFastest","StatisticsTimeLoss"],f=["SplitTime","TimeLoss"],g=function(g){this.span=d3.select(g).append("span").attr("id",b);var h=this.span.selectAll("span").data(d).enter().append("span");h.append("input").attr("id",function(a){return c+a}).attr("type","checkbox").attr("checked",function(a){return f.indexOf(a)>=0?"checked":null}),h.append("label").attr("for",function(a){return c+a}).classed("statisticsSelectorLabel",!0).text(function(b,c){return a(e[c])});var i=this;$("input",this.span.node()).bind("change",function(){return i.onCheckboxChanged()}),this.handlers=[]};g.prototype.clearAll=function(){this.span.selectAll("input").attr("checked",null)},g.prototype.setEnabled=function(a){this.span.selectAll("label.statisticsSelectorLabel").classed("disabled",!a),this.span.selectAll("input").attr("disabled",a?null:"disabled")},g.prototype.registerChangeHandler=function(a){-1===this.handlers.indexOf(a)&&this.handlers.push(a)},g.prototype.deregisterChangeHandler=function(a){var b=this.handlers.indexOf(a);-1!==b&&this.handlers.splice(b,1)},g.prototype.getVisibleStatistics=function(){var a={};return this.span.selectAll("input")[0].forEach(function(b,c){a[d[c]]=b.checked}),a},g.prototype.onCheckboxChanged=function(){var a=this.getVisibleStatistics();this.handlers.forEach(function(b){b(a)})},SplitsBrowser.Controls.StatisticsSelector=g}(),function(){"use strict";var a=SplitsBrowser.getMessage,b=function(b,c){this.changeHandlers=[],this.chartTypes=c,this.raceGraphDisabledNotifier=null,this.lastSelectedIndex=0;var d=d3.select(b).append("div").attr("id","chartTypeSelector");d.append("span").text(a("ChartTypeSelectorLabel"));var e=this;this.dropDown=d.append("select").node(),$(this.dropDown).bind("change",function(){e.onSelectionChanged()});var f=d3.select(this.dropDown).selectAll("option").data(c);f.enter().append("option"),f.attr("value",function(a,b){return b.toString()}).text(function(b){return a(b.nameKey)}),f.exit().remove()};b.prototype.setRaceGraphDisabledNotifier=function(a){this.raceGraphDisabledNotifier=a},b.prototype.registerChangeHandler=function(a){-1===this.changeHandlers.indexOf(a)&&this.changeHandlers.push(a)},b.prototype.getChartType=function(){return this.chartTypes[Math.max(this.dropDown.selectedIndex,0)]},b.prototype.onSelectionChanged=function(){null!==this.raceGraphDisabledNotifier&&this.chartTypes[this.dropDown.selectedIndex].isRaceGraph&&(this.raceGraphDisabledNotifier(),this.dropDown.selectedIndex=Math.max(this.lastSelectedIndex,0)),this.changeHandlers.forEach(function(a){a(this.chartTypes[this.dropDown.selectedIndex])},this),this.lastSelectedIndex=this.dropDown.selectedIndex},SplitsBrowser.Controls.ChartTypeSelector=b}(),function(){"use strict";var a="originalDataSelectorContainer",b=SplitsBrowser.getMessage,c=function(c,d,e){this.parent=c,this.showRepairedData=e,this.showOriginalData=d;var f="originalDataCheckbox";this.containerDiv=c.append("div").attr("id",a),this.containerDiv.append("div").classed("topRowSpacer",!0);var g=this.containerDiv.append("span"),h=this;this.checkbox=g.append("input").attr("type","checkbox").attr("id",f).on("click",function(){h.showOriginalOrRepairedData()}).node(),g.append("label").attr("for",f).classed("originalDataSelectorLabel",!0).text(b("ShowOriginalData")),this.containerDiv.attr("title",b("ShowOriginalDataTooltip"))};c.prototype.showOriginalOrRepairedData=function(){this.checkbox.checked?this.showOriginalData():this.showRepairedData()},c.prototype.setVisible=function(a){this.containerDiv.style("display",a?null:"none")},c.prototype.setEnabled=function(a){this.parent.selectAll("label.originalDataSelectorLabel").classed("disabled",!a),this.checkbox.disabled=!a},SplitsBrowser.Controls.OriginalDataSelector=c}(),function(){"use strict";function a(a,b){if(a===b)return 0;if(""===a||""===b||a[0]!==b[0])return b>a?-1:1;var c=/^[^0-9]+/.exec(a);if(null!==c&&c.length>0){var d=c[0];if(0<d.length&&d.length<a.length&&b.substring(0,d.length)===d){var e=parseInt(a.substring(d.length),10),f=parseInt(b.substring(d.length),10);if(!isNaN(e)&&!isNaN(f))return e-f}}return b>a?-1:1}function b(a){return a.map(function(a){var b=a.nextControls.slice(0);
return b[b.length-1]===h.FINISH&&(b[b.length-1]=f("FinishName")),{course:a.course,nextControls:b.join(", ")}})}var c=10,d=240,e=SplitsBrowser.formatTime,f=SplitsBrowser.getMessage,g=SplitsBrowser.getMessageWithFormatting,h=SplitsBrowser.Model.Course,i={};i.getFastestSplitsPopupData=function(a,b){var d=a.getFastestSplitsTo(c,b);return d=d.map(function(a){return{time:a.split,name:a.name,highlight:!1}}),{title:f("SelectedClassesPopupHeader"),data:d,placeholder:f("SelectedClassesPopupPlaceholder")}},i.getFastestSplitsForLegPopupData=function(a,b,c){var d=a.getCourse(),e=d.getControlCode(c-1),i=d.getControlCode(c),j=e===h.START?f("StartName"):e,k=i===h.FINISH?f("FinishName"):i,l=g("FastestLegTimePopupHeader",{$$START$$:j,$$END$$:k}),m=a.getPrimaryClassName(),n=b.getFastestSplitsForLeg(e,i).map(function(a){return{name:a.name,className:a.className,time:a.split,highlight:a.className===m}});return{title:l,data:n,placeholder:null}},i.getCompetitorsVisitingCurrentControlPopupData=function(a,b,c,i){var j,k=a.getCourse().getControlCode(c),l=i-d/2,m=i+d/2,n=b.getCompetitorsAtControlInTimeRange(k,l,m),o=a.getPrimaryClassName(),p=n.map(function(a){return{name:a.name,className:a.className,time:a.time,highlight:a.className===o}});j=k===h.START?f("StartName"):k===h.FINISH?f("FinishName"):g("ControlName",{$$CODE$$:k});var q=g("NearbyCompetitorsPopupHeader",{$$START$$:e(l),$$END$$:e(m),$$CONTROL$$:j});return{title:q,data:p,placeholder:f("NoNearbyCompetitors")}},i.getNextControlData=function(c,d,e){var i=Math.min(e,c.controls.length),j=c.getControlCode(i),k=d.getNextControlsAfter(j);k.sort(function(b,c){return a(b.course.name,c.course.name)});var l=j===h.START?f("StartName"):g("ControlName",{$$CODE$$:j});return{thisControl:l,nextControls:b(k)}},SplitsBrowser.Model.ChartPopupData=i}(),function(){"use strict";var a=SplitsBrowser.formatTime,b=function(a,b){this.shown=!1,this.mouseIn=!1,this.popupDiv=d3.select(a).append("div"),this.popupDiv.classed("chartPopup",!0).style("display","none").style("position","absolute"),this.dataHeader=this.popupDiv.append("div").classed("chartPopupHeader",!0).append("span");var c=this.popupDiv.append("div").classed("chartPopupTableContainer",!0);this.dataTable=c.append("table"),this.popupDiv.selectAll(".nextControls").style("display","none");for(var d in b)b.hasOwnProperty(d)&&$(this.popupDiv.node()).on(d,b[d]);var e=this;$(this.popupDiv.node()).mouseenter(function(){e.mouseIn=!0}),$(this.popupDiv.node()).mouseleave(function(){e.mouseIn=!1})};b.prototype.isShown=function(){return this.shown},b.prototype.isMouseIn=function(){return this.mouseIn},b.prototype.setData=function(b,c){this.dataHeader.text(b.title);var d=this.dataTable.selectAll("tr").data(b.data);d.enter().append("tr"),d.classed("highlighted",function(a){return a.highlight}),d.selectAll("td").remove(),d.append("td").text(function(b){return a(b.time)}),c&&d.append("td").text(function(a){return a.className}),d.append("td").text(function(a){return a.name}),d.exit().remove(),0===b.data.length&&null!==b.placeholder&&this.dataTable.append("tr").append("td").text(b.placeholder)},b.prototype.setNextControlData=function(a){this.dataHeader.text(a.thisControl);var b=this.dataTable.selectAll("tr").data(a.nextControls);b.enter().append("tr"),b.selectAll("td").remove(),b.classed("highlighted",!1),b.append("td").text(function(a){return a.course.name}),b.append("td").text("-->"),b.append("td").text(function(a){return a.nextControls}),b.exit().remove()},b.prototype.setLocation=function(a){this.popupDiv.style("left",a.x+"px").style("top",a.y+"px")},b.prototype.show=function(a){this.popupDiv.style("display",null),this.shown=!0,this.setLocation(a)},b.prototype.hide=function(){this.popupDiv.style("display","none"),this.shown=!1},b.prototype.height=function(){return $(this.popupDiv.node()).height()},SplitsBrowser.Controls.ChartPopup=b}(),function(){"use strict";function a(a,b){var c;return c=null===b?"-":q(b)?"?":b.toString(),l+n(a)+" ("+c+")"}function b(a,b){return""===b?a:a+" ("+b+")"}function c(a){var b=a.filter(p);return b.length>0?d3.max(b):0}var d="sb-text-size-element",e="chart",f=10,g={top:18,right:0,bottom:18,left:53},h=10,i=10,j=1,k=3,l="\xa0\xa0\xa0\xa0",m=["#FF0000","#4444FF","#00FF00","#000000","#CC0066","#000099","#FFCC00","#884400","#9900FF","#CCCC00","#888800","#CC6699","#00DD00","#3399FF","#BB00BB","#00DDDD","#FF00FF","#0088BB","#888888","#FF99FF","#55BB33"],n=SplitsBrowser.formatTime,o=SplitsBrowser.getMessage,p=SplitsBrowser.isNotNullNorNaN,q=SplitsBrowser.isNaNStrict,r=SplitsBrowser.Model.ChartPopupData,s=SplitsBrowser.Controls.ChartPopup,t=function(a){this.parent=a,this.xScale=null,this.yScale=null,this.overallWidth=-1,this.overallHeight=-1,this.contentWidth=-1,this.contentHeight=-1,this.numControls=-1,this.selectedIndexes=[],this.currentCompetitorData=null,this.isPopupOpen=!1,this.popupUpdateFunc=null,this.maxStartTimeLabelWidth=0,this.mouseOutTimeout=null,this.selectedIndexesOrderedByLastYValue=[],this.referenceCumTimes=[],this.referenceCumTimesSorted=[],this.referenceCumTimeIndexes=[],this.fastestCumTimes=[],this.isMouseIn=!1,this.currentControlIndex=null,this.actualControlIndex=null,this.controlLine=null,this.svg=d3.select(this.parent).append("svg").attr("id",e),this.svgGroup=this.svg.append("g"),this.setLeftMargin(g.left);var b=this,c=function(a){b.onMouseMove(a)},f=function(a){b.onMouseUp(a)},h=function(a){b.onMouseDown(a)};$(this.svg.node()).mouseenter(function(a){b.onMouseEnter(a)}).mousemove(c).mouseleave(function(a){b.onMouseLeave(a)}).mousedown(h).mouseup(f),$(this.svg.node()).contextmenu(function(a){a.preventDefault()}),this.textSizeElement=this.svg.append("text").attr("fill","transparent").attr("id",d);var i={mousemove:c,mousedown:h,mouseup:f};this.popup=new s(a,i),$(document).mouseup(function(){b.popup.hide()})};t.prototype.hide=function(){this.svg.style("position","absolute").style("left","-9999px")},t.prototype.show=function(){this.svg.style("position",null).style("left",null)},t.prototype.setLeftMargin=function(a){this.currentLeftMargin=a,this.svgGroup.attr("transform","translate("+this.currentLeftMargin+","+g.top+")")},t.prototype.getPopupLocation=function(a){return{x:a.pageX+f,y:Math.max(a.pageY-this.popup.height()/2,0)}},t.prototype.getFastestSplitsPopupData=function(){return r.getFastestSplitsPopupData(this.ageClassSet,this.currentControlIndex)},t.prototype.getFastestSplitsForCurrentLegPopupData=function(){return r.getFastestSplitsForLegPopupData(this.ageClassSet,this.eventData,this.currentControlIndex)},t.prototype.setCurrentChartTime=function(a){var b=a.pageY-$(this.svg.node()).offset().top-g.top;this.currentChartTime=Math.round(60*this.yScale.invert(b))+this.referenceCumTimes[this.currentControlIndex]},t.prototype.getCompetitorsVisitingCurrentControlPopupData=function(){return r.getCompetitorsVisitingCurrentControlPopupData(this.ageClassSet,this.eventData,this.currentControlIndex,this.currentChartTime)},t.prototype.getNextControlData=function(){return r.getNextControlData(this.ageClassSet.getCourse(),this.eventData,this.actualControlIndex)},t.prototype.onMouseEnter=function(a){null!==this.mouseOutTimeout&&(clearTimeout(this.mouseOutTimeout),this.mouseOutTimeout=null),this.isMouseIn=!0,this.updateControlLineLocation(a)},t.prototype.onMouseMove=function(a){this.isMouseIn&&null!==this.xScale&&this.updateControlLineLocation(a)},t.prototype.onMouseLeave=function(){var a=this;this.mouseOutTimeout=setTimeout(function(){a.popup.isMouseIn()||(a.isMouseIn=!1,a.removeControlLine())},1)},t.prototype.onMouseDown=function(a){var b=this;setTimeout(function(){b.showPopupDialog(a)},1)},t.prototype.onMouseUp=function(a){this.popup.hide(),a.preventDefault()},t.prototype.showPopupDialog=function(a){if(this.isMouseIn&&null!==this.currentControlIndex){var b=!1,c=this;!this.isRaceGraph||a.which!==j&&a.which!==k?a.which===j?(this.popupUpdateFunc=function(){c.popup.setData(c.getFastestSplitsPopupData(),!1)},b=!0):a.which===k&&this.hasControls&&(this.popupUpdateFunc=function(){c.popup.setData(c.getFastestSplitsForCurrentLegPopupData(),!0)},b=!0):this.hasControls&&(this.setCurrentChartTime(a),this.popupUpdateFunc=function(){c.popup.setData(c.getCompetitorsVisitingCurrentControlPopupData(),!0)},b=!0),b&&(this.updatePopupContents(a),this.popup.show(this.getPopupLocation(a)))}},t.prototype.updatePopupContents=function(a){var b=a.pageY-$(this.svg.node()).offset().top,c=this.hasControls&&b<g.top;c?this.updateNextControlInformation():this.popupUpdateFunc()},t.prototype.updateNextControlInformation=function(){this.hasControls&&this.popup.setNextControlData(this.getNextControlData())},t.prototype.drawControlLine=function(a){this.currentControlIndex=a,this.updateCompetitorStatistics();var b=this.xScale(this.referenceCumTimes[a]);this.controlLine=this.svgGroup.append("line").attr("x1",b).attr("y1",0).attr("x2",b).attr("y2",this.contentHeight).attr("class","controlLine").node()},t.prototype.updateControlLineLocation=function(a){var b=$(this.svg.node()),c=b.offset(),d=a.pageX-c.left,e=a.pageY-c.top;if(this.currentLeftMargin<=d&&d<b.width()-g.right&&e<b.height()-g.bottom){var f,h=this.xScale.invert(d-this.currentLeftMargin),i=d3.bisect(this.referenceCumTimesSorted,h);if(i>=this.referenceCumTimesSorted.length)f=this.referenceCumTimesSorted.length-1;else{var j=Math.abs(this.referenceCumTimesSorted[i]-h),k=Math.abs(h-this.referenceCumTimesSorted[i-1]);f=j>k?i-1:i}var l=this.referenceCumTimeIndexes[f];(null===this.actualControlIndex||this.actualControlIndex!==l)&&(this.removeControlLine(),this.actualControlIndex=l,this.drawControlLine(Math.max(this.minViewableControl,l))),this.popup.isShown()&&null!==this.currentControlIndex&&(this.isRaceGraph&&this.setCurrentChartTime(a),this.updatePopupContents(a),this.popup.setLocation(this.getPopupLocation(a)))}else this.removeControlLine(),this.popup.hide()},t.prototype.removeControlLine=function(){this.currentControlIndex=null,this.actualControlIndex=null,this.updateCompetitorStatistics(),null!==this.controlLine&&(d3.select(this.controlLine).remove(),this.controlLine=null)},t.prototype.getTimesBehindFastest=function(a,b){var c=b.map(function(a){return this.ageClassSet.allCompetitors[a]},this),d=this.fastestCumTimes[a]-this.fastestCumTimes[a-1],e=c.map(function(b){var c=b.getSplitTimeTo(a);return null===c?null:c-d});return e},t.prototype.getTimeLosses=function(a,b){var c=b.map(function(a){return this.ageClassSet.allCompetitors[a]},this),d=c.map(function(b){return b.getTimeLossAt(a)});return d},t.prototype.updateCompetitorStatistics=function(){var c=this.selectedIndexesOrderedByLastYValue.map(function(a){return this.ageClassSet.allCompetitors[a]},this),d=c.map(function(a){return b(a.name,a.getSuffix())});if(null!==this.currentControlIndex&&this.currentControlIndex>0){if(this.visibleStatistics.TotalTime){var e=c.map(function(a){return a.getCumulativeTimeTo(this.currentControlIndex)},this),f=c.map(function(a){return a.getCumulativeRankTo(this.currentControlIndex)},this);d=d3.zip(d,e,f).map(function(b){return b[0]+a(b[1],b[2])})}if(this.visibleStatistics.SplitTime){var g=c.map(function(a){return a.getSplitTimeTo(this.currentControlIndex)},this),h=c.map(function(a){return a.getSplitRankTo(this.currentControlIndex)},this);d=d3.zip(d,g,h).map(function(b){return b[0]+a(b[1],b[2])})}if(this.visibleStatistics.BehindFastest){var i=this.getTimesBehindFastest(this.currentControlIndex,this.selectedIndexesOrderedByLastYValue);d=d3.zip(d,i).map(function(a){return a[0]+l+n(a[1])})}if(this.visibleStatistics.TimeLoss){var j=this.getTimeLosses(this.currentControlIndex,this.selectedIndexesOrderedByLastYValue);d=d3.zip(d,j).map(function(a){return a[0]+l+n(a[1])})}}this.currentCompetitorData.forEach(function(a,b){a.label=d[b]}),d3.selectAll("text.competitorLabel").text(function(a){return a.label})},t.prototype.getTickFormatter=function(){var a=this;return function(b,c){return 0===c?o("StartNameShort"):c===a.numControls+1?o("FinishNameShort"):c.toString()}},t.prototype.getTextWidth=function(a){return this.textSizeElement.text(a).node().getBBox().width},t.prototype.getTextHeight=function(a){return this.textSizeElement.text(a).node().getBBox().height},t.prototype.getMaxGraphEndTextWidth=function(){if(0===this.selectedIndexes.length)return 0;var a=this.selectedIndexes.map(function(a){var c=this.ageClassSet.allCompetitors[a];return this.getTextWidth(b(c.name,c.getSuffix()))},this);return d3.max(a)+this.determineMaxStatisticTextWidth()},t.prototype.getMaxTimeAndRankTextWidth=function(b,d){var e=0,f=0,g=this.selectedIndexes.map(function(a){return this.ageClassSet.allCompetitors[a]},this);d3.range(1,this.numControls+2).forEach(function(a){var h=g.map(function(c){return c[b](a)});e=Math.max(e,c(h));var i=g.map(function(b){return b[d](a)});f=Math.max(f,c(i))});var h=a(e,f);return this.getTextWidth(h)},t.prototype.getMaxSplitTimeAndRankTextWidth=function(){return this.getMaxTimeAndRankTextWidth("getSplitTimeTo","getSplitRankTo")},t.prototype.getMaxCumulativeTimeAndRankTextWidth=function(){return this.getMaxTimeAndRankTextWidth("getCumulativeTimeTo","getCumulativeRankTo")},t.prototype.getMaxTimeBehindFastestWidth=function(){for(var a=0,b=1;b<=this.numControls+1;b+=1){var d=this.getTimesBehindFastest(b,this.selectedIndexes);a=Math.max(a,c(d))}return this.getTextWidth(l+n(a))},t.prototype.getMaxTimeLossWidth=function(){for(var a=0,b=0,c=1;c<=this.numControls+1;c+=1){var d=this.getTimeLosses(c,this.selectedIndexes),e=d.filter(p);e.length>0&&(a=Math.max(a,d3.max(e)),b=Math.min(b,d3.min(e)))}return Math.max(this.getTextWidth(l+n(a)),this.getTextWidth(l+n(b)))},t.prototype.determineMaxStatisticTextWidth=function(){var a=0;return this.visibleStatistics.TotalTime&&(a+=this.getMaxCumulativeTimeAndRankTextWidth()),this.visibleStatistics.SplitTime&&(a+=this.getMaxSplitTimeAndRankTextWidth()),this.visibleStatistics.BehindFastest&&(a+=this.getMaxTimeBehindFastestWidth()),this.visibleStatistics.TimeLoss&&(a+=this.getMaxTimeLossWidth()),a},t.prototype.determineMaxStartTimeLabelWidth=function(a){var b;return b=a.competitorNames.length>0?d3.max(a.competitorNames.map(function(a){return this.getTextWidth("00:00:00 "+a)},this)):0},t.prototype.createScales=function(a){this.xScale=d3.scale.linear().domain(a.xExtent).range([0,this.contentWidth]),this.yScale=d3.scale.linear().domain(a.yExtent).range([0,this.contentHeight]),this.xScaleMinutes=d3.scale.linear().domain([a.xExtent[0]/60,a.xExtent[1]/60]).range([0,this.contentWidth])},t.prototype.drawBackgroundRectangles=function(){var a=this.referenceCumTimes.slice(0);a.sort(d3.ascending);for(var b=1;b<a.length;)a[b]===a[b-1]?a.splice(b,1):b+=1;var c=this,d=this.svgGroup.selectAll("rect").data(d3.range(a.length-1));d.enter().append("rect"),d.attr("x",function(b){return c.xScale(a[b])}).attr("y",0).attr("width",function(b){return c.xScale(a[b+1])-c.xScale(a[b])}).attr("height",this.contentHeight).attr("class",function(a){return 0===a%2?"background1":"background2"}),d.exit().remove()},t.prototype.determineYAxisTickFormatter=function(a){if(this.isRaceGraph){var b=0===a.dataColumns.length?[]:a.dataColumns[0].ys;if(0===b.length)return function(a){return n(60*a)};var c=this.yScale;return function(a){var d=d3.min(b.map(function(b){return Math.abs(c(b)-c(a))}));return d>=i?n(Math.round(60*a)):""}}return null},t.prototype.drawAxes=function(a,b){var c=this.determineYAxisTickFormatter(b),d=d3.svg.axis().scale(this.xScale).orient("top").tickFormat(this.getTickFormatter()).tickValues(this.referenceCumTimes),e=d3.svg.axis().scale(this.yScale).tickFormat(c).orient("left"),f=d3.svg.axis().scale(this.xScaleMinutes).orient("bottom");this.svgGroup.selectAll("g.axis").remove(),this.svgGroup.append("g").attr("class","x axis").call(d),this.svgGroup.append("g").attr("class","y axis").call(e).append("text").attr("transform","rotate(-90)").attr("x",-(this.contentHeight-6)).attr("y",6).attr("dy",".71em").style("text-anchor","start").text(a),this.svgGroup.append("g").attr("class","x axis").attr("transform","translate(0,"+this.contentHeight+")").call(f).append("text").attr("x",60).attr("y",-5).style("text-anchor","start").text(o("LowerXAxisChartLabel"))},t.prototype.drawChartLines=function(a){var b=this,c=function(c){return a.dataColumns.every(function(a){return null===a.ys[c]})?d3.svg.line().x(0).y(0).defined(function(a,b){return 0===b}):d3.svg.line().x(function(a){return b.xScale(a.x)}).y(function(a){return b.yScale(a.ys[c])}).defined(function(a){return p(a.ys[c])}).interpolate("linear")};this.svgGroup.selectAll("path.graphLine").remove(),this.svgGroup.selectAll("line.aroundDubiousTimes").remove(),d3.range(this.numLines).forEach(function(d){var e=m[this.selectedIndexes[d]%m.length],f=function(){b.highlight(b.selectedIndexes[d])},g=function(){b.unhighlight()};this.svgGroup.append("path").attr("d",c(d)(a.dataColumns)).attr("stroke",e).attr("class","graphLine competitor"+this.selectedIndexes[d]).on("mouseenter",f).on("mouseleave",g).append("title").text(a.competitorNames[d]),a.dubiousTimesInfo[d].forEach(function(b){this.svgGroup.append("line").attr("x1",this.xScale(a.dataColumns[b.start].x)).attr("y1",this.yScale(a.dataColumns[b.start].ys[d])).attr("x2",this.xScale(a.dataColumns[b.end].x)).attr("y2",this.yScale(a.dataColumns[b.end].ys[d])).attr("stroke",e).attr("class","aroundDubiousTimes competitor"+this.selectedIndexes[d]).on("mouseenter",f).on("mouseleave",g).append("title").text(a.competitorNames[d])},this)},this)},t.prototype.highlight=function(a){this.svg.selectAll("path.graphLine.competitor"+a).classed("selected",!0),this.svg.selectAll("line.competitorLegendLine.competitor"+a).classed("selected",!0),this.svg.selectAll("text.competitorLabel.competitor"+a).classed("selected",!0),this.svg.selectAll("text.startLabel.competitor"+a).classed("selected",!0),this.svg.selectAll("line.aroundDubiousTimes.competitor"+a).classed("selected",!0)},t.prototype.unhighlight=function(){this.svg.selectAll("path.graphLine.selected").classed("selected",!1),this.svg.selectAll("line.competitorLegendLine.selected").classed("selected",!1),this.svg.selectAll("text.competitorLabel.selected").classed("selected",!1),this.svg.selectAll("text.startLabel.selected").classed("selected",!1),this.svg.selectAll("line.aroundDubiousTimes.selected").classed("selected",!1)},t.prototype.drawCompetitorStartTimeLabels=function(a){var b=a.dataColumns[0],c=this,d=this.svgGroup.selectAll("text.startLabel").data(this.selectedIndexes);d.enter().append("text"),d.attr("x",-7).attr("y",function(d,e){return c.yScale(b.ys[e])+c.getTextHeight(a.competitorNames[e])/4}).attr("class",function(a){return"startLabel competitor"+a}).on("mouseenter",function(a){c.highlight(a)}).on("mouseleave",function(){c.unhighlight()}).text(function(c,d){return n(Math.round(60*b.ys[d]))+" "+a.competitorNames[d]}),d.exit().remove()},t.prototype.removeCompetitorStartTimeLabels=function(){this.svgGroup.selectAll("text.startLabel").remove()},t.prototype.adjustCompetitorLegendLabelsDownwardsIfNecessary=function(){for(var a=1;a<this.numLines;a+=1){var b=this.currentCompetitorData[a-1],c=this.currentCompetitorData[a];c.y<b.y+b.textHeight&&(c.y=b.y+b.textHeight)}},t.prototype.adjustCompetitorLegendLabelsUpwardsIfNecessary=function(a){if(this.numLines>0&&this.currentCompetitorData[this.numLines-1].y>this.contentHeight){this.currentCompetitorData[this.numLines-1].y=Math.max(a,this.contentHeight);for(var b=this.numLines-2;b>=0;b-=1){var c=this.currentCompetitorData[b+1],d=this.currentCompetitorData[b];if(!(d.y+d.textHeight>c.y))break;d.y=c.y-d.textHeight}}},t.prototype.drawCompetitorLegendLabels=function(a){var c=0;if(0===a.dataColumns.length)this.currentCompetitorData=[];else{var d=a.dataColumns[a.dataColumns.length-1];this.currentCompetitorData=d3.range(this.numLines).map(function(a){var e=this.selectedIndexes[a],f=this.ageClassSet.allCompetitors[e].name,g=this.getTextHeight(f);return c+=g,{label:b(f,this.ageClassSet.allCompetitors[e].getSuffix()),textHeight:g,y:p(d.ys[a])?this.yScale(d.ys[a]):null,colour:m[e%m.length],index:e}},this),c-=this.currentCompetitorData[this.numLines-1].textHeight;for(var e=null,f=this.numLines-1;f>=0;f-=1)null===this.currentCompetitorData[f].y&&(this.currentCompetitorData[f].y=null===e?this.contentHeight:e-this.currentCompetitorData[f].textHeight,e=this.currentCompetitorData[f].y)}this.currentCompetitorData.sort(function(a,b){return a.y-b.y}),this.selectedIndexesOrderedByLastYValue=this.currentCompetitorData.map(function(a){return a.index}),this.adjustCompetitorLegendLabelsDownwardsIfNecessary(),this.adjustCompetitorLegendLabelsUpwardsIfNecessary(c);var g=this.svgGroup.selectAll("line.competitorLegendLine").data(this.currentCompetitorData);g.enter().append("line");var i=this;g.attr("x1",this.contentWidth+1).attr("y1",function(a){return a.y}).attr("x2",this.contentWidth+h+1).attr("y2",function(a){return a.y}).attr("stroke",function(a){return a.colour}).attr("class",function(a){return"competitorLegendLine competitor"+a.index}).on("mouseenter",function(a){i.highlight(a.index)}).on("mouseleave",function(){i.unhighlight()}),g.exit().remove();var j=this.svgGroup.selectAll("text.competitorLabel").data(this.currentCompetitorData);j.enter().append("text"),j.attr("x",this.contentWidth+h+2).attr("y",function(a){return a.y+a.textHeight/4}).attr("class",function(a){return"competitorLabel competitor"+a.index}).on("mouseenter",function(a){i.highlight(a.index)}).on("mouseleave",function(){i.unhighlight()}).text(function(a){return a.label}),j.exit().remove()},t.prototype.adjustContentSize=function(){var a=8,b=this.getMaxGraphEndTextWidth();this.setLeftMargin(Math.max(this.maxStartTimeLabelWidth+a,g.left)),this.contentWidth=Math.max(this.overallWidth-this.currentLeftMargin-g.right-b-(h+2),100),this.contentHeight=Math.max(this.overallHeight-g.top-g.bottom,100)},t.prototype.setSize=function(a,b){this.overallWidth=a,this.overallHeight=b,$(this.svg.node()).width(a).height(b),this.adjustContentSize()},t.prototype.clearGraph=function(){this.svgGroup.selectAll("*").remove()},t.prototype.sortReferenceCumTimes=function(){var a=d3.map();this.referenceCumTimes.forEach(function(b,c){a.has(b)||a.set(b,c)}),this.referenceCumTimesSorted=a.keys().map(function(a){return parseInt(a,10)}).sort(d3.ascending),this.referenceCumTimeIndexes=this.referenceCumTimesSorted.map(function(b){return a.get(b)})},t.prototype.drawChart=function(a,b,c,d){var e=a.chartData;this.numControls=e.numControls,this.numLines=e.competitorNames.length,this.selectedIndexes=b,this.referenceCumTimes=a.referenceCumTimes,this.fastestCumTimes=a.fastestCumTimes,this.eventData=a.eventData,this.ageClassSet=a.ageClassSet,this.hasControls=a.ageClassSet.getCourse().hasControls(),this.isRaceGraph=d.isRaceGraph,this.minViewableControl=d.minViewableControl,this.visibleStatistics=c,this.maxStatisticTextWidth=this.determineMaxStatisticTextWidth(),this.maxStartTimeLabelWidth=this.isRaceGraph?this.determineMaxStartTimeLabelWidth(e):0,this.sortReferenceCumTimes(),this.adjustContentSize(),this.createScales(e),this.drawBackgroundRectangles(),this.drawAxes(o(d.yAxisLabelKey),e),this.drawChartLines(e),this.drawCompetitorLegendLabels(e),this.removeControlLine(),this.isRaceGraph?this.drawCompetitorStartTimeLabels(e):this.removeCompetitorStartTimeLabels()},SplitsBrowser.Controls.Chart=t}(),function(){"use strict";var a=SplitsBrowser.formatTime,b=SplitsBrowser.Model.compareCompetitors,c=SplitsBrowser.getMessage,d=SplitsBrowser.getMessageWithFormatting,e="\xa0",f=function(a){this.parent=a,this.ageClass=null,this.div=null,this.headerSpan=null,this.table=null,this.buildTable()};f.prototype.buildTable=function(){this.div=d3.select(this.parent).append("div").attr("id","resultsTableContainer"),this.headerSpan=this.div.append("div").append("span").classed("resultsTableHeader",!0),this.table=this.div.append("table").classed("resultsTable",!0),this.table.append("thead").append("tr"),this.table.append("tbody")},f.prototype.populateTable=function(){function f(a,b,c,d,e,f){var g=a.append("td");g.append("span").classed("dubious",e).text(b),g.append("br"),g.append("span").classed("dubious",f).text(c),d&&g.classed(d,!0)}var g=this.ageClass.name+", ";g+=1===this.ageClass.numControls?c("ResultsTableHeaderSingleControl"):d("ResultsTableHeaderMultipleControls",{$$NUM$$:this.ageClass.numControls});var h=this.ageClass.course;null!==h.length&&(g+=", "+d("ResultsTableHeaderCourseLength",{$$DISTANCE$$:h.length.toFixed(1)})),null!==h.climb&&(g+=", "+d("ResultsTableHeaderClimb",{$$CLIMB$$:h.climb})),this.headerSpan.text(g);var i=[c("ResultsTableHeaderControlNumber"),c("ResultsTableHeaderName"),c("ResultsTableHeaderTime")],j=this.ageClass.course.controls;i=null===j?i.concat(d3.range(1,this.ageClass.numControls+1)):i.concat(j.map(function(a,b){return b+1+e+"("+a+")"})),i.push(c("FinishName"));var k=this.table.select("thead tr").selectAll("th").data(i);k.enter().append("th"),k.text(function(a){return a}),k.exit().remove();var l=this.table.select("tbody");l.selectAll("tr").remove();var m=this.ageClass.competitors.slice(0);m.sort(b);var n=0,o=0;m.forEach(function(b,d){var g=l.append("tr"),h=g.append("td");b.isNonCompetitive?(h.text(c("NonCompetitiveShort")),n+=1):b.completed()&&((0===d||m[d-1].totalTime!==b.totalTime)&&(o=d+1-n),h.text(o)),f(g,b.name,b.club,!1,!1),f(g,b.completed()?a(b.totalTime):c("MispunchedShort"),e,"time",!1,!1),d3.range(1,this.ageClass.numControls+2).forEach(function(c){var d=b.isCumulativeTimeDubious(c),e=b.isSplitTimeDubious(c);f(g,a(b.getOriginalCumulativeTimeTo(c)),a(b.getOriginalSplitTimeTo(c)),"time",d,e)})},this)},f.prototype.setClass=function(a){this.ageClass=a,this.populateTable(),"none"!==this.div.style("display")&&this.adjustTableCellWidths()},f.prototype.adjustTableCellWidths=function(){var a=d3.select("tbody tr td:last-child").node();$("tbody td.time").width($(a).width())},f.prototype.show=function(){this.div.style("display",null),this.adjustTableCellWidths()},f.prototype.hide=function(){this.div.style("display","none")},SplitsBrowser.Controls.ResultsTable=f}(),function(){"use strict";function a(a,b){a.property("disabled",!b)}function b(){alert(i("RaceGraphDisabledAsStartTimesMissing"))}function c(a,b){d3.select("body").append("h1").text(i("LoadFailedHeader")),d3.select("body").append("p").text(k(a,b))}function d(a,b,d){"success"===b?SplitsBrowser.readEvent(a,d):c("LoadFailedStatusNotSuccess",{$$STATUS$$:b})}function e(a,b,d){c("LoadFailedReadError",{$$ERROR$$:d})}var f=100,g="competitorListContainer",h=SplitsBrowser.Version,i=SplitsBrowser.getMessage,j=SplitsBrowser.tryGetMessage,k=SplitsBrowser.getMessageWithFormatting,l=SplitsBrowser.Model,m=l.CompetitorSelection,n=l.AgeClassSet,o=l.ChartTypes,p=SplitsBrowser.Input.parseEventData,q=SplitsBrowser.DataRepair.repairEventData,r=SplitsBrowser.DataRepair.transferCompetitorData,s=SplitsBrowser.Controls,t=s.ClassSelector,u=s.ChartTypeSelector,v=s.ComparisonSelector,w=s.OriginalDataSelector,x=s.StatisticsSelector,y=s.CompetitorListBox,z=s.Chart,A=s.ResultsTable,B=function(a){this.options=a,this.eventData=null,this.classes=null,this.currentClasses=[],this.currentIndexes=null,this.chartData=null,this.referenceCumTimes=null,this.fastestCumTimes=null,this.previousCompetitorList=[],this.topBarHeight=a&&a.topBar&&$(a.topBar).length>0?$(a.topBar).height():0,this.selection=null,this.ageClassSet=null,this.classSelector=null,this.comparisonSelector=null,this.originalDataSelector=null,this.statisticsSelector=null,this.competitorListBox=null,this.chart=null,this.topPanel=null,this.mainPanel=null,this.buttonsPanel=null,this.competitorListContainer=null,this.currentResizeTimeout=null};B.prototype.enableOrDisableRaceGraph=function(){var a=this.ageClassSet.allCompetitors.some(function(a){return a.lacksStartTime()});this.chartTypeSelector.setRaceGraphDisabledNotifier(a?b:null)},B.prototype.setEvent=function(a){this.eventData=a,this.classes=a.classes,null!==this.classSelector&&this.classSelector.setClasses(this.classes)},B.prototype.drawLogo=function(){var a=this.topPanel.append("svg").style("float","left");a.style("width","19px").style("height","19px").style("margin-bottom","-3px").style("margin-right","20px"),a.append("rect").attr("x","0").attr("y","0").attr("width","19").attr("height","19").attr("fill","white"),a.append("polygon").attr("points","0,19 19,0 19,19").attr("fill","red"),a.append("polyline").attr("points","0.5,0.5 0.5,18.5 18.5,18.5 18.5,0.5 0.5,0.5 0.5,18.5").attr("stroke","black").attr("fill","none"),a.append("polyline").attr("points","1,12 5,8 8,14 17,11").attr("fill","none").attr("stroke","blue").attr("stroke-width","2"),a.selectAll("*").append("title").text(k("ApplicationVersion",{$$VERSION$$:h}))},B.prototype.addSpacer=function(){this.topPanel.append("div").classed("topRowSpacer",!0)},B.prototype.addCountryFlag=function(){var a=this.topPanel.append("img").attr("id","flagImage").attr("src",this.options.flagImageURL).attr("alt",j("Language","")).attr("title",j("Language",""));this.options.hasOwnProperty("flagImageWidth")&&a.attr("width",this.options.flagImageWidth),this.options.hasOwnProperty("flagImageHeight")&&a.attr("height",this.options.flagImageHeight)},B.prototype.addClassSelector=function(){this.classSelector=new t(this.topPanel.node()),null!==this.classes&&this.classSelector.setClasses(this.classes)},B.prototype.addChartTypeSelector=function(){var a=[o.SplitsGraph,o.RaceGraph,o.PositionAfterLeg,o.SplitPosition,o.PercentBehind,o.ResultsTable];this.chartTypeSelector=new u(this.topPanel.node(),a),this.chartType=this.chartTypeSelector.getChartType()},B.prototype.addComparisonSelector=function(){this.comparisonSelector=new v(this.topPanel.node(),function(a){alert(a)}),null!==this.classes&&this.comparisonSelector.setClasses(this.classes),this.comparisonFunction=this.comparisonSelector.getComparisonFunction()},B.prototype.addOriginalDataSelector=function(){var a=this,b=function(){r(a.eventData),a.eventData.determineTimeLosses(),a.drawChart()},c=function(){q(a.eventData),a.eventData.determineTimeLosses(),a.drawChart()};this.originalDataSelector=new w(this.topPanel,b,c)},B.prototype.addCompetitorList=function(){this.competitorListContainer=this.mainPanel.append("div").attr("id",g),this.buttonsPanel=this.competitorListContainer.append("div");var a=this;this.allButton=this.buttonsPanel.append("button").text(i("SelectAllCompetitors")).style("width","50%").on("click",function(){a.selectAll()}),this.noneButton=this.buttonsPanel.append("button").text(i("SelectNoCompetitors")).style("width","50%").on("click",function(){a.selectNone()}),this.buttonsPanel.append("br"),this.crossingRunnersButton=this.buttonsPanel.append("button").text(i("SelectCrossingRunners")).style("width","100%").on("click",function(){a.selectCrossingRunners()}).style("display","none"),this.competitorListBox=new y(this.competitorListContainer.node())},B.prototype.buildUi=function(){var a=d3.select("body");this.topPanel=a.append("div"),this.drawLogo(),this.options&&this.options.flagImageURL&&this.addCountryFlag(),this.addClassSelector(),this.addSpacer(),this.addChartTypeSelector(),this.addSpacer(),this.addComparisonSelector(),this.addOriginalDataSelector(),this.statisticsSelector=new x(this.topPanel.node()),this.topPanel.append("div").style("clear","both"),this.mainPanel=a.append("div"),this.addCompetitorList(),this.chart=new z(this.mainPanel.node()),this.resultsTable=new A(a.node()),this.resultsTable.hide();var b=this;this.classSelector.registerChangeHandler(function(a){b.selectClasses(a)}),this.chartTypeSelector.registerChangeHandler(function(a){b.selectChartType(a)}),this.comparisonSelector.registerChangeHandler(function(a){b.selectComparison(a)}),$(window).resize(function(){b.handleWindowResize()}),$("body").bind("selectstart",function(){return!1})},B.prototype.selectAll=function(){this.selection.selectAll()},B.prototype.selectNone=function(){this.selection.selectNone()},B.prototype.selectCrossingRunners=function(){if(this.selection.selectCrossingRunners(this.ageClassSet.allCompetitors),this.selection.isSingleRunnerSelected()){var a=this.ageClassSet.allCompetitors[this.currentIndexes[0]].name;
alert(k("RaceGraphNoCrossingRunners",{$$NAME$$:a}))}},B.prototype.handleWindowResize=function(){null!==this.currentResizeTimeout&&clearTimeout(this.currentResizeTimeout);var a=this;this.currentResizeTimeout=setTimeout(function(){a.postResizeHook()},f)},B.prototype.postResizeHook=function(){this.currentResizeTimeout=null,this.drawChart()},B.prototype.adjustSize=function(){var a=parseInt($("body").css("margin-left"),10)+parseInt($("body").css("margin-right"),10),b=parseInt($("body").css("margin-top"),10)+parseInt($("body").css("margin-bottom"),10),c=2,d=$(window).width()-a,e=$(window).height()-b-this.topBarHeight;$("body").width(d).height(e);var f=$(this.topPanel.node()).height();this.chart.hide(),this.competitorListBox.setCompetitorList(this.ageClassSet.allCompetitors,this.currentClasses.length>1);var g=d-this.competitorListBox.width()-c,h=e-f;this.chart.setSize(g,h),this.chart.show(),$(this.competitorListContainer.node()).height(e-$(this.buttonsPanel.node()).height()-f)},B.prototype.drawChart=function(){if(!this.chartType.isResultsTable){this.adjustSize(),this.currentVisibleStatistics=this.statisticsSelector.getVisibleStatistics(),null!==this.selectionChangeHandler&&this.selection.deregisterChangeHandler(this.selectionChangeHandler),null!==this.statisticsChangeHandler&&this.statisticsSelector.deregisterChangeHandler(this.statisticsChangeHandler);var a=this;this.selectionChangeHandler=function(b){a.currentIndexes=b,a.enableOrDisableCrossingRunnersButton(),a.redraw()},this.selection.registerChangeHandler(this.selectionChangeHandler),this.statisticsChangeHandler=function(b){a.currentVisibleStatistics=b,a.redraw()},this.statisticsSelector.registerChangeHandler(this.statisticsChangeHandler),this.updateControlEnabledness(),this.referenceCumTimes=this.comparisonFunction(this.ageClassSet),this.fastestCumTimes=this.ageClassSet.getFastestCumTimes(),this.chartData=this.ageClassSet.getChartData(this.referenceCumTimes,this.currentIndexes,this.chartType),this.redrawChart()}},B.prototype.redrawChart=function(){var a={chartData:this.chartData,eventData:this.eventData,ageClassSet:this.ageClassSet,referenceCumTimes:this.referenceCumTimes,fastestCumTimes:this.fastestCumTimes};this.chart.drawChart(a,this.currentIndexes,this.currentVisibleStatistics,this.chartType)},B.prototype.redraw=function(){this.chartType.isResultsTable||(this.chartData=this.ageClassSet.getChartData(this.referenceCumTimes,this.currentIndexes,this.chartType),this.redrawChart())},B.prototype.selectClasses=function(a){null===this.selection?(this.selection=new m(0),this.competitorListBox.setSelection(this.selection)):a.length>0&&this.currentClasses.length>0&&this.classes[a[0]]===this.currentClasses[0]||this.selection.selectNone(),this.currentIndexes=[],this.currentClasses=a.map(function(a){return this.classes[a]},this),this.ageClassSet=new n(this.currentClasses),this.comparisonSelector.setAgeClassSet(this.ageClassSet),this.resultsTable.setClass(this.currentClasses[0]),this.drawChart(),this.selection.migrate(this.previousCompetitorList,this.ageClassSet.allCompetitors),this.previousCompetitorList=this.ageClassSet.allCompetitors,this.enableOrDisableRaceGraph(),this.originalDataSelector.setVisible(this.ageClassSet.hasDubiousData())},B.prototype.selectComparison=function(a){this.comparisonFunction=a,this.drawChart()},B.prototype.selectChartType=function(a){this.chartType=a,a.isResultsTable?(this.mainPanel.style("display","none"),d3.select("body").style("width",null).style("height",null),this.resultsTable.show()):(this.resultsTable.hide(),this.mainPanel.style("display",null)),this.updateControlEnabledness(),this.crossingRunnersButton.style("display",a.isRaceGraph?null:"none"),this.drawChart()},B.prototype.updateControlEnabledness=function(){this.classSelector.setOtherClassesEnabled(!this.chartType.isResultsTable),this.comparisonSelector.setEnabled(!this.chartType.isResultsTable),this.statisticsSelector.setEnabled(!this.chartType.isResultsTable),this.originalDataSelector.setEnabled(!this.chartType.isResultsTable),this.enableOrDisableCrossingRunnersButton()},B.prototype.enableOrDisableCrossingRunnersButton=function(){a(this.crossingRunnersButton,this.selection.isSingleRunnerSelected())},SplitsBrowser.Viewer=B,SplitsBrowser.readEvent=function(a,b){var d;try{d=p(a)}catch(e){if("InvalidData"===e.name)return c("LoadFailedInvalidData",{$$MESSAGE$$:e.message}),void 0;throw e}if(null===d)c("LoadFailedUnrecognisedData",{});else{d.needsRepair()&&q(d),"string"==typeof b&&(b={topBar:b}),d.determineTimeLosses();var f=new B(b);f.buildUi(),f.setEvent(d),f.selectClasses([0])}},SplitsBrowser.loadEvent=function(a,b){$.ajax({url:a,data:"",success:function(a,c){d(a,c,b)},dataType:"text",error:e})}}();