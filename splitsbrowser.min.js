var SplitsBrowser={Model:{},Input:{},Controls:{}};!function(){"use strict";SplitsBrowser.isTrue=function(a){return a},SplitsBrowser.isNotNull=function(a){return null!==a};var a=function(a){this.name="InvalidData",this.message=a};a.prototype.toString=function(){return this.name+": "+this.message},SplitsBrowser.throwInvalidData=function(b){throw new a(b)};var b=function(a){this.name="WrongFileFormat",this.message=a};b.prototype.toString=function(){return this.name+": "+this.message},SplitsBrowser.throwWrongFileFormat=function(a){throw new b(a)}}(),function(){"use strict";SplitsBrowser.NULL_TIME_PLACEHOLDER="-----",SplitsBrowser.formatTime=function(a){if(null===a)return SplitsBrowser.NULL_TIME_PLACEHOLDER;var b="";0>a&&(b="-",a=-a);var c=Math.floor(a/3600),d=Math.floor(a/60)%60,e=a%60;return c>0&&(b+=c.toString()+":"),10>d&&(b+="0"),b+=d+":",10>e&&(b+="0"),b+=e},SplitsBrowser.parseTime=function(a){return a.match(/^\d+:\d\d$/)?60*parseInt(a.substring(0,a.length-3),10)+parseInt(a.substring(a.length-2),10):a.match(/^\d+:\d\d:\d\d$/)?3600*parseInt(a.substring(0,a.length-6),10)+60*parseInt(a.substring(a.length-5,a.length-3),10)+parseInt(a.substring(a.length-2),10):null}}(),function(){"use strict";function a(a,b){return null===a||null===b?null:a+b}function b(a,b){return null===a||null===b?null:a-b}function c(b){if(!$.isArray(b))throw new TypeError("Split times must be an array - got "+typeof b+" instead");0===b.length&&f("Array of split times must not be empty");for(var c=[0],d=0;d<b.length;d+=1)c.push(a(c[d],b[d]));return c}function d(a){if(!$.isArray(a))throw new TypeError("Cumulative times must be an array - got "+typeof a+" instead");0===a.length?f("Array of cumulative times must not be empty"):0!==a[0]?f("Array of cumulative times must have zero as its first item"):1===a.length&&f("Array of cumulative times must contain more than just a single zero");for(var c=[],d=0;d+1<a.length;d+=1)c.push(b(a[d+1],a[d]));return c}var e="number",f=SplitsBrowser.throwInvalidData;SplitsBrowser.Model.compareCompetitors=function(a,b){return a.totalTime===b.totalTime?a.order-b.order:null===a.totalTime?null===b.totalTime?0:1:null===b.totalTime?-1:a.totalTime-b.totalTime};var g=function(a,b,c,d,g,h,i){typeof a!==e&&f("Competitor order must be a number, got "+typeof a+" '"+a+"' instead"),this.order=a,this.forename=b,this.surname=c,this.club=d,this.startTime=g,this.isNonCompetitive=!1,this.className=null,this.splitTimes=h,this.cumTimes=i,this.splitRanks=null,this.cumRanks=null,this.name=b+" "+c,this.totalTime=this.cumTimes.indexOf(null)>-1?null:this.cumTimes[this.cumTimes.length-1]};g.prototype.setNonCompetitive=function(){this.isNonCompetitive=!0},g.prototype.setClassName=function(a){this.className=a},g.fromSplitTimes=function(a,b,d,e,f,h){var i=c(h);return new g(a,b,d,e,f,h,i)},g.fromCumTimes=function(a,b,c,e,f,h){var i=d(h);return new g(a,b,c,e,f,i,h)},g.prototype.completed=function(){return null!==this.totalTime},g.prototype.getSuffix=function(){return this.completed()?this.isNonCompetitive?"n/c":"":"mp"},g.prototype.getSplitTimeTo=function(a){return 0===a?0:this.splitTimes[a-1]},g.prototype.getCumulativeTimeTo=function(a){return this.cumTimes[a]},g.prototype.getSplitRankTo=function(a){return 0===a?null:this.splitRanks[a-1]},g.prototype.getCumulativeRankTo=function(a){return 0===a?null:this.cumRanks[a-1]},g.prototype.getAllCumulativeTimes=function(){return this.cumTimes},g.prototype.setSplitAndCumulativeRanks=function(a,b){this.splitRanks=a,this.cumRanks=b},g.prototype.getCumTimesAdjustedToReference=function(a){a.length!==this.cumTimes.length?f("Cannot adjust competitor times because the numbers of times are different ("+this.cumTimes.length+" and "+a.length+")"):a.indexOf(null)>-1&&f("Cannot adjust competitor times because a null value is in the reference data");var c=this.cumTimes.map(function(c,d){return b(c,a[d])});return c},g.prototype.getCumTimesAdjustedToReferenceWithStartAdded=function(b){var c=this.getCumTimesAdjustedToReference(b),d=this.startTime;return c.map(function(b){return a(b,d)})},g.prototype.getSplitPercentsBehindReferenceCumTimes=function(a){a.length!==this.cumTimes.length?f("Cannot determine percentages-behind because the numbers of times are different ("+this.cumTimes.length+" and "+a.length+")"):a.indexOf(null)>-1&&f("Cannot determine percentages-behind because a null value is in the reference data");var b=[0];return this.splitTimes.forEach(function(c,d){if(null===c)b.push(null);else{var e=a[d+1]-a[d];b.push(100*(c-e)/e)}}),b},g.prototype.crosses=function(a){a.cumTimes.length!==this.cumTimes.length&&f("Two competitors with different numbers of controls cannot cross");for(var b=!1,c=!1,d=0;d<this.cumTimes.length;d+=1)if(null!==this.cumTimes[d]&&null!==a.cumTimes[d]){var e=this.startTime+this.cumTimes[d],g=a.startTime+a.cumTimes[d];g>e?b=!0:e>g&&(c=!0)}return b&&c},SplitsBrowser.Model.Competitor=g}(),function(){"use strict";var a=SplitsBrowser.throwInvalidData,b=function(a,b,c){this.name=a,this.numControls=b,this.competitors=c,this.course=null,this.competitors.forEach(function(a){a.setClassName(this.name)},this)};b.prototype.setCourse=function(a){this.course=a},b.prototype.getControlsWithNoSplits=function(){return d3.range(1,this.numControls+1).filter(function(a){return this.competitors.every(function(b){return null===b.getSplitTimeTo(a)})},this)},b.prototype.getFastestSplitTo=function(b){("number"!=typeof b||1>b||b>this.numControls+1)&&a("Cannot return splits to leg '"+this.numControls+"' in a course with "+this.numControls+" control(s)");var c=null,d=null;return this.competitors.forEach(function(a){var e=a.getSplitTimeTo(b);null!==e&&(null===c||c>e)&&(c=e,d=a)}),null===c?null:{split:c,name:d.name}},b.prototype.getCompetitorsAtControlInTimeRange=function(b,c,d){("number"!=typeof b||isNaN(b)||0>b||b>this.numControls+1)&&a("Control number must be a number between 0 and "+this.numControls+" inclusive");var e=[];return this.competitors.forEach(function(a){var f=a.getCumulativeTimeTo(b);if(null!==f&&null!==a.startTime){var g=f+a.startTime;g>=c&&d>=g&&e.push({name:a.name,time:g})}}),e},SplitsBrowser.Model.AgeClass=b}(),function(){"use strict";function a(a){0===a.length&&c("Cannot create an AgeClassSet from an empty set of competitors");var b=[],e=a[0].numControls;return a.forEach(function(a){a.numControls!==e&&c("Cannot merge age classes with "+e+" and "+a.numControls+" controls"),a.competitors.forEach(function(a){b.push(a)})}),b.sort(d),b}function b(a){var b=a.filter(function(a){return null!==a});b.sort(d3.ascending);var c=new d3.map;b.forEach(function(a,b){c.has(a)||c.set(a,b+1)});var d=a.map(function(a){return null===a?null:c.get(a)});return d}var c=SplitsBrowser.throwInvalidData,d=SplitsBrowser.Model.compareCompetitors,e=function(b){this.allCompetitors=a(b),this.ageClasses=b,this.numControls=b[0].numControls,this.computeRanks()};e.prototype.isEmpty=function(){return 0===this.allCompetitors.length},e.prototype.getCourse=function(){return this.ageClasses[0].course},e.prototype.getPrimaryClassName=function(){return this.ageClasses[0].name},e.prototype.getNumClasses=function(){return this.ageClasses.length},e.prototype.getWinnerCumTimes=function(){if(0===this.allCompetitors.length)return null;var a=this.allCompetitors[0];return a.completed()?a.cumTimes:null},e.prototype.getFastestCumTimes=function(){return this.getFastestCumTimesPlusPercentage(0)},e.prototype.getControlsWithNoSplits=function(){for(var a=this.ageClasses[0].getControlsWithNoSplits(),b=1;b<this.ageClasses.length&&a.length>0;b+=1)for(var c=this.ageClasses[b].getControlsWithNoSplits(),d=0;d<a.length;)c.indexOf(a[d])>=0?d+=1:a.splice(d,1);return a},e.prototype.getFastestCumTimesPlusPercentage=function(a){var b=1+a/100,c=new Array(this.numControls+1);c[0]=0;for(var d=1;d<=this.numControls+1;d+=1){for(var e=null,f=0;f<this.allCompetitors.length;f+=1){var g=this.allCompetitors[f].getSplitTimeTo(d);null!==g&&(null===e||e>g)&&(e=g)}if(null===e)return null;c[d]=c[d-1]+e*b}return c},e.prototype.computeRanks=function(){var a=[],c=[];this.allCompetitors.forEach(function(){a.push([]),c.push([])}),d3.range(1,this.numControls+2).forEach(function(c){var d=this.allCompetitors.map(function(a){return a.getSplitTimeTo(c)}),e=b(d);this.allCompetitors.forEach(function(b,c){a[c].push(e[c])})},this),d3.range(1,this.numControls+2).forEach(function(a){var d=this.allCompetitors.map(function(b,d){return a>1&&null===c[d][a-1-1]?null:b.getCumulativeTimeTo(a)}),e=b(d);this.allCompetitors.forEach(function(a,b){c[b].push(e[b])})},this),this.allCompetitors.forEach(function(b,d){b.setSplitAndCumulativeRanks(a[d],c[d])})},e.prototype.getFastestSplitsTo=function(a,b){if("number"!=typeof a||0>=a)c("The number of splits must be a positive integer");else{if(!("number"!=typeof b||0>=b||b>this.numControls+1)){var d=function(a,c){var d=a.getSplitTimeTo(b),e=c.getSplitTimeTo(b);return d===e?d3.ascending(a.totalTime,c.totalTime):d3.ascending(d,e)},e=this.allCompetitors.filter(function(a){return a.completed()});e.sort(d);for(var f=[],g=0;g<e.length&&a>g;g+=1)f.push({name:e[g].name,split:e[g].getSplitTimeTo(b)});return f}c("Control "+b+" out of range")}},e.prototype.getChartData=function(a,b,d){if(this.isEmpty())c("Cannot return chart data when there is no data");else{if("undefined"==typeof a)throw new TypeError("referenceCumTimes undefined or missing");if("undefined"==typeof b)throw new TypeError("currentIndexes undefined or missing");if("undefined"==typeof d)throw new TypeError("chartType undefined or missing")}var e,f,g=this.allCompetitors.map(function(b){return d.dataSelector(b,a)}),h=b.map(function(a){return g[a]}),i=a[a.length-1];if(0===b.length){var j=g[0];e=d3.min(j),f=d3.max(j)}else e=d3.min(h.map(function(a){return d3.min(a)})),f=d3.max(h.map(function(a){return d3.max(a)}));f===e&&(f=e+1);var k=d3.transpose(h),l=d.skipStart?a.slice(1):a,m=d3.zip(l,k),n=b.map(function(a){return this.allCompetitors[a].name},this);return{dataColumns:m.map(function(a){return{x:a[0],ys:a[1]}}),competitorNames:n,numControls:this.numControls,xExtent:[0,i],yExtent:[e,f]}},SplitsBrowser.Model.AgeClassSet=e}(),function(){"use strict";var a=SplitsBrowser.throwInvalidData,b=function(a,b,c,d,e){this.name=a,this.classes=b,this.length=c,this.climb=d,this.controls=e};b.START="__START__",b.FINISH="__FINISH__";var c=b.START,d=b.FINISH;b.prototype.getOtherClasses=function(b){var c=this.classes.filter(function(a){return a!==b});return c.length!==this.classes.length?c:(a("Course.getOtherClasses: given class is not in this course"),void 0)},b.prototype.getNumClasses=function(){return this.classes.length},b.prototype.hasControls=function(){return null!==this.controls},b.prototype.getControlCode=function(b){return 0===b?c:b>=1&&b<=this.controls.length?this.controls[b-1]:b===this.controls.length+1?d:(a("Cannot get control code of control "+b+" because it is out of range"),void 0)},b.prototype.usesLeg=function(a,b){return this.getLegNumber(a,b)>=0},b.prototype.getLegNumber=function(a,b){if(null===this.controls)return-1;if(null===a&&null===b)return 0===this.controls.length?1:-1;if(a===c)return this.controls.length>0&&this.controls[0]===b?1:-1;if(b===d)return this.controls.length>0&&this.controls[this.controls.length-1]===a?this.controls.length+1:-1;for(var e=1;e<this.controls.length;e+=1)if(this.controls[e-1]===a&&this.controls[e]===b)return e+1;return-1},b.prototype.getFastestSplitsForLeg=function(b,e){null===this.legs&&a("Cannot determine fastest splits for a leg because leg information is not available");var f=this.getLegNumber(b,e);if(0>f){var g=(b===c?"start":b)+" to "+(e===d?"end":e);a("Leg from "+g+" not found in course "+this.name)}var h=f,i=[];return this.classes.forEach(function(a){var b=a.getFastestSplitTo(h);null!==b&&i.push({name:b.name,className:a.name,split:b.split})}),i},b.prototype.getCompetitorsAtControlInTimeRange=function(a,b,e){if(null===this.controls)return[];if(a===c)return this.getCompetitorsAtControlNumInTimeRange(0,b,e);if(a===d)return this.getCompetitorsAtControlNumInTimeRange(this.controls.length+1,b,e);var f=this.controls.indexOf(a);return f>=0?this.getCompetitorsAtControlNumInTimeRange(f+1,b,e):[]},b.prototype.getCompetitorsAtControlNumInTimeRange=function(a,b,c){var d=[];return this.classes.forEach(function(e){e.getCompetitorsAtControlInTimeRange(a,b,c).forEach(function(a){d.push({name:a.name,time:a.time,className:e.name})})}),d},SplitsBrowser.Model.Course=b}(),function(){"use strict";var a=function(a,b){this.classes=a,this.courses=b};a.prototype.getFastestSplitsForLeg=function(a,b){var c=[];return this.courses.forEach(function(d){d.usesLeg(a,b)&&(c=c.concat(d.getFastestSplitsForLeg(a,b)))}),c.sort(function(a,b){return d3.ascending(a.split,b.split)}),c},a.prototype.getCompetitorsAtControlInTimeRange=function(a,b,c){var d=[];return this.courses.forEach(function(e){e.getCompetitorsAtControlInTimeRange(a,b,c).forEach(function(a){d.push(a)})}),d.sort(function(a,b){return d3.ascending(a.time,b.time)}),d},SplitsBrowser.Model.Event=a}(),function(){function a(a){return null===a?null:a/60}SplitsBrowser.Model.ChartTypes={SplitsGraph:{name:"Splits graph",dataSelector:function(b,c){return b.getCumTimesAdjustedToReference(c).map(a)},skipStart:!1,yAxisLabel:"Time loss (min)",isRaceGraph:!1,isResultsTable:!1,minViewableControl:1},RaceGraph:{name:"Race graph",dataSelector:function(b,c){return b.getCumTimesAdjustedToReferenceWithStartAdded(c).map(a)},skipStart:!1,yAxisLabel:"Time",isRaceGraph:!0,isResultsTable:!1,minViewableControl:0},PositionAfterLeg:{name:"Position after leg",dataSelector:function(a){return a.cumRanks},skipStart:!0,yAxisLabel:"Position",isRaceGraph:!1,isResultsTable:!1,minViewableControl:1},SplitPosition:{name:"Split position",dataSelector:function(a){return a.splitRanks},skipStart:!0,yAxisLabel:"Position",isRaceGraph:!1,isResultsTable:!1,minViewableControl:1},PercentBehind:{name:"Percent behind",dataSelector:function(a,b){return a.getSplitPercentsBehindReferenceCumTimes(b)},skipStart:!1,yAxisLabel:"Percent behind",isRaceGraph:!1,isResultsTable:!1,minViewableControl:1},ResultsTable:{name:"Results table",dataSelector:null,skipStart:!1,yAxisLabel:null,isRaceGraph:!1,isResultsTable:!0,minViewableControl:1}}}(),function(){"use strict";var a="number",b=SplitsBrowser.throwInvalidData,c=function(c){typeof c!==a?b("Competitor count must be a number"):0>c&&b("Competitor count must be a non-negative number"),this.count=c,this.currentIndexes=[],this.changeHandlers=[]};c.prototype.isSelected=function(a){return this.currentIndexes.indexOf(a)>-1},c.prototype.isSingleRunnerSelected=function(){return 1===this.currentIndexes.length},c.prototype.selectCrossingRunners=function(a){if(this.isSingleRunnerSelected()){var b=a[this.currentIndexes[0]];a.forEach(function(a,c){a.crosses(b)&&this.currentIndexes.push(c)},this),this.currentIndexes.sort(d3.ascending),this.fireChangeHandlers()}},c.prototype.fireChangeHandlers=function(){this.changeHandlers.forEach(function(a){a(this.currentIndexes.slice(0))},this)},c.prototype.selectAll=function(){this.currentIndexes=d3.range(this.count),this.fireChangeHandlers()},c.prototype.selectNone=function(){this.currentIndexes=[],this.fireChangeHandlers()},c.prototype.registerChangeHandler=function(a){-1===this.changeHandlers.indexOf(a)&&this.changeHandlers.push(a)},c.prototype.deregisterChangeHandler=function(a){var b=this.changeHandlers.indexOf(a);b>-1&&this.changeHandlers.splice(b,1)},c.prototype.toggle=function(c){if(typeof c===a)if(c>=0&&c<this.count){var d=this.currentIndexes.indexOf(c);-1===d?(this.currentIndexes.push(c),this.currentIndexes.sort(d3.ascending)):this.currentIndexes.splice(d,1),this.fireChangeHandlers()}else b("Index '"+c+"' is out of range");else b("Index is not a number")},c.prototype.migrate=function(a,c){$.isArray(a)?$.isArray(c)?a.length!==this.count?b("CompetitorSelection.migrate: oldCompetitors list must have the same length as the current count"):0===c.length&&b("CompetitorSelection.migrate: newCompetitors list must not be empty"):b("CompetitorSelection.migrate: newCompetitors not an array"):b("CompetitorSelection.migrate: oldCompetitors not an array");var d=this.currentIndexes.map(function(b){return a[b]});this.count=c.length,this.currentIndexes=[],c.forEach(function(a,b){d.indexOf(a)>=0&&this.currentIndexes.push(b)},this),this.fireChangeHandlers()},SplitsBrowser.Model.CompetitorSelection=c}(),function(){"use strict";function a(a,b,c){var d=b.split(",");if(d.length===c+5){var f=d.shift(),i=d.shift(),j=d.shift(),k=60*g(d.shift()),l=d.map(g);return l.indexOf(0)>=0&&e("Zero split times are not permitted - found one or more zero splits for competitor '"+f+" "+i+"'"),h.fromSplitTimes(a+1,f,i,j,k,l)}e("Expected "+(c+5)+" items in row for competitor in class with "+c+" controls, got "+d.length+" instead.")}function b(b){var c=b.split("\r\n").filter(d);0===c.length&&e("parseAgeClass got an empty list of lines");var g=c.shift().split(",");if(2===g.length){var h=g.shift(),k=g.shift(),l=parseInt(k,10);if(isNaN(l))e("Could not read control count: '"+k+"'");else{if(!(0>l)){var m=c.map(function(b,c){return a(c,b,l)});return m.sort(i),new j(h,l,m)}e("Expected a positive control count, got "+l+" instead")}}else f("Expected first line to have two parts (class name and number of controls), got "+g.length+" part(s) instead")}function c(a){for(var c=a.split("\r\n\r\n").map($.trim).filter(d),e=c.map(b),f=e.map(function(a){return new k(a.name,[a],null,null,null)}),g=0;g<e.length;g+=1)e[g].setCourse(f[g]);return new l(e,f)}var d=SplitsBrowser.isTrue,e=SplitsBrowser.throwInvalidData,f=SplitsBrowser.throwWrongFileFormat,g=SplitsBrowser.parseTime,h=SplitsBrowser.Model.Competitor,i=SplitsBrowser.Model.compareCompetitors,j=SplitsBrowser.Model.AgeClass,k=SplitsBrowser.Model.Course,l=SplitsBrowser.Model.Event;SplitsBrowser.Input.CSV={parseEventData:c}}(),function(){"use strict";function a(a,c){null!==c&&a>=c&&b("Cumulative times must be strictly ascending: read "+d(a)+" and "+d(c)+" in that order")}var b=SplitsBrowser.throwInvalidData,c=SplitsBrowser.throwWrongFileFormat,d=SplitsBrowser.formatTime,e=SplitsBrowser.parseTime,f=SplitsBrowser.Model.Competitor,g=SplitsBrowser.Model.AgeClass,h=SplitsBrowser.Model.Course,i=SplitsBrowser.Model.Event,j={SURNAME:3,FORENAME:4,START:9,TIME:11,CLUB:15,AGE_CLASS:18,COURSE:39,DISTANCE:40,CLIMB:41,CONTROL_COUNT:42,PLACING:43},k=46;SplitsBrowser.Input.SI={},SplitsBrowser.Input.SI.Reader=function(a){this.data=a,this.ageClasses=d3.map(),this.courseDetails=d3.map(),this.classCoursePairs=[],this.anyCompetitors=!1};var l=SplitsBrowser.Input.SI.Reader;l.prototype.checkHeader=function(){this.lines.length<=1&&c("No data found to read");var a=this.lines[0].split(";");a.length<=1&&c("Data appears not to be in the SI CSV format")},l.prototype.getNumControls=function(a){var b=a[j.AGE_CLASS];return this.ageClasses.has(b)?this.ageClasses.get(b).numControls:parseInt(a[j.CONTROL_COUNT],10)},l.prototype.readCumulativeTimes=function(c,d,f){c.length<=k+1+2*(f-1)&&b("Line "+d+" reports "+f+" controls but there aren't enough data values in the row for this many controls");for(var g=[0],h=0,i=0;f>i;i+=1){var l=c[k+1+2*i],m=e(l);a(h,m),g.push(m),null!==m&&(h=m)}var n=e(c[j.TIME]);return a(h,n),g.push(n),g},l.prototype.createAgeClassIfNecessary=function(a,b){var c=a[j.AGE_CLASS];this.ageClasses.has(c)||this.ageClasses.set(c,{numControls:b,competitors:[]})},l.prototype.createCourseIfNecessary=function(a,b){var c=a[j.COURSE];if(!this.courseDetails.has(c)){var d=d3.range(0,b).map(function(b){return a[k+2*b]});this.courseDetails.set(c,{length:parseFloat(a[j.DISTANCE])||null,climb:parseInt(a[j.CLIMB],10)||null,controls:d})}},l.prototype.createClassCoursePairIfNecessary=function(a){var b=a[j.AGE_CLASS],c=a[j.COURSE];this.classCoursePairs.some(function(a){return a[0]===b&&a[1]===c})||this.classCoursePairs.push([b,c])},l.prototype.addCompetitor=function(a,b){var c=a[j.AGE_CLASS],d=a[j.FORENAME],g=a[j.SURNAME],h=a[j.CLUB],i=e(a[j.START]),k=a[j.PLACING],l=isNaN(parseInt(k,10));l&&g.substring(g.length-k.length)===k&&(g=$.trim(g.substring(0,g.length-k.length)));var m=this.ageClasses.get(c).competitors.length+1,n=f.fromCumTimes(m,d,g,h,i,b);l&&n.completed()&&n.setNonCompetitive(),this.ageClasses.get(c).competitors.push(n)},l.prototype.readLine=function(a,c){if(""!==$.trim(a)){var d=a.split(";");d.length<k&&b("Too few items on line "+c+" of the input file: expected at least "+k+", got "+d.length);var e=this.getNumControls(d),f=this.readCumulativeTimes(d,c,e);f.some(function(a){return null!==a&&0!==a})&&(this.anyCompetitors=!0,this.createAgeClassIfNecessary(d,e),this.createCourseIfNecessary(d,e),this.createClassCoursePairIfNecessary(d),this.addCompetitor(d,f))}},l.prototype.getMapsBetweenClassesAndCourses=function(){var a=d3.map(),b=d3.map();return this.classCoursePairs.forEach(function(c){var d=c[0],e=c[1];a.has(d)?a.get(d).push(e):a.set(d,[e]),b.has(e)?b.get(e).push(d):b.set(e,[d])}),{classesToCourses:a,coursesToClasses:b}},l.prototype.createAgeClasses=function(){var a=this.ageClasses.keys();return a.sort(),a.map(function(a){var b=this.ageClasses.get(a);return new g(a,b.numControls,b.competitors)},this)},l.prototype.createCourseFromLinkedClassesAndCourses=function(a,b,c,d){for(var e,f,g=[a],i=[],j=[],k=[];g.length>0||i.length>0;){for(;g.length>0;){e=g.shift();for(var l=b.coursesToClasses.get(e),m=0;m<l.length;m+=1)f=l[m],i.indexOf(f)<0&&k.indexOf(f)<0&&i.push(f);j.push(e)}for(;i.length>0;){f=i.shift();for(var n=b.classesToCourses.get(f),o=0;o<n.length;o+=1)e=n[o],g.indexOf(e)<0&&j.indexOf(e)<0&&g.push(e);k.push(f)}}j.forEach(function(a){c.add(a)});var p=k.map(function(a){return d.get(a)}),q=this.courseDetails.get(a),r=new h(a,p,q.length,q.climb,q.controls);return p.forEach(function(a){a.setCourse(r)}),r},l.prototype.determineCourses=function(a){var b=this.getMapsBetweenClassesAndCourses(),c=d3.set(),d=d3.map();a.forEach(function(a){d.set(a.name,a)});var e=[];return b.coursesToClasses.keys().forEach(function(a){if(!c.has(a)){var f=this.createCourseFromLinkedClassesAndCourses(a,b,c,d);e.push(f)}},this),e},l.prototype.parseEventData=function(){this.lines=this.data.split(/\r?\n/),this.checkHeader(),this.lines.shift(),this.lines.forEach(function(a,b){this.readLine(a,b+1)},this),this.anyCompetitors||c("No competitors' data were found");var a=this.createAgeClasses(),b=this.determineCourses(a);return new i(a,b)},SplitsBrowser.Input.SI.parseEventData=function(a){var b=new l(a);return b.parseEventData()}}(),function(){"use strict";var a=[SplitsBrowser.Input.CSV.parseEventData,SplitsBrowser.Input.SI.parseEventData];SplitsBrowser.Input.parseEventData=function(b){for(var c=0;c<a.length;c+=1){var d=a[c];try{return d(b)}catch(e){if("WrongFileFormat"!==e.name)throw e}}return null}}(),function(){"use strict";var a="competitorList",b=function(b){this.parent=b,this.handler=null,this.competitorSelection=null,this.isEnabled=!0,this.listDiv=d3.select(b).append("div").attr("id",a)};b.prototype.setEnabled=function(a){this.isEnabled=a,this.listDiv.selectAll("div.competitor").classed("disabled",!a)},b.prototype.width=function(){return $(this.listDiv.node()).width()},b.prototype.selectionChanged=function(){var a=this;this.listDiv.selectAll("div.competitor").data(d3.range(this.competitorSelection.count)).classed("selected",function(b,c){return a.competitorSelection.isSelected(c)})},b.prototype.toggleCompetitor=function(a){this.isEnabled&&this.competitorSelection.toggle(a)},b.prototype.setCompetitorList=function(a,b){$("div.competitor").off("click");var c=this.listDiv.selectAll("div.competitor").data(a);c.enter().append("div").classed("competitor",!0),c.selectAll("span").remove(),b&&c.append("span").classed("competitorClassLabel",!0).text(function(a){return a.className}),c.append("span").classed("nonfinisher",function(a){return!a.completed()}).text(function(a){return a.completed()?a.name:"* "+a.name}),c.exit().remove();var d=this;$("div.competitor").each(function(a,b){$(b).on("click",function(){d.toggleCompetitor(a)})})},b.prototype.setSelection=function(a){null!==this.competitorSelection&&this.competitorSelection.deregisterChangeHandler(this.handler);var b=this;this.competitorSelection=a,this.handler=function(a){b.selectionChanged(a)},this.competitorSelection.registerChangeHandler(this.handler),this.selectionChanged(d3.range(a.count))},SplitsBrowser.Controls.CompetitorListBox=b}(),function(){"use strict";var a=SplitsBrowser.throwInvalidData,b=function(a){this.changeHandlers=[],this.otherClassesEnabled=!0;var b=d3.select(a).append("span");b.text("Class: ");var c=this;this.dropDown=b.append("select").node(),$(this.dropDown).bind("change",function(){c.updateOtherClasses(),c.onSelectionChanged()}),this.otherClassesCombiningLabel=b.append("span").classed("otherClassCombining",!0).style("display","none").text("and"),this.otherClassesSelector=b.append("div").classed("otherClassSelector",!0).style("display","none"),this.otherClassesSpan=this.otherClassesSelector.append("span"),this.otherClassesList=d3.select(a).append("div").classed("otherClassList",!0).style("position","absolute").style("display","none"),this.otherClassesSelector.on("click",function(){c.showHideClassSelector()}),this.setClasses([]),this.selectedOtherClassIndexes=d3.set(),$(document).click(function(a){var b=c.otherClassesList.node();if("none"!==b.style.display){var d=$("div.otherClassList,div.otherClassSelector");d.is(a.target)||0!==d.has(a.target).length||(b.style.display="none")}}),$(document).keydown(function(a){27===a.which&&c.otherClassesList.style("display","none")})};b.prototype.setOtherClassesEnabled=function(a){this.otherClassesCombiningLabel.classed("disabled",!a),this.otherClassesSelector.classed("disabled",!a),this.otherClassesEnabled=a},b.prototype.setClasses=function(b){if($.isArray(b)){this.classes=b;var c;0===b.length?(this.dropDown.disabled=!0,c=["[No classes loaded]"]):(this.dropDown.disabled=!1,c=b.map(function(a){return a.name}));var d=d3.select(this.dropDown).selectAll("option").data(c);d.enter().append("option"),d.attr("value",function(a,b){return b.toString()}).text(function(a){return a}),d.exit().remove(),this.updateOtherClasses()}else a("ClassSelector.setClasses: classes is not an array")},b.prototype.registerChangeHandler=function(a){-1===this.changeHandlers.indexOf(a)&&this.changeHandlers.push(a)},b.prototype.onSelectionChanged=function(){var a=[this.dropDown.selectedIndex];this.selectedOtherClassIndexes.forEach(function(b){a.push(parseInt(b,10))}),this.changeHandlers.forEach(function(b){b(a)})},b.prototype.updateOtherClassText=function(){var a=this.selectedOtherClassIndexes.values();a.sort(d3.ascending);var b;b=0===a.length?"<select>":a.map(function(a){return this.classes[a].name},this).join(", "),this.otherClassesSpan.text(b)},b.prototype.updateOtherClasses=function(){this.otherClassesList.style("display","none"),this.selectedOtherClassIndexes=d3.set(),this.updateOtherClassText(),$("div.otherClassItem").off("click");var a,b=this;if(this.classes.length>0){var c=this.classes[this.dropDown.selectedIndex];a=c.course.getOtherClasses(c)}else a=[];var d=a.map(function(a){return this.classes.indexOf(a)},this),e=this.otherClassesList.selectAll("div").data(d);e.enter().append("div").classed("otherClassItem",!0),e.attr("id",function(a){return"ageClassIdx_"+a}).classed("selected",!1).text(function(a){return b.classes[a].name}),e.exit().remove(),d.length>0?(this.otherClassesSelector.style("display","inline-block"),this.otherClassesCombiningLabel.style("display","")):(this.otherClassesSelector.style("display","none"),this.otherClassesCombiningLabel.style("display","none"));var f=$(this.otherClassesSelector.node()).offset(),g=$(this.otherClassesSelector.node()).outerHeight();this.otherClassesList.style("left",f.left+"px").style("top",f.top+g+"px"),$("div.otherClassItem").each(function(a,c){$(c).on("click",function(){b.toggleOtherClass(d[a])})})},b.prototype.showHideClassSelector=function(){this.otherClassesEnabled&&this.otherClassesList.style("display","none"===this.otherClassesList.style("display")?"":"none")},b.prototype.toggleOtherClass=function(a){this.selectedOtherClassIndexes.has(a)?this.selectedOtherClassIndexes.remove(a):this.selectedOtherClassIndexes.add(a),d3.select("div#ageClassIdx_"+a).classed("selected",this.selectedOtherClassIndexes.has(a)),this.updateOtherClassText(),this.onSelectionChanged()},SplitsBrowser.Controls.ClassSelector=b}(),function(){"use strict";var a=[{name:"Winner",selector:function(a){return a.getWinnerCumTimes()},requiresWinner:!0},{name:"Fastest time",selector:function(a){return a.getFastestCumTimes()},requiresWinner:!1}],b=[5,25,50,100];b.forEach(function(b){a.push({name:"Fastest time + "+b+"%",selector:function(a){return a.getFastestCumTimesPlusPercentage(b)},requiresWinner:!1})}),a.push({name:"Any runner...",requiresWinner:!0});var c=1,d="comparisonSelector",e="runnerSelector",f=function(b,f){this.changeHandlers=[],this.classes=null,this.currentRunnerIndex=null,this.previousCompetitorList=null,this.parent=b,this.alerter=f,this.hasWinner=!1,this.previousSelectedIndex=-1;var g=d3.select(b).append("span");g.append("span").classed("comparisonSelectorLabel",!0).text("Compare with ");var h=this;this.dropDown=g.append("select").attr("id",d).node(),$(this.dropDown).bind("change",function(){h.onSelectionChanged()});var i=d3.select(this.dropDown).selectAll("option").data(a);i.enter().append("option"),i.attr("value",function(a,b){return b.toString()}).text(function(a){return a.name}),i.exit().remove(),this.runnerSpan=d3.select(b).append("span").style("display","none").style("padding-left","20px"),this.runnerSpan.append("span").classed("comparisonSelectorLabel",!0).text("Runner: "),this.runnerDropDown=this.runnerSpan.append("select").attr("id",e).node(),$(this.runnerDropDown).bind("change",function(){h.onSelectionChanged()}),this.dropDown.selectedIndex=c,this.previousSelectedIndex=c};f.prototype.registerChangeHandler=function(a){-1===this.changeHandlers.indexOf(a)&&this.changeHandlers.push(a)},f.prototype.isAnyRunnerSelected=function(){return this.dropDown.selectedIndex===a.length-1},f.prototype.setAgeClassSet=function(a){this.ageClassSet=a,this.setRunners()},f.prototype.setRunners=function(){var a=this.ageClassSet.allCompetitors,b=d3.range(a.length).filter(function(b){return a[b].completed()}),c=a.filter(function(a){return a.completed()});this.hasWinner=c.length>0;var d=d3.select(this.runnerDropDown).selectAll("option").data(c);if(d.enter().append("option"),d.attr("value",function(a,c){return b[c].toString()}).text(function(a){return a.name}),d.exit().remove(),null===this.previousCompetitorList)this.currentRunnerIndex=0;else{var e=this.previousCompetitorList[this.currentRunnerIndex],f=this.ageClassSet.allCompetitors.indexOf(e);this.currentRunnerIndex=Math.max(f,0)}this.runnerDropDown.selectedIndex=this.currentRunnerIndex,this.previousCompetitorList=this.ageClassSet.allCompetitors},f.prototype.setEnabled=function(a){d3.select(this.parent).selectAll("span.comparisonSelectorLabel").classed("disabled",!a),this.dropDown.disabled=!a,this.runnerDropDown.disabled=!a},f.prototype.getComparisonFunction=function(){if(this.isAnyRunnerSelected()){var b=this;return function(a){return a.allCompetitors[b.currentRunnerIndex].getAllCumulativeTimes()}}return a[this.dropDown.selectedIndex].selector},f.prototype.onSelectionChanged=function(){var b=Math.max(this.runnerDropDown.selectedIndex,0),c=a[this.dropDown.selectedIndex];!this.hasWinner&&c.requiresWinner?(this.alerter("Cannot compare against '"+c.name+"' because no competitors in this class complete the course."),this.dropDown.selectedIndex=this.previousSelectedIndex):(this.runnerSpan.style("display",this.isAnyRunnerSelected()?"":"none"),this.currentRunnerIndex=0===this.runnerDropDown.options.length?0:parseInt(this.runnerDropDown.options[b].value,10),this.previousSelectedIndex=this.dropDown.selectedIndex,this.changeHandlers.forEach(function(a){a(this.getComparisonFunction())},this))},SplitsBrowser.Controls.ComparisonSelector=f}(),function(){"use strict";var a="statisticSelector",b="statisticCheckbox",c=["Total time","Split time","Behind fastest"],d=function(d){this.span=d3.select(d).append("span").attr("id",a);
var e=this.span.selectAll("span").data(c).enter().append("span");e.append("input").attr("type","checkbox").attr("id",function(a,c){return b+c}),e.append("label").attr("for",function(a,c){return b+c}).classed("statisticsSelectorLabel",!0).text(function(a){return a});var f=this;$("input",this.span.node()).bind("change",function(){return f.onCheckboxChanged()}),this.handlers=[]};d.prototype.setEnabled=function(a){this.span.selectAll("label.statisticsSelectorLabel").classed("disabled",!a),this.span.selectAll("input").attr("disabled",a?null:"disabled")},d.prototype.registerChangeHandler=function(a){-1===this.handlers.indexOf(a)&&this.handlers.push(a)},d.prototype.deregisterChangeHandler=function(a){var b=this.handlers.indexOf(a);-1!==b&&this.handlers.splice(b,1)},d.prototype.getVisibleStatistics=function(){return this.span.selectAll("input")[0].map(function(a){return a.checked})},d.prototype.onCheckboxChanged=function(){var a=this.getVisibleStatistics();this.handlers.forEach(function(b){b(a)})},SplitsBrowser.Controls.StatisticsSelector=d}(),function(){"use strict";var a=function(a,b){this.changeHandlers=[],this.chartTypes=b;var c=d3.select(a).append("span");c.text("View: ");var d=this;this.dropDown=c.append("select").node(),$(this.dropDown).bind("change",function(){d.onSelectionChanged()});var e=d3.select(this.dropDown).selectAll("option").data(b);e.enter().append("option"),e.attr("value",function(a,b){return b.toString()}).text(function(a){return a.name}),e.exit().remove()};a.prototype.registerChangeHandler=function(a){-1===this.changeHandlers.indexOf(a)&&this.changeHandlers.push(a)},a.prototype.getChartType=function(){return this.chartTypes[Math.max(this.dropDown.selectedIndex,0)]},a.prototype.onSelectionChanged=function(){this.changeHandlers.forEach(function(a){a(this.chartTypes[this.dropDown.selectedIndex])},this)},SplitsBrowser.Controls.ChartTypeSelector=a}(),function(){"use strict";var a=SplitsBrowser.formatTime,b=function(a,b){this.shown=!1,this.mouseIn=!1,this.popupDiv=d3.select(a).append("div"),this.popupDiv.classed("chartPopup",!0).style("display","none").style("position","absolute"),this.popupDivHeader=this.popupDiv.append("div").classed("chartPopupHeader",!0).append("span");var c=this.popupDiv.append("div").classed("chartPopupTableContainer",!0);this.popupDivTable=c.append("table");for(var d in b)b.hasOwnProperty(d)&&$(this.popupDiv.node()).on(d,b[d]);var e=this;$(this.popupDiv.node()).mouseenter(function(){e.mouseIn=!0}),$(this.popupDiv.node()).mouseleave(function(){e.mouseIn=!1})};b.prototype.isShown=function(){return this.shown},b.prototype.isMouseIn=function(){return this.mouseIn},b.prototype.setData=function(b,c){this.popupDivHeader.text(b.title);var d=this.popupDivTable.selectAll("tr").data(b.data);d.enter().append("tr"),d.classed("highlighted",function(a){return a.highlight}),d.selectAll("td").remove(),d.append("td").text(function(b){return a(b.time)}),c&&d.append("td").text(function(a){return a.className}),d.append("td").text(function(a){return a.name}),d.exit().remove(),0===b.data.length&&null!==b.placeholder&&this.popupDivTable.append("tr").append("td").text(b.placeholder)},b.prototype.setLocation=function(a){this.popupDiv.style("left",a.x+"px").style("top",a.y+"px")},b.prototype.show=function(a){this.popupDiv.style("display",""),this.shown=!0,this.setLocation(a)},b.prototype.hide=function(){this.popupDiv.style("display","none"),this.shown=!1},b.prototype.height=function(){return $(this.popupDiv.node()).height()},SplitsBrowser.Controls.ChartPopup=b}(),function(){"use strict";function a(a,b){return m+r(a)+" ("+(null===b?"-":b)+")"}function b(a,b){return""===b?a:a+" ("+b+")"}var c="sb-text-size-element",d="chart",e=10,f=10,g={top:20,right:20,bottom:30,left:50},h=10,i=10,j=240,k=1,l=3,m="    ",n=["#FF0000","#4444FF","#00FF00","#000000","#CC0066","#000099","#FFCC00","#884400","#9900FF","#CCCC00","#888800","#CC6699","#00DD00","#3399FF","#BB00BB","#00DDDD","#FF00FF","#0088BB","#888888","#FF99FF","#55BB33"],o=SplitsBrowser.Model.Course.START,p=SplitsBrowser.Model.Course.FINISH,q=SplitsBrowser.isNotNull,r=SplitsBrowser.formatTime,s=SplitsBrowser.Controls.ChartPopup,t=function(a){this.parent=a,this.xScale=null,this.yScale=null,this.overallWidth=-1,this.overallHeight=-1,this.contentWidth=-1,this.contentHeight=-1,this.numControls=-1,this.selectedIndexes=[],this.currentCompetitorData=null,this.isPopupOpen=!1,this.popupUpdateFunc=null,this.maxStartTimeLabelWidth=0,this.warningPanel=null,this.selectedIndexesOrderedByLastYValue=[],this.referenceCumTimes=[],this.fastestCumTimes=[],this.isMouseIn=!1,this.currentControlIndex=null,this.controlLine=null,this.svg=d3.select(this.parent).append("svg").attr("id",d),this.svgGroup=this.svg.append("g"),this.setLeftMargin(g.left);var b=this,e=function(a){b.onMouseMove(a)},f=function(a){b.onMouseUp(a)},h=function(a){b.onMouseDown(a)};$(this.svg.node()).mouseenter(function(a){b.onMouseEnter(a)}).mousemove(e).mouseleave(function(a){b.onMouseLeave(a)}).mousedown(h).mouseup(f),$(this.svg.node()).contextmenu(function(a){a.preventDefault()}),this.textSizeElement=this.svg.append("text").attr("fill","transparent").attr("id",c);var i={mousemove:e,mousedown:h,mouseup:f};this.popup=new s(a,i)};t.prototype.setLeftMargin=function(a){this.currentLeftMargin=a,this.svgGroup.attr("transform","translate("+this.currentLeftMargin+","+g.top+")")},t.prototype.getPopupLocation=function(a){return{x:a.pageX+e,y:Math.max(a.pageY-this.popup.height()/2,0)}},t.prototype.getFastestSplitsPopupData=function(){var a=this.ageClassSet.getFastestSplitsTo(f,this.currentControlIndex);return a=a.map(function(a){return{time:a.split,name:a.name,highlight:!1}}),{title:"Selected classes",data:a,placeholder:"No competitors completed this course"}},t.prototype.getFastestSplitsForCurrentLegPopupData=function(){var a=this.ageClassSet.getCourse(),b=a.getControlCode(this.currentControlIndex-1),c=a.getControlCode(this.currentControlIndex),d="Fastest leg-time "+(b===o?"Start":b)+" to "+(c===p?"Finish":c),e=this.ageClassSet.getPrimaryClassName(),f=this.eventData.getFastestSplitsForLeg(b,c).map(function(a){return{name:a.name,className:a.className,time:a.split,highlight:a.className===e}});return{title:d,data:f,placeholder:null}},t.prototype.setCurrentChartTime=function(a){var b=a.pageY-$(this.svg.node()).offset().top-g.top;this.currentChartTime=Math.round(60*this.yScale.invert(b))+this.referenceCumTimes[this.currentControlIndex]},t.prototype.getCompetitorsVisitingCurrentControlPopupData=function(){var a=this.ageClassSet.getCourse().getControlCode(this.currentControlIndex),b=this.currentChartTime-j/2,c=this.currentChartTime+j/2,d=this.eventData.getCompetitorsAtControlInTimeRange(a,b,c),e=this.ageClassSet.getPrimaryClassName(),f=d.map(function(a){return{name:a.name,className:a.className,time:a.time,highlight:a.className===e}}),g=r(b)+" - "+r(c)+": ";return g+=a===o?"Start":a===p?"Finish":"Control "+a,{title:g,data:f,placeholder:"No competitors."}},t.prototype.onMouseEnter=function(a){null===this.warningPanel&&(this.isMouseIn=!0,this.updateControlLineLocation(a))},t.prototype.onMouseMove=function(a){this.isMouseIn&&null!==this.xScale&&null===this.warningPanel&&this.updateControlLineLocation(a)},t.prototype.onMouseLeave=function(){if(null===this.warningPanel){var a=this;setTimeout(function(){a.popup.isMouseIn()||(a.isMouseIn=!1,a.removeControlLine())},1)}},t.prototype.onMouseDown=function(a){if(null===this.warningPanel){var b=this;setTimeout(function(){b.showPopupDialog(a)},1)}},t.prototype.onMouseUp=function(a){null===this.warningPanel&&(this.popup.hide(),a.preventDefault())},t.prototype.showPopupDialog=function(a){if(this.isMouseIn&&null!==this.currentControlIndex){var b=!1,c=this;!this.isRaceGraph||a.which!==k&&a.which!==l?a.which===k?(this.popupUpdateFunc=function(){c.popup.setData(c.getFastestSplitsPopupData(),!1)},b=!0):a.which===l&&this.hasControls&&(this.popupUpdateFunc=function(){c.popup.setData(c.getFastestSplitsForCurrentLegPopupData(),!0)},b=!0):this.hasControls&&(this.setCurrentChartTime(a),this.popupUpdateFunc=function(){c.popup.setData(c.getCompetitorsVisitingCurrentControlPopupData(),!0)},b=!0),b&&(this.popupUpdateFunc(),this.popup.show(this.getPopupLocation(a)))}},t.prototype.drawControlLine=function(a){this.currentControlIndex=a,this.updateCompetitorStatistics();var b=this.xScale(this.referenceCumTimes[a]);this.controlLine=this.svgGroup.append("line").attr("x1",b).attr("y1",0).attr("x2",b).attr("y2",this.contentHeight).attr("class","controlLine").node()},t.prototype.updateControlLineLocation=function(a){var b=$(this.svg.node()),c=b.offset(),d=a.pageX-c.left,e=a.pageY-c.top;if(this.currentLeftMargin<=d&&d<b.width()-g.right&&g.top<=e&&e<b.height()-g.bottom){var f,h=this.xScale.invert(d-this.currentLeftMargin),i=d3.bisect(this.referenceCumTimes,h);if(i>=this.referenceCumTimes.length)f=this.numControls+1;else if(i<=this.minViewableControl)f=this.minViewableControl;else{var j=Math.abs(this.referenceCumTimes[i]-h),k=Math.abs(h-this.referenceCumTimes[i-1]);f=j>k?i-1:i}(null===this.currentControlIndex||this.currentControlIndex!==f)&&(this.removeControlLine(),this.drawControlLine(f)),this.popup.isShown()&&null!==this.currentControlIndex&&(this.isRaceGraph&&this.setCurrentChartTime(a),this.popupUpdateFunc(),this.popup.setLocation(this.getPopupLocation(a)))}else this.removeControlLine(),this.popup.hide()},t.prototype.removeControlLine=function(){this.currentControlIndex=null,this.updateCompetitorStatistics(),null!==this.controlLine&&(d3.select(this.controlLine).remove(),this.controlLine=null)},t.prototype.getTimesBehindFastest=function(a,b){var c=b.map(function(a){return this.ageClassSet.allCompetitors[a]},this),d=this.fastestCumTimes[a]-this.fastestCumTimes[a-1],e=c.map(function(b){var c=b.getSplitTimeTo(a);return null===c?null:c-d});return e},t.prototype.updateCompetitorStatistics=function(){var c=this.selectedIndexesOrderedByLastYValue.map(function(a){return this.ageClassSet.allCompetitors[a]},this),d=c.map(function(a){return b(a.name,a.getSuffix())});if(null!==this.currentControlIndex&&this.currentControlIndex>0){if(this.visibleStatistics[0]){var e=c.map(function(a){return a.getCumulativeTimeTo(this.currentControlIndex)},this),f=c.map(function(a){return a.getCumulativeRankTo(this.currentControlIndex)},this);d=d3.zip(d,e,f).map(function(b){return b[0]+a(b[1],b[2])})}if(this.visibleStatistics[1]){var g=c.map(function(a){return a.getSplitTimeTo(this.currentControlIndex)},this),h=c.map(function(a){return a.getSplitRankTo(this.currentControlIndex)},this);d=d3.zip(d,g,h).map(function(b){return b[0]+a(b[1],b[2])})}if(this.visibleStatistics[2]){var i=this.getTimesBehindFastest(this.currentControlIndex,this.selectedIndexesOrderedByLastYValue);d=d3.zip(d,i).map(function(a){return a[0]+m+r(a[1])})}}this.currentCompetitorData.forEach(function(a,b){a.label=d[b]}),d3.selectAll("text.competitorLabel").text(function(a){return a.label})},t.prototype.getTickFormatter=function(){var a=this;return function(b,c){return 0===c?"S":c===a.numControls+1?"F":c.toString()}},t.prototype.getTextWidth=function(a){return this.textSizeElement.text(a).node().getBBox().width},t.prototype.getTextHeight=function(a){return this.textSizeElement.text(a).node().getBBox().height},t.prototype.getMaxGraphEndTextWidth=function(){if(0===this.selectedIndexes.length)return 0;var a=this.selectedIndexes.map(function(a){var c=this.ageClassSet.allCompetitors[a];return this.getTextWidth(b(c.name,c.getSuffix()))},this);return d3.max(a)+this.determineMaxStatisticTextWidth()},t.prototype.getMaxTimeAndRankTextWidth=function(b,c){var d=0,e=0,f=this.selectedIndexes.map(function(a){return this.ageClassSet.allCompetitors[a]},this);d3.range(1,this.numControls+2).forEach(function(a){var g=f.map(function(c){return c[b](a)});d=Math.max(d,d3.max(g.filter(q)));var h=f.map(function(b){return b[c](a)});e=Math.max(e,d3.max(h.filter(q)))});var g=a(d,e);return this.getTextWidth(g)},t.prototype.getMaxSplitTimeAndRankTextWidth=function(){return this.getMaxTimeAndRankTextWidth("getSplitTimeTo","getSplitRankTo")},t.prototype.getMaxCumulativeTimeAndRankTextWidth=function(){return this.getMaxTimeAndRankTextWidth("getCumulativeTimeTo","getCumulativeRankTo")},t.prototype.getMaxTimeBehindFastestWidth=function(){for(var a=0,b=1;b<=this.numControls+1;b+=1){var c=this.getTimesBehindFastest(b,this.selectedIndexes);a=Math.max(a,d3.max(c.filter(q)))}return this.getTextWidth(m+r(a))},t.prototype.determineMaxStatisticTextWidth=function(){var a=0;return this.visibleStatistics[0]&&(a+=this.getMaxCumulativeTimeAndRankTextWidth()),this.visibleStatistics[1]&&(a+=this.getMaxSplitTimeAndRankTextWidth()),this.visibleStatistics[2]&&(a+=this.getMaxTimeBehindFastestWidth()),a},t.prototype.determineMaxStartTimeLabelWidth=function(a){var b;return b=a.competitorNames.length>0?d3.max(a.competitorNames.map(function(a){return this.getTextWidth("00:00:00 "+a)},this)):0},t.prototype.createScales=function(a){this.xScale=d3.scale.linear().domain(a.xExtent).range([0,this.contentWidth]),this.yScale=d3.scale.linear().domain(a.yExtent).range([0,this.contentHeight]),this.xScaleMinutes=d3.scale.linear().domain([a.xExtent[0]/60,a.xExtent[1]/60]).range([0,this.contentWidth])},t.prototype.drawBackgroundRectangles=function(){var a=this.svgGroup.selectAll("rect").data(d3.range(this.numControls+1)),b=this;a.enter().append("rect"),a.attr("x",function(a){return b.xScale(b.referenceCumTimes[a])}).attr("y",0).attr("width",function(a){return b.xScale(b.referenceCumTimes[a+1]-b.referenceCumTimes[a])}).attr("height",this.contentHeight).attr("class",function(a){return 0===a%2?"background1":"background2"}),a.exit().remove()},t.prototype.determineYAxisTickFormatter=function(a){if(this.isRaceGraph){var b=0===a.dataColumns.length?[]:a.dataColumns[0].ys;if(0===b.length)return function(a){return r(60*a)};var c=this.yScale;return function(a){var d=d3.min(b.map(function(b){return Math.abs(c(b)-c(a))}));return d>=i?r(Math.round(60*a)):""}}return null},t.prototype.drawAxes=function(a,b){var c=this.determineYAxisTickFormatter(b),d=d3.svg.axis().scale(this.xScale).orient("top").tickFormat(this.getTickFormatter()).tickValues(this.referenceCumTimes),e=d3.svg.axis().scale(this.yScale).tickFormat(c).orient("left"),f=d3.svg.axis().scale(this.xScaleMinutes).orient("bottom");this.svgGroup.selectAll("g.axis").remove(),this.svgGroup.append("g").attr("class","x axis").call(d),this.svgGroup.append("g").attr("class","y axis").call(e).append("text").attr("transform","rotate(-90)").attr("x",-(this.contentHeight-6)).attr("y",6).attr("dy",".71em").style("text-anchor","start").text(a),this.svgGroup.append("g").attr("class","x axis").attr("transform","translate(0,"+this.contentHeight+")").call(f).append("text").attr("x",60).attr("y",-5).style("text-anchor","start").text("Time (min)")},t.prototype.drawChartLines=function(a){var b=this,c=function(c){return a.dataColumns.every(function(a){return null===a.ys[c]})?d3.svg.line().x(-1e4).y(-1e4):d3.svg.line().x(function(a){return b.xScale(a.x)}).y(function(a){return b.yScale(a.ys[c])}).defined(function(a){return null!==a.ys[c]}).interpolate("linear")},d=this.svgGroup.selectAll("path.graphLine").data(d3.range(this.numLines));d.enter().append("path"),d.attr("d",function(b){return c(b)(a.dataColumns)}).attr("stroke",function(a){return n[b.selectedIndexes[a]%n.length]}).attr("class",function(a){return"graphLine competitor"+b.selectedIndexes[a]}).on("mouseenter",function(a){b.highlight(b.selectedIndexes[a])}).on("mouseleave",function(){b.unhighlight()}),d.exit().remove()},t.prototype.highlight=function(a){this.svg.selectAll("path.graphLine.competitor"+a).classed("selected",!0),this.svg.selectAll("line.competitorLegendLine.competitor"+a).classed("selected",!0),this.svg.selectAll("text.competitorLabel.competitor"+a).classed("selected",!0),this.svg.selectAll("text.startLabel.competitor"+a).classed("selected",!0)},t.prototype.unhighlight=function(){this.svg.selectAll("path.graphLine.selected").classed("selected",!1),this.svg.selectAll("line.competitorLegendLine.selected").classed("selected",!1),this.svg.selectAll("text.competitorLabel.selected").classed("selected",!1),this.svg.selectAll("text.startLabel.selected").classed("selected",!1)},t.prototype.drawCompetitorStartTimeLabels=function(a){var b=a.dataColumns[0],c=this,d=this.svgGroup.selectAll("text.startLabel").data(this.selectedIndexes);d.enter().append("text"),d.attr("x",-7).attr("y",function(d,e){return c.yScale(b.ys[e])+c.getTextHeight(a.competitorNames[e])/4}).attr("class",function(a){return"startLabel competitor"+a}).on("mouseenter",function(a){c.highlight(a)}).on("mouseleave",function(){c.unhighlight()}).text(function(c,d){return r(Math.round(60*b.ys[d]))+" "+a.competitorNames[d]}),d.exit().remove()},t.prototype.removeCompetitorStartTimeLabels=function(){this.svgGroup.selectAll("text.startLabel").remove()},t.prototype.drawCompetitorLegendLabels=function(a){if(0===a.dataColumns.length)this.currentCompetitorData=[];else{var c=a.dataColumns[a.dataColumns.length-1];this.currentCompetitorData=d3.range(this.numLines).map(function(a){var d=this.selectedIndexes[a],e=this.ageClassSet.allCompetitors[d].name;return{label:b(e,this.ageClassSet.allCompetitors[d].getSuffix()),textHeight:this.getTextHeight(e),y:null===c.ys[a]?null:this.yScale(c.ys[a]),colour:n[d%n.length],index:d}},this);for(var d=null,e=this.currentCompetitorData.length-1;e>=0;e-=1)null===this.currentCompetitorData[e].y&&(this.currentCompetitorData[e].y=null===d?this.contentHeight:d-this.currentCompetitorData[e].textHeight,d=this.currentCompetitorData[e].y)}this.currentCompetitorData.sort(function(a,b){return a.y-b.y}),this.selectedIndexesOrderedByLastYValue=this.currentCompetitorData.map(function(a){return a.index});for(var f=1;f<this.currentCompetitorData.length;f+=1)this.currentCompetitorData[f].y<this.currentCompetitorData[f-1].y+this.currentCompetitorData[f-1].textHeight&&(this.currentCompetitorData[f].y=this.currentCompetitorData[f-1].y+this.currentCompetitorData[f-1].textHeight);var g=this.svgGroup.selectAll("line.competitorLegendLine").data(this.currentCompetitorData);g.enter().append("line");var i=this;g.attr("x1",this.contentWidth+1).attr("y1",function(a){return a.y}).attr("x2",this.contentWidth+h+1).attr("y2",function(a){return a.y}).attr("stroke",function(a){return a.colour}).attr("class",function(a){return"competitorLegendLine competitor"+a.index}).on("mouseenter",function(a){i.highlight(a.index)}).on("mouseleave",function(){i.unhighlight()}),g.exit().remove();var j=this.svgGroup.selectAll("text.competitorLabel").data(this.currentCompetitorData);j.enter().append("text"),j.attr("x",this.contentWidth+h+2).attr("y",function(a){return a.y+a.textHeight/4}).attr("class",function(a){return"competitorLabel competitor"+a.index}).on("mouseenter",function(a){i.highlight(a.index)}).on("mouseleave",function(){i.unhighlight()}).text(function(a){return a.label}),j.exit().remove()},t.prototype.adjustContentSize=function(){var a=this.getMaxGraphEndTextWidth();this.setLeftMargin(this.maxStartTimeLabelWidth+g.left),this.contentWidth=Math.max(this.overallWidth-this.currentLeftMargin-g.right-a-(h+2),100),this.contentHeight=Math.max(this.overallHeight-g.top-g.bottom,100)},t.prototype.setSize=function(a,b){this.overallWidth=a,this.overallHeight=b,$(this.svg.node()).width(a).height(b),this.adjustContentSize()},t.prototype.clearGraph=function(){this.svgGroup.selectAll("*").remove()},t.prototype.clearWarningPanel=function(){null!==this.warningPanel&&(this.warningPanel.remove(),this.warningPanel=null)},t.prototype.showWarningPanel=function(a){this.clearWarningPanel(),this.warningPanel=d3.select(this.parent).append("div").classed("warningPanel",!0),this.warningPanel.text(a);var b=$(this.warningPanel.node()).width(),c=$(this.warningPanel.node()).height();this.warningPanel.style("left",($(this.parent).width()-b)/2+"px").style("top",(this.overallHeight-c)/2+"px")},t.prototype.drawChart=function(a,b,c,d){var e=a.chartData;this.numControls=e.numControls,this.numLines=e.competitorNames.length,this.selectedIndexes=b,this.referenceCumTimes=a.referenceCumTimes,this.fastestCumTimes=a.fastestCumTimes,this.eventData=a.eventData,this.ageClassSet=a.ageClassSet,this.hasControls=a.ageClassSet.getCourse().hasControls(),this.isRaceGraph=d.isRaceGraph,this.minViewableControl=d.minViewableControl,this.visibleStatistics=c,this.maxStatisticTextWidth=this.determineMaxStatisticTextWidth(),this.maxStartTimeLabelWidth=this.isRaceGraph?this.determineMaxStartTimeLabelWidth(e):0,this.clearWarningPanel(),this.adjustContentSize(),this.createScales(e),this.drawBackgroundRectangles(),this.drawAxes(d.yAxisLabel,e),this.drawChartLines(e),this.drawCompetitorLegendLabels(e),this.isRaceGraph?this.drawCompetitorStartTimeLabels(e):this.removeCompetitorStartTimeLabels()},t.prototype.clearAndShowWarning=function(a){this.numControls=0,this.numLines=0;var b={dataColumns:[],competitorNames:[],numControls:0,xExtent:[0,3600],yExtent:[0,1]};this.maxStatisticTextWidth=0,this.maxStartTimeWidth=0,this.clearGraph(),this.adjustContentSize(),this.referenceCumTimes=[0],this.createScales(b),this.drawAxes("",b),this.showWarningPanel(a)},SplitsBrowser.Controls.Chart=t}(),function(){"use strict";var a=SplitsBrowser.formatTime,b=SplitsBrowser.Model.compareCompetitors,c=" ",d=function(a){this.parent=a,this.ageClass=null,this.div=null,this.headerSpan=null,this.table=null,this.buildTable()};d.prototype.buildTable=function(){this.div=d3.select(this.parent).append("div").attr("id","resultsTableContainer"),this.headerSpan=this.div.append("div").append("span").classed("resultsTableHeader",!0),this.table=this.div.append("table").classed("resultsTable",!0),this.table.append("thead").append("tr"),this.table.append("tbody")},d.prototype.populateTable=function(){function d(a,b,c,d){var e=a.append("td");e.append("span").text(b),e.append("br"),e.append("span").text(c),d&&e.classed(d,!0)}var e=this.ageClass.name+", "+this.ageClass.numControls+" control"+(1===this.ageClass.numControls?"":"s"),f=this.ageClass.course;null!==f.length&&(e+=", "+f.length.toFixed(1)+"km"),null!==f.climb&&(e+=", "+f.climb+"m"),this.headerSpan.text(e);var g=["#","Name","Time"].concat(d3.range(1,this.ageClass.numControls+1)).concat(["Finish"]),h=this.table.select("thead tr").selectAll("th").data(g);h.enter().append("th"),h.text(function(a){return a}),h.exit().remove();var i=this.table.select("tbody");i.selectAll("tr").remove();var j=this.ageClass.competitors.slice(0);j.sort(b);var k=0,l=0;j.forEach(function(b,e){var f=i.append("tr"),g=f.append("td");b.isNonCompetitive?(g.text("n/c"),k+=1):b.completed()&&((0===e||j[e-1].totalTime!==b.totalTime)&&(l=e+1-k),g.text(l)),d(f,b.name,b.club),d(f,b.completed()?a(b.totalTime):"mp",c,"time"),d3.range(1,this.ageClass.numControls+2).forEach(function(c){d(f,a(b.getCumulativeTimeTo(c)),a(b.getSplitTimeTo(c)),"time")})},this)},d.prototype.setClass=function(a){this.ageClass=a,this.populateTable(),"none"!==this.div.style("display")&&this.adjustTableCellWidths()},d.prototype.adjustTableCellWidths=function(){var a=d3.select("tbody tr td:last-child").node();$("tbody td.time").width($(a).width())},d.prototype.show=function(){this.div.style("display",""),this.adjustTableCellWidths()},d.prototype.hide=function(){this.div.style("display","none")},SplitsBrowser.Controls.ResultsTable=d}(),function(){"use strict";function a(a,b){a.node().disabled=!b}function b(a,b){if("success"===b){var c=SplitsBrowser.Input.parseEventData(a);if(null===c)alert("Unable to read in event data file");else{var d=new l;d.buildUi(),d.setEvent(c),d.selectClasses([0])}}else alert("Unable to read event data.  Status: "+b)}var c=100,d="competitorListContainer",e=SplitsBrowser.Controls.ClassSelector,f=SplitsBrowser.Controls.ChartTypeSelector,g=SplitsBrowser.Controls.ComparisonSelector,h=SplitsBrowser.Controls.StatisticsSelector,i=SplitsBrowser.Controls.CompetitorListBox,j=SplitsBrowser.Controls.Chart,k=SplitsBrowser.Controls.ResultsTable,l=function(){this.eventData=null,this.classes=null,this.currentClasses=[],this.currentIndexes=null,this.chartData=null,this.referenceCumTimes=null,this.fastestCumTimes=null,this.previousCompetitorList=[],this.isChartEnabled=!1,this.selection=null,this.ageClassSet=null,this.classSelector=null,this.statisticsSelector=null,this.competitorListBox=null,this.chart=null,this.topPanel=null,this.mainPanel=null,this.buttonsPanel=null,this.competitorListContainer=null,this.currentResizeTimeout=null};l.prototype.setEvent=function(a){this.eventData=a,this.classes=a.classes,null!==this.classSelector&&this.classSelector.setClasses(this.classes)},l.prototype.buildUi=function(){var a=d3.select("body");this.topPanel=a.append("div");var b=this;this.classSelector=new e(this.topPanel.node()),null!==this.classes&&this.classSelector.setClasses(this.classes),this.topPanel.append("span").style("padding","0px 30px 0px 30px");var c=SplitsBrowser.Model.ChartTypes,l=[c.SplitsGraph,c.RaceGraph,c.PositionAfterLeg,c.SplitPosition,c.PercentBehind,c.ResultsTable];this.chartTypeSelector=new f(this.topPanel.node(),l),this.chartType=this.chartTypeSelector.getChartType(),this.topPanel.append("span").style("padding","0px 30px 0px 30px"),this.comparisonSelector=new g(this.topPanel.node(),function(a){alert(a)}),null!==this.classes&&this.comparisonSelector.setClasses(this.classes),this.comparisonFunction=this.comparisonSelector.getComparisonFunction(),this.statisticsSelector=new h(this.topPanel.node()),this.mainPanel=a.append("div"),this.competitorListContainer=this.mainPanel.append("div").attr("id",d),this.buttonsPanel=this.competitorListContainer.append("div"),this.allButton=this.buttonsPanel.append("button").text("All").style("width","50%").on("click",function(){b.selectAll()}),this.noneButton=this.buttonsPanel.append("button").text("None").style("width","50%").on("click",function(){b.selectNone()}),this.buttonsPanel.append("br"),this.crossingRunnersButton=this.buttonsPanel.append("button").text("Crossing runners").style("width","100%").on("click",function(){b.selectCrossingRunners()}).style("display","none"),this.competitorListBox=new i(this.competitorListContainer.node()),this.chart=new j(this.mainPanel.node()),this.resultsTable=new k(a.node()),this.resultsTable.hide(),this.classSelector.registerChangeHandler(function(a){b.selectClasses(a)}),this.chartTypeSelector.registerChangeHandler(function(a){b.selectChartType(a)}),this.comparisonSelector.registerChangeHandler(function(a){b.selectComparison(a)}),$(window).resize(function(){b.handleWindowResize()})},l.prototype.selectAll=function(){this.selection.selectAll()},l.prototype.selectNone=function(){this.selection.selectNone()},l.prototype.selectCrossingRunners=function(){if(this.selection.selectCrossingRunners(this.ageClassSet.allCompetitors),this.selection.isSingleRunnerSelected()){var a=this.ageClassSet.allCompetitors[this.currentIndexes[0]].name;alert(a+" has no crossing runners.")}},l.prototype.handleWindowResize=function(){null!==this.currentResizeTimeout&&clearTimeout(this.currentResizeTimeout);var a=this;this.currentResizeTimeout=setTimeout(function(){a.postResizeHook()},c)},l.prototype.postResizeHook=function(){this.currentResizeTimeout=null,this.drawChart()},l.prototype.drawChart=function(){if(!this.chartType.isResultsTable){var a=$(window).width(),b=$(window).height();this.competitorListBox.setCompetitorList(this.ageClassSet.allCompetitors,this.currentClasses.length>1);var c=$(this.topPanel.node()).height(),d=a-18-this.competitorListBox.width()-40,e=b-19-c;this.chart.setSize(d,e),$("body").height(b-19-c),$(this.competitorListContainer.node()).height(b-19-$(this.buttonsPanel.node()).height()-c),this.currentVisibleStatistics=this.statisticsSelector.getVisibleStatistics(),null!==this.selectionChangeHandler&&this.selection.deregisterChangeHandler(this.selectionChangeHandler),null!==this.statisticsChangeHandler&&this.statisticsSelector.deregisterChangeHandler(this.statisticsChangeHandler);var f=this;this.selectionChangeHandler=function(a){f.currentIndexes=a,f.enableOrDisableCrossingRunnersButton(),f.redraw()},this.selection.registerChangeHandler(this.selectionChangeHandler),this.statisticsChangeHandler=function(a){f.currentVisibleStatistics=a,f.redraw()},this.statisticsSelector.registerChangeHandler(this.statisticsChangeHandler);var g=this.ageClassSet.getControlsWithNoSplits();if(this.isChartEnabled=0===g.length,this.updateControlEnabledness(),this.isChartEnabled)this.referenceCumTimes=this.comparisonFunction(this.ageClassSet),this.fastestCumTimes=this.ageClassSet.getFastestCumTimes(),this.chartData=this.ageClassSet.getChartData(this.referenceCumTimes,this.currentIndexes,this.chartType),this.redrawChart();else{var h="Cannot draw a graph because no competitor has recorded a split time for control "+g[0]+".";this.ageClassSet.getCourse().getNumClasses()>this.ageClassSet.getNumClasses()&&(h+="\n\nTry selecting some other classes."),this.chart.clearAndShowWarning(h)}}},l.prototype.redrawChart=function(){var a={chartData:this.chartData,eventData:this.eventData,ageClassSet:this.ageClassSet,referenceCumTimes:this.referenceCumTimes,fastestCumTimes:this.fastestCumTimes};this.chart.drawChart(a,this.currentIndexes,this.currentVisibleStatistics,this.chartType)},l.prototype.redraw=function(){!this.chartType.isResultsTable&&this.isChartEnabled&&(this.chartData=this.ageClassSet.getChartData(this.referenceCumTimes,this.currentIndexes,this.chartType),this.redrawChart())},l.prototype.selectClasses=function(a){null===this.selection?(this.selection=new SplitsBrowser.Model.CompetitorSelection(0),this.competitorListBox.setSelection(this.selection)):a.length>0&&this.currentClasses.length>0&&this.classes[a[0]]===this.currentClasses[0]||this.selection.selectNone(),this.currentIndexes=[],this.currentClasses=a.map(function(a){return this.classes[a]},this),this.ageClassSet=new SplitsBrowser.Model.AgeClassSet(this.currentClasses),this.comparisonSelector.setAgeClassSet(this.ageClassSet),this.resultsTable.setClass(this.currentClasses[0]),this.drawChart(),this.selection.migrate(this.previousCompetitorList,this.ageClassSet.allCompetitors),this.previousCompetitorList=this.ageClassSet.allCompetitors},l.prototype.selectComparison=function(a){this.comparisonFunction=a,this.drawChart()},l.prototype.selectChartType=function(a){this.chartType=a,a.isResultsTable?(this.mainPanel.style("display","none"),this.resultsTable.show()):(this.resultsTable.hide(),this.mainPanel.style("display","")),this.updateControlEnabledness(),this.crossingRunnersButton.style("display",a.isRaceGraph?"":"none"),this.drawChart()},l.prototype.updateControlEnabledness=function(){this.classSelector.setOtherClassesEnabled(!this.chartType.isResultsTable),this.comparisonSelector.setEnabled(this.isChartEnabled&&!this.chartType.isResultsTable),this.statisticsSelector.setEnabled(this.isChartEnabled&&!this.chartType.isResultsTable),this.competitorListBox.setEnabled(this.isChartEnabled),a(this.allButton,this.isChartEnabled),a(this.noneButton,this.isChartEnabled),this.enableOrDisableCrossingRunnersButton()},l.prototype.enableOrDisableCrossingRunnersButton=function(){a(this.crossingRunnersButton,this.isChartEnabled&&this.selection.isSingleRunnerSelected())},SplitsBrowser.Viewer=l,SplitsBrowser.loadEvent=function(a){$.ajax({url:a,data:"",success:b,dataType:"text"})}}();