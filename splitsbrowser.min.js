var SplitsBrowser={Model:{},Input:{},Controls:{}};!function(){"use strict";SplitsBrowser.isTrue=function(a){return a},SplitsBrowser.isNotNull=function(a){return null!==a},SplitsBrowser.InvalidData=function(a){this.name="InvalidData",this.message=a},SplitsBrowser.InvalidData.prototype.toString=function(){return this.name+": "+this.message},SplitsBrowser.throwInvalidData=function(a){throw new SplitsBrowser.InvalidData(a)},SplitsBrowser.WrongFileFormat=function(a){this.name="WrongFileFormat",this.message=a},SplitsBrowser.WrongFileFormat.prototype.toString=function(){return this.name+": "+this.message},SplitsBrowser.throwWrongFileFormat=function(a){throw new SplitsBrowser.WrongFileFormat(a)}}(),function(){"use strict";SplitsBrowser.NULL_TIME_PLACEHOLDER="-----",SplitsBrowser.formatTime=function(a){if(null===a)return SplitsBrowser.NULL_TIME_PLACEHOLDER;var b="";0>a&&(b="-",a=-a);var c=Math.floor(a/3600),d=Math.floor(a/60)%60,e=a%60;return c>0&&(b+=c.toString()+":"),10>d&&(b+="0"),b+=d+":",10>e&&(b+="0"),b+=e},SplitsBrowser.parseTime=function(a){return a.match(/^\d+:\d\d$/)?60*parseInt(a.substring(0,a.length-3),10)+parseInt(a.substring(a.length-2),10):a.match(/^\d+:\d\d:\d\d$/)?3600*parseInt(a.substring(0,a.length-6),10)+60*parseInt(a.substring(a.length-5,a.length-3),10)+parseInt(a.substring(a.length-2),10):null}}(),function(){"use strict";function a(a,b){return null===a||null===b?null:a+b}function b(a,b){return null===a||null===b?null:a-b}function c(b){if(!$.isArray(b))throw new TypeError("Split times must be an array - got "+typeof b+" instead");0===b.length&&SplitsBrowser.throwInvalidData("Array of split times must not be empty");for(var c=[0],d=0;d<b.length;d+=1)c.push(a(c[d],b[d]));return c}function d(a){if(!$.isArray(a))throw new TypeError("Cumulative times must be an array - got "+typeof a+" instead");0===a.length?SplitsBrowser.throwInvalidData("Array of cumulative times must not be empty"):0!==a[0]?SplitsBrowser.throwInvalidData("Array of cumulative times must have zero as its first item"):1===a.length&&SplitsBrowser.throwInvalidData("Array of cumulative times must contain more than just a single zero");for(var c=[],d=0;d+1<a.length;d+=1)c.push(b(a[d+1],a[d]));return c}var e="number";SplitsBrowser.Model.compareCompetitors=function(a,b){return a.totalTime===b.totalTime?a.order-b.order:null===a.totalTime?null===b.totalTime?0:1:null===b.totalTime?-1:a.totalTime-b.totalTime},SplitsBrowser.Model.Competitor=function(a,b,c,d,f,g,h){typeof a!==e&&SplitsBrowser.throwInvalidData("Competitor order must be a number, got "+typeof a+" '"+a+"' instead"),this.order=a,this.forename=b,this.surname=c,this.club=d,this.startTime=f,this.isNonCompetitive=!1,this.className=null,this.splitTimes=g,this.cumTimes=h,this.splitRanks=null,this.cumRanks=null,this.name=b+" "+c,this.totalTime=this.cumTimes.indexOf(null)>-1?null:this.cumTimes[this.cumTimes.length-1]},SplitsBrowser.Model.Competitor.prototype.setNonCompetitive=function(){this.isNonCompetitive=!0},SplitsBrowser.Model.Competitor.prototype.setClassName=function(a){this.className=a},SplitsBrowser.Model.Competitor.fromSplitTimes=function(a,b,d,e,f,g){var h=c(g);return new SplitsBrowser.Model.Competitor(a,b,d,e,f,g,h)},SplitsBrowser.Model.Competitor.fromCumTimes=function(a,b,c,e,f,g){var h=d(g);return new SplitsBrowser.Model.Competitor(a,b,c,e,f,h,g)},SplitsBrowser.Model.Competitor.prototype.completed=function(){return null!==this.totalTime},SplitsBrowser.Model.Competitor.prototype.getSuffix=function(){return this.completed()?this.isNonCompetitive?"n/c":"":"mp"},SplitsBrowser.Model.Competitor.prototype.getSplitTimeTo=function(a){return 0===a?0:this.splitTimes[a-1]},SplitsBrowser.Model.Competitor.prototype.getCumulativeTimeTo=function(a){return this.cumTimes[a]},SplitsBrowser.Model.Competitor.prototype.getSplitRankTo=function(a){return 0===a?null:this.splitRanks[a-1]},SplitsBrowser.Model.Competitor.prototype.getCumulativeRankTo=function(a){return 0===a?null:this.cumRanks[a-1]},SplitsBrowser.Model.Competitor.prototype.getAllCumulativeTimes=function(){return this.cumTimes},SplitsBrowser.Model.Competitor.prototype.setSplitAndCumulativeRanks=function(a,b){this.splitRanks=a,this.cumRanks=b},SplitsBrowser.Model.Competitor.prototype.getCumTimesAdjustedToReference=function(a){a.length!==this.cumTimes.length?SplitsBrowser.throwInvalidData("Cannot adjust competitor times because the numbers of times are different ("+this.cumTimes.length+" and "+a.length+")"):a.indexOf(null)>-1&&SplitsBrowser.throwInvalidData("Cannot adjust competitor times because a null value is in the reference data");var c=this.cumTimes.map(function(c,d){return b(c,a[d])});return c},SplitsBrowser.Model.Competitor.prototype.getCumTimesAdjustedToReferenceWithStartAdded=function(b){var c=this.getCumTimesAdjustedToReference(b),d=this.startTime;return c.map(function(b){return a(b,d)})},SplitsBrowser.Model.Competitor.prototype.getSplitPercentsBehindReferenceCumTimes=function(a){a.length!==this.cumTimes.length?SplitsBrowser.throwInvalidData("Cannot determine percentages-behind because the numbers of times are different ("+this.cumTimes.length+" and "+a.length+")"):a.indexOf(null)>-1&&SplitsBrowser.throwInvalidData("Cannot determine percentages-behind because a null value is in the reference data");var b=[0];return this.splitTimes.forEach(function(c,d){if(null===c)b.push(null);else{var e=a[d+1]-a[d];b.push(100*(c-e)/e)}}),b},SplitsBrowser.Model.Competitor.prototype.crosses=function(a){a.cumTimes.length!==this.cumTimes.length&&SplitsBrowser.throwInvalidData("Two competitors with different numbers of controls cannot cross");for(var b=!1,c=!1,d=0;d<this.cumTimes.length;d+=1)if(null!==this.cumTimes[d]&&null!==a.cumTimes[d]){var e=this.startTime+this.cumTimes[d],f=a.startTime+a.cumTimes[d];f>e?b=!0:e>f&&(c=!0)}return b&&c}}(),function(){"use strict";SplitsBrowser.Model.AgeClass=function(a,b,c){this.name=a,this.numControls=b,this.competitors=c,this.course=null,this.competitors.forEach(function(a){a.setClassName(this.name)},this)},SplitsBrowser.Model.AgeClass.prototype.setCourse=function(a){this.course=a}}(),function(){"use strict";function a(a){0===a.length&&SplitsBrowser.throwInvalidData("Cannot create an AgeClassSet from an empty set of competitors");var b=[],c=a[0].numControls;return a.forEach(function(a){a.numControls!==c&&SplitsBrowser.throwInvalidData("Cannot merge age classes with "+c+" and "+a.numControls+" controls"),a.competitors.forEach(function(a){b.push(a)})}),b.sort(SplitsBrowser.Model.compareCompetitors),b}SplitsBrowser.Model.getRanks=function(a){var b=a.filter(function(a){return null!==a});b.sort(d3.ascending);var c=new d3.map;b.forEach(function(a,b){c.has(a)||c.set(a,b+1)});var d=a.map(function(a){return null===a?null:c.get(a)});return d},SplitsBrowser.Model.AgeClassSet=function(b){this.allCompetitors=a(b),this.ageClasses=b,this.numControls=b[0].numControls,this.computeRanks()},SplitsBrowser.Model.AgeClassSet.prototype.isEmpty=function(){return 0===this.allCompetitors.length},SplitsBrowser.Model.AgeClassSet.prototype.getWinnerCumTimes=function(){if(0===this.allCompetitors.length)return null;var a=this.allCompetitors[0];return a.completed()?a.cumTimes:null},SplitsBrowser.Model.AgeClassSet.prototype.getFastestCumTimes=function(){return this.getFastestCumTimesPlusPercentage(0)},SplitsBrowser.Model.AgeClassSet.prototype.getFastestCumTimesPlusPercentage=function(a){var b=1+a/100,c=new Array(this.numControls+1);c[0]=0;for(var d=1;d<=this.numControls+1;d+=1){for(var e=null,f=0;f<this.allCompetitors.length;f+=1){var g=this.allCompetitors[f].getSplitTimeTo(d);null!==g&&(null===e||e>g)&&(e=g)}if(null===e)return null;c[d]=c[d-1]+e*b}return c},SplitsBrowser.Model.AgeClassSet.prototype.computeRanks=function(){var a=[],b=[];this.allCompetitors.forEach(function(){a.push([]),b.push([])}),d3.range(1,this.numControls+2).forEach(function(b){var c=this.allCompetitors.map(function(a){return a.getSplitTimeTo(b)}),d=SplitsBrowser.Model.getRanks(c);this.allCompetitors.forEach(function(b,c){a[c].push(d[c])})},this),d3.range(1,this.numControls+2).forEach(function(a){var c=this.allCompetitors.map(function(c,d){return a>1&&null===b[d][a-1-1]?null:c.getCumulativeTimeTo(a)}),d=SplitsBrowser.Model.getRanks(c);this.allCompetitors.forEach(function(a,c){b[c].push(d[c])})},this),this.allCompetitors.forEach(function(c,d){c.setSplitAndCumulativeRanks(a[d],b[d])})},SplitsBrowser.Model.AgeClassSet.prototype.getFastestSplitsTo=function(a,b){if("number"!=typeof a||0>=a)SplitsBrowser.throwInvalidData("The number of splits must be a positive integer");else{if(!("number"!=typeof b||0>=b||b>this.numControls+1)){var c=function(a,c){var d=a.getSplitTimeTo(b),e=c.getSplitTimeTo(b);return d===e?d3.ascending(a.totalTime,c.totalTime):d3.ascending(d,e)},d=this.allCompetitors.filter(function(a){return a.completed()});d.sort(c);for(var e=[],f=0;f<d.length&&a>f;f+=1)e.push([d[f].getSplitTimeTo(b),d[f].name]);return e}SplitsBrowser.throwInvalidData("Control "+b+" out of range")}},SplitsBrowser.Model.AgeClassSet.prototype.getChartData=function(a,b,c){if(this.isEmpty())SplitsBrowser.throwInvalidData("Cannot return chart data when there is no data");else{if("undefined"==typeof a)throw new TypeError("referenceCumTimes undefined or missing");if("undefined"==typeof b)throw new TypeError("currentIndexes undefined or missing");if("undefined"==typeof c)throw new TypeError("chartType undefined or missing")}var d,e,f=this.allCompetitors.map(function(b){return c.dataSelector(b,a)}),g=b.map(function(a){return f[a]}),h=a[a.length-1];if(0===b.length){var i=f[0];d=d3.min(i),e=d3.max(i)}else d=d3.min(g.map(function(a){return d3.min(a)})),e=d3.max(g.map(function(a){return d3.max(a)}));e===d&&(e=d+1);var j=d3.transpose(g),k=c.skipStart?a.slice(1):a,l=d3.zip(k,j),m=b.map(function(a){return this.allCompetitors[a].name},this);return{dataColumns:l.map(function(a){return{x:a[0],ys:a[1]}}),competitorNames:m,numControls:this.numControls,xExtent:[0,h],yExtent:[d,e]}}}(),function(){"use strict";SplitsBrowser.Model.Course=function(a,b,c,d){this.name=a,this.classes=b,this.length=c,this.climb=d},SplitsBrowser.Model.Course.prototype.getOtherClasses=function(a){var b=this.classes.filter(function(b){return b!==a});return b.length!==this.classes.length?b:(SplitsBrowser.throwInvalidData("Course.getOtherClasses: given class is not in this course"),void 0)}}(),function(){"use strict";SplitsBrowser.Model.Event=function(a,b){this.classes=a,this.courses=b}}(),function(){"use strict";var a="number";SplitsBrowser.Model.CompetitorSelection=function(b){typeof b!==a?SplitsBrowser.throwInvalidData("Competitor count must be a number"):0>b&&SplitsBrowser.throwInvalidData("Competitor count must be a non-negative number"),this.count=b,this.currentIndexes=[],this.changeHandlers=[]},SplitsBrowser.Model.CompetitorSelection.prototype.isSelected=function(a){return this.currentIndexes.indexOf(a)>-1},SplitsBrowser.Model.CompetitorSelection.prototype.isSingleRunnerSelected=function(){return 1===this.currentIndexes.length},SplitsBrowser.Model.CompetitorSelection.prototype.selectCrossingRunners=function(a){if(this.isSingleRunnerSelected()){var b=a[this.currentIndexes[0]];a.forEach(function(a,c){a.crosses(b)&&this.currentIndexes.push(c)},this),this.currentIndexes.sort(d3.ascending),this.fireChangeHandlers()}},SplitsBrowser.Model.CompetitorSelection.prototype.fireChangeHandlers=function(){this.changeHandlers.forEach(function(a){a(this.currentIndexes.slice(0))},this)},SplitsBrowser.Model.CompetitorSelection.prototype.selectAll=function(){this.currentIndexes=d3.range(this.count),this.fireChangeHandlers()},SplitsBrowser.Model.CompetitorSelection.prototype.selectNone=function(){this.currentIndexes=[],this.fireChangeHandlers()},SplitsBrowser.Model.CompetitorSelection.prototype.registerChangeHandler=function(a){-1===this.changeHandlers.indexOf(a)&&this.changeHandlers.push(a)},SplitsBrowser.Model.CompetitorSelection.prototype.deregisterChangeHandler=function(a){var b=this.changeHandlers.indexOf(a);b>-1&&this.changeHandlers.splice(b,1)},SplitsBrowser.Model.CompetitorSelection.prototype.toggle=function(b){if(typeof b===a)if(b>=0&&b<this.count){var c=this.currentIndexes.indexOf(b);-1===c?(this.currentIndexes.push(b),this.currentIndexes.sort(d3.ascending)):this.currentIndexes.splice(c,1),this.fireChangeHandlers()}else SplitsBrowser.throwInvalidData("Index '"+b+"' is out of range");else SplitsBrowser.throwInvalidData("Index is not a number")},SplitsBrowser.Model.CompetitorSelection.prototype.migrate=function(a,b){$.isArray(a)?$.isArray(b)?a.length!==this.count?SplitsBrowser.throwInvalidData("CompetitorSelection.migrate: oldCompetitors list must have the same length as the current count"):0===b.length&&SplitsBrowser.throwInvalidData("CompetitorSelection.migrate: newCompetitors list must not be empty"):SplitsBrowser.throwInvalidData("CompetitorSelection.migrate: newCompetitors not an array"):SplitsBrowser.throwInvalidData("CompetitorSelection.migrate: oldCompetitors not an array");var c=this.currentIndexes.map(function(b){return a[b]});this.count=b.length,this.currentIndexes=[],b.forEach(function(a,b){c.indexOf(a)>=0&&this.currentIndexes.push(b)},this),this.fireChangeHandlers()}}(),function(){"use strict";SplitsBrowser.Input.CSV={},SplitsBrowser.Input.CSV.parseCompetitors=function(a,b,c){var d=b.split(",");if(d.length===c+5){var e=d.shift(),f=d.shift(),g=d.shift(),h=60*SplitsBrowser.parseTime(d.shift()),i=d.map(SplitsBrowser.parseTime);return i.indexOf(0)>=0&&SplitsBrowser.throwInvalidData("Zero split times are not permitted - found one or more zero splits for competitor '"+e+" "+f+"'"),SplitsBrowser.Model.Competitor.fromSplitTimes(a+1,e,f,g,h,i)}SplitsBrowser.throwInvalidData("Expected "+(c+5)+" items in row for competitor in class with "+c+" controls, got "+d.length+" instead.")},SplitsBrowser.Input.CSV.parseAgeClass=function(a){var b=a.split("\r\n").filter(SplitsBrowser.isTrue);0===b.length&&SplitsBrowser.throwInvalidData("parseAgeClass got an empty list of lines");var c=b.shift().split(",");if(2===c.length){var d=c.shift(),e=c.shift(),f=parseInt(e,10);if(isNaN(f))SplitsBrowser.throwInvalidData("Could not read control count: '"+e+"'");else{if(!(0>f)){var g=b.map(function(a,b){return SplitsBrowser.Input.CSV.parseCompetitors(b,a,f)});return g.sort(SplitsBrowser.Model.compareCompetitors),new SplitsBrowser.Model.AgeClass(d,f,g)}SplitsBrowser.throwInvalidData("Expected a positive control count, got "+f+" instead")}}else SplitsBrowser.throwWrongFileFormat("Expected first line to have two parts (class name and number of controls), got "+c.length+" part(s) instead")},SplitsBrowser.Input.CSV.parseEventData=function(a){for(var b=a.split("\r\n\r\n").map($.trim).filter(SplitsBrowser.isTrue),c=b.map(SplitsBrowser.Input.CSV.parseAgeClass),d=c.map(function(a){return new SplitsBrowser.Model.Course(a.name,[a],null,null)}),e=0;e<c.length;e+=1)c[e].setCourse(d[e]);return new SplitsBrowser.Model.Event(c,d)}}(),function(){"use strict";var a="City",b="Short",c="Course",d="Pl",e=["First name","Surname",a,"Start","Time",b,"Course controls",d,c];SplitsBrowser.Input.SI={},SplitsBrowser.Input.SI.verifyCumulativeTimesInOrder=function(a,b){null!==b&&a>=b&&SplitsBrowser.throwInvalidData("Cumulative times must be strictly ascending: read "+SplitsBrowser.formatTime(a)+" and "+SplitsBrowser.formatTime(b)+" in that order")},SplitsBrowser.Input.SI.determineCourses=function(a,b,c){var d=d3.map(),e=d3.map();c.forEach(function(a){var b=a[0],c=a[1];d.has(b)?d.get(b).push(c):d.set(b,[c]),e.has(c)?e.get(c).push(b):e.set(c,[b])});var f=d3.set(),g=d3.map();a.forEach(function(a){g.set(a.name,a)});var h=[];return e.keys().forEach(function(a){if(!f.has(a)){for(var c,i,j=[a],k=[],l=[],m=[];j.length>0||k.length>0;){for(;j.length>0;){c=j.shift();for(var n=e.get(c),o=0;o<n.length;o+=1)i=n[o],k.indexOf(i)<0&&m.indexOf(i)<0&&k.push(i);l.push(c)}for(;k.length>0;){i=k.shift();for(var p=d.get(i),q=0;q<p.length;q+=1)c=p[q],j.indexOf(c)<0&&l.indexOf(c)<0&&j.push(c);m.push(i)}}l.forEach(function(a){f.add(a)});var r=m.map(function(a){return g.get(a)}),s=b.get(a),t=new SplitsBrowser.Model.Course(a,r,s.length,s.climb);r.forEach(function(a){a.setCourse(t)}),h.push(t)}}),h},SplitsBrowser.Input.SI.parseEventData=function(f){f=f.replace(/;City;(.*?);City;/,";City;$1;City2;");var g=d3.dsv(";").parse(f);$.isArray(g)&&0!==g.length?1===g[0].length&&SplitsBrowser.throwWrongFileFormat("Data seems not to be in the SI semicolon-separated format"):SplitsBrowser.throwWrongFileFormat("No data found to read");var h=d3.map(),i=d3.map(),j=[];g.forEach(function(f){e.forEach(function(a){f.hasOwnProperty(a)||SplitsBrowser.throwInvalidData("Column '"+a+"' missing")});var g,k=f["First name"],l=f.Surname,m=f[a],n=SplitsBrowser.parseTime(f.Start),o=f[b];h.has(o)?g=h.get(o).numControls:(g=parseInt(f["Course controls"],10),h.set(o,{numControls:g,competitors:[]}));var p=f[c];i.has(p)||i.set(p,{length:parseFloat(f.Km)||null,climb:parseInt(f.m,10)||null}),j.some(function(a){return a[0]===o&&a[1]===p})||j.push([o,p]);for(var q=[0],r=0,s=1;g>=s;s+=1){var t="Punch"+s;if(f.hasOwnProperty(t)){var u=f[t],v=SplitsBrowser.parseTime(u);SplitsBrowser.Input.SI.verifyCumulativeTimesInOrder(r,v),q.push(v),null!==v&&(r=v)}else SplitsBrowser.throwInvalidData("No '"+t+"' column")}var w=SplitsBrowser.parseTime(f.Time);SplitsBrowser.Input.SI.verifyCumulativeTimesInOrder(r,w),l=l.replace(/ mp$| n\/c$/,""),q.push(w);var x=h.get(o).competitors.length+1,y=SplitsBrowser.Model.Competitor.fromCumTimes(x,k,l,m,n,q);"n/c"===f[d]&&y.setNonCompetitive(),h.get(o).competitors.push(y)});var k=h.keys();k.sort();var l=k.map(function(a){var b=h.get(a);return new SplitsBrowser.Model.AgeClass(a,b.numControls,b.competitors)}),m=SplitsBrowser.Input.SI.determineCourses(l,i,j);return new SplitsBrowser.Model.Event(l,m)}}(),function(){"use strict";var a=[SplitsBrowser.Input.CSV.parseEventData,SplitsBrowser.Input.SI.parseEventData];SplitsBrowser.Input.parseEventData=function(b){for(var c=0;c<a.length;c+=1){var d=a[c];try{return d(b)}catch(e){if("WrongFileFormat"!==e.name)throw e}}return null}}(),function(){"use strict";var a="competitorList";SplitsBrowser.Controls.CompetitorListBox=function(b){this.parent=b,this.handler=null,this.competitorSelection=null,this.listDiv=d3.select(b).append("div").attr("id",a)},SplitsBrowser.Controls.CompetitorListBox.prototype.width=function(){return $(this.listDiv.node()).width()},SplitsBrowser.Controls.CompetitorListBox.prototype.selectionChanged=function(){var a=this;this.listDiv.selectAll("div.competitor").data(d3.range(this.competitorSelection.count)).classed("selected",function(b,c){return a.competitorSelection.isSelected(c)})},SplitsBrowser.Controls.CompetitorListBox.prototype.toggleCompetitor=function(a){this.competitorSelection.toggle(a)},SplitsBrowser.Controls.CompetitorListBox.prototype.setCompetitorList=function(a,b){$("div.competitor").off("click");var c=this.listDiv.selectAll("div.competitor").data(a);c.enter().append("div").classed("competitor",!0),c.selectAll("span").remove(),b&&c.append("span").classed("competitorClassLabel",!0).text(function(a){return a.className}),c.append("span").classed("nonfinisher",function(a){return!a.completed()}).text(function(a){return a.completed()?a.name:"* "+a.name}),c.exit().remove();var d=this;$("div.competitor").each(function(a,b){$(b).on("click",function(){d.toggleCompetitor(a)})})},SplitsBrowser.Controls.CompetitorListBox.prototype.setSelection=function(a){null!==this.competitorSelection&&this.competitorSelection.deregisterChangeHandler(this.handler);var b=this;this.competitorSelection=a,this.handler=function(a){b.selectionChanged(a)},this.competitorSelection.registerChangeHandler(this.handler),this.selectionChanged(d3.range(a.count))}}(),function(){"use strict";SplitsBrowser.Controls.ClassSelector=function(a){this.changeHandlers=[],this.otherClassesEnabled=!0;var b=d3.select(a).append("span");b.text("Class: ");var c=this;this.dropDown=b.append("select").node(),$(this.dropDown).bind("change",function(){c.updateOtherClasses(),c.onSelectionChanged()}),this.otherClassesCombiningLabel=b.append("span").classed("otherClassCombining",!0).style("display","none").text("and"),this.otherClassesSelector=b.append("div").classed("otherClassSelector",!0).style("display","none"),this.otherClassesSpan=this.otherClassesSelector.append("span"),this.otherClassesList=d3.select(a).append("div").classed("otherClassList",!0).style("position","absolute").style("display","none"),this.otherClassesSelector.on("click",function(){c.showHideClassSelector()}),this.setClasses([]),this.selectedOtherClassIndexes=d3.set(),$(document).click(function(a){var b=c.otherClassesList.node();if("none"!==b.style.display){var d=$("div.otherClassList,div.otherClassSelector");d.is(a.target)||0!==d.has(a.target).length||(b.style.display="none")}}),$(document).keydown(function(a){27===a.which&&c.otherClassesList.style("display","none")})},SplitsBrowser.Controls.ClassSelector.prototype.setOtherClassesEnabled=function(a){this.otherClassesCombiningLabel.classed("disabled",!a),this.otherClassesSelector.classed("disabled",!a),this.otherClassesEnabled=a},SplitsBrowser.Controls.ClassSelector.prototype.setClasses=function(a){if($.isArray(a)){this.classes=a;var b;0===a.length?(this.dropDown.disabled=!0,b=["[No classes loaded]"]):(this.dropDown.disabled=!1,b=a.map(function(a){return a.name}));var c=d3.select(this.dropDown).selectAll("option").data(b);c.enter().append("option"),c.attr("value",function(a,b){return b.toString()}).text(function(a){return a}),c.exit().remove(),this.updateOtherClasses()}else SplitsBrowser.throwInvalidData("ClassSelector.setClasses: classes is not an array")},SplitsBrowser.Controls.ClassSelector.prototype.registerChangeHandler=function(a){-1===this.changeHandlers.indexOf(a)&&this.changeHandlers.push(a)},SplitsBrowser.Controls.ClassSelector.prototype.onSelectionChanged=function(){var a=[this.dropDown.selectedIndex];this.selectedOtherClassIndexes.forEach(function(b){a.push(parseInt(b,10))}),this.changeHandlers.forEach(function(b){b(a)})},SplitsBrowser.Controls.ClassSelector.prototype.updateOtherClassText=function(){var a=this.selectedOtherClassIndexes.values();a.sort(d3.ascending);var b;b=0===a.length?"<select>":a.map(function(a){return this.classes[a].name},this).join(", "),this.otherClassesSpan.text(b)},SplitsBrowser.Controls.ClassSelector.prototype.updateOtherClasses=function(){this.otherClassesList.style("display","none"),this.selectedOtherClassIndexes=d3.set(),this.updateOtherClassText(),$("div.otherClassItem").off("click");var a,b=this;if(this.classes.length>0){var c=this.classes[this.dropDown.selectedIndex];a=c.course.getOtherClasses(c)}else a=[];var d=a.map(function(a){return this.classes.indexOf(a)},this),e=this.otherClassesList.selectAll("div").data(d);e.enter().append("div").classed("otherClassItem",!0),e.attr("id",function(a){return"ageClassIdx_"+a}).classed("selected",!1).text(function(a){return b.classes[a].name}),e.exit().remove(),d.length>0?(this.otherClassesSelector.style("display","inline-block"),this.otherClassesCombiningLabel.style("display","")):(this.otherClassesSelector.style("display","none"),this.otherClassesCombiningLabel.style("display","none"));var f=$(this.otherClassesSelector.node()).offset(),g=$(this.otherClassesSelector.node()).outerHeight();this.otherClassesList.style("left",f.left+"px").style("top",f.top+g+"px"),$("div.otherClassItem").each(function(a,c){$(c).on("click",function(){b.toggleOtherClass(d[a])})})},SplitsBrowser.Controls.ClassSelector.prototype.showHideClassSelector=function(){this.otherClassesEnabled&&this.otherClassesList.style("display","none"===this.otherClassesList.style("display")?"":"none")},SplitsBrowser.Controls.ClassSelector.prototype.toggleOtherClass=function(a){this.selectedOtherClassIndexes.has(a)?this.selectedOtherClassIndexes.remove(a):this.selectedOtherClassIndexes.add(a),d3.select("div#ageClassIdx_"+a).classed("selected",this.selectedOtherClassIndexes.has(a)),this.updateOtherClassText(),this.onSelectionChanged()}}(),function(){"use strict";var a=[{name:"Winner",selector:function(a){return a.getWinnerCumTimes()}},{name:"Fastest time",selector:function(a){return a.getFastestCumTimes()}}],b=[5,25,50,100];b.forEach(function(b){a.push({name:"Fastest time + "+b+"%",selector:function(a){return a.getFastestCumTimesPlusPercentage(b)}})}),a.push({name:"Any runner..."});var c=1,d="comparisonSelector",e="runnerSelector";SplitsBrowser.Controls.ComparisonSelector=function(b){this.changeHandlers=[],this.classes=null,this.currentRunnerIndex=null,this.previousCompetitorList=null,this.parent=b;var f=d3.select(b).append("span");f.append("span").classed("comparisonSelectorLabel",!0).text("Compare with ");var g=this;this.dropDown=f.append("select").attr("id",d).node(),$(this.dropDown).bind("change",function(){g.onSelectionChanged()});var h=d3.select(this.dropDown).selectAll("option").data(a);h.enter().append("option"),h.attr("value",function(a,b){return b.toString()}).text(function(a){return a.name}),h.exit().remove(),this.runnerSpan=d3.select(b).append("span").style("display","none").style("padding-left","20px"),this.runnerSpan.append("span").classed("comparisonSelectorLabel",!0).text("Runner: "),this.runnerDropDown=this.runnerSpan.append("select").attr("id",e).node(),$(this.runnerDropDown).bind("change",function(){g.onSelectionChanged()}),this.dropDown.selectedIndex=c},SplitsBrowser.Controls.ComparisonSelector.prototype.registerChangeHandler=function(a){-1===this.changeHandlers.indexOf(a)&&this.changeHandlers.push(a)},SplitsBrowser.Controls.ComparisonSelector.prototype.isAnyRunnerSelected=function(){return this.dropDown.selectedIndex===a.length-1},SplitsBrowser.Controls.ComparisonSelector.prototype.setAgeClassSet=function(a){this.ageClassSet=a,this.setRunners()},SplitsBrowser.Controls.ComparisonSelector.prototype.setRunners=function(){var a=this.ageClassSet.allCompetitors,b=d3.range(a.length).filter(function(b){return a[b].completed()}),c=a.filter(function(a){return a.completed()}),d=d3.select(this.runnerDropDown).selectAll("option").data(c);if(d.enter().append("option"),d.attr("value",function(a,c){return b[c].toString()}).text(function(a){return a.name}),d.exit().remove(),null===this.previousCompetitorList)this.currentRunnerIndex=0;else{var e=this.previousCompetitorList[this.currentRunnerIndex],f=this.ageClassSet.allCompetitors.indexOf(e);this.currentRunnerIndex=Math.max(f,0)}this.runnerDropDown.selectedIndex=this.currentRunnerIndex,this.previousCompetitorList=this.ageClassSet.allCompetitors},SplitsBrowser.Controls.ComparisonSelector.prototype.setEnabled=function(a){d3.select(this.parent).selectAll("span.comparisonSelectorLabel").classed("disabled",!a),this.dropDown.disabled=!a,this.runnerDropDown.disabled=!a},SplitsBrowser.Controls.ComparisonSelector.prototype.getComparisonFunction=function(){if(this.isAnyRunnerSelected()){var b=this;return function(a){return a.allCompetitors[b.currentRunnerIndex].getAllCumulativeTimes()}}return a[this.dropDown.selectedIndex].selector},SplitsBrowser.Controls.ComparisonSelector.prototype.onSelectionChanged=function(){this.runnerSpan.style("display",this.isAnyRunnerSelected()?"":"none");var a=Math.max(this.runnerDropDown.selectedIndex,0);this.currentRunnerIndex=0===this.runnerDropDown.options.length?0:parseInt(this.runnerDropDown.options[a].value,10),this.changeHandlers.forEach(function(a){a(this.getComparisonFunction())},this)}}(),function(){"use strict";var a="statisticSelector",b="statisticCheckbox",c=["Total time","Split time","Behind fastest"];SplitsBrowser.Controls.StatisticsSelector=function(d){this.span=d3.select(d).append("span").attr("id",a);var e=this.span.selectAll("span").data(c).enter().append("span");e.append("input").attr("type","checkbox").attr("id",function(a,c){return b+c}),e.append("label").attr("for",function(a,c){return b+c}).classed("statisticsSelectorLabel",!0).text(function(a){return a});var f=this;$("input",this.span.node()).bind("change",function(){return f.onCheckboxChanged()}),this.handlers=[]},SplitsBrowser.Controls.StatisticsSelector.prototype.setEnabled=function(a){this.span.selectAll("label.statisticsSelectorLabel").classed("disabled",!a),this.span.selectAll("input").attr("disabled",a?null:"disabled")},SplitsBrowser.Controls.StatisticsSelector.prototype.registerChangeHandler=function(a){-1===this.handlers.indexOf(a)&&this.handlers.push(a)},SplitsBrowser.Controls.StatisticsSelector.prototype.deregisterChangeHandler=function(a){var b=this.handlers.indexOf(a);-1!==b&&this.handlers.splice(b,1)},SplitsBrowser.Controls.StatisticsSelector.prototype.getVisibleStatistics=function(){return this.span.selectAll("input")[0].map(function(a){return a.checked})},SplitsBrowser.Controls.StatisticsSelector.prototype.onCheckboxChanged=function(){var a=this.getVisibleStatistics();this.handlers.forEach(function(b){b(a)})}}(),function(){"use strict";function a(a){return null===a?null:a/60}var b=[{name:"Splits graph",dataSelector:function(b,c){return b.getCumTimesAdjustedToReference(c).map(a)},skipStart:!1,yAxisLabel:"Time loss (min)",showCrossingRunnersButton:!1,isResultsTable:!1},{name:"Race graph",dataSelector:function(b,c){return b.getCumTimesAdjustedToReferenceWithStartAdded(c).map(a)},skipStart:!1,yAxisLabel:"Time",showCrossingRunnersButton:!0,isResultsTable:!1},{name:"Position after leg",dataSelector:function(a){return a.cumRanks},skipStart:!0,yAxisLabel:"Position",showCrossingRunnersButton:!1,isResultsTable:!1},{name:"Split position",dataSelector:function(a){return a.splitRanks},skipStart:!0,yAxisLabel:"Position",showCrossingRunnersButton:!1,isResultsTable:!1},{name:"Percent behind",dataSelector:function(a,b){return a.getSplitPercentsBehindReferenceCumTimes(b)},skipStart:!1,yAxisLabel:"Percent behind",showCrossingRunnersButton:!1,isResultsTable:!1},{name:"Results table",dataSelector:null,skipStart:!1,yAxisLabel:null,showCrossingRunnersButton:!1,isResultsTable:!0}];SplitsBrowser.Controls.ChartTypeSelector=function(a){this.changeHandlers=[];var c=d3.select(a).append("span");c.text("View: ");var d=this;this.dropDown=c.append("select").node(),$(this.dropDown).bind("change",function(){d.onSelectionChanged()});var e=d3.select(this.dropDown).selectAll("option").data(b);e.enter().append("option"),e.attr("value",function(a,b){return b.toString()}).text(function(a){return a.name}),e.exit().remove()},SplitsBrowser.Controls.ChartTypeSelector.prototype.registerChangeHandler=function(a){-1===this.changeHandlers.indexOf(a)&&this.changeHandlers.push(a)},SplitsBrowser.Controls.ChartTypeSelector.prototype.getChartType=function(){return b[Math.max(this.dropDown.selectedIndex,0)]},SplitsBrowser.Controls.ChartTypeSelector.prototype.onSelectionChanged=function(){this.changeHandlers.forEach(function(a){a(b[this.dropDown.selectedIndex])},this)}}(),function(){"use strict";SplitsBrowser.Controls.ChartPopup=function(a,b){this.shown=!1,this.mouseIn=!1,this.popupDiv=d3.select(a).append("div"),this.popupDiv.classed("chartPopup",!0).style("display","none").style("position","absolute"),this.popupDivHeader=this.popupDiv.append("div").classed("chartPopupHeader",!0).append("span");var c=this.popupDiv.append("div").classed("chartPopupTableContainer",!0);this.popupDivTable=c.append("table");for(var d in b)$(this.popupDiv.node()).on(d,b[d]);var e=this;$(this.popupDiv.node()).mouseenter(function(){e.mouseIn=!0}),$(this.popupDiv.node()).mouseleave(function(){e.mouseIn=!1})},SplitsBrowser.Controls.ChartPopup.prototype.isShown=function(){return this.shown},SplitsBrowser.Controls.ChartPopup.prototype.isMouseIn=function(){return this.mouseIn},SplitsBrowser.Controls.ChartPopup.prototype.setSelectedClasses=function(a){this.popupDivHeader.text("Selected classes");var b=this.popupDivTable.selectAll("tr").data(a);b.enter().append("tr"),b.selectAll("td").remove(),b.append("td").text(function(a){return SplitsBrowser.formatTime(a[0])}),b.append("td").text(function(a){return a[1]}),b.exit().remove()},SplitsBrowser.Controls.ChartPopup.prototype.setLocation=function(a,b){this.popupDiv.style("left",a+"px").style("top",b+"px")
},SplitsBrowser.Controls.ChartPopup.prototype.show=function(a,b){this.popupDiv.style("display",""),this.shown=!0,this.setLocation(a,b)},SplitsBrowser.Controls.ChartPopup.prototype.hide=function(){this.popupDiv.style("display","none"),this.shown=!1},SplitsBrowser.Controls.ChartPopup.prototype.height=function(){return $(this.popupDiv.node()).height()}}(),function(){"use strict";function a(a,b){return k+SplitsBrowser.formatTime(a)+" ("+(null===b?"-":b)+")"}function b(a,b){return""===b?a:a+" ("+b+")"}var c="sb-text-size-element",d="chart",e=10,f=10,g={top:20,right:20,bottom:30,left:50},h=10,i=10,j=1,k="    ",l=["#FF0000","#4444FF","#00FF00","#000000","#CC0066","#000099","#FFCC00","#884400","#9900FF","#CCCC00","#888800","#CC6699","#00DD00","#3399FF","#BB00BB","#00DDDD","#FF00FF","#0088BB","#888888","#FF99FF","#55BB33"];SplitsBrowser.Controls.Chart=function(a){this.parent=a,this.xScale=null,this.yScale=null,this.overallWidth=-1,this.overallHeight=-1,this.contentWidth=-1,this.contentHeight=-1,this.numControls=-1,this.selectedIndexes=[],this.currentCompetitorData=null,this.isPopupOpen=!1,this.selectedIndexesOrderedByLastYValue=[],this.referenceCumTimes=[],this.fastestCumTimes=[],this.isMouseIn=!1,this.currentControlIndex=null,this.controlLine=null,this.svg=d3.select(this.parent).append("svg").attr("id",d),this.svgGroup=this.svg.append("g"),this.setLeftMargin(g.left);var b=this,e=function(a){b.onMouseMove(a)},f=function(a){b.onMouseUp(a)},h=function(a){b.onMouseDown(a)};$(this.svg.node()).mouseenter(function(a){b.onMouseEnter(a)}).mousemove(e).mouseleave(function(a){b.onMouseLeave(a)}).mousedown(h).mouseup(f),this.textSizeElement=this.svg.append("text").attr("fill","transparent").attr("id",c);var i={mousemove:e,mousedown:h,mouseup:f};this.popup=new SplitsBrowser.Controls.ChartPopup(a,i)},SplitsBrowser.Controls.Chart.prototype.onMouseEnter=function(){this.isMouseIn=!0},SplitsBrowser.Controls.Chart.prototype.setLeftMargin=function(a){this.currentLeftMargin=a,this.svgGroup.attr("transform","translate("+this.currentLeftMargin+","+g.top+")")},SplitsBrowser.Controls.Chart.prototype.onMouseMove=function(a){if(this.isMouseIn&&null!==this.xScale){var b=$(this.svg.node()),c=b.offset(),d=a.pageX-c.left,e=a.pageY-c.top;if(this.currentLeftMargin<=d&&d<b.width()-g.right&&g.top<=e&&e<b.height()-g.bottom){var f,h=this.xScale.invert(d-this.currentLeftMargin),i=d3.bisect(this.referenceCumTimes,h);if(i>=this.referenceCumTimes.length)f=this.numControls+1;else if(1===i)f=1;else{var j=Math.abs(this.referenceCumTimes[i]-h),k=Math.abs(h-this.referenceCumTimes[i-1]);f=j>k?i-1:i}(null===this.currentControlIndex||this.currentControlIndex!==f)&&(this.removeControlLine(),this.drawControlLine(f)),this.popup.isShown()&&(this.popup.setSelectedClasses(this.getFastestSplits()),this.popup.setLocation(a.pageX+10,a.pageY-this.popup.height()/2))}else this.removeControlLine(),this.popup.hide()}},SplitsBrowser.Controls.Chart.prototype.getFastestSplits=function(){return this.ageClassSet.getFastestSplitsTo(f,this.currentControlIndex)},SplitsBrowser.Controls.Chart.prototype.onMouseLeave=function(){var a=this;setTimeout(function(){a.popup.isMouseIn()||(a.isMouseIn=!1,a.removeControlLine())},1)},SplitsBrowser.Controls.Chart.prototype.onMouseDown=function(a){this.isMouseIn&&a.which===j&&(this.popup.setSelectedClasses(this.getFastestSplits()),this.popup.show(a.pageX+e,a.pageY-this.popup.height()/2))},SplitsBrowser.Controls.Chart.prototype.onMouseUp=function(){this.popup.hide()},SplitsBrowser.Controls.Chart.prototype.drawControlLine=function(a){this.currentControlIndex=a,this.updateCompetitorStatistics();var b=this.xScale(this.referenceCumTimes[a]);this.controlLine=this.svgGroup.append("line").attr("x1",b).attr("y1",0).attr("x2",b).attr("y2",this.contentHeight).attr("class","controlLine").node()},SplitsBrowser.Controls.Chart.prototype.removeControlLine=function(){this.currentControlIndex=null,this.updateCompetitorStatistics(),null!==this.controlLine&&(d3.select(this.controlLine).remove(),this.controlLine=null)},SplitsBrowser.Controls.Chart.prototype.getTimesBehindFastest=function(a,b){var c=b.map(function(a){return this.ageClassSet.allCompetitors[a]},this),d=this.fastestCumTimes[a]-this.fastestCumTimes[a-1],e=c.map(function(b){var c=b.getSplitTimeTo(a);return null===c?null:c-d});return e},SplitsBrowser.Controls.Chart.prototype.updateCompetitorStatistics=function(){var c=this.selectedIndexesOrderedByLastYValue.map(function(a){return this.ageClassSet.allCompetitors[a]},this),d=c.map(function(a){return b(a.name,a.getSuffix())});if(null!==this.currentControlIndex&&this.currentControlIndex>0){if(this.visibleStatistics[0]){var e=c.map(function(a){return a.getCumulativeTimeTo(this.currentControlIndex)},this),f=c.map(function(a){return a.getCumulativeRankTo(this.currentControlIndex)},this);d=d3.zip(d,e,f).map(function(b){return b[0]+a(b[1],b[2])})}if(this.visibleStatistics[1]){var g=c.map(function(a){return a.getSplitTimeTo(this.currentControlIndex)},this),h=c.map(function(a){return a.getSplitRankTo(this.currentControlIndex)},this);d=d3.zip(d,g,h).map(function(b){return b[0]+a(b[1],b[2])})}if(this.visibleStatistics[2]){var i=this.getTimesBehindFastest(this.currentControlIndex,this.selectedIndexesOrderedByLastYValue);d=d3.zip(d,i).map(function(a){return a[0]+k+SplitsBrowser.formatTime(a[1])})}}this.currentCompetitorData.forEach(function(a,b){a.label=d[b]}),d3.selectAll("text.competitorLabel").text(function(a){return a.label})},SplitsBrowser.Controls.Chart.prototype.getTickFormatter=function(){var a=this;return function(b,c){return 0===c?"S":c===a.numControls+1?"F":c.toString()}},SplitsBrowser.Controls.Chart.prototype.getTextWidth=function(a){return this.textSizeElement.text(a).node().getBBox().width},SplitsBrowser.Controls.Chart.prototype.getTextHeight=function(a){return this.textSizeElement.text(a).node().getBBox().height},SplitsBrowser.Controls.Chart.prototype.getMaxGraphEndTextWidth=function(){if(0===this.selectedIndexes.length)return 0;var a=this.selectedIndexes.map(function(a){var c=this.ageClassSet.allCompetitors[a];return this.getTextWidth(b(c.name,c.getSuffix()))},this);return d3.max(a)+this.determineMaxStatisticTextWidth()},SplitsBrowser.Controls.Chart.prototype.getMaxTimeAndRankTextWidth=function(b,c){var d=0,e=0,f=this.selectedIndexes.map(function(a){return this.ageClassSet.allCompetitors[a]},this);d3.range(1,this.numControls+2).forEach(function(a){var g=f.map(function(c){return c[b](a)});d=Math.max(d,d3.max(g.filter(SplitsBrowser.isNotNull)));var h=f.map(function(b){return b[c](a)});e=Math.max(e,d3.max(h.filter(SplitsBrowser.isNotNull)))});var g=a(d,e);return this.getTextWidth(g)},SplitsBrowser.Controls.Chart.prototype.getMaxSplitTimeAndRankTextWidth=function(){return this.getMaxTimeAndRankTextWidth("getSplitTimeTo","getSplitRankTo")},SplitsBrowser.Controls.Chart.prototype.getMaxCumulativeTimeAndRankTextWidth=function(){return this.getMaxTimeAndRankTextWidth("getCumulativeTimeTo","getCumulativeRankTo")},SplitsBrowser.Controls.Chart.prototype.getMaxTimeBehindFastestWidth=function(){for(var a=0,b=1;b<=this.numControls+1;b+=1){var c=this.getTimesBehindFastest(b,this.selectedIndexes);a=Math.max(a,d3.max(c.filter(SplitsBrowser.isNotNull)))}return this.getTextWidth(k+SplitsBrowser.formatTime(a))},SplitsBrowser.Controls.Chart.prototype.determineMaxStatisticTextWidth=function(){var a=0;return this.visibleStatistics[0]&&(a+=this.getMaxCumulativeTimeAndRankTextWidth()),this.visibleStatistics[1]&&(a+=this.getMaxSplitTimeAndRankTextWidth()),this.visibleStatistics[2]&&(a+=this.getMaxTimeBehindFastestWidth()),a},SplitsBrowser.Controls.Chart.prototype.determineMaxStartTimeLabelWidth=function(a){var b;return b=a.competitorNames.length>0?d3.max(a.competitorNames.map(function(a){return this.getTextWidth("00:00:00 "+a)},this)):0},SplitsBrowser.Controls.Chart.prototype.createScales=function(a){this.xScale=d3.scale.linear().domain(a.xExtent).range([0,this.contentWidth]),this.yScale=d3.scale.linear().domain(a.yExtent).range([0,this.contentHeight]),this.xScaleMinutes=d3.scale.linear().domain([a.xExtent[0]/60,a.xExtent[1]/60]).range([0,this.contentWidth])},SplitsBrowser.Controls.Chart.prototype.drawBackgroundRectangles=function(){var a=this.svgGroup.selectAll("rect").data(d3.range(this.numControls+1)),b=this;a.enter().append("rect"),a.attr("x",function(a){return b.xScale(b.referenceCumTimes[a])}).attr("y",0).attr("width",function(a){return b.xScale(b.referenceCumTimes[a+1]-b.referenceCumTimes[a])}).attr("height",this.contentHeight).attr("class",function(a){return 0===a%2?"background1":"background2"}),a.exit().remove()},SplitsBrowser.Controls.Chart.prototype.determineYAxisTickFormatter=function(a){if(this.showStartTimes){var b=0===a.dataColumns.length?[]:a.dataColumns[0].ys;if(0===b.length)return function(a){return SplitsBrowser.formatTime(60*a)};var c=this.yScale;return function(a){var d=d3.min(b.map(function(b){return Math.abs(c(b)-c(a))}));return d>=i?SplitsBrowser.formatTime(60*a):""}}return null},SplitsBrowser.Controls.Chart.prototype.drawAxes=function(a,b){var c=this.determineYAxisTickFormatter(b),d=d3.svg.axis().scale(this.xScale).orient("top").tickFormat(this.getTickFormatter()).tickValues(this.referenceCumTimes),e=d3.svg.axis().scale(this.yScale).tickFormat(c).orient("left"),f=d3.svg.axis().scale(this.xScaleMinutes).orient("bottom");this.svgGroup.selectAll("g.axis").remove(),this.svgGroup.append("g").attr("class","x axis").call(d),this.svgGroup.append("g").attr("class","y axis").call(e).append("text").attr("transform","rotate(-90)").attr("x",-(this.contentHeight-6)).attr("y",6).attr("dy",".71em").style("text-anchor","start").text(a),this.svgGroup.append("g").attr("class","x axis").attr("transform","translate(0,"+this.contentHeight+")").call(f).append("text").attr("x",60).attr("y",-5).style("text-anchor","start").text("Time (min)")},SplitsBrowser.Controls.Chart.prototype.drawChartLines=function(a){var b=this,c=function(c){return a.dataColumns.every(function(a){return null===a.ys[c]})?d3.svg.line().x(-1e4).y(-1e4):d3.svg.line().x(function(a){return b.xScale(a.x)}).y(function(a){return b.yScale(a.ys[c])}).defined(function(a){return null!==a.ys[c]}).interpolate("linear")},d=this.svgGroup.selectAll("path.graphLine").data(d3.range(this.numLines));d.enter().append("path"),d.attr("d",function(b){return c(b)(a.dataColumns)}).attr("stroke",function(a){return l[b.selectedIndexes[a]%l.length]}).attr("class",function(a){return"graphLine competitor"+b.selectedIndexes[a]}).on("mouseenter",function(a){b.highlight(b.selectedIndexes[a])}).on("mouseleave",function(){b.unhighlight()}),d.exit().remove()},SplitsBrowser.Controls.Chart.prototype.highlight=function(a){this.svg.selectAll("path.graphLine.competitor"+a).classed("selected",!0),this.svg.selectAll("line.competitorLegendLine.competitor"+a).classed("selected",!0),this.svg.selectAll("text.competitorLabel.competitor"+a).classed("selected",!0),this.svg.selectAll("text.startLabel.competitor"+a).classed("selected",!0)},SplitsBrowser.Controls.Chart.prototype.unhighlight=function(){this.svg.selectAll("path.graphLine.selected").classed("selected",!1),this.svg.selectAll("line.competitorLegendLine.selected").classed("selected",!1),this.svg.selectAll("text.competitorLabel.selected").classed("selected",!1),this.svg.selectAll("text.startLabel.selected").classed("selected",!1)},SplitsBrowser.Controls.Chart.prototype.drawCompetitorStartTimeLabels=function(a){var b=a.dataColumns[0],c=this,d=this.svgGroup.selectAll("text.startLabel").data(this.selectedIndexes);d.enter().append("text"),d.attr("x",-7).attr("y",function(d,e){return c.yScale(b.ys[e])+c.getTextHeight(a.competitorNames[e])/4}).attr("class",function(a){return"startLabel competitor"+a}).on("mouseenter",function(a){c.highlight(a)}).on("mouseleave",function(){c.unhighlight()}).text(function(c,d){return SplitsBrowser.formatTime(60*b.ys[d])+" "+a.competitorNames[d]}),d.exit().remove()},SplitsBrowser.Controls.Chart.prototype.removeCompetitorStartTimeLabels=function(){this.svgGroup.selectAll("text.startLabel").remove()},SplitsBrowser.Controls.Chart.prototype.drawCompetitorLegendLabels=function(a){if(0===a.dataColumns.length)this.currentCompetitorData=[];else{var c=a.dataColumns[a.dataColumns.length-1];this.currentCompetitorData=d3.range(this.numLines).map(function(a){var d=this.selectedIndexes[a],e=this.ageClassSet.allCompetitors[d].name;return{label:b(e,this.ageClassSet.allCompetitors[d].getSuffix()),textHeight:this.getTextHeight(e),y:null===c.ys[a]?null:this.yScale(c.ys[a]),colour:l[d%l.length],index:d}},this);for(var d=null,e=this.currentCompetitorData.length-1;e>=0;e-=1)null===this.currentCompetitorData[e].y&&(this.currentCompetitorData[e].y=null===d?this.contentHeight:d-this.currentCompetitorData[e].textHeight,d=this.currentCompetitorData[e].y)}this.currentCompetitorData.sort(function(a,b){return a.y-b.y}),this.selectedIndexesOrderedByLastYValue=this.currentCompetitorData.map(function(a){return a.index});for(var f=1;f<this.currentCompetitorData.length;f+=1)this.currentCompetitorData[f].y<this.currentCompetitorData[f-1].y+this.currentCompetitorData[f-1].textHeight&&(this.currentCompetitorData[f].y=this.currentCompetitorData[f-1].y+this.currentCompetitorData[f-1].textHeight);var g=this.svgGroup.selectAll("line.competitorLegendLine").data(this.currentCompetitorData);g.enter().append("line");var i=this;g.attr("x1",this.contentWidth+1).attr("y1",function(a){return a.y}).attr("x2",this.contentWidth+h+1).attr("y2",function(a){return a.y}).attr("stroke",function(a){return a.colour}).attr("class",function(a){return"competitorLegendLine competitor"+a.index}).on("mouseenter",function(a){i.highlight(a.index)}).on("mouseleave",function(){i.unhighlight()}),g.exit().remove();var j=this.svgGroup.selectAll("text.competitorLabel").data(this.currentCompetitorData);j.enter().append("text"),j.attr("x",this.contentWidth+h+2).attr("y",function(a){return a.y+a.textHeight/4}).attr("class",function(a){return"competitorLabel competitor"+a.index}).on("mouseenter",function(a){i.highlight(a.index)}).on("mouseleave",function(){i.unhighlight()}).text(function(a){return a.label}),j.exit().remove()},SplitsBrowser.Controls.Chart.prototype.adjustContentSize=function(){var a=this.getMaxGraphEndTextWidth();this.setLeftMargin(this.maxStartTimeLabelWidth+g.left),this.contentWidth=Math.max(this.overallWidth-this.currentLeftMargin-g.right-a-(h+2),100),this.contentHeight=Math.max(this.overallHeight-g.top-g.bottom,100)},SplitsBrowser.Controls.Chart.prototype.setSize=function(a,b){this.overallWidth=a,this.overallHeight=b,$(this.svg.node()).width(a).height(b),this.adjustContentSize()},SplitsBrowser.Controls.Chart.prototype.drawChart=function(a,b,c,d,e,f,g,h){this.numControls=a.numControls,this.numLines=a.competitorNames.length,this.selectedIndexes=e,this.referenceCumTimes=c,this.fastestCumTimes=d,this.ageClassSet=b,this.showStartTimes=h,this.visibleStatistics=f,this.maxStatisticTextWidth=this.determineMaxStatisticTextWidth(),this.maxStartTimeLabelWidth=h?this.determineMaxStartTimeLabelWidth(a):0,this.adjustContentSize(),this.createScales(a),this.drawBackgroundRectangles(),this.drawAxes(g,a),this.drawChartLines(a),this.drawCompetitorLegendLabels(a),h?this.drawCompetitorStartTimeLabels(a):this.removeCompetitorStartTimeLabels()}}(),function(){"use strict";var a=" ";SplitsBrowser.Controls.ResultsTable=function(a){this.parent=a,this.ageClass=null,this.div=null,this.headerSpan=null,this.table=null,this.buildTable()},SplitsBrowser.Controls.ResultsTable.prototype.buildTable=function(){this.div=d3.select(this.parent).append("div").attr("id","resultsTableContainer"),this.headerSpan=this.div.append("div").append("span").classed("resultsTableHeader",!0),this.table=this.div.append("table").classed("resultsTable",!0),this.table.append("thead").append("tr"),this.table.append("tbody")},SplitsBrowser.Controls.ResultsTable.prototype.populateTable=function(){function b(a,b,c,d){var e=a.append("td");e.append("span").text(b),e.append("br"),e.append("span").text(c),d&&e.classed(d,!0)}var c=this.ageClass.name+", "+this.ageClass.numControls+" control"+(1===this.ageClass.numControls?"":"s"),d=this.ageClass.course;null!==d.length&&(c+=", "+d.length.toFixed(1)+"km"),null!==d.climb&&(c+=", "+d.climb+"m"),this.headerSpan.text(c);var e=["#","Name","Time"].concat(d3.range(1,this.ageClass.numControls+1)).concat(["Finish"]),f=this.table.select("thead tr").selectAll("th").data(e);f.enter().append("th"),f.text(function(a){return a}),f.exit().remove();var g=this.table.select("tbody");g.selectAll("tr").remove();var h=this.ageClass.competitors.slice(0);h.sort(SplitsBrowser.Model.compareCompetitors);var i=0,j=0;h.forEach(function(c,d){var e=g.append("tr"),f=e.append("td");c.isNonCompetitive?(f.text("n/c"),i+=1):c.completed()&&((0===d||h[d-1].totalTime!==c.totalTime)&&(j=d+1-i),f.text(j)),b(e,c.name,c.club),b(e,c.completed()?SplitsBrowser.formatTime(c.totalTime):"mp",a,"time"),d3.range(1,this.ageClass.numControls+2).forEach(function(a){b(e,SplitsBrowser.formatTime(c.getCumulativeTimeTo(a)),SplitsBrowser.formatTime(c.getSplitTimeTo(a)),"time")})},this)},SplitsBrowser.Controls.ResultsTable.prototype.setClass=function(a){this.ageClass=a,this.populateTable(),"none"!==this.div.style("display")&&this.adjustTableCellWidths()},SplitsBrowser.Controls.ResultsTable.prototype.adjustTableCellWidths=function(){var a=d3.select("tbody tr td:last-child").node();$("tbody td.time").width($(a).width())},SplitsBrowser.Controls.ResultsTable.prototype.show=function(){this.div.style("display",""),this.adjustTableCellWidths()},SplitsBrowser.Controls.ResultsTable.prototype.hide=function(){this.div.style("display","none")}}(),function(){"use strict";function a(a,b){if("success"===b){var c=SplitsBrowser.Input.parseEventData(a);if(null===c)alert("Unable to read in event data file");else{var d=new SplitsBrowser.Viewer;d.buildUi(),d.setClasses(c.classes),d.selectClasses([0])}}else alert("Unable to read event data.  Status: "+b)}var b=100,c="competitorListContainer";SplitsBrowser.Viewer=function(){this.classes=null,this.currentClasses=[],this.currentIndexes=null,this.chartData=null,this.referenceCumTimes=null,this.fastestCumTimes=null,this.previousCompetitorList=[],this.selection=null,this.ageClassSet=null,this.classSelector=null,this.statisticsSelector=null,this.competitorListBox=null,this.chart=null,this.topPanel=null,this.mainPanel=null,this.buttonsPanel=null,this.competitorListContainer=null,this.currentResizeTimeout=null},SplitsBrowser.Viewer.prototype.setClasses=function(a){this.classes=a,null!==this.classSelector&&this.classSelector.setClasses(this.classes)},SplitsBrowser.Viewer.prototype.buildUi=function(){var a=d3.select("body");this.topPanel=a.append("div");var b=this;this.classSelector=new SplitsBrowser.Controls.ClassSelector(this.topPanel.node()),null!==this.classes&&this.classSelector.setClasses(this.classes),this.topPanel.append("span").style("padding","0px 30px 0px 30px"),this.chartTypeSelector=new SplitsBrowser.Controls.ChartTypeSelector(this.topPanel.node()),this.chartType=this.chartTypeSelector.getChartType(),this.topPanel.append("span").style("padding","0px 30px 0px 30px"),this.comparisonSelector=new SplitsBrowser.Controls.ComparisonSelector(this.topPanel.node()),null!==this.classes&&this.comparisonSelector.setClasses(this.classes),this.comparisonFunction=this.comparisonSelector.getComparisonFunction(),this.statisticsSelector=new SplitsBrowser.Controls.StatisticsSelector(this.topPanel.node()),this.mainPanel=a.append("div"),this.competitorListContainer=this.mainPanel.append("div").attr("id",c),this.buttonsPanel=this.competitorListContainer.append("div"),this.buttonsPanel.append("button").text("All").style("width","50%").on("click",function(){b.selectAll()}),this.buttonsPanel.append("button").text("None").style("width","50%").on("click",function(){b.selectNone()}),this.buttonsPanel.append("br"),this.crossingRunnersButton=this.buttonsPanel.append("button").text("Crossing runners").style("width","100%").on("click",function(){b.selectCrossingRunners()}).attr("disabled","disabled").style("display","none"),this.competitorListBox=new SplitsBrowser.Controls.CompetitorListBox(this.competitorListContainer.node()),this.chart=new SplitsBrowser.Controls.Chart(this.mainPanel.node()),this.resultsTable=new SplitsBrowser.Controls.ResultsTable(a.node()),this.resultsTable.hide(),this.classSelector.registerChangeHandler(function(a){b.selectClasses(a)}),this.chartTypeSelector.registerChangeHandler(function(a){b.selectChartType(a)}),this.comparisonSelector.registerChangeHandler(function(a){b.selectComparison(a)}),$(window).resize(function(){b.handleWindowResize()})},SplitsBrowser.Viewer.prototype.selectAll=function(){this.selection.selectAll()},SplitsBrowser.Viewer.prototype.selectNone=function(){this.selection.selectNone()},SplitsBrowser.Viewer.prototype.selectCrossingRunners=function(){if(this.selection.selectCrossingRunners(this.ageClassSet.allCompetitors),this.selection.isSingleRunnerSelected()){var a=this.ageClassSet.allCompetitors[this.currentIndexes[0]].name;alert(a+" has no crossing runners.")}},SplitsBrowser.Viewer.prototype.handleWindowResize=function(){null!==this.currentResizeTimeout&&clearTimeout(this.currentResizeTimeout);var a=this;this.currentResizeTimeout=setTimeout(function(){a.postResizeHook()},b)},SplitsBrowser.Viewer.prototype.postResizeHook=function(){this.currentResizeTimeout=null,this.drawChart()},SplitsBrowser.Viewer.prototype.drawChart=function(){if(!this.chartType.isResultsTable){this.referenceCumTimes=this.comparisonFunction(this.ageClassSet),this.fastestCumTimes=this.ageClassSet.getFastestCumTimes(),this.chartData=this.ageClassSet.getChartData(this.referenceCumTimes,this.currentIndexes,this.chartType);var a=$(window).width(),b=$(window).height();this.currentVisibleStatistics=this.statisticsSelector.getVisibleStatistics(),this.competitorListBox.setCompetitorList(this.ageClassSet.allCompetitors,this.currentClasses.length>1);var c=$(this.topPanel.node()).height(),d=a-18-this.competitorListBox.width()-40,e=b-19-c;this.chart.setSize(d,e),this.redrawChart();var f=this;null!==this.selectionChangeHandler&&this.selection.deregisterChangeHandler(this.selectionChangeHandler),null!==this.statisticsChangeHandler&&this.statisticsSelector.deregisterChangeHandler(this.statisticsChangeHandler),this.selectionChangeHandler=function(a){f.currentIndexes=a,f.crossingRunnersButton.attr("disabled",f.selection.isSingleRunnerSelected()?null:"disabled"),f.redraw()},this.selection.registerChangeHandler(this.selectionChangeHandler),this.statisticsChangeHandler=function(a){f.currentVisibleStatistics=a,f.redraw()},this.statisticsSelector.registerChangeHandler(this.statisticsChangeHandler),$("body").height(b-19-c),$(this.competitorListContainer.node()).height(b-19-$(this.buttonsPanel.node()).height()-c)}},SplitsBrowser.Viewer.prototype.redrawChart=function(){this.chart.drawChart(this.chartData,this.ageClassSet,this.referenceCumTimes,this.fastestCumTimes,this.currentIndexes,this.currentVisibleStatistics,this.chartType.yAxisLabel,this.chartType.showCrossingRunnersButton)},SplitsBrowser.Viewer.prototype.redraw=function(){this.chartType.isResultsTable||(this.chartData=this.ageClassSet.getChartData(this.referenceCumTimes,this.currentIndexes,this.chartType),this.redrawChart())},SplitsBrowser.Viewer.prototype.selectClasses=function(a){null===this.selection?(this.selection=new SplitsBrowser.Model.CompetitorSelection(0),this.competitorListBox.setSelection(this.selection)):a.length>0&&this.currentClasses.length>0&&this.classes[a[0]]===this.currentClasses[0]||this.selection.selectNone(),this.currentIndexes=[],this.currentClasses=a.map(function(a){return this.classes[a]},this),this.ageClassSet=new SplitsBrowser.Model.AgeClassSet(this.currentClasses),this.comparisonSelector.setAgeClassSet(this.ageClassSet),this.resultsTable.setClass(this.currentClasses[0]),this.drawChart(),this.selection.migrate(this.previousCompetitorList,this.ageClassSet.allCompetitors),this.previousCompetitorList=this.ageClassSet.allCompetitors},SplitsBrowser.Viewer.prototype.selectComparison=function(a){this.comparisonFunction=a,this.drawChart()},SplitsBrowser.Viewer.prototype.selectChartType=function(a){this.chartType=a,a.isResultsTable?(this.mainPanel.style("display","none"),this.resultsTable.show()):(this.resultsTable.hide(),this.mainPanel.style("display","")),this.classSelector.setOtherClassesEnabled(!a.isResultsTable),this.comparisonSelector.setEnabled(!a.isResultsTable),this.statisticsSelector.setEnabled(!a.isResultsTable),this.crossingRunnersButton.style("display",a.showCrossingRunnersButton?"":"none"),this.drawChart()},SplitsBrowser.loadEvent=function(b){$.ajax({url:b,data:"",success:a,dataType:"text"})}}();