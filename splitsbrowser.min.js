/*!
 *  SplitsBrowser - Orienteering results analysis.
 *  
 *  Copyright (C) 2000-2013 Dave Ryder, Reinhard Balling, Andris Strazdins,
 *                          Ed Nash, Luke Woodward
 *
 *  This program is free software; you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation; either version 2 of the License, or
 *  (at your option) any later version.
 *
 *  This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License along
 *  with this program; if not, write to the Free Software Foundation, Inc.,
 *  51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
 */
var SplitsBrowser={Version:"3.0.0",Model:{},Input:{},Controls:{}};!function(){"use strict";function a(a){b||(c(a),b=!0)}var b=!1,c=function(a){window.alert(a)};SplitsBrowser.setMessageAlerter=function(a){c=a},SplitsBrowser.getMessage=function(b){return SplitsBrowser.hasOwnProperty("Messages")?SplitsBrowser.Messages.hasOwnProperty(b)?SplitsBrowser.Messages[b]:(a("Message not found for key '"+b+"'"),"?????"):(a("No messages found.  Has a language file been loaded?"),"?????")},SplitsBrowser.getMessageWithFormatting=function(a,b){var c=SplitsBrowser.getMessage(a);for(var d in b)if(b.hasOwnProperty(d)){var e=d.replace(/([.+*?|{}()^$\[\]\\])/g,"\\$1");c=c.replace(new RegExp(e,"g"),b[d])}return c}}(),function(){"use strict";SplitsBrowser.isTrue=function(a){return a},SplitsBrowser.isNotNull=function(a){return null!==a};var a=function(a){this.name="InvalidData",this.message=a};a.prototype.toString=function(){return this.name+": "+this.message},SplitsBrowser.throwInvalidData=function(b){throw new a(b)};var b=function(a){this.name="WrongFileFormat",this.message=a};b.prototype.toString=function(){return this.name+": "+this.message},SplitsBrowser.throwWrongFileFormat=function(a){throw new b(a)}}(),function(){"use strict";SplitsBrowser.NULL_TIME_PLACEHOLDER="-----",SplitsBrowser.formatTime=function(a){if(null===a)return SplitsBrowser.NULL_TIME_PLACEHOLDER;var b="";0>a&&(b="-",a=-a);var c=Math.floor(a/3600),d=Math.floor(a/60)%60,e=a%60;return c>0&&(b+=c.toString()+":"),10>d&&(b+="0"),b+=d+":",10>e&&(b+="0"),b+=e},SplitsBrowser.parseTime=function(a){return a.match(/^\d+:\d\d$/)?60*parseInt(a.substring(0,a.length-3),10)+parseInt(a.substring(a.length-2),10):a.match(/^\d+:\d\d:\d\d$/)?3600*parseInt(a.substring(0,a.length-6),10)+60*parseInt(a.substring(a.length-5,a.length-3),10)+parseInt(a.substring(a.length-2),10):null}}(),function(){"use strict";function a(a,b){return null===a||null===b?null:a+b}function b(a,b){return null===a||null===b?null:a-b}function c(b){if(!$.isArray(b))throw new TypeError("Split times must be an array - got "+typeof b+" instead");0===b.length&&f("Array of split times must not be empty");for(var c=[0],d=0;d<b.length;d+=1)c.push(a(c[d],b[d]));return c}function d(a){if(!$.isArray(a))throw new TypeError("Cumulative times must be an array - got "+typeof a+" instead");0===a.length?f("Array of cumulative times must not be empty"):0!==a[0]?f("Array of cumulative times must have zero as its first item"):1===a.length&&f("Array of cumulative times must contain more than just a single zero");for(var c=[],d=0;d+1<a.length;d+=1)c.push(b(a[d+1],a[d]));return c}var e="number",f=SplitsBrowser.throwInvalidData,g=SplitsBrowser.getMessage;SplitsBrowser.Model.compareCompetitors=function(a,b){return a.totalTime===b.totalTime?a.order-b.order:null===a.totalTime?null===b.totalTime?0:1:null===b.totalTime?-1:a.totalTime-b.totalTime};var h=function(a,b,c,d,g,h,i){typeof a!==e&&f("Competitor order must be a number, got "+typeof a+" '"+a+"' instead"),this.order=a,this.forename=b,this.surname=c,this.club=d,this.startTime=g,this.isNonCompetitive=!1,this.className=null,this.splitTimes=h,this.cumTimes=i,this.splitRanks=null,this.cumRanks=null,this.timeLosses=null,this.name=b+" "+c,this.totalTime=this.cumTimes.indexOf(null)>-1?null:this.cumTimes[this.cumTimes.length-1]};h.prototype.setNonCompetitive=function(){this.isNonCompetitive=!0},h.prototype.setClassName=function(a){this.className=a},h.fromSplitTimes=function(a,b,d,e,f,g){var i=c(g);return new h(a,b,d,e,f,g,i)},h.fromCumTimes=function(a,b,c,e,f,g){var i=d(g);return new h(a,b,c,e,f,i,g)},h.prototype.completed=function(){return null!==this.totalTime},h.prototype.getSuffix=function(){return this.completed()?this.isNonCompetitive?g("NonCompetitiveShort"):"":g("MispunchedShort")},h.prototype.getSplitTimeTo=function(a){return 0===a?0:this.splitTimes[a-1]},h.prototype.getCumulativeTimeTo=function(a){return this.cumTimes[a]},h.prototype.getSplitRankTo=function(a){return 0===a?null:this.splitRanks[a-1]},h.prototype.getCumulativeRankTo=function(a){return 0===a?null:this.cumRanks[a-1]},h.prototype.getTimeLossAt=function(a){return 0===a||null===this.timeLosses?null:this.timeLosses[a-1]},h.prototype.getAllCumulativeTimes=function(){return this.cumTimes},h.prototype.setSplitAndCumulativeRanks=function(a,b){this.splitRanks=a,this.cumRanks=b},h.prototype.getCumTimesAdjustedToReference=function(a){a.length!==this.cumTimes.length?f("Cannot adjust competitor times because the numbers of times are different ("+this.cumTimes.length+" and "+a.length+")"):a.indexOf(null)>-1&&f("Cannot adjust competitor times because a null value is in the reference data");var c=this.cumTimes.map(function(c,d){return b(c,a[d])});return c},h.prototype.getCumTimesAdjustedToReferenceWithStartAdded=function(b){var c=this.getCumTimesAdjustedToReference(b),d=this.startTime;return c.map(function(b){return a(b,d)})},h.prototype.getSplitPercentsBehindReferenceCumTimes=function(a){a.length!==this.cumTimes.length?f("Cannot determine percentages-behind because the numbers of times are different ("+this.cumTimes.length+" and "+a.length+")"):a.indexOf(null)>-1&&f("Cannot determine percentages-behind because a null value is in the reference data");var b=[0];return this.splitTimes.forEach(function(c,d){if(null===c)b.push(null);else{var e=a[d+1]-a[d];b.push(100*(c-e)/e)}}),b},h.prototype.determineTimeLosses=function(a){if(this.completed()){a.length!==this.splitTimes.length?f("Cannot determine time loss of competitor with "+this.splitTimes.length+" split times using "+a.length+" fastest splits"):a.indexOf(null)>=0&&f("Cannot determine time loss of competitor when there is a null value in the fastest splits");var b=this.splitTimes.map(function(b,c){return b/a[c]});b.sort(d3.ascending);var c;if(1===b.length%2)c=b[(b.length-1)/2];else{var d=b.length/2;c=(b[d-1]+b[d])/2}this.timeLosses=this.splitTimes.map(function(b,d){return Math.round(b-a[d]*c)})}},h.prototype.crosses=function(a){a.cumTimes.length!==this.cumTimes.length&&f("Two competitors with different numbers of controls cannot cross");for(var b=!1,c=!1,d=0;d<this.cumTimes.length;d+=1)if(null!==this.cumTimes[d]&&null!==a.cumTimes[d]){var e=this.startTime+this.cumTimes[d],g=a.startTime+a.cumTimes[d];g>e?b=!0:e>g&&(c=!0)}return b&&c},SplitsBrowser.Model.Competitor=h}(),function(){"use strict";var a=SplitsBrowser.throwInvalidData,b=function(a,b,c){this.name=a,this.numControls=b,this.competitors=c,this.course=null;var d=d3.range(1,b+2).map(function(a){var b=this.getFastestSplitTo(a);return null===b?null:b.split},this);this.competitors.forEach(function(a){a.setClassName(this.name),a.determineTimeLosses(d)},this)};b.prototype.isEmpty=function(){return 0===this.competitors.length},b.prototype.setCourse=function(a){this.course=a},b.prototype.getControlsWithNoSplits=function(){return d3.range(1,this.numControls+1).filter(function(a){return this.competitors.every(function(b){return null===b.getSplitTimeTo(a)})},this)},b.prototype.getFastestSplitTo=function(b){("number"!=typeof b||1>b||b>this.numControls+1)&&a("Cannot return splits to leg '"+b+"' in a course with "+this.numControls+" control(s)");var c=null,d=null;return this.competitors.forEach(function(a){var e=a.getSplitTimeTo(b);null!==e&&(null===c||c>e)&&(c=e,d=a)}),null===c?null:{split:c,name:d.name}},b.prototype.getCompetitorsAtControlInTimeRange=function(b,c,d){("number"!=typeof b||isNaN(b)||0>b||b>this.numControls+1)&&a("Control number must be a number between 0 and "+this.numControls+" inclusive");var e=[];return this.competitors.forEach(function(a){var f=a.getCumulativeTimeTo(b);if(null!==f&&null!==a.startTime){var g=f+a.startTime;g>=c&&d>=g&&e.push({name:a.name,time:g})}}),e},SplitsBrowser.Model.AgeClass=b}(),function(){"use strict";function a(a){0===a.length&&c("Cannot create an AgeClassSet from an empty set of competitors");var b=[],e=a[0].numControls;return a.forEach(function(a){a.numControls!==e&&c("Cannot merge age classes with "+e+" and "+a.numControls+" controls"),a.competitors.forEach(function(a){b.push(a)})}),b.sort(d),b}function b(a){var b=a.filter(function(a){return null!==a});b.sort(d3.ascending);var c=new d3.map;b.forEach(function(a,b){c.has(a)||c.set(a,b+1)});var d=a.map(function(a){return null===a?null:c.get(a)});return d}var c=SplitsBrowser.throwInvalidData,d=SplitsBrowser.Model.compareCompetitors,e=function(b){this.allCompetitors=a(b),this.ageClasses=b,this.numControls=b[0].numControls,this.computeRanks()};e.prototype.isEmpty=function(){return 0===this.allCompetitors.length},e.prototype.getCourse=function(){return this.ageClasses[0].course},e.prototype.getPrimaryClassName=function(){return this.ageClasses[0].name},e.prototype.getNumClasses=function(){return this.ageClasses.length},e.prototype.getWinnerCumTimes=function(){if(0===this.allCompetitors.length)return null;var a=this.allCompetitors[0];return a.completed()?a.cumTimes:null},e.prototype.getFastestCumTimes=function(){return this.getFastestCumTimesPlusPercentage(0)},e.prototype.getControlsWithNoSplits=function(){for(var a=this.ageClasses[0].getControlsWithNoSplits(),b=1;b<this.ageClasses.length&&a.length>0;b+=1)for(var c=this.ageClasses[b].getControlsWithNoSplits(),d=0;d<a.length;)c.indexOf(a[d])>=0?d+=1:a.splice(d,1);return a},e.prototype.getFastestCumTimesPlusPercentage=function(a){var b=1+a/100,c=new Array(this.numControls+1);c[0]=0;for(var d=1;d<=this.numControls+1;d+=1){for(var e=null,f=0;f<this.allCompetitors.length;f+=1){var g=this.allCompetitors[f].getSplitTimeTo(d);null!==g&&(null===e||e>g)&&(e=g)}if(null===e)return null;c[d]=c[d-1]+e*b}return c},e.prototype.computeRanks=function(){var a=[],c=[];this.allCompetitors.forEach(function(){a.push([]),c.push([])}),d3.range(1,this.numControls+2).forEach(function(c){var d=this.allCompetitors.map(function(a){return a.getSplitTimeTo(c)}),e=b(d);this.allCompetitors.forEach(function(b,c){a[c].push(e[c])})},this),d3.range(1,this.numControls+2).forEach(function(a){var d=this.allCompetitors.map(function(b,d){return a>1&&null===c[d][a-1-1]?null:b.getCumulativeTimeTo(a)}),e=b(d);this.allCompetitors.forEach(function(a,b){c[b].push(e[b])})},this),this.allCompetitors.forEach(function(b,d){b.setSplitAndCumulativeRanks(a[d],c[d])})},e.prototype.getFastestSplitsTo=function(a,b){if("number"!=typeof a||0>=a)c("The number of splits must be a positive integer");else{if(!("number"!=typeof b||0>=b||b>this.numControls+1)){var d=function(a,c){var d=a.getSplitTimeTo(b),e=c.getSplitTimeTo(b);return d===e?d3.ascending(a.totalTime,c.totalTime):d3.ascending(d,e)},e=this.allCompetitors.filter(function(a){return a.completed()});e.sort(d);for(var f=[],g=0;g<e.length&&a>g;g+=1)f.push({name:e[g].name,split:e[g].getSplitTimeTo(b)});return f}c("Control "+b+" out of range")}},e.prototype.getChartData=function(a,b,d){if(this.isEmpty())c("Cannot return chart data when there is no data");else{if("undefined"==typeof a)throw new TypeError("referenceCumTimes undefined or missing");if("undefined"==typeof b)throw new TypeError("currentIndexes undefined or missing");if("undefined"==typeof d)throw new TypeError("chartType undefined or missing")}var e,f,g=this.allCompetitors.map(function(b){return d.dataSelector(b,a)}),h=b.map(function(a){return g[a]}),i=a[a.length-1];if(0===b.length){var j=g[0];e=d3.min(j),f=d3.max(j)}else e=d3.min(h.map(function(a){return d3.min(a)})),f=d3.max(h.map(function(a){return d3.max(a)}));f===e&&(f=e+1);var k=d3.transpose(h),l=d.skipStart?a.slice(1):a,m=d3.zip(l,k),n=b.map(function(a){return this.allCompetitors[a].name},this);return{dataColumns:m.map(function(a){return{x:a[0],ys:a[1]}}),competitorNames:n,numControls:this.numControls,xExtent:[0,i],yExtent:[e,f]}},SplitsBrowser.Model.AgeClassSet=e}(),function(){"use strict";var a=SplitsBrowser.throwInvalidData,b=function(a,b,c,d,e){this.name=a,this.classes=b,this.length=c,this.climb=d,this.controls=e};b.START="__START__",b.FINISH="__FINISH__";var c=b.START,d=b.FINISH;b.prototype.getOtherClasses=function(b){var c=this.classes.filter(function(a){return a!==b});return c.length!==this.classes.length?c:(a("Course.getOtherClasses: given class is not in this course"),void 0)},b.prototype.getNumClasses=function(){return this.classes.length},b.prototype.hasControls=function(){return null!==this.controls},b.prototype.getControlCode=function(b){return 0===b?c:b>=1&&b<=this.controls.length?this.controls[b-1]:b===this.controls.length+1?d:(a("Cannot get control code of control "+b+" because it is out of range"),void 0)},b.prototype.usesLeg=function(a,b){return this.getLegNumber(a,b)>=0},b.prototype.getLegNumber=function(a,b){if(null===this.controls)return-1;if(null===a&&null===b)return 0===this.controls.length?1:-1;if(a===c)return this.controls.length>0&&this.controls[0]===b?1:-1;if(b===d)return this.controls.length>0&&this.controls[this.controls.length-1]===a?this.controls.length+1:-1;for(var e=1;e<this.controls.length;e+=1)if(this.controls[e-1]===a&&this.controls[e]===b)return e+1;return-1},b.prototype.getFastestSplitsForLeg=function(b,e){null===this.legs&&a("Cannot determine fastest splits for a leg because leg information is not available");var f=this.getLegNumber(b,e);if(0>f){var g=(b===c?"start":b)+" to "+(e===d?"end":e);a("Leg from "+g+" not found in course "+this.name)}var h=f,i=[];return this.classes.forEach(function(a){var b=a.getFastestSplitTo(h);null!==b&&i.push({name:b.name,className:a.name,split:b.split})}),i},b.prototype.getCompetitorsAtControlInTimeRange=function(a,b,e){if(null===this.controls)return[];if(a===c)return this.getCompetitorsAtControlNumInTimeRange(0,b,e);if(a===d)return this.getCompetitorsAtControlNumInTimeRange(this.controls.length+1,b,e);var f=this.controls.indexOf(a);return f>=0?this.getCompetitorsAtControlNumInTimeRange(f+1,b,e):[]},b.prototype.getCompetitorsAtControlNumInTimeRange=function(a,b,c){var d=[];return this.classes.forEach(function(e){e.getCompetitorsAtControlInTimeRange(a,b,c).forEach(function(a){d.push({name:a.name,time:a.time,className:e.name})})}),d},b.prototype.hasControl=function(a){return null!==this.controls&&this.controls.indexOf(a)>-1},b.prototype.getNextControls=function(b){if(null===this.controls)a("Course has no controls");else if(b===d)a("Cannot fetch next control after the finish");else{if(b===c)return[this.controls[0]];for(var e=-1,f=[];;){var g=this.controls.indexOf(b,e+1);if(-1===g)break;g===this.controls.length-1?f.push(d):f.push(this.controls[g+1]),e=g}if(0!==f.length)return f;a("Control '"+b+"' not found on course "+this.name)}},SplitsBrowser.Model.Course=b}(),function(){"use strict";var a=SplitsBrowser.Model.Course,b=function(a,b){this.classes=a,this.courses=b};b.prototype.getFastestSplitsForLeg=function(a,b){var c=[];return this.courses.forEach(function(d){d.usesLeg(a,b)&&(c=c.concat(d.getFastestSplitsForLeg(a,b)))}),c.sort(function(a,b){return d3.ascending(a.split,b.split)}),c},b.prototype.getCompetitorsAtControlInTimeRange=function(a,b,c){var d=[];return this.courses.forEach(function(e){e.getCompetitorsAtControlInTimeRange(a,b,c).forEach(function(a){d.push(a)})}),d.sort(function(a,b){return d3.ascending(a.time,b.time)}),d},b.prototype.getNextControlsAfter=function(b){var c=this.courses;return b!==a.START&&(c=c.filter(function(a){return a.hasControl(b)})),c.map(function(a){return{course:a,nextControls:a.getNextControls(b)}})},SplitsBrowser.Model.Event=b}(),function(){function a(a){return null===a?null:a/60}SplitsBrowser.Model.ChartTypes={SplitsGraph:{nameKey:"SplitsGraphChartType",dataSelector:function(b,c){return b.getCumTimesAdjustedToReference(c).map(a)},skipStart:!1,yAxisLabelKey:"SplitsGraphYAxisLabel",isRaceGraph:!1,isResultsTable:!1,minViewableControl:1},RaceGraph:{nameKey:"RaceGraphChartType",dataSelector:function(b,c){return b.getCumTimesAdjustedToReferenceWithStartAdded(c).map(a)},skipStart:!1,yAxisLabelKey:"RaceGraphYAxisLabel",isRaceGraph:!0,isResultsTable:!1,minViewableControl:0},PositionAfterLeg:{nameKey:"PositionAfterLegChartType",dataSelector:function(a){return a.cumRanks},skipStart:!0,yAxisLabelKey:"PositionYAxisLabel",isRaceGraph:!1,isResultsTable:!1,minViewableControl:1},SplitPosition:{nameKey:"SplitPositionChartType",dataSelector:function(a){return a.splitRanks},skipStart:!0,yAxisLabelKey:"PositionYAxisLabel",isRaceGraph:!1,isResultsTable:!1,minViewableControl:1},PercentBehind:{nameKey:"PercentBehindChartType",dataSelector:function(a,b){return a.getSplitPercentsBehindReferenceCumTimes(b)},skipStart:!1,yAxisLabelKey:"PercentBehindYAxisLabel",isRaceGraph:!1,isResultsTable:!1,minViewableControl:1},ResultsTable:{nameKey:"ResultsTableChartType",dataSelector:null,skipStart:!1,yAxisLabelKey:null,isRaceGraph:!1,isResultsTable:!0,minViewableControl:1}}}(),function(){"use strict";var a="number",b=SplitsBrowser.throwInvalidData,c=function(c){typeof c!==a?b("Competitor count must be a number"):0>c&&b("Competitor count must be a non-negative number"),this.count=c,this.currentIndexes=[],this.changeHandlers=[]};c.prototype.isSelected=function(a){return this.currentIndexes.indexOf(a)>-1},c.prototype.isSingleRunnerSelected=function(){return 1===this.currentIndexes.length},c.prototype.selectCrossingRunners=function(a){if(this.isSingleRunnerSelected()){var b=a[this.currentIndexes[0]];a.forEach(function(a,c){a.crosses(b)&&this.currentIndexes.push(c)},this),this.currentIndexes.sort(d3.ascending),this.fireChangeHandlers()}},c.prototype.fireChangeHandlers=function(){this.changeHandlers.forEach(function(a){a(this.currentIndexes.slice(0))},this)},c.prototype.selectAll=function(){this.currentIndexes=d3.range(this.count),this.fireChangeHandlers()},c.prototype.selectNone=function(){this.currentIndexes=[],this.fireChangeHandlers()},c.prototype.registerChangeHandler=function(a){-1===this.changeHandlers.indexOf(a)&&this.changeHandlers.push(a)},c.prototype.deregisterChangeHandler=function(a){var b=this.changeHandlers.indexOf(a);b>-1&&this.changeHandlers.splice(b,1)},c.prototype.toggle=function(c){if(typeof c===a)if(c>=0&&c<this.count){var d=this.currentIndexes.indexOf(c);-1===d?(this.currentIndexes.push(c),this.currentIndexes.sort(d3.ascending)):this.currentIndexes.splice(d,1),this.fireChangeHandlers()}else b("Index '"+c+"' is out of range");else b("Index is not a number")},c.prototype.migrate=function(a,c){$.isArray(a)?$.isArray(c)?a.length!==this.count?b("CompetitorSelection.migrate: oldCompetitors list must have the same length as the current count"):0===c.length&&b("CompetitorSelection.migrate: newCompetitors list must not be empty"):b("CompetitorSelection.migrate: newCompetitors not an array"):b("CompetitorSelection.migrate: oldCompetitors not an array");var d=this.currentIndexes.map(function(b){return a[b]});this.count=c.length,this.currentIndexes=[],c.forEach(function(a,b){d.indexOf(a)>=0&&this.currentIndexes.push(b)},this),this.fireChangeHandlers()},SplitsBrowser.Model.CompetitorSelection=c}(),function(){"use strict";function a(a,b,c){var d=b.split(",");if(d.length===c+5){var f=d.shift(),i=d.shift(),j=d.shift(),k=60*g(d.shift()),l=d.map(g);return l.indexOf(0)>=0&&e("Zero split times are not permitted - found one or more zero splits for competitor '"+f+" "+i+"'"),h.fromSplitTimes(a+1,f,i,j,k,l)}e("Expected "+(c+5)+" items in row for competitor in class with "+c+" controls, got "+d.length+" instead.")}function b(b){var c=b.split(/\r?\n/).filter(d);0===c.length&&e("parseAgeClass got an empty list of lines");var g=c.shift().split(",");if(2===g.length){var h=g.shift(),k=g.shift(),l=parseInt(k,10);if(isNaN(l))e("Could not read control count: '"+k+"'");else{if(!(0>l)){var m=c.map(function(b,c){return a(c,b,l)});return m.sort(i),new j(h,l,m)}e("Expected a positive control count, got "+l+" instead")}}else f("Expected first line to have two parts (class name and number of controls), got "+g.length+" part(s) instead")}function c(a){var c=a.split(/\r?\n\r?\n/).map($.trim).filter(d),f=c.map(b);f=f.filter(function(a){return!a.isEmpty()}),0===f.length&&e("No competitor data was found");for(var g=f.map(function(a){return new k(a.name,[a],null,null,null)}),h=0;h<f.length;h+=1)f[h].setCourse(g[h]);return new l(f,g)}var d=SplitsBrowser.isTrue,e=SplitsBrowser.throwInvalidData,f=SplitsBrowser.throwWrongFileFormat,g=SplitsBrowser.parseTime,h=SplitsBrowser.Model.Competitor,i=SplitsBrowser.Model.compareCompetitors,j=SplitsBrowser.Model.AgeClass,k=SplitsBrowser.Model.Course,l=SplitsBrowser.Model.Event;SplitsBrowser.Input.CSV={parseEventData:c}}(),function(){"use strict";function a(a,c){null!==c&&a>=c&&b("Cumulative times must be strictly ascending: read "+d(a)+" and "+d(c)+" in that order")}var b=SplitsBrowser.throwInvalidData,c=SplitsBrowser.throwWrongFileFormat,d=SplitsBrowser.formatTime,e=SplitsBrowser.parseTime,f=SplitsBrowser.Model.Competitor,g=SplitsBrowser.Model.AgeClass,h=SplitsBrowser.Model.Course,i=SplitsBrowser.Model.Event,j={SURNAME:3,FORENAME:4,START:9,TIME:11,CLUB:15,AGE_CLASS:18,COURSE:39,DISTANCE:40,CLIMB:41,CONTROL_COUNT:42,PLACING:43},k=46;SplitsBrowser.Input.SI={},SplitsBrowser.Input.SI.Reader=function(a){this.data=a,this.ageClasses=d3.map(),this.courseDetails=d3.map(),this.classCoursePairs=[],this.anyCompetitors=!1};var l=SplitsBrowser.Input.SI.Reader;l.prototype.checkHeader=function(){this.lines.length<=1&&c("No data found to read");var a=this.lines[0].split(";");a.length<=1&&c("Data appears not to be in the SI CSV format")},l.prototype.getNumControls=function(a){var b=a[j.AGE_CLASS];return this.ageClasses.has(b)?this.ageClasses.get(b).numControls:parseInt(a[j.CONTROL_COUNT],10)},l.prototype.readCumulativeTimes=function(c,d,f){c.length<=k+1+2*(f-1)&&b("Line "+d+" reports "+f+" controls but there aren't enough data values in the row for this many controls");for(var g=[0],h=0,i=0;f>i;i+=1){var l=c[k+1+2*i],m=e(l);a(h,m),g.push(m),null!==m&&(h=m)}var n=e(c[j.TIME]);return a(h,n),g.push(n),g},l.prototype.createAgeClassIfNecessary=function(a,b){var c=a[j.AGE_CLASS];this.ageClasses.has(c)||this.ageClasses.set(c,{numControls:b,competitors:[]})},l.prototype.createCourseIfNecessary=function(a,b){var c=a[j.COURSE];if(!this.courseDetails.has(c)){var d=d3.range(0,b).map(function(b){return a[k+2*b]});this.courseDetails.set(c,{length:parseFloat(a[j.DISTANCE])||null,climb:parseInt(a[j.CLIMB],10)||null,controls:d})}},l.prototype.createClassCoursePairIfNecessary=function(a){var b=a[j.AGE_CLASS],c=a[j.COURSE];this.classCoursePairs.some(function(a){return a[0]===b&&a[1]===c})||this.classCoursePairs.push([b,c])},l.prototype.addCompetitor=function(a,b){var c=a[j.AGE_CLASS],d=a[j.FORENAME],g=a[j.SURNAME],h=a[j.CLUB],i=e(a[j.START]),k=a[j.PLACING],l=isNaN(parseInt(k,10));l&&g.substring(g.length-k.length)===k&&(g=$.trim(g.substring(0,g.length-k.length)));var m=this.ageClasses.get(c).competitors.length+1,n=f.fromCumTimes(m,d,g,h,i,b);l&&n.completed()&&n.setNonCompetitive(),this.ageClasses.get(c).competitors.push(n)},l.prototype.readLine=function(a,c){if(""!==$.trim(a)){var d=a.split(";");d.length<k&&b("Too few items on line "+c+" of the input file: expected at least "+k+", got "+d.length);var e=this.getNumControls(d),f=this.readCumulativeTimes(d,c,e);f.some(function(a){return null!==a&&0!==a})&&(this.anyCompetitors=!0,this.createAgeClassIfNecessary(d,e),this.createCourseIfNecessary(d,e),this.createClassCoursePairIfNecessary(d),this.addCompetitor(d,f))}},l.prototype.getMapsBetweenClassesAndCourses=function(){var a=d3.map(),b=d3.map();return this.classCoursePairs.forEach(function(c){var d=c[0],e=c[1];a.has(d)?a.get(d).push(e):a.set(d,[e]),b.has(e)?b.get(e).push(d):b.set(e,[d])}),{classesToCourses:a,coursesToClasses:b}},l.prototype.createAgeClasses=function(){var a=this.ageClasses.keys();return a.sort(),a.map(function(a){var b=this.ageClasses.get(a);return new g(a,b.numControls,b.competitors)},this)},l.prototype.createCourseFromLinkedClassesAndCourses=function(a,b,c,d){for(var e,f,g=[a],i=[],j=[],k=[];g.length>0||i.length>0;){for(;g.length>0;){e=g.shift();for(var l=b.coursesToClasses.get(e),m=0;m<l.length;m+=1)f=l[m],i.indexOf(f)<0&&k.indexOf(f)<0&&i.push(f);j.push(e)}for(;i.length>0;){f=i.shift();for(var n=b.classesToCourses.get(f),o=0;o<n.length;o+=1)e=n[o],g.indexOf(e)<0&&j.indexOf(e)<0&&g.push(e);k.push(f)}}j.forEach(function(a){c.add(a)});var p=k.map(function(a){return d.get(a)}),q=this.courseDetails.get(a),r=new h(a,p,q.length,q.climb,q.controls);return p.forEach(function(a){a.setCourse(r)}),r},l.prototype.determineCourses=function(a){var b=this.getMapsBetweenClassesAndCourses(),c=d3.set(),d=d3.map();a.forEach(function(a){d.set(a.name,a)});var e=[];return b.coursesToClasses.keys().forEach(function(a){if(!c.has(a)){var f=this.createCourseFromLinkedClassesAndCourses(a,b,c,d);e.push(f)}},this),e},l.prototype.parseEventData=function(){this.lines=this.data.split(/\r?\n/),this.checkHeader(),this.lines.shift(),this.lines.forEach(function(a,b){this.readLine(a,b+1)},this),this.anyCompetitors||b("No competitors' data were found");var a=this.createAgeClasses(),c=this.determineCourses(a);return new i(a,c)},SplitsBrowser.Input.SI.parseEventData=function(a){var b=new l(a);return b.parseEventData()}}(),function(){"use strict";var a=[SplitsBrowser.Input.CSV.parseEventData,SplitsBrowser.Input.SI.parseEventData];SplitsBrowser.Input.parseEventData=function(b){for(var c=0;c<a.length;c+=1){var d=a[c];try{return d(b)}catch(e){if("WrongFileFormat"!==e.name)throw e}}return null}}(),function(){"use strict";var a="competitorList",b=function(b){this.parent=b,this.handler=null,this.competitorSelection=null,this.isEnabled=!0,this.listDiv=d3.select(b).append("div").attr("id",a)};b.prototype.setEnabled=function(a){this.isEnabled=a,this.listDiv.selectAll("div.competitor").classed("disabled",!a)},b.prototype.width=function(){return $(this.listDiv.node()).width()},b.prototype.selectionChanged=function(){var a=this;this.listDiv.selectAll("div.competitor").data(d3.range(this.competitorSelection.count)).classed("selected",function(b,c){return a.competitorSelection.isSelected(c)})},b.prototype.toggleCompetitor=function(a){this.isEnabled&&this.competitorSelection.toggle(a)},b.prototype.setCompetitorList=function(a,b){$("div.competitor").off("click");var c=this.listDiv.selectAll("div.competitor").data(a);c.enter().append("div").classed("competitor",!0),c.selectAll("span").remove(),b&&c.append("span").classed("competitorClassLabel",!0).text(function(a){return a.className}),c.append("span").classed("nonfinisher",function(a){return!a.completed()}).text(function(a){return a.completed()?a.name:"* "+a.name}),c.exit().remove();var d=this;$("div.competitor").each(function(a,b){$(b).on("click",function(){d.toggleCompetitor(a)})})},b.prototype.setSelection=function(a){null!==this.competitorSelection&&this.competitorSelection.deregisterChangeHandler(this.handler);var b=this;this.competitorSelection=a,this.handler=function(a){b.selectionChanged(a)},this.competitorSelection.registerChangeHandler(this.handler),this.selectionChanged(d3.range(a.count))},SplitsBrowser.Controls.CompetitorListBox=b}(),function(){"use strict";var a=SplitsBrowser.throwInvalidData,b=SplitsBrowser.getMessage,c=function(a){this.changeHandlers=[],this.otherClassesEnabled=!0;var c=d3.select(a).append("span");c.text(b("ClassSelectorLabel"));var d=this;this.dropDown=c.append("select").node(),$(this.dropDown).bind("change",function(){d.updateOtherClasses(),d.onSelectionChanged()}),this.otherClassesCombiningLabel=c.append("span").classed("otherClassCombining",!0).style("display","none").text(b("AdditionalClassSelectorLabel")),this.otherClassesSelector=c.append("div").classed("otherClassSelector",!0).style("display","none"),this.otherClassesSpan=this.otherClassesSelector.append("span"),this.otherClassesList=d3.select(a).append("div").classed("otherClassList",!0).style("position","absolute").style("display","none"),this.otherClassesSelector.on("click",function(){d.showHideClassSelector()}),this.setClasses([]),this.selectedOtherClassIndexes=d3.set(),$(document).click(function(a){var b=d.otherClassesList.node();if("none"!==b.style.display){var c=$("div.otherClassList,div.otherClassSelector");c.is(a.target)||0!==c.has(a.target).length||(b.style.display="none")}}),$(document).keydown(function(a){27===a.which&&d.otherClassesList.style("display","none")})};c.prototype.setOtherClassesEnabled=function(a){this.otherClassesCombiningLabel.classed("disabled",!a),this.otherClassesSelector.classed("disabled",!a),this.otherClassesEnabled=a},c.prototype.setClasses=function(c){if($.isArray(c)){this.classes=c;var d;0===c.length?(this.dropDown.disabled=!0,d=[b("NoClassesLoadedPlaceholder")]):(this.dropDown.disabled=!1,d=c.map(function(a){return a.name}));var e=d3.select(this.dropDown).selectAll("option").data(d);e.enter().append("option"),e.attr("value",function(a,b){return b.toString()}).text(function(a){return a}),e.exit().remove(),this.updateOtherClasses()}else a("ClassSelector.setClasses: classes is not an array")},c.prototype.registerChangeHandler=function(a){-1===this.changeHandlers.indexOf(a)&&this.changeHandlers.push(a)},c.prototype.onSelectionChanged=function(){var a=[this.dropDown.selectedIndex];this.selectedOtherClassIndexes.forEach(function(b){a.push(parseInt(b,10))}),this.changeHandlers.forEach(function(b){b(a)})},c.prototype.updateOtherClassText=function(){var a=this.selectedOtherClassIndexes.values();a.sort(d3.ascending);var c;c=0===a.length?b("NoAdditionalClassesSelectedPlaceholder"):a.map(function(a){return this.classes[a].name},this).join(", "),this.otherClassesSpan.text(c)},c.prototype.updateOtherClasses=function(){this.otherClassesList.style("display","none"),this.selectedOtherClassIndexes=d3.set(),this.updateOtherClassText(),$("div.otherClassItem").off("click");var a,b=this;if(this.classes.length>0){var c=this.classes[this.dropDown.selectedIndex];a=c.course.getOtherClasses(c)}else a=[];var d=a.map(function(a){return this.classes.indexOf(a)},this),e=this.otherClassesList.selectAll("div").data(d);e.enter().append("div").classed("otherClassItem",!0),e.attr("id",function(a){return"ageClassIdx_"+a}).classed("selected",!1).text(function(a){return b.classes[a].name}),e.exit().remove(),d.length>0?(this.otherClassesSelector.style("display","inline-block"),this.otherClassesCombiningLabel.style("display",null)):(this.otherClassesSelector.style("display","none"),this.otherClassesCombiningLabel.style("display","none"));var f=$(this.otherClassesSelector.node()).offset(),g=$(this.otherClassesSelector.node()).outerHeight();this.otherClassesList.style("left",f.left+"px").style("top",f.top+g+"px"),$("div.otherClassItem").each(function(a,c){$(c).on("click",function(){b.toggleOtherClass(d[a])})})},c.prototype.showHideClassSelector=function(){this.otherClassesEnabled&&this.otherClassesList.style("display","none"===this.otherClassesList.style("display")?null:"none")},c.prototype.toggleOtherClass=function(a){this.selectedOtherClassIndexes.has(a)?this.selectedOtherClassIndexes.remove(a):this.selectedOtherClassIndexes.add(a),d3.select("div#ageClassIdx_"+a).classed("selected",this.selectedOtherClassIndexes.has(a)),this.updateOtherClassText(),this.onSelectionChanged()},SplitsBrowser.Controls.ClassSelector=c}(),function(){"use strict";var a=SplitsBrowser.getMessage,b=SplitsBrowser.getMessageWithFormatting,c=[{nameKey:"CompareWithWinner",selector:function(a){return a.getWinnerCumTimes()},requiresWinner:!0,percentage:""},{nameKey:"CompareWithFastestTime",selector:function(a){return a.getFastestCumTimes()},requiresWinner:!1,percentage:""}],d=[5,25,50,100];d.forEach(function(a){c.push({nameKey:"CompareWithFastestTimePlusPercentage",selector:function(b){return b.getFastestCumTimesPlusPercentage(a)},requiresWinner:!1,percentage:a})}),c.push({nameKey:"CompareWithAnyRunner",selector:null,requiresWinner:!0,percentage:""});var e=1,f="comparisonSelector",g="runnerSelector",h=function(d,h){this.changeHandlers=[],this.classes=null,this.currentRunnerIndex=null,this.previousCompetitorList=null,this.parent=d,this.alerter=h,this.hasWinner=!1,this.previousSelectedIndex=-1;var i=d3.select(d).append("span");i.append("span").classed("comparisonSelectorLabel",!0).text(a("ComparisonSelectorLabel"));
var j=this;this.dropDown=i.append("select").attr("id",f).node(),$(this.dropDown).bind("change",function(){j.onSelectionChanged()});var k=d3.select(this.dropDown).selectAll("option").data(c);k.enter().append("option"),k.attr("value",function(a,b){return b.toString()}).text(function(a){return b(a.nameKey,{$$PERCENT$$:a.percentage})}),k.exit().remove(),this.runnerSpan=d3.select(d).append("span").style("display","none").style("padding-left","20px"),this.runnerSpan.append("span").classed("comparisonSelectorLabel",!0).text(a("CompareWithAnyRunnerLabel")),this.runnerDropDown=this.runnerSpan.append("select").attr("id",g).node(),$(this.runnerDropDown).bind("change",function(){j.onSelectionChanged()}),this.dropDown.selectedIndex=e,this.previousSelectedIndex=e};h.prototype.registerChangeHandler=function(a){-1===this.changeHandlers.indexOf(a)&&this.changeHandlers.push(a)},h.prototype.isAnyRunnerSelected=function(){return this.dropDown.selectedIndex===c.length-1},h.prototype.setAgeClassSet=function(a){this.ageClassSet=a,this.setRunners()},h.prototype.setRunners=function(){var a=this.ageClassSet.allCompetitors,b=d3.range(a.length).filter(function(b){return a[b].completed()}),c=a.filter(function(a){return a.completed()});this.hasWinner=c.length>0;var d=d3.select(this.runnerDropDown).selectAll("option").data(c);if(d.enter().append("option"),d.attr("value",function(a,c){return b[c].toString()}).text(function(a){return a.name}),d.exit().remove(),null===this.previousCompetitorList)this.currentRunnerIndex=0;else{var e=this.previousCompetitorList[this.currentRunnerIndex],f=this.ageClassSet.allCompetitors.indexOf(e);this.currentRunnerIndex=Math.max(f,0)}this.runnerDropDown.selectedIndex=this.currentRunnerIndex,this.previousCompetitorList=this.ageClassSet.allCompetitors},h.prototype.setEnabled=function(a){d3.select(this.parent).selectAll("span.comparisonSelectorLabel").classed("disabled",!a),this.dropDown.disabled=!a,this.runnerDropDown.disabled=!a},h.prototype.getComparisonFunction=function(){if(this.isAnyRunnerSelected()){var a=this;return function(b){return b.allCompetitors[a.currentRunnerIndex].getAllCumulativeTimes()}}return c[this.dropDown.selectedIndex].selector},h.prototype.onSelectionChanged=function(){var d=Math.max(this.runnerDropDown.selectedIndex,0),e=c[this.dropDown.selectedIndex];!this.hasWinner&&e.requiresWinner?(this.alerter(b("CannotCompareAsNoWinner",{$$OPTION$$:a(e.nameKey)})),this.dropDown.selectedIndex=this.previousSelectedIndex):(this.runnerSpan.style("display",this.isAnyRunnerSelected()?null:"none"),this.currentRunnerIndex=0===this.runnerDropDown.options.length?0:parseInt(this.runnerDropDown.options[d].value,10),this.previousSelectedIndex=this.dropDown.selectedIndex,this.changeHandlers.forEach(function(a){a(this.getComparisonFunction())},this))},SplitsBrowser.Controls.ComparisonSelector=h}(),function(){"use strict";var a=SplitsBrowser.getMessage,b="statisticSelector",c="statisticCheckbox",d=["StatisticsTotalTimeKey","StatisticsSplitTimeKey","StatisticsBehindFastestKey","StatisticsTimeLossKey"],e=function(e){this.span=d3.select(e).append("span").attr("id",b);var f=this.span.selectAll("span").data(d).enter().append("span");f.append("input").attr("type","checkbox").attr("id",function(a,b){return c+b}),f.append("label").attr("for",function(a,b){return c+b}).classed("statisticsSelectorLabel",!0).text(function(b){return a(b)});var g=this;$("input",this.span.node()).bind("change",function(){return g.onCheckboxChanged()}),this.handlers=[]};e.prototype.setEnabled=function(a){this.span.selectAll("label.statisticsSelectorLabel").classed("disabled",!a),this.span.selectAll("input").attr("disabled",a?null:"disabled")},e.prototype.registerChangeHandler=function(a){-1===this.handlers.indexOf(a)&&this.handlers.push(a)},e.prototype.deregisterChangeHandler=function(a){var b=this.handlers.indexOf(a);-1!==b&&this.handlers.splice(b,1)},e.prototype.getVisibleStatistics=function(){return this.span.selectAll("input")[0].map(function(a){return a.checked})},e.prototype.onCheckboxChanged=function(){var a=this.getVisibleStatistics();this.handlers.forEach(function(b){b(a)})},SplitsBrowser.Controls.StatisticsSelector=e}(),function(){"use strict";var a=SplitsBrowser.getMessage,b=function(b,c){this.changeHandlers=[],this.chartTypes=c;var d=d3.select(b).append("span");d.text(a("ChartTypeSelectorLabel"));var e=this;this.dropDown=d.append("select").node(),$(this.dropDown).bind("change",function(){e.onSelectionChanged()});var f=d3.select(this.dropDown).selectAll("option").data(c);f.enter().append("option"),f.attr("value",function(a,b){return b.toString()}).text(function(b){return a(b.nameKey)}),f.exit().remove()};b.prototype.registerChangeHandler=function(a){-1===this.changeHandlers.indexOf(a)&&this.changeHandlers.push(a)},b.prototype.getChartType=function(){return this.chartTypes[Math.max(this.dropDown.selectedIndex,0)]},b.prototype.onSelectionChanged=function(){this.changeHandlers.forEach(function(a){a(this.chartTypes[this.dropDown.selectedIndex])},this)},SplitsBrowser.Controls.ChartTypeSelector=b}(),function(){"use strict";function a(a,b){if(a===b)return 0;if(""===a||""===b||a[0]!==b[0])return b>a?-1:1;var c=/^[^0-9]+/.exec(a);if(null!==c&&c.length>0){var d=c[0];if(0<d.length&&d.length<a.length&&b.substring(0,d.length)===d){var e=parseInt(a.substring(d.length),10),f=parseInt(b.substring(d.length),10);if(!isNaN(e)&&!isNaN(f))return e-f}}return b>a?-1:1}function b(a){return a.map(function(a){var b=a.nextControls.slice(0);return b[b.length-1]===h.FINISH&&(b[b.length-1]=f("FinishName")),{course:a.course,nextControls:b.join(", ")}})}var c=10,d=240,e=SplitsBrowser.formatTime,f=SplitsBrowser.getMessage,g=SplitsBrowser.getMessageWithFormatting,h=SplitsBrowser.Model.Course,i={};i.getFastestSplitsPopupData=function(a,b){var d=a.getFastestSplitsTo(c,b);return d=d.map(function(a){return{time:a.split,name:a.name,highlight:!1}}),{title:f("SelectedClassesPopupHeader"),data:d,placeholder:f("SelectedClassesPopupPlaceholder")}},i.getFastestSplitsForLegPopupData=function(a,b,c){var d=a.getCourse(),e=d.getControlCode(c-1),i=d.getControlCode(c),j=e===h.START?f("StartName"):e,k=i===h.FINISH?f("FinishName"):i,l=g("FastestLegTimePopupHeader",{$$START$$:j,$$END$$:k}),m=a.getPrimaryClassName(),n=b.getFastestSplitsForLeg(e,i).map(function(a){return{name:a.name,className:a.className,time:a.split,highlight:a.className===m}});return{title:l,data:n,placeholder:null}},i.getCompetitorsVisitingCurrentControlPopupData=function(a,b,c,i){var j,k=a.getCourse().getControlCode(c),l=i-d/2,m=i+d/2,n=b.getCompetitorsAtControlInTimeRange(k,l,m),o=a.getPrimaryClassName(),p=n.map(function(a){return{name:a.name,className:a.className,time:a.time,highlight:a.className===o}});j=k===h.START?f("StartName"):k===h.FINISH?f("FinishName"):g("ControlName",{$$CODE$$:k});var q=g("NearbyCompetitorsPopupHeader",{$$START$$:e(l),$$END$$:e(m),$$CONTROL$$:j});return{title:q,data:p,placeholder:f("NoNearbyCompetitors")}},i.getNextControlData=function(c,d,e){var i=Math.min(e,c.controls.length),j=c.getControlCode(i),k=d.getNextControlsAfter(j);k.sort(function(b,c){return a(b.course.name,c.course.name)});var l=j===h.START?f("StartName"):g("ControlName",{$$CODE$$:j});return{thisControl:l,nextControls:b(k)}},SplitsBrowser.Model.ChartPopupData=i}(),function(){"use strict";var a=SplitsBrowser.formatTime,b=function(a,b){this.shown=!1,this.mouseIn=!1,this.popupDiv=d3.select(a).append("div"),this.popupDiv.classed("chartPopup",!0).style("display","none").style("position","absolute"),this.dataHeader=this.popupDiv.append("div").classed("chartPopupHeader",!0).append("span");var c=this.popupDiv.append("div").classed("chartPopupTableContainer",!0);this.dataTable=c.append("table"),this.popupDiv.selectAll(".nextControls").style("display","none");for(var d in b)b.hasOwnProperty(d)&&$(this.popupDiv.node()).on(d,b[d]);var e=this;$(this.popupDiv.node()).mouseenter(function(){e.mouseIn=!0}),$(this.popupDiv.node()).mouseleave(function(){e.mouseIn=!1})};b.prototype.isShown=function(){return this.shown},b.prototype.isMouseIn=function(){return this.mouseIn},b.prototype.setData=function(b,c){this.dataHeader.text(b.title);var d=this.dataTable.selectAll("tr").data(b.data);d.enter().append("tr"),d.classed("highlighted",function(a){return a.highlight}),d.selectAll("td").remove(),d.append("td").text(function(b){return a(b.time)}),c&&d.append("td").text(function(a){return a.className}),d.append("td").text(function(a){return a.name}),d.exit().remove(),0===b.data.length&&null!==b.placeholder&&this.dataTable.append("tr").append("td").text(b.placeholder)},b.prototype.setNextControlData=function(a){this.dataHeader.text(a.thisControl);var b=this.dataTable.selectAll("tr").data(a.nextControls);b.enter().append("tr"),b.selectAll("td").remove(),b.classed("highlighted",!1),b.append("td").text(function(a){return a.course.name}),b.append("td").text("-->"),b.append("td").text(function(a){return a.nextControls}),b.exit().remove()},b.prototype.setLocation=function(a){this.popupDiv.style("left",a.x+"px").style("top",a.y+"px")},b.prototype.show=function(a){this.popupDiv.style("display",null),this.shown=!0,this.setLocation(a)},b.prototype.hide=function(){this.popupDiv.style("display","none"),this.shown=!1},b.prototype.height=function(){return $(this.popupDiv.node()).height()},SplitsBrowser.Controls.ChartPopup=b}(),function(){"use strict";function a(a,b){return k+n(a)+" ("+(null===b?"-":b)+")"}function b(a,b){return""===b?a:a+" ("+b+")"}var c="sb-text-size-element",d="chart",e=10,f={top:18,right:0,bottom:18,left:53},g=10,h=10,i=1,j=3,k="    ",l=["#FF0000","#4444FF","#00FF00","#000000","#CC0066","#000099","#FFCC00","#884400","#9900FF","#CCCC00","#888800","#CC6699","#00DD00","#3399FF","#BB00BB","#00DDDD","#FF00FF","#0088BB","#888888","#FF99FF","#55BB33"],m=SplitsBrowser.isNotNull,n=SplitsBrowser.formatTime,o=SplitsBrowser.getMessage,p=SplitsBrowser.Model.ChartPopupData,q=SplitsBrowser.Controls.ChartPopup,r=function(a){this.parent=a,this.xScale=null,this.yScale=null,this.overallWidth=-1,this.overallHeight=-1,this.contentWidth=-1,this.contentHeight=-1,this.numControls=-1,this.selectedIndexes=[],this.currentCompetitorData=null,this.isPopupOpen=!1,this.popupUpdateFunc=null,this.maxStartTimeLabelWidth=0,this.warningPanel=null,this.mouseOutTimeout=null,this.selectedIndexesOrderedByLastYValue=[],this.referenceCumTimes=[],this.fastestCumTimes=[],this.isMouseIn=!1,this.currentControlIndex=null,this.actualControlIndex=null,this.controlLine=null,this.svg=d3.select(this.parent).append("svg").attr("id",d),this.svgGroup=this.svg.append("g"),this.setLeftMargin(f.left);var b=this,e=function(a){b.onMouseMove(a)},g=function(a){b.onMouseUp(a)},h=function(a){b.onMouseDown(a)};$(this.svg.node()).mouseenter(function(a){b.onMouseEnter(a)}).mousemove(e).mouseleave(function(a){b.onMouseLeave(a)}).mousedown(h).mouseup(g),$(this.svg.node()).contextmenu(function(a){a.preventDefault()}),this.textSizeElement=this.svg.append("text").attr("fill","transparent").attr("id",c);var i={mousemove:e,mousedown:h,mouseup:g};this.popup=new q(a,i),$(document).mouseup(function(){b.popup.hide()})};r.prototype.hide=function(){this.svg.style("position","absolute").style("left","-9999px")},r.prototype.show=function(){this.svg.style("position",null).style("left",null)},r.prototype.setLeftMargin=function(a){this.currentLeftMargin=a,this.svgGroup.attr("transform","translate("+this.currentLeftMargin+","+f.top+")")},r.prototype.getPopupLocation=function(a){return{x:a.pageX+e,y:Math.max(a.pageY-this.popup.height()/2,0)}},r.prototype.getFastestSplitsPopupData=function(){return p.getFastestSplitsPopupData(this.ageClassSet,this.currentControlIndex)},r.prototype.getFastestSplitsForCurrentLegPopupData=function(){return p.getFastestSplitsForLegPopupData(this.ageClassSet,this.eventData,this.currentControlIndex)},r.prototype.setCurrentChartTime=function(a){var b=a.pageY-$(this.svg.node()).offset().top-f.top;this.currentChartTime=Math.round(60*this.yScale.invert(b))+this.referenceCumTimes[this.currentControlIndex]},r.prototype.getCompetitorsVisitingCurrentControlPopupData=function(){return p.getCompetitorsVisitingCurrentControlPopupData(this.ageClassSet,this.eventData,this.currentControlIndex,this.currentChartTime)},r.prototype.getNextControlData=function(){return p.getNextControlData(this.ageClassSet.getCourse(),this.eventData,this.actualControlIndex)},r.prototype.onMouseEnter=function(a){null===this.warningPanel&&(null!==this.mouseOutTimeout&&(clearTimeout(this.mouseOutTimeout),this.mouseOutTimeout=null),this.isMouseIn=!0,this.updateControlLineLocation(a))},r.prototype.onMouseMove=function(a){this.isMouseIn&&null!==this.xScale&&null===this.warningPanel&&this.updateControlLineLocation(a)},r.prototype.onMouseLeave=function(){if(null===this.warningPanel){var a=this;this.mouseOutTimeout=setTimeout(function(){a.popup.isMouseIn()||(a.isMouseIn=!1,a.removeControlLine())},1)}},r.prototype.onMouseDown=function(a){if(null===this.warningPanel){var b=this;setTimeout(function(){b.showPopupDialog(a)},1)}},r.prototype.onMouseUp=function(a){null===this.warningPanel&&(this.popup.hide(),a.preventDefault())},r.prototype.showPopupDialog=function(a){if(this.isMouseIn&&null!==this.currentControlIndex){var b=!1,c=this;!this.isRaceGraph||a.which!==i&&a.which!==j?a.which===i?(this.popupUpdateFunc=function(){c.popup.setData(c.getFastestSplitsPopupData(),!1)},b=!0):a.which===j&&this.hasControls&&(this.popupUpdateFunc=function(){c.popup.setData(c.getFastestSplitsForCurrentLegPopupData(),!0)},b=!0):this.hasControls&&(this.setCurrentChartTime(a),this.popupUpdateFunc=function(){c.popup.setData(c.getCompetitorsVisitingCurrentControlPopupData(),!0)},b=!0),b&&(this.updatePopupContents(a),this.popup.show(this.getPopupLocation(a)))}},r.prototype.updatePopupContents=function(a){var b=a.pageY-$(this.svg.node()).offset().top,c=this.hasControls&&b<f.top;c?this.updateNextControlInformation():this.popupUpdateFunc()},r.prototype.updateNextControlInformation=function(){this.hasControls&&this.popup.setNextControlData(this.getNextControlData())},r.prototype.drawControlLine=function(a){this.currentControlIndex=a,this.updateCompetitorStatistics();var b=this.xScale(this.referenceCumTimes[a]);this.controlLine=this.svgGroup.append("line").attr("x1",b).attr("y1",0).attr("x2",b).attr("y2",this.contentHeight).attr("class","controlLine").node()},r.prototype.updateControlLineLocation=function(a){var b=$(this.svg.node()),c=b.offset(),d=a.pageX-c.left,e=a.pageY-c.top;if(this.currentLeftMargin<=d&&d<b.width()-f.right&&e<b.height()-f.bottom){var g,h=this.xScale.invert(d-this.currentLeftMargin),i=d3.bisect(this.referenceCumTimes,h);if(i>=this.referenceCumTimes.length)g=this.numControls+1;else{var j=Math.abs(this.referenceCumTimes[i]-h),k=Math.abs(h-this.referenceCumTimes[i-1]);g=j>k?i-1:i}(null===this.actualControlIndex||this.actualControlIndex!==g)&&(this.removeControlLine(),this.actualControlIndex=g,this.drawControlLine(Math.max(this.minViewableControl,g))),this.popup.isShown()&&null!==this.currentControlIndex&&(this.isRaceGraph&&this.setCurrentChartTime(a),this.updatePopupContents(a),this.popup.setLocation(this.getPopupLocation(a)))}else this.removeControlLine(),this.popup.hide()},r.prototype.removeControlLine=function(){this.currentControlIndex=null,this.actualControlIndex=null,this.updateCompetitorStatistics(),null!==this.controlLine&&(d3.select(this.controlLine).remove(),this.controlLine=null)},r.prototype.getTimesBehindFastest=function(a,b){var c=b.map(function(a){return this.ageClassSet.allCompetitors[a]},this),d=this.fastestCumTimes[a]-this.fastestCumTimes[a-1],e=c.map(function(b){var c=b.getSplitTimeTo(a);return null===c?null:c-d});return e},r.prototype.getTimeLosses=function(a,b){var c=b.map(function(a){return this.ageClassSet.allCompetitors[a]},this),d=c.map(function(b){return b.getTimeLossAt(a)});return d},r.prototype.updateCompetitorStatistics=function(){var c=this.selectedIndexesOrderedByLastYValue.map(function(a){return this.ageClassSet.allCompetitors[a]},this),d=c.map(function(a){return b(a.name,a.getSuffix())});if(null!==this.currentControlIndex&&this.currentControlIndex>0){if(this.visibleStatistics[0]){var e=c.map(function(a){return a.getCumulativeTimeTo(this.currentControlIndex)},this),f=c.map(function(a){return a.getCumulativeRankTo(this.currentControlIndex)},this);d=d3.zip(d,e,f).map(function(b){return b[0]+a(b[1],b[2])})}if(this.visibleStatistics[1]){var g=c.map(function(a){return a.getSplitTimeTo(this.currentControlIndex)},this),h=c.map(function(a){return a.getSplitRankTo(this.currentControlIndex)},this);d=d3.zip(d,g,h).map(function(b){return b[0]+a(b[1],b[2])})}if(this.visibleStatistics[2]){var i=this.getTimesBehindFastest(this.currentControlIndex,this.selectedIndexesOrderedByLastYValue);d=d3.zip(d,i).map(function(a){return a[0]+k+n(a[1])})}if(this.visibleStatistics[3]){var j=this.getTimeLosses(this.currentControlIndex,this.selectedIndexesOrderedByLastYValue);d=d3.zip(d,j).map(function(a){return a[0]+k+n(a[1])})}}this.currentCompetitorData.forEach(function(a,b){a.label=d[b]}),d3.selectAll("text.competitorLabel").text(function(a){return a.label})},r.prototype.getTickFormatter=function(){var a=this;return function(b,c){return 0===c?o("StartNameShort"):c===a.numControls+1?o("FinishNameShort"):c.toString()}},r.prototype.getTextWidth=function(a){return this.textSizeElement.text(a).node().getBBox().width},r.prototype.getTextHeight=function(a){return this.textSizeElement.text(a).node().getBBox().height},r.prototype.getMaxGraphEndTextWidth=function(){if(0===this.selectedIndexes.length)return 0;var a=this.selectedIndexes.map(function(a){var c=this.ageClassSet.allCompetitors[a];return this.getTextWidth(b(c.name,c.getSuffix()))},this);return d3.max(a)+this.determineMaxStatisticTextWidth()},r.prototype.getMaxTimeAndRankTextWidth=function(b,c){var d=0,e=0,f=this.selectedIndexes.map(function(a){return this.ageClassSet.allCompetitors[a]},this);d3.range(1,this.numControls+2).forEach(function(a){var g=f.map(function(c){return c[b](a)});d=Math.max(d,d3.max(g.filter(m)));var h=f.map(function(b){return b[c](a)});e=Math.max(e,d3.max(h.filter(m)))});var g=a(d,e);return this.getTextWidth(g)},r.prototype.getMaxSplitTimeAndRankTextWidth=function(){return this.getMaxTimeAndRankTextWidth("getSplitTimeTo","getSplitRankTo")},r.prototype.getMaxCumulativeTimeAndRankTextWidth=function(){return this.getMaxTimeAndRankTextWidth("getCumulativeTimeTo","getCumulativeRankTo")},r.prototype.getMaxTimeBehindFastestWidth=function(){for(var a=0,b=1;b<=this.numControls+1;b+=1){var c=this.getTimesBehindFastest(b,this.selectedIndexes);a=Math.max(a,d3.max(c.filter(m)))}return this.getTextWidth(k+n(a))},r.prototype.getMaxTimeLossWidth=function(){for(var a=0,b=1;b<=this.numControls+1;b+=1){var c=this.getTimeLosses(b,this.selectedIndexes);a=Math.max(a,d3.max(c.filter(m)))}return this.getTextWidth(k+n(a))},r.prototype.determineMaxStatisticTextWidth=function(){var a=0;return this.visibleStatistics[0]&&(a+=this.getMaxCumulativeTimeAndRankTextWidth()),this.visibleStatistics[1]&&(a+=this.getMaxSplitTimeAndRankTextWidth()),this.visibleStatistics[2]&&(a+=this.getMaxTimeBehindFastestWidth()),this.visibleStatistics[3]&&(a+=this.getMaxTimeLossWidth()),a},r.prototype.determineMaxStartTimeLabelWidth=function(a){var b;return b=a.competitorNames.length>0?d3.max(a.competitorNames.map(function(a){return this.getTextWidth("00:00:00 "+a)},this)):0},r.prototype.createScales=function(a){this.xScale=d3.scale.linear().domain(a.xExtent).range([0,this.contentWidth]),this.yScale=d3.scale.linear().domain(a.yExtent).range([0,this.contentHeight]),this.xScaleMinutes=d3.scale.linear().domain([a.xExtent[0]/60,a.xExtent[1]/60]).range([0,this.contentWidth])},r.prototype.drawBackgroundRectangles=function(){var a=this.svgGroup.selectAll("rect").data(d3.range(this.numControls+1)),b=this;a.enter().append("rect"),a.attr("x",function(a){return b.xScale(b.referenceCumTimes[a])}).attr("y",0).attr("width",function(a){return b.xScale(b.referenceCumTimes[a+1]-b.referenceCumTimes[a])}).attr("height",this.contentHeight).attr("class",function(a){return 0===a%2?"background1":"background2"}),a.exit().remove()},r.prototype.determineYAxisTickFormatter=function(a){if(this.isRaceGraph){var b=0===a.dataColumns.length?[]:a.dataColumns[0].ys;if(0===b.length)return function(a){return n(60*a)};var c=this.yScale;return function(a){var d=d3.min(b.map(function(b){return Math.abs(c(b)-c(a))}));return d>=h?n(Math.round(60*a)):""}}return null},r.prototype.drawAxes=function(a,b){var c=this.determineYAxisTickFormatter(b),d=d3.svg.axis().scale(this.xScale).orient("top").tickFormat(this.getTickFormatter()).tickValues(this.referenceCumTimes),e=d3.svg.axis().scale(this.yScale).tickFormat(c).orient("left"),f=d3.svg.axis().scale(this.xScaleMinutes).orient("bottom");this.svgGroup.selectAll("g.axis").remove(),this.svgGroup.append("g").attr("class","x axis").call(d),this.svgGroup.append("g").attr("class","y axis").call(e).append("text").attr("transform","rotate(-90)").attr("x",-(this.contentHeight-6)).attr("y",6).attr("dy",".71em").style("text-anchor","start").text(a),this.svgGroup.append("g").attr("class","x axis").attr("transform","translate(0,"+this.contentHeight+")").call(f).append("text").attr("x",60).attr("y",-5).style("text-anchor","start").text(o("LowerXAxisChartLabel"))},r.prototype.drawChartLines=function(a){var b=this,c=function(c){return a.dataColumns.every(function(a){return null===a.ys[c]})?d3.svg.line().x(-1e4).y(-1e4):d3.svg.line().x(function(a){return b.xScale(a.x)}).y(function(a){return b.yScale(a.ys[c])}).defined(function(a){return null!==a.ys[c]}).interpolate("linear")},d=this.svgGroup.selectAll("path.graphLine").data(d3.range(this.numLines));d.enter().append("path").append("title"),d.attr("d",function(b){return c(b)(a.dataColumns)}).attr("stroke",function(a){return l[b.selectedIndexes[a]%l.length]}).attr("class",function(a){return"graphLine competitor"+b.selectedIndexes[a]}).on("mouseenter",function(a){b.highlight(b.selectedIndexes[a])}).on("mouseleave",function(){b.unhighlight()}).select("title").text(function(b){return a.competitorNames[b]}),d.exit().remove()},r.prototype.highlight=function(a){this.svg.selectAll("path.graphLine.competitor"+a).classed("selected",!0),this.svg.selectAll("line.competitorLegendLine.competitor"+a).classed("selected",!0),this.svg.selectAll("text.competitorLabel.competitor"+a).classed("selected",!0),this.svg.selectAll("text.startLabel.competitor"+a).classed("selected",!0)},r.prototype.unhighlight=function(){this.svg.selectAll("path.graphLine.selected").classed("selected",!1),this.svg.selectAll("line.competitorLegendLine.selected").classed("selected",!1),this.svg.selectAll("text.competitorLabel.selected").classed("selected",!1),this.svg.selectAll("text.startLabel.selected").classed("selected",!1)},r.prototype.drawCompetitorStartTimeLabels=function(a){var b=a.dataColumns[0],c=this,d=this.svgGroup.selectAll("text.startLabel").data(this.selectedIndexes);d.enter().append("text"),d.attr("x",-7).attr("y",function(d,e){return c.yScale(b.ys[e])+c.getTextHeight(a.competitorNames[e])/4}).attr("class",function(a){return"startLabel competitor"+a}).on("mouseenter",function(a){c.highlight(a)}).on("mouseleave",function(){c.unhighlight()}).text(function(c,d){return n(Math.round(60*b.ys[d]))+" "+a.competitorNames[d]}),d.exit().remove()},r.prototype.removeCompetitorStartTimeLabels=function(){this.svgGroup.selectAll("text.startLabel").remove()},r.prototype.adjustCompetitorLegendLabelsDownwardsIfNecessary=function(){for(var a=1;a<this.numLines;a+=1){var b=this.currentCompetitorData[a-1],c=this.currentCompetitorData[a];c.y<b.y+b.textHeight&&(c.y=b.y+b.textHeight)}},r.prototype.adjustCompetitorLegendLabelsUpwardsIfNecessary=function(a){if(this.numLines>0&&this.currentCompetitorData[this.numLines-1].y>this.contentHeight){this.currentCompetitorData[this.numLines-1].y=Math.max(a,this.contentHeight);for(var b=this.numLines-2;b>=0;b-=1){var c=this.currentCompetitorData[b+1],d=this.currentCompetitorData[b];if(!(d.y+d.textHeight>c.y))break;d.y=c.y-d.textHeight}}},r.prototype.drawCompetitorLegendLabels=function(a){var c=0;if(0===a.dataColumns.length)this.currentCompetitorData=[];else{var d=a.dataColumns[a.dataColumns.length-1];this.currentCompetitorData=d3.range(this.numLines).map(function(a){var e=this.selectedIndexes[a],f=this.ageClassSet.allCompetitors[e].name,g=this.getTextHeight(f);return c+=g,{label:b(f,this.ageClassSet.allCompetitors[e].getSuffix()),textHeight:g,y:null===d.ys[a]?null:this.yScale(d.ys[a]),colour:l[e%l.length],index:e}},this),c-=this.currentCompetitorData[this.numLines-1].textHeight;for(var e=null,f=this.numLines-1;f>=0;f-=1)null===this.currentCompetitorData[f].y&&(this.currentCompetitorData[f].y=null===e?this.contentHeight:e-this.currentCompetitorData[f].textHeight,e=this.currentCompetitorData[f].y)}this.currentCompetitorData.sort(function(a,b){return a.y-b.y}),this.selectedIndexesOrderedByLastYValue=this.currentCompetitorData.map(function(a){return a.index}),this.adjustCompetitorLegendLabelsDownwardsIfNecessary(),this.adjustCompetitorLegendLabelsUpwardsIfNecessary(c);var h=this.svgGroup.selectAll("line.competitorLegendLine").data(this.currentCompetitorData);h.enter().append("line");var i=this;h.attr("x1",this.contentWidth+1).attr("y1",function(a){return a.y}).attr("x2",this.contentWidth+g+1).attr("y2",function(a){return a.y}).attr("stroke",function(a){return a.colour}).attr("class",function(a){return"competitorLegendLine competitor"+a.index}).on("mouseenter",function(a){i.highlight(a.index)}).on("mouseleave",function(){i.unhighlight()}),h.exit().remove();var j=this.svgGroup.selectAll("text.competitorLabel").data(this.currentCompetitorData);j.enter().append("text"),j.attr("x",this.contentWidth+g+2).attr("y",function(a){return a.y+a.textHeight/4}).attr("class",function(a){return"competitorLabel competitor"+a.index}).on("mouseenter",function(a){i.highlight(a.index)}).on("mouseleave",function(){i.unhighlight()}).text(function(a){return a.label}),j.exit().remove()},r.prototype.adjustContentSize=function(){var a=8,b=this.getMaxGraphEndTextWidth();this.setLeftMargin(Math.max(this.maxStartTimeLabelWidth+a,f.left)),this.contentWidth=Math.max(this.overallWidth-this.currentLeftMargin-f.right-b-(g+2),100),this.contentHeight=Math.max(this.overallHeight-f.top-f.bottom,100)},r.prototype.setSize=function(a,b){this.overallWidth=a,this.overallHeight=b,$(this.svg.node()).width(a).height(b),this.adjustContentSize()},r.prototype.clearGraph=function(){this.svgGroup.selectAll("*").remove()},r.prototype.clearWarningPanel=function(){null!==this.warningPanel&&(this.warningPanel.remove(),this.warningPanel=null)},r.prototype.showWarningPanel=function(a){this.clearWarningPanel(),this.warningPanel=d3.select(this.parent).append("div").classed("warningPanel",!0),this.warningPanel.text(a);var b=$(this.warningPanel.node()).width(),c=$(this.warningPanel.node()).height();this.warningPanel.style("left",($(this.parent).width()-b)/2+"px").style("top",(this.overallHeight-c)/2+"px")},r.prototype.drawChart=function(a,b,c,d){var e=a.chartData;this.numControls=e.numControls,this.numLines=e.competitorNames.length,this.selectedIndexes=b,this.referenceCumTimes=a.referenceCumTimes,this.fastestCumTimes=a.fastestCumTimes,this.eventData=a.eventData,this.ageClassSet=a.ageClassSet,this.hasControls=a.ageClassSet.getCourse().hasControls(),this.isRaceGraph=d.isRaceGraph,this.minViewableControl=d.minViewableControl,this.visibleStatistics=c,this.maxStatisticTextWidth=this.determineMaxStatisticTextWidth(),this.maxStartTimeLabelWidth=this.isRaceGraph?this.determineMaxStartTimeLabelWidth(e):0,this.clearWarningPanel(),this.adjustContentSize(),this.createScales(e),this.drawBackgroundRectangles(),this.drawAxes(o(d.yAxisLabelKey),e),this.drawChartLines(e),this.drawCompetitorLegendLabels(e),this.removeControlLine(),this.isRaceGraph?this.drawCompetitorStartTimeLabels(e):this.removeCompetitorStartTimeLabels()},r.prototype.clearAndShowWarning=function(a){this.numControls=0,this.numLines=0;var b={dataColumns:[],competitorNames:[],numControls:0,xExtent:[0,3600],yExtent:[0,1]};this.maxStatisticTextWidth=0,this.maxStartTimeWidth=0,this.clearGraph(),this.adjustContentSize(),this.referenceCumTimes=[0],this.createScales(b),this.drawAxes("",b),this.showWarningPanel(a)},SplitsBrowser.Controls.Chart=r}(),function(){"use strict";var a=SplitsBrowser.formatTime,b=SplitsBrowser.Model.compareCompetitors,c=SplitsBrowser.getMessage,d=SplitsBrowser.getMessageWithFormatting,e=" ",f=function(a){this.parent=a,this.ageClass=null,this.div=null,this.headerSpan=null,this.table=null,this.buildTable()};f.prototype.buildTable=function(){this.div=d3.select(this.parent).append("div").attr("id","resultsTableContainer"),this.headerSpan=this.div.append("div").append("span").classed("resultsTableHeader",!0),this.table=this.div.append("table").classed("resultsTable",!0),this.table.append("thead").append("tr"),this.table.append("tbody")},f.prototype.populateTable=function(){function f(a,b,c,d){var e=a.append("td");e.append("span").text(b),e.append("br"),e.append("span").text(c),d&&e.classed(d,!0)}var g=this.ageClass.name+", ";g+=1===this.ageClass.numControls?c("ResultsTableHeaderSingleControl"):d("ResultsTableHeaderMultipleControls",{$$NUM$$:this.ageClass.numControls});var h=this.ageClass.course;null!==h.length&&(g+=", "+d("ResultsTableHeaderCourseLength",{$$DISTANCE$$:h.length.toFixed(1)})),null!==h.climb&&(g+=", "+d("ResultsTableHeaderClimb",{$$CLIMB$$:h.climb})),this.headerSpan.text(g);var i=[c("ResultsTableHeaderControlNumber"),c("ResultsTableHeaderName"),c("ResultsTableHeaderTime")].concat(d3.range(1,this.ageClass.numControls+1)).concat([c("FinishName")]),j=this.table.select("thead tr").selectAll("th").data(i);j.enter().append("th"),j.text(function(a){return a}),j.exit().remove();var k=this.table.select("tbody");k.selectAll("tr").remove();var l=this.ageClass.competitors.slice(0);l.sort(b);var m=0,n=0;l.forEach(function(b,d){var g=k.append("tr"),h=g.append("td");b.isNonCompetitive?(h.text(c("NonCompetitiveShort")),m+=1):b.completed()&&((0===d||l[d-1].totalTime!==b.totalTime)&&(n=d+1-m),h.text(n)),f(g,b.name,b.club),f(g,b.completed()?a(b.totalTime):c("MispunchedShort"),e,"time"),d3.range(1,this.ageClass.numControls+2).forEach(function(c){f(g,a(b.getCumulativeTimeTo(c)),a(b.getSplitTimeTo(c)),"time")})},this)},f.prototype.setClass=function(a){this.ageClass=a,this.populateTable(),"none"!==this.div.style("display")&&this.adjustTableCellWidths()},f.prototype.adjustTableCellWidths=function(){var a=d3.select("tbody tr td:last-child").node();$("tbody td.time").width($(a).width())},f.prototype.show=function(){this.div.style("display",null),this.adjustTableCellWidths()},f.prototype.hide=function(){this.div.style("display","none")},SplitsBrowser.Controls.ResultsTable=f}(),function(){"use strict";function a(a,b){a.node().disabled=!b}function b(a,b){d3.select("body").append("h1").text(n("LoadFailedHeader")),d3.select("body").append("p").text(o(a,b))}function c(a,c,d){if("success"===c){var e;try{e=SplitsBrowser.Input.parseEventData(a)}catch(f){if("InvalidData"===f.name)return b("LoadFailedInvalidData",{$$MESSAGE$$:f.message}),void 0;throw f}if(null===e)b("LoadFailedUnrecognisedData",{});else{var g=new p(d);g.buildUi(),g.setEvent(e),g.selectClasses([0])}}else b("LoadFailedStatusNotSuccess",{$$STATUS$$:c})}function d(a,c,d){b("LoadFailedReadError",{$$ERROR$$:d})}var e=100,f="competitorListContainer",g=SplitsBrowser.Controls.ClassSelector,h=SplitsBrowser.Controls.ChartTypeSelector,i=SplitsBrowser.Controls.ComparisonSelector,j=SplitsBrowser.Controls.StatisticsSelector,k=SplitsBrowser.Controls.CompetitorListBox,l=SplitsBrowser.Controls.Chart,m=SplitsBrowser.Controls.ResultsTable,n=SplitsBrowser.getMessage,o=SplitsBrowser.getMessageWithFormatting,p=function(a){this.eventData=null,this.classes=null,this.currentClasses=[],this.currentIndexes=null,this.chartData=null,this.referenceCumTimes=null,this.fastestCumTimes=null,this.previousCompetitorList=[],this.topDivHeight=a&&$(a).length>0?$(a).height():0,this.isChartEnabled=!1,this.selection=null,this.ageClassSet=null,this.classSelector=null,this.statisticsSelector=null,this.competitorListBox=null,this.chart=null,this.topPanel=null,this.mainPanel=null,this.buttonsPanel=null,this.competitorListContainer=null,this.currentResizeTimeout=null
};p.prototype.setEvent=function(a){this.eventData=a,this.classes=a.classes,null!==this.classSelector&&this.classSelector.setClasses(this.classes)},p.prototype.drawLogo=function(){var a=this.topPanel.append("svg");a.style("width","19px").style("height","19px").style("margin-bottom","-3px").style("margin-right","20px"),a.append("rect").attr("x","0").attr("y","0").attr("width","19").attr("height","19").attr("fill","white"),a.append("polygon").attr("points","0,19 19,0 19,19").attr("fill","red"),a.append("polyline").attr("points","0.5,0.5 0.5,18.5 18.5,18.5 18.5,0.5 0.5,0.5").attr("stroke","black").attr("fill","none"),a.append("polyline").attr("points","1,12 5,8 8,14 17,11").attr("fill","none").attr("stroke","blue").attr("stroke-width","2"),a.selectAll("*").append("title").text(o("ApplicationVersion",{$$VERSION$$:SplitsBrowser.Version}))},p.prototype.addSpacer=function(){this.topPanel.append("span").classed("topRowSpacer",!0)},p.prototype.addClassSelector=function(){this.classSelector=new g(this.topPanel.node()),null!==this.classes&&this.classSelector.setClasses(this.classes)},p.prototype.addChartTypeSelector=function(){var a=SplitsBrowser.Model.ChartTypes,b=[a.SplitsGraph,a.RaceGraph,a.PositionAfterLeg,a.SplitPosition,a.PercentBehind,a.ResultsTable];this.chartTypeSelector=new h(this.topPanel.node(),b),this.chartType=this.chartTypeSelector.getChartType()},p.prototype.addComparisonSelector=function(){this.comparisonSelector=new i(this.topPanel.node(),function(a){alert(a)}),null!==this.classes&&this.comparisonSelector.setClasses(this.classes),this.comparisonFunction=this.comparisonSelector.getComparisonFunction()},p.prototype.addCompetitorList=function(){this.competitorListContainer=this.mainPanel.append("div").attr("id",f),this.buttonsPanel=this.competitorListContainer.append("div");var a=this;this.allButton=this.buttonsPanel.append("button").text(n("SelectAllCompetitors")).style("width","50%").on("click",function(){a.selectAll()}),this.noneButton=this.buttonsPanel.append("button").text(n("SelectNoCompetitors")).style("width","50%").on("click",function(){a.selectNone()}),this.buttonsPanel.append("br"),this.crossingRunnersButton=this.buttonsPanel.append("button").text(n("SelectCrossingRunners")).style("width","100%").on("click",function(){a.selectCrossingRunners()}).style("display","none"),this.competitorListBox=new k(this.competitorListContainer.node())},p.prototype.buildUi=function(){var a=d3.select("body");this.topPanel=a.append("div"),this.drawLogo(),this.addClassSelector(),this.addSpacer(),this.addChartTypeSelector(),this.addSpacer(),this.addComparisonSelector(),this.statisticsSelector=new j(this.topPanel.node()),this.mainPanel=a.append("div"),this.addCompetitorList(),this.chart=new l(this.mainPanel.node()),this.resultsTable=new m(a.node()),this.resultsTable.hide();var b=this;this.classSelector.registerChangeHandler(function(a){b.selectClasses(a)}),this.chartTypeSelector.registerChangeHandler(function(a){b.selectChartType(a)}),this.comparisonSelector.registerChangeHandler(function(a){b.selectComparison(a)}),$(window).resize(function(){b.handleWindowResize()})},p.prototype.selectAll=function(){this.selection.selectAll()},p.prototype.selectNone=function(){this.selection.selectNone()},p.prototype.selectCrossingRunners=function(){if(this.selection.selectCrossingRunners(this.ageClassSet.allCompetitors),this.selection.isSingleRunnerSelected()){var a=this.ageClassSet.allCompetitors[this.currentIndexes[0]].name;alert(o("RaceGraphNoCrossingRunners",{$$NAME$$:a}))}},p.prototype.handleWindowResize=function(){null!==this.currentResizeTimeout&&clearTimeout(this.currentResizeTimeout);var a=this;this.currentResizeTimeout=setTimeout(function(){a.postResizeHook()},e)},p.prototype.postResizeHook=function(){this.currentResizeTimeout=null,this.drawChart()},p.prototype.adjustSize=function(){var a=parseInt($("body").css("margin-left"),10)+parseInt($("body").css("margin-right"),10),b=parseInt($("body").css("margin-top"),10)+parseInt($("body").css("margin-bottom"),10),c=1,d=$(window).width()-a,e=$(window).height()-b-this.topDivHeight;$("body").width(d).height(e);var f=$(this.topPanel.node()).height();this.chart.hide(),this.competitorListBox.setCompetitorList(this.ageClassSet.allCompetitors,this.currentClasses.length>1);var g=d-this.competitorListBox.width()-c,h=e-f;this.chart.setSize(g,h),this.chart.show(),$(this.competitorListContainer.node()).height(e-$(this.buttonsPanel.node()).height()-f)},p.prototype.drawChart=function(){if(!this.chartType.isResultsTable){this.adjustSize(),this.currentVisibleStatistics=this.statisticsSelector.getVisibleStatistics(),null!==this.selectionChangeHandler&&this.selection.deregisterChangeHandler(this.selectionChangeHandler),null!==this.statisticsChangeHandler&&this.statisticsSelector.deregisterChangeHandler(this.statisticsChangeHandler);var a=this;this.selectionChangeHandler=function(b){a.currentIndexes=b,a.enableOrDisableCrossingRunnersButton(),a.redraw()},this.selection.registerChangeHandler(this.selectionChangeHandler),this.statisticsChangeHandler=function(b){a.currentVisibleStatistics=b,a.redraw()},this.statisticsSelector.registerChangeHandler(this.statisticsChangeHandler);var b=this.ageClassSet.getControlsWithNoSplits();if(this.isChartEnabled=0===b.length,this.updateControlEnabledness(),this.isChartEnabled)this.referenceCumTimes=this.comparisonFunction(this.ageClassSet),this.fastestCumTimes=this.ageClassSet.getFastestCumTimes(),this.chartData=this.ageClassSet.getChartData(this.referenceCumTimes,this.currentIndexes,this.chartType),this.redrawChart();else{var c=this.ageClassSet.getCourse().getNumClasses()>this.ageClassSet.getNumClasses(),d=o(c?"NoSplitsForControlTryOtherClasses":"NoSplitsForControl",{$$CONTROL$$:b[0]});this.chart.clearAndShowWarning(d)}}},p.prototype.redrawChart=function(){var a={chartData:this.chartData,eventData:this.eventData,ageClassSet:this.ageClassSet,referenceCumTimes:this.referenceCumTimes,fastestCumTimes:this.fastestCumTimes};this.chart.drawChart(a,this.currentIndexes,this.currentVisibleStatistics,this.chartType)},p.prototype.redraw=function(){!this.chartType.isResultsTable&&this.isChartEnabled&&(this.chartData=this.ageClassSet.getChartData(this.referenceCumTimes,this.currentIndexes,this.chartType),this.redrawChart())},p.prototype.selectClasses=function(a){null===this.selection?(this.selection=new SplitsBrowser.Model.CompetitorSelection(0),this.competitorListBox.setSelection(this.selection)):a.length>0&&this.currentClasses.length>0&&this.classes[a[0]]===this.currentClasses[0]||this.selection.selectNone(),this.currentIndexes=[],this.currentClasses=a.map(function(a){return this.classes[a]},this),this.ageClassSet=new SplitsBrowser.Model.AgeClassSet(this.currentClasses),this.comparisonSelector.setAgeClassSet(this.ageClassSet),this.resultsTable.setClass(this.currentClasses[0]),this.drawChart(),this.selection.migrate(this.previousCompetitorList,this.ageClassSet.allCompetitors),this.previousCompetitorList=this.ageClassSet.allCompetitors},p.prototype.selectComparison=function(a){this.comparisonFunction=a,this.drawChart()},p.prototype.selectChartType=function(a){this.chartType=a,a.isResultsTable?(this.mainPanel.style("display","none"),this.resultsTable.show()):(this.resultsTable.hide(),this.mainPanel.style("display",null)),this.updateControlEnabledness(),this.crossingRunnersButton.style("display",a.isRaceGraph?null:"none"),this.drawChart()},p.prototype.updateControlEnabledness=function(){this.classSelector.setOtherClassesEnabled(!this.chartType.isResultsTable),this.comparisonSelector.setEnabled(this.isChartEnabled&&!this.chartType.isResultsTable),this.statisticsSelector.setEnabled(this.isChartEnabled&&!this.chartType.isResultsTable),this.competitorListBox.setEnabled(this.isChartEnabled),a(this.allButton,this.isChartEnabled),a(this.noneButton,this.isChartEnabled),this.enableOrDisableCrossingRunnersButton()},p.prototype.enableOrDisableCrossingRunnersButton=function(){a(this.crossingRunnersButton,this.isChartEnabled&&this.selection.isSingleRunnerSelected())},SplitsBrowser.Viewer=p,SplitsBrowser.loadEvent=function(a,b){$.ajax({url:a,data:"",success:function(a,d){c(a,d,b)},dataType:"text",error:d})}}();