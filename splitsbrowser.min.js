/*!
 *  SplitsBrowser - Orienteering results analysis.
 *  
 *  Copyright (C) 2000-2018 Dave Ryder, Reinhard Balling, Andris Strazdins,
 *                          Ed Nash, Luke Woodward
 *
 *  This program is free software; you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation; either version 2 of the License, or
 *  (at your option) any later version.
 *
 *  This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License along
 *  with this program; if not, write to the Free Software Foundation, Inc.,
 *  51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
 */

var SplitsBrowser={Version:"3.4.4",Model:{},Input:{},Controls:{},Messages:{}};!function(){"use strict";var e=!1,s=function(t){window.alert(t)},i=null,n=null,r=SplitsBrowser.Messages;function o(t){e||(s(t),e=!0)}SplitsBrowser.setMessageAlerter=function(t){s=t},SplitsBrowser.tryGetMessage=function(t,e){return null!==i&&r[i].hasOwnProperty(t)?SplitsBrowser.getMessage(t):e},SplitsBrowser.getMessage=function(t){return null===n&&SplitsBrowser.initialiseMessages(),null!==i?r[i].hasOwnProperty(t)?r[i][t]:(o("Message not found for key '"+t+"' in language '"+i+"'"),"?????"):(o("No messages found.  Has a language file been loaded?"),"?????")},SplitsBrowser.getMessageWithFormatting=function(t,e){var s=SplitsBrowser.getMessage(t);for(var i in e)if(e.hasOwnProperty(i)){var n=i.replace(/([.+*?|{}()^$\[\]\\])/g,"\\$1");s=s.replace(new RegExp(n,"g"),e[i])}return s},SplitsBrowser.getAllLanguages=function(){return n.slice(0)},SplitsBrowser.getLanguage=function(){return i},SplitsBrowser.getLanguageName=function(t){return r.hasOwnProperty(t)&&r[t].hasOwnProperty("Language")?r[t].Language:"?????"},SplitsBrowser.setLanguage=function(t){r.hasOwnProperty(t)&&(i=t)},SplitsBrowser.initialiseMessages=function(t){for(var e in n=[],r!==SplitsBrowser.Messages&&o("You appear to have loaded a messages file in the old format.  This file, and all others loaded after it, will not work.\n\nPlease check the messages files."),r)r.hasOwnProperty(e)&&n.push(e);0===n.length?o("No messages files were found."):i=t&&r.hasOwnProperty(t)?t:n[0]}}(),function(){"use strict";function e(t){this.name="InvalidData",this.message=t}function s(t){this.name="WrongFileFormat",this.message=t}SplitsBrowser.isTrue=function(t){return t},SplitsBrowser.isNotNull=function(t){return null!==t},SplitsBrowser.isNaNStrict=function(t){return t!=t},SplitsBrowser.isNotNullNorNaN=function(t){return null!==t&&t==t},e.prototype.toString=function(){return this.name+": "+this.message},SplitsBrowser.throwInvalidData=function(t){throw new e(t)},s.prototype.toString=function(){return this.name+": "+this.message},SplitsBrowser.throwWrongFileFormat=function(t){throw new s(t)},SplitsBrowser.addIfNotNull=function(t,e){return null===t||null===e?null:t+e},SplitsBrowser.subtractIfNotNull=function(t,e){return null===t||null===e?null:t-e},SplitsBrowser.parseCourseLength=function(t){var e=parseFloat(t.replace(",","."));return isFinite(e)?(500<=e&&(e/=1e3),e):null},SplitsBrowser.parseCourseClimb=function(t){var e=parseInt(t,10);return SplitsBrowser.isNaNStrict(e)?null:e},SplitsBrowser.normaliseLineEndings=function(t){return t.replace(/\r\n/g,"\n").replace(/\r/g,"\n")}}(),function(){"use strict";SplitsBrowser.NULL_TIME_PLACEHOLDER="-----";var o=SplitsBrowser.isNaNStrict;SplitsBrowser.formatTime=function(t,e){if(null===t)return SplitsBrowser.NULL_TIME_PLACEHOLDER;if(o(t))return"???";var s="";t<0&&(s="-",t=-t);var i=Math.floor(t/3600),n=Math.floor(t/60)%60,r=t%60;return 0<i&&(s+=i.toString()+":"),n<10&&(s+="0"),s+=n+":",r<10&&(s+="0"),s+="number"==typeof e?r.toFixed(e):Math.round(100*r)/100},SplitsBrowser.parseTime=function(t){if(t=t.trim(),/^(-?\d+:)?-?\d+:-?\d\d([,.]\d+)?$/.test(t)){var e=t.replace(",",".").split(":"),s=0;return e.forEach(function(t){s=60*s+parseFloat(t)}),s}return null}}(),function(){"use strict";var n="number",t=SplitsBrowser.isNotNull,r=SplitsBrowser.isNaNStrict,i=SplitsBrowser.addIfNotNull,o=SplitsBrowser.subtractIfNotNull,a=SplitsBrowser.throwInvalidData;function l(t){if(!$.isArray(t))throw new TypeError("Cumulative times must be an array - got "+typeof t+" instead");0===t.length?a("Array of cumulative times must not be empty"):0!==t[0]?a("Array of cumulative times must have zero as its first item"):1===t.length&&a("Array of cumulative times must contain more than just a single zero");for(var e=[],s=0;s+1<t.length;s+=1)e.push(o(t[s+1],t[s]));return e}function u(t,e,s,i){typeof t!=n&&a("Result order must be a number, got "+typeof t+" '"+t+"' instead"),typeof e!=n&&null!==e&&a("Start time must be a number, got "+typeof e+" '"+e+"' instead"),this.order=t,this.startTime=e,this.isOKDespiteMissingTimes=!1,this.isNonCompetitive=!1,this.isNonStarter=!1,this.isNonFinisher=!1,this.isDisqualified=!1,this.isOverMaxTime=!1,this.originalSplitTimes=s,this.originalCumTimes=i,this.splitTimes=null,this.cumTimes=null,this.splitRanks=null,this.cumRanks=null,this.timeLosses=null,this.totalTime=null===i||-1<i.indexOf(null)?null:i[i.length-1]}SplitsBrowser.Model.compareResults=function(t,e){return t.isDisqualified!==e.isDisqualified?t.isDisqualified?1:-1:t.totalTime===e.totalTime?t.order-e.order:null===t.totalTime?null===e.totalTime?0:1:null===e.totalTime?-1:t.totalTime-e.totalTime},u.prototype.setOKDespiteMissingTimes=function(){this.isOKDespiteMissingTimes=!0,null!==this.originalCumTimes&&(this.totalTime=this.originalCumTimes[this.originalCumTimes.length-1])},u.prototype.setNonCompetitive=function(){this.isNonCompetitive=!0},u.prototype.setNonStarter=function(){this.isNonStarter=!0},u.prototype.setNonFinisher=function(){this.isNonFinisher=!0},u.prototype.disqualify=function(){this.isDisqualified=!0},u.prototype.setOverMaxTime=function(){this.isOverMaxTime=!0},u.fromOriginalCumTimes=function(t,e,s){return new u(t,e,l(s),s)},u.fromCumTimes=function(t,e,s){var i=u.fromOriginalCumTimes(t,e,s);return i.splitTimes=i.originalSplitTimes,i.cumTimes=i.originalCumTimes,i},u.prototype.setRepairedCumulativeTimes=function(t){this.cumTimes=t,this.splitTimes=l(t)},u.prototype.completed=function(){return null!==this.totalTime&&!this.isDisqualified&&!this.isOverMaxTime},u.prototype.hasAnyTimes=function(){return this.originalCumTimes.slice(1).some(t)},u.prototype.getSplitTimeTo=function(t){return 0===t?0:this.splitTimes[t-1]},u.prototype.getOriginalSplitTimeTo=function(t){return this.isNonStarter?null:0===t?0:this.originalSplitTimes[t-1]},u.prototype.isSplitTimeDubious=function(t){return 0<t&&this.originalSplitTimes[t-1]!==this.splitTimes[t-1]},u.prototype.getCumulativeTimeTo=function(t){return this.cumTimes[t]},u.prototype.getOriginalCumulativeTimeTo=function(t){return this.isNonStarter?null:this.originalCumTimes[t]},u.prototype.isCumulativeTimeDubious=function(t){return this.originalCumTimes[t]!==this.cumTimes[t]},u.prototype.getSplitRankTo=function(t){return null===this.splitRanks||0===t?null:this.splitRanks[t-1]},u.prototype.getCumulativeRankTo=function(t){return null===this.cumRanks||0===t?null:this.cumRanks[t-1]},u.prototype.getTimeLossAt=function(t){return 0===t||null===this.timeLosses?null:this.timeLosses[t-1]},u.prototype.getAllCumulativeTimes=function(){return this.cumTimes},u.prototype.getAllOriginalCumulativeTimes=function(){return this.originalCumTimes},u.prototype.getAllSplitTimes=function(){return this.splitTimes},u.prototype.lacksStartTime=function(){return null===this.startTime&&this.splitTimes.some(t)},u.prototype.setSplitAndCumulativeRanks=function(t,e){this.splitRanks=t,this.cumRanks=e},u.prototype.getCumTimesAdjustedToReference=function(s){return s.length!==this.cumTimes.length?a("Cannot adjust cumulative times because the numbers of times are different ("+this.cumTimes.length+" and "+s.length+")"):-1<s.indexOf(null)&&a("Cannot adjust cumulative times because a null value is in the reference data"),this.cumTimes.map(function(t,e){return o(t,s[e])})},u.prototype.getCumTimesAdjustedToReferenceWithStartAdded=function(t){var e=this.getCumTimesAdjustedToReference(t),s=this.startTime;return e.map(function(t){return i(t,s)})},u.prototype.getSplitPercentsBehindReferenceCumTimes=function(i){i.length!==this.cumTimes.length?a("Cannot determine percentages-behind because the numbers of times are different ("+this.cumTimes.length+" and "+i.length+")"):-1<i.indexOf(null)&&a("Cannot determine percentages-behind because a null value is in the reference data");var n=[0];return this.splitTimes.forEach(function(t,e){if(null===t)n.push(null);else{var s=i[e+1]-i[e];0<s?n.push(100*(t-s)/s):n.push(null)}}),n},u.prototype.determineTimeLosses=function(s){if(this.completed())if(s.length!==this.splitTimes.length?a("Cannot determine time loss with "+this.splitTimes.length+" split times using "+s.length+" fastest splits"):s.some(r)&&a("Cannot determine time loss when there is a NaN value in the fastest splits"),s.some(function(t){return 0===t}))this.timeLosses=this.splitTimes.map(function(){return NaN});else if(this.isOKDespiteMissingTimes||this.splitTimes.some(r))this.timeLosses=this.splitTimes.map(function(){return NaN});else{var i,t=this.splitTimes.map(function(t,e){return t/s[e]});if(t.sort(d3.ascending),t.length%2==1)i=t[(t.length-1)/2];else{var e=t.length/2;i=(t[e-1]+t[e])/2}this.timeLosses=this.splitTimes.map(function(t,e){return Math.round(t-s[e]*i)})}},u.prototype.crosses=function(t){t.cumTimes.length!==this.cumTimes.length&&a("Two results with different numbers of controls cannot cross");for(var e=!1,s=!1,i=0;i<this.cumTimes.length;i+=1)if(null!==this.cumTimes[i]&&null!==t.cumTimes[i]){var n=this.startTime+this.cumTimes[i],r=t.startTime+t.cumTimes[i];n<r?e=!0:r<n&&(s=!0)}return e&&s},u.prototype.isTimeOmitted=function(t){return r(t)||this.isOKDespiteMissingTimes&&null===t},u.prototype.getIndexesAroundOmittedTimes=function(t){for(var e=[],s=1;s+1<t.length;)if(this.isTimeOmitted(t[s])){for(var i=s;i+1<t.length&&this.isTimeOmitted(t[i+1]);)i+=1;i+1<t.length&&null!==t[s-1]&&null!==t[i+1]&&e.push({start:s-1,end:i+1}),s=i+1}else s+=1;return e},u.prototype.getControlIndexesAroundOmittedCumulativeTimes=function(){return this.getIndexesAroundOmittedTimes(this.cumTimes)},u.prototype.getControlIndexesAroundOmittedSplitTimes=function(){return this.getIndexesAroundOmittedTimes([0].concat(this.splitTimes))},SplitsBrowser.Model.Result=u}(),function(){"use strict";var s=SplitsBrowser.Model.compareResults;function t(t,e,s){this.name=t,this.club=e,this.result=s,this.className=null,this.yearOfBirth=null,this.gender=null}SplitsBrowser.Model.compareCompetitors=function(t,e){return s(t.result,e.result)},t.prototype.setClassName=function(t){this.className=t},t.prototype.setYearOfBirth=function(t){this.yearOfBirth=t},t.prototype.setGender=function(t){this.gender=t},SplitsBrowser.Model.Competitor=t}(),function(){"use strict";var r=SplitsBrowser.isNotNullNorNaN,t=SplitsBrowser.throwInvalidData;function e(e,t,s){this.name=e,this.numControls=t,this.competitors=s,this.course=null,this.hasDubiousData=!1,this.competitors.forEach(function(t){t.setClassName(e)})}e.prototype.recordHasDubiousData=function(){this.hasDubiousData=!0},e.prototype.determineTimeLosses=function(){var e=d3.range(1,this.numControls+2).map(function(t){var e=this.getFastestSplitTo(t);return null===e?null:e.split},this);this.competitors.forEach(function(t){t.result.determineTimeLosses(e)})},e.prototype.isEmpty=function(){return 0===this.competitors.length},e.prototype.setCourse=function(t){this.course=t},e.prototype.getFastestSplitTo=function(s){("number"!=typeof s||s<1||s>this.numControls+1)&&t("Cannot return splits to leg '"+s+"' in a course with "+this.numControls+" control(s)");var i=null,n=null;return this.competitors.forEach(function(t){var e=t.result.getSplitTimeTo(s);r(e)&&(null===i||e<i)&&(i=e,n=t)}),null===i?null:{split:i,name:n.name}},e.prototype.getCompetitorsAtControlInTimeRange=function(i,n,r){("number"!=typeof i||isNaN(i)||i<0||i>this.numControls+1)&&t("Control number must be a number between 0 and "+this.numControls+" inclusive");var o=[];return this.competitors.forEach(function(t){var e=t.result.getCumulativeTimeTo(i);if(null!==e&&null!==t.result.startTime){var s=e+t.result.startTime;n<=s&&s<=r&&o.push({name:t.name,time:s})}}),o},SplitsBrowser.Model.CourseClass=e}(),function(){"use strict";var c=SplitsBrowser.isNotNull,u=SplitsBrowser.isNaNStrict,p=SplitsBrowser.isNotNullNorNaN,r=SplitsBrowser.throwInvalidData,i=SplitsBrowser.Model.compareCompetitors;function t(t){var e=t.filter(p);e.sort(d3.ascending);var s=new d3.map;return e.forEach(function(t,e){s.has(t)||s.set(t,e+1)}),t.map(function(t){return p(t)?s.get(t):t})}function e(t){this.allCompetitors=function(t){if(0===t.length)return[];var e=[],s=t[0].numControls;return t.forEach(function(t){t.numControls!==s&&r("Cannot merge classes with "+s+" and "+t.numControls+" controls"),t.competitors.forEach(function(t){t.result.isNonStarter||e.push(t)})}),e.sort(i),e}(t),this.classes=t,this.numControls=0<t.length?t[0].numControls:null,this.computeRanks()}function d(t,e){for(var s=[],i=1;i+1<t.length;)if(p(t[i]))i+=1;else{for(var n=i;n+1<t.length&&!p(t[n+1]);)n+=1;(n+1<t.length||e)&&s.push({start:i-1,end:n+1}),i=n+1}return s}function s(t){for(var e=d(t=t.slice(0),!1),s=0;s<e.length;s+=1)for(var i=e[s],n=t[i.start],r=(t[i.end]-n)/(i.end-i.start),o=i.start+1;o<i.end;o+=1)t[o]=n+(o-i.start)*r;for(var a=t.length;0<=a&&u(t[a-1]);)a-=1;if(0<a)for(var l=a;l<t.length;l+=1)t[l]=t[l-1]+(l===t.length-1?60:180);return t}e.prototype.isEmpty=function(){return 0===this.allCompetitors.length},e.prototype.getCourse=function(){return 0<this.classes.length?this.classes[0].course:null},e.prototype.getPrimaryClassName=function(){return 0<this.classes.length?this.classes[0].name:null},e.prototype.getNumClasses=function(){return this.classes.length},e.prototype.hasDubiousData=function(){return this.classes.some(function(t){return t.hasDubiousData})},e.prototype.getWinnerCumTimes=function(){if(0===this.allCompetitors.length)return null;var t=this.allCompetitors[0];return t.result.completed()?s(t.result.cumTimes):null},e.prototype.getFastestCumTimes=function(){return this.getFastestCumTimesPlusPercentage(0)},e.prototype.getFastestCumTimesPlusPercentage=function(t){if(null===this.numControls)return null;var s=1+t/100,r=new Array(this.numControls+1);r[0]=0;for(var e=1;e<=this.numControls+1;e+=1){for(var i=null,n=0;n<this.allCompetitors.length;n+=1){var o=this.allCompetitors[n].result.getSplitTimeTo(e);p(o)&&(null===i||o<i)&&(i=o)}r[e]=i}if(!r.every(c)){var a=d(r,!0),l=[];this.allCompetitors.forEach(function(e){d(e.result.getAllCumulativeTimes(),!1).forEach(function(t){l.push({start:t.start,end:t.end,size:t.end-t.start,overallSplit:e.result.getCumulativeTimeTo(t.end)-e.result.getCumulativeTimeTo(t.start)})})}),a.forEach(function(e){var t=l.filter(function(t){return t.start<=e.start&&e.end<=t.end+1}),s=null,i=null;if(t.forEach(function(t){(null===s||t.size<s)&&(s=t.size,i=null),(null===i||t.overallSplit<i)&&(i=t.overallSplit)}),null!==s&&null!==i)for(var n=e.start+1;n<e.end;n+=1)r[n]=i/s})}if(!r.every(c))for(var u=0;u<r.length;u+=1)null===r[u]&&(r[u]=u===r.length-1?60:180);var h=new Array(this.numControls+1);return r.forEach(function(t,e){h[e]=0===e?0:h[e-1]+t*s}),h},e.prototype.getCumulativeTimesForCompetitor=function(t){return s(this.allCompetitors[t].result.getAllCumulativeTimes())},e.prototype.computeRanks=function(){if(0!==this.allCompetitors.length){var i=[],n=[];this.allCompetitors.forEach(function(){i.push([]),n.push([])}),d3.range(1,this.numControls+2).forEach(function(e){var s=t(this.allCompetitors.map(function(t){return t.result.getSplitTimeTo(e)}));this.allCompetitors.forEach(function(t,e){i[e].push(s[e])})},this),d3.range(1,this.numControls+2).forEach(function(s){var i=t(this.allCompetitors.map(function(t,e){return 1<s&&null===n[e][s-1-1]&&!t.result.isOKDespiteMissingTimes?null:t.result.getCumulativeTimeTo(s)}));this.allCompetitors.forEach(function(t,e){n[e].push(i[e])})},this),this.allCompetitors.forEach(function(t,e){t.result.setSplitAndCumulativeRanks(i[e],n[e])})}},e.prototype.getFastestSplitsTo=function(t,n){if("number"!=typeof t||t<=0)r("The number of splits must be a positive integer");else{if(!("number"!=typeof n||n<=0||n>this.numControls+1)){var e=this.allCompetitors.filter(function(t){return t.result.completed()&&!u(t.result.getSplitTimeTo(n))});e.sort(function(t,e){var s=t.result.getSplitTimeTo(n),i=e.result.getSplitTimeTo(n);return s===i?d3.ascending(t.result.totalTime,e.result.totalTime):d3.ascending(s,i)});for(var s=[],i=0;i<e.length&&i<t;i+=1)s.push({name:e[i].name,split:e[i].result.getSplitTimeTo(n)});return s}r("Control "+n+" out of range")}},e.prototype.getChartData=function(e,t,s){if(void 0===e)throw new TypeError("referenceCumTimes undefined or missing");if(void 0===t)throw new TypeError("currentIndexes undefined or missing");if(void 0===s)throw new TypeError("chartType undefined or missing");var i,n,r=this.allCompetitors.map(function(t){return s.dataSelector(t.result,e)}),o=t.map(function(t){return r[t]}),a=d3.min(e),l=d3.max(e);if(0===t.length)if(this.isEmpty())i=0,n=60;else{var u=r[0];i=d3.min(u),n=d3.max(u)}else i=d3.min(o.map(function(t){return d3.min(t)})),n=d3.max(o.map(function(t){return d3.max(t)}));Math.abs(n-i)<1e-8&&(n=i+1);var h=s.skipStart?1:0,c=t.map(function(t){return s.indexesAroundOmittedTimesFunc(this.allCompetitors[t].result).filter(function(t){return t.start>=h}).map(function(t){return{start:t.start-h,end:t.end-h}})},this),p=d3.transpose(o),d=s.skipStart?e.slice(1):e,m=d3.zip(d,p),f=t.map(function(t){return this.allCompetitors[t].name},this);return{dataColumns:m.map(function(t){return{x:t[0],ys:t[1]}}),competitorNames:f,numControls:this.numControls,xExtent:[a,l],yExtent:[i,n],dubiousTimesInfo:c}},SplitsBrowser.Model.CourseClassSet=e}(),function(){"use strict";var r=SplitsBrowser.throwInvalidData;function t(t,e,s,i,n){this.name=t,this.classes=e,this.length=s,this.climb=i,this.controls=n}var a=t.START="__START__",l=t.FINISH="__FINISH__";t.prototype.getOtherClasses=function(e){var t=this.classes.filter(function(t){return t!==e});if(t.length!==this.classes.length)return t;r("Course.getOtherClasses: given class is not in this course")},t.prototype.getNumClasses=function(){return this.classes.length},t.prototype.hasControls=function(){return null!==this.controls},t.prototype.getControlCode=function(t){return 0===t?a:1<=t&&t<=this.controls.length?this.controls[t-1]:t===this.controls.length+1?l:void r("Cannot get control code of control "+t+" because it is out of range")},t.prototype.usesLeg=function(t,e){return 0<=this.getLegNumber(t,e)},t.prototype.getLegNumber=function(t,e){if(null===this.controls)return-1;if(t===a&&e===l)return 0===this.controls.length?1:-1;if(t===a)return 0<this.controls.length&&this.controls[0]===e?1:-1;if(e===l)return 0<this.controls.length&&this.controls[this.controls.length-1]===t?this.controls.length+1:-1;for(var s=1;s<this.controls.length;s+=1)if(this.controls[s-1]===t&&this.controls[s]===e)return s+1;return-1},t.prototype.getFastestSplitsForLeg=function(t,e){null===this.legs&&r("Cannot determine fastest splits for a leg because leg information is not available");var s=this.getLegNumber(t,e);s<0&&r("Leg from "+((t===a?"start":t)+" to "+(e===l?"end":e))+" not found in course "+this.name);var i=s,n=[];return this.classes.forEach(function(t){var e=t.getFastestSplitTo(i);null!==e&&n.push({name:e.name,className:t.name,split:e.split})}),n},t.prototype.getCompetitorsAtControlInTimeRange=function(t,e,s){if(null===this.controls)return[];if(t===a)return this.getCompetitorsAtControlNumInTimeRange(0,e,s);if(t===l)return this.getCompetitorsAtControlNumInTimeRange(this.controls.length+1,e,s);for(var i=-1,n=[],r=function(t){n.push(t)};;){var o=this.controls.indexOf(t,i+1);if(o<0)return n;this.getCompetitorsAtControlNumInTimeRange(o+1,e,s).forEach(r),i=o}},t.prototype.getCompetitorsAtControlNumInTimeRange=function(t,s,i){var n=[];return this.classes.forEach(function(e){e.getCompetitorsAtControlInTimeRange(t,s,i).forEach(function(t){n.push({name:t.name,time:t.time,className:e.name})})}),n},t.prototype.hasControl=function(t){return null!==this.controls&&-1<this.controls.indexOf(t)},t.prototype.getNextControls=function(t){if(null===this.controls)r("Course has no controls");else if(t===l)r("Cannot fetch next control after the finish");else{if(t===a)return[0===this.controls.length?l:this.controls[0]];for(var e=-1,s=[];;){var i=this.controls.indexOf(t,e+1);if(-1===i)break;i===this.controls.length-1?s.push(l):s.push(this.controls[i+1]),e=i}if(0!==s.length)return s;r("Control '"+t+"' not found on course "+this.name)}},SplitsBrowser.Model.Course=t}(),function(){"use strict";var s=SplitsBrowser.Model.Course;function t(t,e,s){this.classes=t,this.courses=e,this.warnings=s}t.prototype.determineTimeLosses=function(){this.classes.forEach(function(t){t.determineTimeLosses()})},t.prototype.needsRepair=function(){return this.classes.some(function(t){return t.competitors.some(function(t){return null===t.result.getAllCumulativeTimes()})})},t.prototype.getFastestSplitsForLeg=function(e,s){var i=[];return this.courses.forEach(function(t){t.usesLeg(e,s)&&(i=i.concat(t.getFastestSplitsForLeg(e,s)))}),i.sort(function(t,e){return d3.ascending(t.split,e.split)}),i},t.prototype.getCompetitorsAtControlInTimeRange=function(e,s,i){var n=[];return this.courses.forEach(function(t){t.getCompetitorsAtControlInTimeRange(e,s,i).forEach(function(t){n.push(t)})}),n.sort(function(t,e){return d3.ascending(t.time,e.time)}),n},t.prototype.getNextControlsAfter=function(e){var t=this.courses;return e!==s.START&&(t=t.filter(function(t){return t.hasControl(e)})),t.map(function(t){return{course:t,nextControls:t.getNextControls(e)}})},SplitsBrowser.Model.Event=t}(),function(){function s(t){return null===t?null:t/60}function t(t){return t.getControlIndexesAroundOmittedCumulativeTimes()}function e(t){return t.getControlIndexesAroundOmittedSplitTimes()}SplitsBrowser.Model.ChartTypes={SplitsGraph:{nameKey:"SplitsGraphChartType",dataSelector:function(t,e){return t.getCumTimesAdjustedToReference(e).map(s)},skipStart:!1,yAxisLabelKey:"SplitsGraphYAxisLabel",isRaceGraph:!1,isResultsTable:!1,minViewableControl:1,indexesAroundOmittedTimesFunc:t},RaceGraph:{nameKey:"RaceGraphChartType",dataSelector:function(t,e){return t.getCumTimesAdjustedToReferenceWithStartAdded(e).map(s)},skipStart:!1,yAxisLabelKey:"RaceGraphYAxisLabel",isRaceGraph:!0,isResultsTable:!1,minViewableControl:0,indexesAroundOmittedTimesFunc:t},PositionAfterLeg:{nameKey:"PositionAfterLegChartType",dataSelector:function(t){return t.cumRanks},skipStart:!0,yAxisLabelKey:"PositionYAxisLabel",isRaceGraph:!1,isResultsTable:!1,minViewableControl:1,indexesAroundOmittedTimesFunc:t},SplitPosition:{nameKey:"SplitPositionChartType",dataSelector:function(t){return t.splitRanks},skipStart:!0,yAxisLabelKey:"PositionYAxisLabel",isRaceGraph:!1,isResultsTable:!1,minViewableControl:1,indexesAroundOmittedTimesFunc:e},PercentBehind:{nameKey:"PercentBehindChartType",dataSelector:function(t,e){return t.getSplitPercentsBehindReferenceCumTimes(e)},skipStart:!1,yAxisLabelKey:"PercentBehindYAxisLabel",isRaceGraph:!1,isResultsTable:!1,minViewableControl:1,indexesAroundOmittedTimesFunc:e},ResultsTable:{nameKey:"ResultsTableChartType",dataSelector:null,skipStart:!1,yAxisLabelKey:null,isRaceGraph:!1,isResultsTable:!0,minViewableControl:1,indexesAroundOmittedTimesFunc:null}}}(),function(){"use strict";var n="number",r=SplitsBrowser.throwInvalidData;function t(t){typeof t!=n?r("Competitor count must be a number"):t<0&&r("Competitor count must be a non-negative number"),this.count=t,this.currentIndexes=[],this.changeHandlers=[]}t.prototype.isSelected=function(t){return-1<this.currentIndexes.indexOf(t)},t.prototype.isSingleRunnerSelected=function(){return 1===this.currentIndexes.length},t.prototype.getSingleRunnerIndex=function(){return this.isSingleRunnerSelected()?this.currentIndexes[0]:null},t.prototype.selectCrossingRunners=function(t){if(this.isSingleRunnerSelected()){var s=t[this.currentIndexes[0]].competitor.result;t.forEach(function(t,e){t.visible&&t.competitor.result.crosses(s)&&this.currentIndexes.push(e)},this),this.currentIndexes.sort(d3.ascending),this.fireChangeHandlers()}},t.prototype.fireChangeHandlers=function(){this.changeHandlers.forEach(function(t){t(this.currentIndexes.slice(0))},this)},t.prototype.selectAll=function(){this.currentIndexes=d3.range(this.count),this.fireChangeHandlers()},t.prototype.selectNone=function(){this.currentIndexes=[],this.fireChangeHandlers()},t.prototype.getSelectedIndexes=function(){return this.currentIndexes.slice(0)},t.prototype.setSelectedIndexes=function(t){t.every(function(t){return 0<=t&&t<this.count},this)&&(this.currentIndexes=t,this.fireChangeHandlers())},t.prototype.registerChangeHandler=function(t){-1===this.changeHandlers.indexOf(t)&&this.changeHandlers.push(t)},t.prototype.deregisterChangeHandler=function(t){var e=this.changeHandlers.indexOf(t);-1<e&&this.changeHandlers.splice(e,1)},t.prototype.toggle=function(t){if(typeof t==n)if(0<=t&&t<this.count){var e=this.currentIndexes.indexOf(t);-1===e?(this.currentIndexes.push(t),this.currentIndexes.sort(d3.ascending)):this.currentIndexes.splice(e,1),this.fireChangeHandlers()}else r("Index '"+t+"' is out of range");else r("Index is not a number")},t.prototype.bulkSelect=function(t){t.some(function(t){return typeof t!=n||t<0||t>=this.count},this)&&r("Indexes not all numeric and in range");var e=d3.set(this.currentIndexes);0<(t=t.filter(function(t){return!e.has(t)})).length&&(this.currentIndexes=this.currentIndexes.concat(t),this.currentIndexes.sort(d3.ascending),this.fireChangeHandlers())},t.prototype.bulkDeselect=function(t){t.some(function(t){return typeof t!=n||t<0||t>=this.count},this)&&r("Indexes not all numeric and in range");for(var e=d3.set(this.currentIndexes),s=!1,i=0;i<t.length;i+=1)e.has(t[i])&&(e.remove(t[i]),s=!0);s&&(this.currentIndexes=e.values().map(function(t){return parseInt(t,10)}),this.currentIndexes.sort(d3.ascending),this.fireChangeHandlers())},t.prototype.migrate=function(e,t){$.isArray(e)?$.isArray(t)?e.length!==this.count?r("CompetitorSelection.migrate: oldCompetitors list must have the same length as the current count"):0===t.length&&0<this.currentIndexes.length&&r("CompetitorSelection.migrate: newCompetitors list must not be empty if current list has competitors selected"):r("CompetitorSelection.migrate: newCompetitors not an array"):r("CompetitorSelection.migrate: oldCompetitors not an array");var s=this.currentIndexes.map(function(t){return e[t]});this.count=t.length,this.currentIndexes=[],t.forEach(function(t,e){0<=s.indexOf(t)&&this.currentIndexes.push(e)},this)},SplitsBrowser.Model.CompetitorSelection=t}(),function(){"use strict";function e(){this.madeAnyChanges=!1}var l=SplitsBrowser.isNotNullNorNaN,n=SplitsBrowser.throwInvalidData;function u(t){0!==t.length&&0===t[0]||n("cumulative times array does not start with a zero cumulative time");for(var e=0,s=1;s<t.length;s+=1){var i=t[s];if(l(i)){if(i<=t[e])return{first:e,second:s};e=s}}return null}e.prototype.removeCumulativeTimesEqualToPrevious=function(t){for(var e=t[0],s=1;s+1<t.length;s+=1)null!==t[s]&&(t[s]===e?(t[s]=NaN,this.madeAnyChanges=!0):e=t[s])},e.prototype.removeCumulativeTimesCausingNegativeSplits=function(t){for(var e=u(t);null!==e&&e.second+1<t.length;){for(var s=e.first,i=e.second,n=!1,r=1;r<=3;r+=1){var o=t.slice();if(3!==r||1!==s&&l(t[s-1])){1===r?o[i]=NaN:2===r?o[s]=NaN:3===r&&(o[s]=NaN,o[s-1]=NaN);var a=u(o);if(null===a||a.first>i){n=!0,t=o,this.madeAnyChanges=!0,e=a;break}}else;}if(!n)break}return t},e.prototype.removeFinishTimeIfAbsurd=function(t){var e=t[t.length-1],s=t[t.length-2];l(e)&&l(s)&&e<=s-300&&(t[t.length-1]=NaN,this.madeAnyChanges=!0)},e.prototype.repairCompetitor=function(t){var e=t.result.originalCumTimes.slice(0);this.removeCumulativeTimesEqualToPrevious(e),e=this.removeCumulativeTimesCausingNegativeSplits(e),t.result.completed()||this.removeFinishTimeIfAbsurd(e),t.result.setRepairedCumulativeTimes(e)},e.prototype.repairCourseClass=function(t){this.madeAnyChanges=!1,t.competitors.forEach(function(t){this.repairCompetitor(t)},this),this.madeAnyChanges&&t.recordHasDubiousData()},e.prototype.repairEventData=function(t){t.classes.forEach(function(t){this.repairCourseClass(t)},this)},SplitsBrowser.DataRepair={repairEventData:function(t){(new e).repairEventData(t)},transferCompetitorData:function(t){t.classes.forEach(function(t){t.competitors.forEach(function(t){t.result.setRepairedCumulativeTimes(t.result.getAllOriginalCumulativeTimes())})})}}}(),function(){"use strict";var l=SplitsBrowser.isTrue,u=SplitsBrowser.isNotNull,h=SplitsBrowser.throwInvalidData,c=SplitsBrowser.throwWrongFileFormat,o=SplitsBrowser.normaliseLineEndings,g=SplitsBrowser.parseTime,C=SplitsBrowser.Model.Result.fromCumTimes,v=SplitsBrowser.Model.Competitor,p=SplitsBrowser.Model.compareCompetitors,d=SplitsBrowser.Model.CourseClass,a=SplitsBrowser.Model.Course,m=SplitsBrowser.Model.Event;function f(t,s){var e=t.split(/\r?\n/).filter(l);0===e.length&&h("parseCourseClass got an empty list of lines");var i=e.shift().split(",");if(2===i.length){var n=i.shift(),r=i.shift(),o=parseInt(r,10);if(isNaN(o))h("Could not read control count: '"+r+"'");else{if(!(o<0&&0<e.length)){var a=e.map(function(t,e){return function(t,e,s,i,n){for(var r=e.split(",");r.length>s+5&&r[3].match(/[^0-9.,:-]/);)r[2]+=","+r[3],r.splice(3,1);var o=r.length,a=((r.shift()||"")+" "+(r.shift()||"")).trim()||"<name unknown>";if(o===s+5){var l=r.shift(),u=r.shift(),h=g(u);0===h?h=null:u.match(/^\d+:\d\d:\d\d$/)||(h*=60);var c=[0],p=0;r.map(function(t){var e=g(t);null!==e&&0<e?(p+=e,c.push(p)):c.push(null)});var d=C(t+1,h,c);return 0===p&&d.setNonStarter(),new v(a,l,d)}var m=o-(s+5),f=m<0?-m+" too few":m+" too many";return n.push("Competitor '"+a+"' appears to have the wrong number of split times - "+f+" (row "+(t+1)+" of class '"+i+"')"),null}(e,t,o,n,s)}).filter(u);return a.sort(p),new d(n,o,a)}h("Expected a non-negative control count, got "+o+" instead")}}else c("Expected first line to have two parts (class name and number of controls), got "+i.length+" part(s) instead")}SplitsBrowser.Input.CSV={parseEventData:function(t){/<html/i.test(t)&&c("Cannot parse this file as CSV as it appears to be HTML");var e=(t=(t=o(t)).replace(/,+\n/g,"\n").replace(/,+$/,"")).split(/\n\n/).map(function(t){return t.trim()}).filter(l),s=[],i=e.map(function(t){return f(t,s)});0===(i=i.filter(function(t){return!t.isEmpty()})).length&&h("No competitor data was found");for(var n=i.map(function(t){return new a(t.name,[t],null,null,null)}),r=0;r<i.length;r+=1)i[r].setCourse(n[r]);return new m(i,n,s)}}}(),function(){"use strict";var o=SplitsBrowser.throwInvalidData,n=SplitsBrowser.throwWrongFileFormat,f=SplitsBrowser.isNaNStrict,r=SplitsBrowser.parseCourseLength,a=SplitsBrowser.parseCourseClimb,e=SplitsBrowser.normaliseLineEndings,c=SplitsBrowser.parseTime,g=SplitsBrowser.Model.Result.fromOriginalCumTimes,C=SplitsBrowser.Model.Competitor,s=SplitsBrowser.Model.CourseClass,v=SplitsBrowser.Model.Course,i=SplitsBrowser.Model.Event,l=[";",",","\t","\\"],u={};[44,46,60].forEach(function(t){u[t]={course:t-7,distance:t-6,climb:t-5,controlCount:t-4,placing:t-3,startPunch:t-2,finish:t-1,control1:t}}),[44,46].forEach(function(t){u[t].nonCompetitive=t-38,u[t].startTime=t-37,u[t].time=t-35,u[t].classifier=t-34,u[t].club=t-31,u[t].className=t-28}),u[44].combinedName=3,u[44].yearOfBirth=4,u[46].forename=4,u[46].surname=3,u[46].yearOfBirth=5,u[46].gender=6,u[60].forename=6,u[60].surname=5,u[60].yearOfBirth=7,u[60].gender=8,u[60].combinedName=3,u[60].nonCompetitive=10,u[60].startTime=11,u[60].time=13,u[60].classifier=14,u[60].club=20,u[60].className=26,u[60].classNameFallback=u[60].course,u[60].clubFallback=18;function h(t){return'"'===t[0]&&'"'===t[t.length-1]&&(t=t.substring(1,t.length-1).replace(/""/g,'"').trim()),t}function p(t){this.data=e(t),this.classes=d3.map(),this.courseDetails=d3.map(),this.classCoursePairs=[],this.columnIndexes=null,this.warnings=[]}p.prototype.identifyDelimiter=function(){this.lines.length<=1&&n("No data found to read");for(var t=this.lines[1],e=0;e<l.length;e+=1){var s=l[e];if(37<t.split(s).length)return s}n("Data appears not to be in the OE CSV format")},p.prototype.identifyFormatVariation=function(t){var e=this.lines[1].split(t),s=/^[A-Za-z0-9]+$/;for(var i in u){if(u.hasOwnProperty(i))if((i=parseInt(i,10))<e.length&&s.test(e[i])&&(""===e[i-2].trim()||null!==c(e[i-2]))&&(""===e[i-1].trim()||null!==c(e[i-1])))if(""!==e[u[i].controlCount].trim())return void(this.columnIndexes=u[i])}n("Did not find control 1 at any of the supported indexes")},p.prototype.getClassName=function(t){var e=t[this.columnIndexes.className];return""===e&&this.columnIndexes.hasOwnProperty("classNameFallback")&&(e=t[this.columnIndexes.classNameFallback]),e},p.prototype.getStartTime=function(t){var e=t[this.columnIndexes.startPunch];return""===e&&(e=t[this.columnIndexes.startTime]),c(e)},p.prototype.getNumControls=function(t,e){var s,i=this.getClassName(t);if(""===i.trim())return s=this.getName(t)||"<name unknown>",this.warnings.push("Could not find a class for competitor '"+s+"' (line "+e+")"),null;if(this.classes.has(i))return this.classes.get(i).numControls;var n=parseInt(t[this.columnIndexes.controlCount],10);return isFinite(n)?n:(
s=this.getName(t)||"<name unknown>",this.warnings.push("Could not read the control count '"+t[this.columnIndexes.controlCount]+"' for competitor '"+s+"' from line "+e),null)},p.prototype.readCumulativeTimes=function(t,e,s){for(var i=[0],n=0;n<s;n+=1){var r=this.columnIndexes.control1+1+2*n,o=r<t.length?t[r]:null,a=null===o?null:c(o);i.push(a)}var l=c(t[this.columnIndexes.time]);if(null===l){var u=this.getStartTime(t),h=c(t[this.columnIndexes.finish]);null!==u&&null!==h&&(l=h-u)}return i.push(l),i},p.prototype.createClassIfNecessary=function(t,e){var s=this.getClassName(t);this.classes.has(s)||this.classes.set(s,{numControls:e,competitors:[]})},p.prototype.createCourseIfNecessary=function(e,t){var s=e[this.columnIndexes.course];if(!this.courseDetails.has(s)){var i=d3.range(0,t).map(function(t){return e[this.columnIndexes.control1+2*t]},this);this.courseDetails.set(s,{length:r(e[this.columnIndexes.distance]),climb:a(e[this.columnIndexes.climb]),controls:i})}},p.prototype.createClassCoursePairIfNecessary=function(t){var e=this.getClassName(t),s=t[this.columnIndexes.course];this.classCoursePairs.some(function(t){return t[0]===e&&t[1]===s})||this.classCoursePairs.push([e,s])},p.prototype.getName=function(t){var e="";this.columnIndexes.hasOwnProperty("forename")&&this.columnIndexes.hasOwnProperty("surname")&&(e=(t[this.columnIndexes.forename]+" "+t[this.columnIndexes.surname]).trim());return""===e&&this.columnIndexes.hasOwnProperty("combinedName")&&(e=t[this.columnIndexes.combinedName]),e},p.prototype.addCompetitor=function(t,e){var s=this.getClassName(t),i=t[this.columnIndexes.placing],n=t[this.columnIndexes.club];""===n&&this.columnIndexes.hasOwnProperty("clubFallback")&&(n=t[this.columnIndexes.clubFallback]);var r=this.getStartTime(t),o=this.getName(t),a=""!==i&&f(parseInt(i,10));a&&o.substring(o.length-i.length)===i&&(o=o.substring(0,o.length-i.length).trim());var l=this.classes.get(s).competitors.length+1,u=g(l,r,e);("1"===t[this.columnIndexes.nonCompetitive]||a)&&u.completed()&&u.setNonCompetitive();var h=t[this.columnIndexes.classifier];""!==h?"0"===h&&0<=e.indexOf(null)&&null!==e[e.length-1]?u.setOKDespiteMissingTimes():"1"===h?u.setNonStarter():"2"===h?u.setNonFinisher():"4"===h?u.disqualify():"5"===h&&u.setOverMaxTime():u.hasAnyTimes()||u.setNonStarter();var c=new C(o,n,u),p=t[this.columnIndexes.yearOfBirth];if(""!==p){var d=parseInt(p,10);f(d)||c.setYearOfBirth(d)}if(this.columnIndexes.hasOwnProperty("gender")){var m=t[this.columnIndexes.gender];"M"!==m&&"F"!==m||c.setGender(m)}this.classes.get(s).competitors.push(c)},p.prototype.readLine=function(t,e,s){if(""!==t.trim()){var i=t.split(s).map(function(t){return t.trim()}).map(h);i.length<37&&o("Too few items on line "+e+" of the input file: expected at least 37, got "+i.length);var n=this.getNumControls(i,e);if(null!==n){var r=this.readCumulativeTimes(i,e,n);this.createClassIfNecessary(i,n),this.createCourseIfNecessary(i,n),this.createClassCoursePairIfNecessary(i),this.addCompetitor(i,r)}}},p.prototype.getMapsBetweenClassesAndCourses=function(){var i=d3.map(),n=d3.map();return this.classCoursePairs.forEach(function(t){var e=t[0],s=t[1];i.has(e)?i.get(e).push(s):i.set(e,[s]),n.has(s)?n.get(s).push(e):n.set(s,[e])}),{classesToCourses:i,coursesToClasses:n}},p.prototype.createClasses=function(){var t=this.classes.keys();return t.sort(),t.map(function(t){var e=this.classes.get(t);return new s(t,e.numControls,e.competitors)},this)},p.prototype.createCourseFromLinkedClassesAndCourses=function(t,e,s,i){for(var n,r,o=[t],a=[],l=[],u=[];0<o.length||0<a.length;){for(;0<o.length;){n=o.shift();for(var h=e.coursesToClasses.get(n),c=0;c<h.length;c+=1)r=h[c],a.indexOf(r)<0&&u.indexOf(r)<0&&a.push(r);l.push(n)}for(;0<a.length;){r=a.shift();for(var p=e.classesToCourses.get(r),d=0;d<p.length;d+=1)n=p[d],o.indexOf(n)<0&&l.indexOf(n)<0&&o.push(n);u.push(r)}}l.forEach(function(t){s.add(t)});var m=u.map(function(t){return i.get(t)}),f=this.courseDetails.get(t),g=new v(t,m,f.length,f.climb,f.controls);return m.forEach(function(t){t.setCourse(g)}),g},p.prototype.determineCourses=function(t){var s=this.getMapsBetweenClassesAndCourses(),i=d3.set(),n=d3.map();t.forEach(function(t){n.set(t.name,t)});var r=[];return s.coursesToClasses.keys().forEach(function(t){if(!i.has(t)){var e=this.createCourseFromLinkedClassesAndCourses(t,s,i,n);r.push(e)}},this),r},p.prototype.parseEventData=function(){this.warnings=[],this.lines=this.data.split(/\n/);var s=this.identifyDelimiter();this.identifyFormatVariation(s),this.lines.shift(),this.lines.forEach(function(t,e){this.readLine(t,e+1,s)},this);var t=this.createClasses();0===t.length&&0<this.warnings.length&&n("This file may have looked vaguely like an OE CSV file but no data could be read out of it");var e=this.determineCourses(t);return new i(t,e,this.warnings)},SplitsBrowser.Input.OE={},SplitsBrowser.Input.OE.parseEventData=function(t){return new p(t).parseEventData()}}(),function(){"use strict";var d=SplitsBrowser.isNotNull,m=SplitsBrowser.throwInvalidData,i=SplitsBrowser.throwWrongFileFormat,s=SplitsBrowser.parseCourseLength,n=SplitsBrowser.normaliseLineEndings,f=SplitsBrowser.parseTime,r=SplitsBrowser.Model.Result.fromOriginalCumTimes,o=SplitsBrowser.Model.Competitor,l=SplitsBrowser.Model.CourseClass,u=SplitsBrowser.Model.Course,e=SplitsBrowser.Model.Event,a=/<[^>]+>/g,h=/([0-9.,]+)\s*(?:Km|km)/,c=/(\d+)\s*(?:Cm|Hm|hm|m)/;function p(t){return null!==t&&""!==t}function g(t){return""!==(t=t.trim())&&isFinite(t)}function C(t){return t.split(/\s+/g).filter(p)}function v(t){return t.replace(a,"")}function S(t,e){for(var s,i=[];null!==(s=t.exec(e));)i.push(v(s[1]));return i}function y(t){return S(/<font[^>]*>(.*?)<\/font>/g,t)}function T(t){return S(/<td[^>]*>(.*?)<\/td>/g,t).map(function(t){return t.trim()})}function x(t){return T(t).filter(function(t){return""!==t})}function w(t){var e=h.exec(t);return null===e?null:s(e[1])}function b(t){var e=c.exec(t);return null===e?null:parseInt(e[1],10)}function D(t){for(var e=[],s=0;s<t.length;s+=1){var i=t[s],n=i.indexOf("(");if(-1<n&&")"===i[i.length-1]){var r=i.substring(n+1,i.length-1);e.push(r)}else s+1===t.length?e.push(null):m("Unrecognised control header label: '"+i+"'")}return e}function L(t,e){for(;0<e.length&&"*"===e[e.length-1][0];)e.splice(e.length-1,1),t.splice(t.length-1,1)}function I(t,e,s,i,n,r){this.name=t,this.club=e,this.className=s,this.totalTime=i,this.cumTimes=n,this.competitive=r}I.prototype.isContinuation=function(){return""===this.name&&""===this.club&&null===this.className&&""===this.totalTime&&!this.competitive},I.prototype.append=function(t){if(!t.isContinuation())throw new Error("Can only append a continuation CompetitorParseRecord");this.cumTimes=this.cumTimes.concat(t.cumTimes)},I.prototype.toCompetitor=function(t){var e=[0].concat(this.cumTimes),s=r(t,null,e);return s.completed()&&!this.competitive&&s.setNonCompetitive(),s.hasAnyTimes()||s.setNonStarter(),new o(this.name,this.club,s)};function t(){this.precedingColumnCount=null}t.prototype.isTextOfThisFormat=function(t){return 0<=t.indexOf("<pre>")&&0<=t.indexOf("<font")},t.prototype.preprocess=function(t){var e=t.indexOf("<pre>");if(-1===e)throw new Error("Cannot find opening pre tag");var s=t.indexOf("\n",e),i=(t=(t=t.substring(s+1)).replace(/\n{2,}/g,"\n")).lastIndexOf("</pre>");return-1===i&&m("Found opening <pre> but no closing </pre>"),s=t.lastIndexOf("\n",i),(t=t.substring(0,s)).trim()},t.prototype.canIgnoreThisLine=function(t){return""===t},t.prototype.isCourseHeaderLine=function(t){return 2===y(t).length},t.prototype.parseCourseHeaderLine=function(t){var e=y(t);if(2!==e.length)throw new Error("Course header line should have two parts");var s=e[0],i=e[1],n=s.indexOf("("),r=-1<n?s.substring(0,n):s,o=w(i),a=b(i);return{name:r.trim(),distance:o,climb:a}},t.prototype.parseControlsLine=function(t){var e=t.lastIndexOf("</font>");return D(C((-1===e?t:t.substring(e+"</font>".length)).trim()))},t.prototype.readCompetitorSplitDataLine=function(t){for(var e=0;e<this.precedingColumnCount;e+=1){var s=t.indexOf("</font>");t=t.substring(s+"</font>".length)}return C(v(t))},t.prototype.parseCompetitor=function(t,e){var s=y(t),i=y(e);if(null===this.precedingColumnCount){var n=s[1].trim();this.precedingColumnCount=n.match(/^\d*$/)?4:3}var r=g(s[0]),o=s[this.precedingColumnCount-2].trim(),a=s[this.precedingColumnCount-1].trim(),l=i[this.precedingColumnCount-2].trim(),u=this.readCompetitorSplitDataLine(t),h=this.readCompetitorSplitDataLine(e);L(u=u.map(f),h);var c=null;if(null!==o&&""!==o){for(var p=-1,d=0;d<this.precedingColumnCount;d+=1)p=t.indexOf("</font>",p+1);var m=C(t.substring(0,p+"</font>".length).replace(/<font[^>]*>(.*?)<\/font>/g,""));0<m.length&&(c=m[0])}return new I(o,l,c,a,u,r)};function N(){this.timesOffset=null}N.prototype.isTextOfThisFormat=function(t){for(var e=-1,s=0;s<5;s+=1)if(-1===(e=t.indexOf("<table",e+1)))return!1;return!0},N.prototype.preprocess=function(t){var e=t.indexOf("</table>");-1===e&&m("Could not find any closing </table> tags");var s=(t=t.substring(e+"</table>".length)).indexOf("</div>"),i=t.indexOf("<table");return-1<s&&s<i&&(t=t.substring(s+"</div>".length)),(t=(t=(t=(t=(t=(t=t.replace(/>\n+</g,"><").replace(/><tr>/g,">\n<tr>").replace(/<\/tr></g,"</tr>\n<").replace(/><table/g,">\n<table").replace(/<\/table></g,"</table>\n<")).replace(/<\/col[^>]*>/g,"")).replace(/<tr[^>]*><td[^>]*>(?:<nobr>)?&nbsp;?(?:<\/nobr>)?<\/td><\/tr>/g,"")).replace(/<a id="[^"]*"><\/a>/g,"")).replace(/<div id="navigation">[\s\S]*?<\/div>/g,"")).replace("</body></html>","")).trim()},N.prototype.canIgnoreThisLine=function(t){if(-1<t.indexOf("<th>")){var e=function(t){return S(/<th[^>]*>(.*?)<\/th>/g,t).filter(function(t){return""!==t})}(t);return this.timesOffset=e.length,!0}return""===t||-1<t.indexOf("<table")||-1<t.indexOf("</table>")},N.prototype.isCourseHeaderLine=function(t){return-1<t.indexOf('<td id="header"')},N.prototype.parseCourseHeaderLine=function(t){var e=x(t);0===e.length&&m("No parts found in course header line");var s=e[0],i=s.indexOf("(");-1<i&&(s=s.substring(0,i)),s=s.trim();for(var n=null,r=null,o=1;o<e.length;o+=1)null===n&&(n=w(e[o])),null===r&&(r=b(e[o]));return{name:s,distance:n,climb:r}},N.prototype.parseControlsLine=function(t){return D(x(t))},N.prototype.readCompetitorSplitDataLine=function(t){for(var e=T(t),s=this.timesOffset,i=e.length;0<i&&""===e[i-1];)i-=1;return e.slice(s,i).filter(p)},N.prototype.parseCompetitor=function(t,e){var s=T(t),i=T(e),n=g(s[0]),r=3===this.timesOffset?1:2,o=s[r],a=s[this.timesOffset-1],l=i[r],u=5===this.timesOffset&&""!==o?s[3]:null,h=this.readCompetitorSplitDataLine(t),c=this.readCompetitorSplitDataLine(e);L(h=h.map(f),c);var p=h.filter(d).length;return p!==c.length&&m("Cumulative and split times do not have the same length: "+p+" cumulative times, "+c.length+" split times"),new I(o,l,u,a,h,n)};function O(){this.usesClasses=!1}function B(t,e,s){this.name=t,this.distance=e,this.climb=s,this.controls=[],this.competitors=[]}function M(t){this.recognizer=t,this.courses=[],this.currentCourse=null,this.lines=null,this.linePos=-1,this.currentCompetitor=null}O.prototype.isTextOfThisFormat=function(t){var e=t.indexOf("<table");if(0<=e){var s=t.indexOf("<table",e+1);if(0<=s)if(t.indexOf("<table",s+1)<0)return!0}return!1},O.prototype.preprocess=function(t){var e=t.indexOf("</table>");return-1===e&&m("Could not find any closing </table> tags"),0<=t.indexOf('<td colspan="25">')&&(this.usesClasses=!0),(t=(t=(t=(t=t.substring(e+"</table>".length)).replace(/<tr[^>]*><td colspan=[^>]*>&nbsp;<\/td><\/tr>/g,"")).replace(/\n{2,}/g,"\n")).replace("</body>","").replace("</html>","")).trim()},O.prototype.canIgnoreThisLine=function(t){return""===t||-1<t.indexOf("<table")||-1<t.indexOf("</table>")||-1<t.indexOf("<hr>")},O.prototype.isCourseHeaderLine=function(t){return-1<t.indexOf('<tr class="clubName"')},O.prototype.parseCourseHeaderLine=function(t){var e=x(t);0===e.length&&m("No parts found in course header line");var s,i,n,r=e[0],o=/^(.*?)\s+\((\d+)m,\s*(\d+)m\)$/.exec(r);return n=null===o?(s=r,i=null):(s=o[1],i=parseInt(o[2],10)/1e3,parseInt(o[3],10)),{name:s.trim(),distance:i,climb:n}},O.prototype.parseControlsLine=function(t){return x(t).map(function(t){var e=t.indexOf("-");return-1===e?null:t.substring(e+1)})},O.prototype.readCompetitorSplitDataLine=function(t){for(var e=this.usesClasses?5:4,s=t.length;0<s&&""===t[s-1];)s-=1;for(var i=[],n=e;n<s;n+=2){var r=t[n];p(r)&&i.push(r)}return i},O.prototype.parseCompetitor=function(t,e){for(var s=T(t),i=T(e),n=g(s[0]),r=s[2],o=s[this.usesClasses?4:3],a=this.usesClasses&&""!==r?s[3]:null,l=i[2],u=this.usesClasses?5:4;u<s.length&&u<i.length;u+=2)""!==s[u]&&""===i[u]&&(i[u]="----");var h=this.readCompetitorSplitDataLine(s),c=this.readCompetitorSplitDataLine(i);return L(h=h.map(f),c),h.length!==c.length&&m("Cumulative and split times do not have the same length: "+h.length+" cumulative times, "+c.length+" split times"),new I(r,l,a,o,h,n)},B.prototype.addControls=function(t){this.controls=this.controls.concat(t)},B.prototype.hasAllControls=function(){return 0<this.controls.length&&null===this.controls[this.controls.length-1]},B.prototype.addCompetitor=function(t){if(t.competitive||t.cumTimes.length!==this.controls.length-1||t.cumTimes.push(null),null===f(t.totalTime)&&0===t.cumTimes.length)for(;t.cumTimes.length<this.controls.length;)t.cumTimes.push(null);t.cumTimes.length===this.controls.length?this.competitors.push(t):m("Competitor '"+t.name+"' should have "+this.controls.length+" cumulative times, but has "+t.cumTimes.length+" times")},M.prototype.tryGetLine=function(){return this.linePos+1<this.lines.length?(this.linePos+=1,this.lines[this.linePos]):null},M.prototype.addCurrentCompetitorIfNecessary=function(){null!==this.currentCompetitor&&(this.currentCourse.addCompetitor(this.currentCompetitor),this.currentCompetitor=null)},M.prototype.addCurrentCompetitorAndCourseIfNecessary=function(){this.addCurrentCompetitorIfNecessary(),null!==this.currentCourse&&this.courses.push(this.currentCourse)},M.prototype.readCompetitorLines=function(t){var e=this.tryGetLine();null===e&&m("Hit end of input data unexpectedly while parsing competitor: first line was '"+t+"'");var s=this.recognizer.parseCompetitor(t,e);s.isContinuation()?null===this.currentCompetitor?m("First row of competitor data has no name nor time"):this.currentCompetitor.append(s):(this.addCurrentCompetitorIfNecessary(),this.currentCompetitor=s)},M.prototype.areClassesUniqueWithinCourses=function(){for(var t=d3.map(),e=0;e<this.courses.length;e+=1)for(var s=this.courses[e],i=0;i<s.competitors.length;i+=1){var n=s.competitors[i];if(t.has(n.className)){if(t.get(n.className)!==s.name)return!1}else t.set(n.className,s.name)}return!0},M.prototype.createOverallEventObject=function(){var s=this.areClassesUniqueWithinCourses(),t=[],a=[],i=this.courses.every(function(t){return t.competitors.every(function(t){return d(t.className)})});return this.courses.forEach(function(n){var r=d3.map();n.competitors.forEach(function(t){var e=i&&s?t.className:n.name;r.has(e)?r.get(e).push(t):r.set(e,[t])});var o=[];r.keys().forEach(function(t){var e=n.controls.length-1,s=r.get(t).map(function(t,e){return t.toCompetitor(e+1)}),i=new l(t,e,s);o.push(i),a.push(i)},this);var e=new u(n.name,o,n.distance,n.climb,n.controls.slice(0,n.controls.length-1));t.push(e),o.forEach(function(t){t.setCourse(e)})},this),new e(a,t,[])},M.prototype.parse=function(t){for(this.lines=t.split("\n");;){var e=this.tryGetLine();if(null===e)break;if(this.recognizer.canIgnoreThisLine(e));else if(this.recognizer.isCourseHeaderLine(e)){this.addCurrentCompetitorAndCourseIfNecessary();var s=this.recognizer.parseCourseHeaderLine(e);this.currentCourse=new B(s.name,s.distance,s.climb)}else if(null===this.currentCourse);else if(this.currentCourse.hasAllControls())this.readCompetitorLines(e);else{var i=this.recognizer.parseControlsLine(e);this.currentCourse.addControls(i)}}return this.addCurrentCompetitorAndCourseIfNecessary(),0===this.courses.length&&m("No competitor data was found"),this.createOverallEventObject()};var R=[t,N,O];SplitsBrowser.Input.Html={},SplitsBrowser.Input.Html.parseEventData=function(t){t=n(t);for(var e=0;e<R.length;e+=1){var s=new R[e];if(s.isTextOfThisFormat(t))return t=s.preprocess(t),new M(s).parse(t)}i("No HTML recognizers recognised this as HTML they could parse")}}(),function(){"use strict";var r=SplitsBrowser.throwWrongFileFormat,o=SplitsBrowser.normaliseLineEndings,p=SplitsBrowser.parseTime,u=SplitsBrowser.parseCourseLength,h=SplitsBrowser.parseCourseClimb,d=SplitsBrowser.Model.Result.fromOriginalCumTimes,m=SplitsBrowser.Model.Competitor,a=SplitsBrowser.Model.CourseClass,i=SplitsBrowser.Model.Course,l=SplitsBrowser.Model.Event,e={controlsOffset:38,step:3,name:3,club:5,courseName:7,startTime:8,length:null,climb:null,placing:null,finishTime:null,allowMultipleCompetitorNames:!0},n=[",",";"],c=/^[A-Za-z0-9]+$/;function f(t){for(var e=t.length-1;0<=e&&""===t[e];)e-=1;t.splice(e+1,t.length-e-1)}function s(t){this.format=t,this.classes=d3.map(),this.delimiter=null,this.hasAnyStarters=!1,this.warnings=[],this.controlsTerminationOffset=null===t.finishTime?t.step:0}s.prototype.determineDelimiter=function(t){for(var e=0;e<n.length;e+=1){var s=n[e],i=t.split(s);if(f(i),i.length>this.format.controlsOffset)return s}return null},s.prototype.adjustLinePartsForMultipleCompetitors=function(t){if(this.format.allowMultipleCompetitorNames)for(;t.length>this.format.name+1&&t[this.format.name+1].match(/^\s\S/);)t[this.format.name]+=","+t[this.format.name+1],t.splice(this.format.name+1,1)},s.prototype.checkControlCodesAlphaNumeric=function(t){var e=t.split(this.delimiter);f(e),this.adjustLinePartsForMultipleCompetitors(e,this.format);for(var s=this.format.controlsOffset;s+this.controlsTerminationOffset<e.length;s+=this.format.step)c.test(e[s])||r("Data appears not to be in an alternative CSV format - data in cell "+s+" of the first row ('"+e[s]+"') is not an number")},s.prototype.addCompetitorToCourse=function(t,e,s){if(this.classes.has(e)){var i=this.classes.get(e),n=t.result.getAllOriginalCumulativeTimes();n.length-1!==i.controls.length+1?this.warnings.push("Competitor '"+t.name+"' has the wrong number of splits for course '"+e+"': expected "+(i.controls.length+1)+", actual "+(n.length-1)):i.competitors.push(t)}else{for(var r=[],o=this.format.controlsOffset;o+this.controlsTerminationOffset<s.length;o+=this.format.step)r.push(s[o]);var a=null===this.format.length?null:u(s[this.format.length]),l=null===this.format.climb?null:h(s[this.format.climb]);this.classes.set(e,{length:a,climb:l,controls:r,competitors:[t]})}},s.prototype.readDataRow=function(t){var e=t.split(this.delimiter);if(f(e),this.adjustLinePartsForMultipleCompetitors(e),!(e.length<this.format.controlsOffset)){for(;(e.length-this.format.controlsOffset)%this.format.step!=0;)e.push("");for(var s=e[this.format.name],i=e[this.format.club],n=e[this.format.courseName],r=p(e[this.format.startTime]),o=[0],a=this.format.controlsOffset+1;a<e.length;a+=this.format.step)o.push(p(e[a]));if(null!==this.format.finishTime){var l=p(e[this.format.finishTime]),u=null===r||null===l?null:l-r;o.push(u)}if(1!==o.length){var h=this.classes.has(n)?this.classes.get(n).competitors.length+1:1,c=d(h,r,o);if(null!==this.format.placing&&c.completed())e[this.format.placing].match(/^\d*$/)||c.setNonCompetitive();c.hasAnyTimes()?this.hasAnyStarters=!0:c.setNonStarter(),this.addCompetitorToCourse(new m(s,i,c),n,e)}else""!==s&&this.warnings.push("Competitor '"+s+"' on course '"+(""===n?"(unnamed)":n)+"' has no times recorded")}},s.prototype.createClassesAndCourses=function(){var r=[],o=d3.map();this.classes.entries().forEach(function(t){var e=t.key,s=t.value,i=new a(e,s.controls.length,s.competitors);r.push(i);var n=s.controls.join(",");o.has(n)?o.get(n).classes.push(i):o.set(n,{name:e,classes:[i],length:s.length,climb:s.climb,controls:s.controls})});var s=[];return o.values().forEach(function(t){var e=new i(t.name,t.classes,t.length,t.climb,t.controls);t.classes.forEach(function(t){t.setCourse(e)}),s.push(e)}),{classes:r,courses:s}},s.prototype.parseEventData=function(t){this.warnings=[];var e=(t=o(t)).split(/\n/);e.length<2&&r("Data appears not to be in an alternative CSV format - too few lines");var s=e[1];this.delimiter=this.determineDelimiter(s),null===this.delimiter&&r("Data appears not to be in an alternative CSV format - first data line has fewer than "+this.format.controlsOffset+" parts when separated by any recognised delimiter"),this.checkControlCodesAlphaNumeric(s);for(var i=1;i<e.length;i+=1)this.readDataRow(e[i]);var n=this.createClassesAndCourses();return this.hasAnyStarters||r("Data appears not to be in an alternative CSV format - data apparently could be read but everyone was a non-starter"),new l(n.classes,n.courses,this.warnings)},SplitsBrowser.Input.AlternativeCSV={parseTripleColumnEventData:function(t){return new s(e).parseEventData(t)}}}(),function(){"use strict";var n=SplitsBrowser.throwInvalidData,h=SplitsBrowser.throwWrongFileFormat,c=SplitsBrowser.isNaNStrict,i=SplitsBrowser.parseTime,y=SplitsBrowser.Model.Result.fromOriginalCumTimes,T=SplitsBrowser.Model.Competitor,p=SplitsBrowser.Model.CourseClass,d=SplitsBrowser.Model.Course,m=SplitsBrowser.Model.Event;function l(t){return void 0===t}var x=/^\d{4}/,t={isOfThisVersion:function(t){return 0<=t.indexOf("IOFdata.dtd")},checkVersion:function(t){var e=$("> IOFVersion",t);if(0===e.length)h("Could not find IOFVersion element");else{var s=e.attr("version");l(s)?h("Version attribute missing from IOFVersion element"):"2.0.3"!==s&&h("Found unrecognised IOF XML data format '"+s+"'")}var i=t.attr("status");l(i)||"complete"===i.toLowerCase()||n("Only complete IOF data supported; snapshot and delta are not supported")},readClassName:function(t){return $("> ClassShortName",t).text()},readCourseFromClass:function(t,e){var s=$("> ClassShortName",t).text(),i=$("> PersonResult > Result",t).first(),n=null;if(0<i.length){var r=$("> CourseLength",i),o=r.text();if(0<o.length)if(n=parseFloat(o),isFinite(n)){var a=r.attr("unit");l(a)||"m"===a?n/=1e3:"km"===a||("ft"===a?n/=3280:(e.push("Course '"+s+"' gives its length in a unit '"+a+"', but this unit was not recognised"),n=null))}else e.push("Course '"+s+"' specifies a course length that was not understood: '"+o+"'"),n=null}return{id:null,name:s,length:n,climb:null,numberOfControls:null}},getCompetitorNameElement:function(t){return $("> Person > PersonName",t)},readClubName:function(t){return $("> Club > ShortName",t).text()},readDateOfBirth:function(t){return $("> Person > BirthDate > Date",t).text()},readStartTime:function(t){var e=$("> StartTime > Clock",t).text();return""===e?null:i(e)},readTotalTime:function(t){var e=$("> Time",t).text();return""===e?null:i(e)},getStatus:function(t){var e=$("> CompetitorStatus",t);return 1===e.length?e.attr("value"):""},StatusNonCompetitive:"NotCompeting",StatusNonStarter:"DidNotStart",StatusNonFinisher:"DidNotFinish",StatusDisqualified:"Disqualified",StatusOverMaxTime:"OverTime",isAdditional:function(){return!1},readSplitTime:function(t){var e=$("> ControlCode",t).text();""===e&&(e=$("> Control > ControlCode",t).text()),""===e&&n("Control code missing for control");var s=$("> Time",t).text();return{code:e,time:""===s?null:i(s)}}},r=/^\d\d\d\d-?\d\d-?\d\dT?(\d\d):?(\d\d)(?::?(\d\d))?/,o={isOfThisVersion:function(t){return 0<=t.indexOf("http://www.orienteering.org/datastandard/3.0")},checkVersion:function(t){var e=t.attr("iofVersion");l(e)?h("Could not find IOF version number"):"3.0"!==e&&h("Found unrecognised IOF XML data format '"+e+"'");var s=t.attr("status");l(s)||"complete"===s.toLowerCase()||n("Only complete IOF data supported; snapshot and delta are not supported")},readClassName:function(t){return $("> Class > Name",t).text()},readCourseFromClass:function(t,e){var s,i=$("> Course",t),n=$("> Id",i).text()||null,r=$("> Name",i).text(),o=$("> Length",i).text();""===o?s=null:(s=parseInt(o,10),c(s)?(e.push("Course '"+r+"' specifies a course length that was not understood: '"+o+"'"),s=null):s/=1e3);var a=$("> NumberOfControls",i).text(),l=parseInt(a,10);c(l)&&(l=null);var u=$("> Climb",i).text(),h=parseInt(u,10);return c(h)&&(h=null),{id:n,name:r,length:s,climb:h,numberOfControls:l}},getCompetitorNameElement:function(t){return $("> Person > Name",t)},readClubName:function(t){return $("> Organisation > ShortName",t).text()},readDateOfBirth:function(t){var e=$("> Person > BirthDate",t).text(),s=x.exec(e);return null===s?null:parseInt(s[0],10)},readStartTime:function(t){var e=$("> StartTime",t).text(),s=r.exec(e);return null===s?null:60*parseInt(s[1],10)*60+60*parseInt(s[2],10)+(l(s[3])?0:parseInt(s[3],10))},readTime:function(t){var e=parseFloat(t);return isFinite(e)?e:null},readTotalTime:function(t){var e=$("> Time",t).text();return o.readTime(e)},getStatus:function(t){return $("> Status",t).text()},StatusNonCompetitive:"NotCompeting",StatusNonStarter:"DidNotStart",StatusNonFinisher:"DidNotFinish",StatusDisqualified:"Disqualified",StatusOverMaxTime:"OverTime",isAdditional:function(t){return"Additional"===t.attr("status")},readSplitTime:function(t){var e,s=$("> ControlCode",t).text();if(""===s&&n("Control code missing for control"),"Missing"===t.attr("status"))e=null;else{var i=$("> Time",t).text();e=""===i?null:o.readTime(i)}return{code:s,time:e}}},f=[t,o];function g(t,e,s,i){var n=$(t),r=function(t){var e=$("> Given",t).text(),s=$("> Family",t).text();return""===e?s:""===s?e:e+" "+s}(s.getCompetitorNameElement(n));if(""===r)return i.push("Could not find a name for a competitor"),null;var o=s.readClubName(n),a=s.readDateOfBirth(n),l=x.exec(a),u=null===l?null:parseInt(l[0],10),h=$("> Person",n).attr("sex"),c=$("Result",n);if(0===c.length)return i.push("Could not find any result information for competitor '"+r+"'"),null;var p=s.readStartTime(c),d=s.readTotalTime(c),m=$("> SplitTime",c).toArray().filter(function(t){return!s.isAdditional($(t))}).map(function(t){return s.readSplitTime($(t))}),f=m.map(function(t){return t.code}),g=m.map(function(t){return t.time});g.unshift(0),g.push(d);var C=y(e,p,g),v=s.getStatus(c);"OK"===v&&null!==d&&0<=g.indexOf(null)?C.setOKDespiteMissingTimes():v===s.StatusNonCompetitive?C.setNonCompetitive():v===s.StatusNonStarter?C.setNonStarter():v===s.StatusNonFinisher?C.setNonFinisher():v===s.StatusDisqualified?C.disqualify():v===s.StatusOverMaxTime&&C.setOverMaxTime();var S=new T(r,o,C);return null!==u&&S.setYearOfBirth(u),"M"!==h&&"F"!==h||S.setGender(h),{competitor:S,controls:f}}SplitsBrowser.Input.IOFXml={parseEventData:function(t){var r=function(t){for(var e=0;e<f.length;e+=1){var s=f[e];if(s.isOfThisVersion(t))return s}h("Data apparently not of any recognised IOF XML format")}(t),e=function(t){var e;try{e=$.parseXML(t)}catch(t){n("XML data not well-formed")}return 0===$("> *",$(e)).length&&n("XML data not well-formed: "+t),e}(t);!function(t,e){var s=$("> *",t),i=s.prop("tagName");"ResultList"!==i&&h("Root element of XML document does not have expected name 'ResultList', got '"+i+"'"),e.checkVersion(s)}(e,r);var s=$("> ResultList > ClassResult",$(e)).toArray();0===s.length&&n("No class result elements found");var o=[],a=[],l=d3.map(),u=[];s.forEach(function(t){var e=function(t,e,s){var i=$(t),n={name:null,competitors:[],controls:[],course:null};n.course=e.readCourseFromClass(i,s);var r=e.readClassName(i);""===r&&(r="<unnamed class>"),n.name=r;var o=$("> PersonResult",i);if(0===o.length)return s.push("Class '"+r+"' has no competitors"),null;for(var a=0;a<o.length;a+=1){var l=g(o[a],a+1,e,s);if(null!==l){var u=l.competitor,h=l.controls;0!==n.competitors.length||u.isNonStarter&&0===h.length||(n.controls=h,null===n.course.numberOfControls&&(n.course.numberOfControls=n.controls.length));var c=u.result.getAllOriginalCumulativeTimes().length-2,p=null;if(u.result.isNonStarter&&0==c);else if(c!==n.course.numberOfControls)p="Competitor '"+u.name+"' in class '"+r+"' has an unexpected number of controls: expected "+n.course.numberOfControls+", actual "+c;else for(var d=0;d<c;d+=1)if(n.controls[d]!==h[d]){p="Competitor '"+u.name+"' has an unexpected control code at control "+(d+1)+": expected '"+n.controls[d]+"', actual '"+h[d]+"'";break}null===p?n.competitors.push(u):s.push(p)}}return null===n.course.id&&0<n.controls.length&&(n.course.id=n.controls.join(",")),n}(t,r,u);if(null!==e){var s=new p(e.name,e.controls.length,e.competitors);o.push(s);var i=e.course,n=i.id+","+e.controls.join(",");null!==i.id&&l.has(n)?l.get(n).classes.push(s):(i.classes=[s],i.controls=e.controls,a.push(i),null!==i.id&&l.set(n,i))}});var i=a.map(function(t){var e=new d(t.name,t.classes,t.length,t.climb,t.controls);return t.classes.forEach(function(t){t.setCourse(e)}),e});return new m(o,i,u)}}}(),function(){"use strict";var i=[SplitsBrowser.Input.CSV.parseEventData,SplitsBrowser.Input.OE.parseEventData,SplitsBrowser.Input.Html.parseEventData,SplitsBrowser.Input.AlternativeCSV.parseTripleColumnEventData,SplitsBrowser.Input.IOFXml.parseEventData];SplitsBrowser.Input.parseEventData=function(t){for(var e=0;e<i.length;e+=1){var s=i[e];try{return s(t)}catch(t){if("WrongFileFormat"!==t.name)throw t}}return null}}(),function(){"use strict";function t(t,e){this.parent=t,this.alerter=e,this.handler=null,this.competitorSelection=null,this.lastFilterString="",this.allCompetitors=[],this.allCompetitorDetails=[],this.dragging=!1,this.dragStartCompetitorIndex=null,this.currentDragCompetitorIndex=null,this.allCompetitorDivs=[],this.inverted=!1,this.placeholderDiv=null,this.changeHandlers=[],this.containerDiv=d3.select(t).append("div").attr("id","competitorListContainer"),this.buttonsPanel=this.containerDiv.append("div");var s=this;this.allButton=this.buttonsPanel.append("button").attr("id","selectAllCompetitors").style("width","50%").on("click",function(){s.selectAllFiltered()}),this.noneButton=this.buttonsPanel.append("button").attr("id","selectNoCompetitors").style("width","50%").on("click",function(){s.selectNoneFiltered()}),$(this.noneButton.node()).dblclick(function(){s.selectNone()}),this.buttonsPanel.append("br"),this.crossingRunnersButton=this.buttonsPanel.append("button").attr("id","selectCrossingRunners").style("width","100%").on("click",function(){s.selectCrossingRunners()}).style("display","none"),this.filter=this.buttonsPanel.append("input").attr("type","text"),this.filter.on("input",function(){s.updateFilterIfChanged()}).on("keyup",function(){s.updateFilterIfChangedDelayed()}).on("mouseup",function(){s.updateFilterIfChangedDelayed()}),this.listDiv=this.containerDiv.append("div").attr("id","competitorList"),this.listDiv.on("mousedown",function(){s.startDrag(-1)}).on("mousemove",function(){s.mouseMove(-1)}).on("mouseup",function(){s.stopDrag()}),d3.select(document.body).on("mouseup",function(){s.stopDrag()}),this.setMessages()}var n=SplitsBrowser.getMessage,s=SplitsBrowser.getMessageWithFormatting;function r(t){return t.toLowerCase().replace(/\W/g,"")}function o(t){return t.result.completed()?""===t.name?"\xa0":t.name:"* "+t.name}t.prototype.setMessages=function(){this.allButton.text(n("SelectAllCompetitors")),this.noneButton.text(n("SelectNoCompetitors")),this.crossingRunnersButton.text(n("SelectCrossingRunners")),this.filter.attr("placeholder",n("CompetitorListFilter"))},t.prototype.retranslate=function(){this.setMessages(),null!==this.placeholderDiv&&(this.placeholderDiv.text(n("NoCompetitorsStarted")),this.fireChangeHandlers())},t.prototype.registerChangeHandler=function(t){-1===this.changeHandlers.indexOf(t)&&this.changeHandlers.push(t)},t.prototype.deregisterChangeHandler=function(t){var e=this.changeHandlers.indexOf(t);-1<e&&this.changeHandlers.splice(e,1)},t.prototype.fireChangeHandlers=function(){this.changeHandlers.forEach(function(t){t()},this)},t.prototype.isMouseOffBottomOfCompetitorList=function(){return null===this.lastVisibleDiv||d3.mouse(this.lastVisibleDiv)[1]>=$(this.lastVisibleDiv).height()},t.prototype.getDragClassName=function(){return this.inverted?"dragDeselected":"dragSelected"},t.prototype.startDrag=function(t){if(1===d3.event.which){this.dragStartCompetitorIndex=t,this.currentDragCompetitorIndex=t,this.allCompetitorDivs=$("div.competitor");var e=this.allCompetitorDivs.filter(":visible");if(this.lastVisibleDiv=0===e.length?null:e[e.length-1],this.inverted=d3.event.shiftKey,-1===t){if(!this.isMouseOffBottomOfCompetitorList())return}else d3.select(this.allCompetitorDivs[t]).classed(this.getDragClassName(),!0);d3.event.stopPropagation(),this.dragging=!0}},t.prototype.mouseMove=function(t){if(this.dragging&&(d3.event.stopPropagation(),t!==this.currentDragCompetitorIndex)){var e,s,i=this.getDragClassName();if(d3.selectAll("div.competitor."+i).classed(i,!1),
-1===this.dragStartCompetitorIndex&&-1===t)return;if(-1===t&&!this.isMouseOffBottomOfCompetitorList())return;s=-1===this.dragStartCompetitorIndex||-1===t?(e=this.dragStartCompetitorIndex+t- -1,this.allCompetitorDivs.length-1):(e=Math.min(this.dragStartCompetitorIndex,t),Math.max(this.dragStartCompetitorIndex,t));for(var n=[],r=e;r<=s;r+=1)this.allCompetitorDetails[r].visible&&n.push(this.allCompetitorDivs[r]);d3.selectAll(n).classed(i,!0),this.currentDragCompetitorIndex=t}},t.prototype.stopDrag=function(){if(this.dragging){this.dragging=!1;for(var t=[],e=this.getDragClassName(),s=0;s<this.allCompetitorDivs.length;s+=1)$(this.allCompetitorDivs[s]).hasClass(e)&&t.push(s);d3.selectAll("div.competitor."+e).classed(e,!1),d3.event.currentTarget===document||-1===this.currentDragCompetitorIndex&&!this.isMouseOffBottomOfCompetitorList()||(1===t.length?this.toggleCompetitor(t[0]):this.inverted?this.competitorSelection.bulkDeselect(t):this.competitorSelection.bulkSelect(t)),this.dragStartCompetitorIndex=null,this.currentDragCompetitorIndex=null,d3.event.stopPropagation()}},t.prototype.width=function(){return $(this.containerDiv.node()).width()},t.prototype.setHeight=function(t){$(this.listDiv.node()).height(t-$(this.buttonsPanel.node()).height())},t.prototype.getAllVisibleIndexes=function(){return d3.range(this.allCompetitorDetails.length).filter(function(t){return this.allCompetitorDetails[t].visible},this)},t.prototype.selectAllFiltered=function(){this.competitorSelection.bulkSelect(this.getAllVisibleIndexes())},t.prototype.selectNoneFiltered=function(){this.competitorSelection.bulkDeselect(this.getAllVisibleIndexes())},t.prototype.selectNone=function(){this.competitorSelection.selectNone()},t.prototype.isSelected=function(t){return null!==this.competitorSelection&&this.competitorSelection.isSelected(t)},t.prototype.selectCrossingRunners=function(){if(this.competitorSelection.selectCrossingRunners(this.allCompetitorDetails),this.competitorSelection.isSingleRunnerSelected()){var t=this.allCompetitors[this.competitorSelection.getSingleRunnerIndex()].name,e=0<this.lastFilterString.length?"RaceGraphNoCrossingRunnersFiltered":"RaceGraphNoCrossingRunners";this.alerter(s(e,{$$NAME$$:t}))}},t.prototype.enableOrDisableCrossingRunnersButton=function(){this.crossingRunnersButton.node().disabled=!this.competitorSelection.isSingleRunnerSelected()},t.prototype.setChartType=function(t){this.crossingRunnersButton.style("display",t.isRaceGraph?"block":"none")},t.prototype.selectionChanged=function(){var s=this;this.listDiv.selectAll("div.competitor").data(d3.range(this.competitorSelection.count)).classed("selected",function(t,e){return s.isSelected(e)})},t.prototype.toggleCompetitor=function(t){this.competitorSelection.toggle(t)},t.prototype.setCompetitorList=function(t,e){this.allCompetitors=t,this.allCompetitorDetails=this.allCompetitors.map(function(t){return{competitor:t,normedName:r(t.name),visible:!0}}),null!==this.placeholderDiv&&(this.placeholderDiv.remove(),this.placeholderDiv=null);var s=this.listDiv.selectAll("div.competitor").data(this.allCompetitors),i=this;s.enter().append("div").classed("competitor",!0).classed("selected",function(t,e){return i.isSelected(e)}),s.selectAll("span").remove(),s=this.listDiv.selectAll("div.competitor").data(this.allCompetitors),e&&s.append("span").classed("competitorClassLabel",!0).text(function(t){return t.className}),s.append("span").classed("nonfinisher",function(t){return!t.result.completed()}).text(o),s.exit().remove(),0===this.allCompetitors.length&&(this.placeholderDiv=this.listDiv.append("div").classed("competitorListPlaceholder",!0).text(n("NoCompetitorsStarted"))),this.allButton.property("disabled",0===this.allCompetitors.length),this.noneButton.property("disabled",0===this.allCompetitors.length),this.filter.property("disabled",0===this.allCompetitors.length),s.on("mousedown",function(t,e){i.startDrag(e)}).on("mousemove",function(t,e){i.mouseMove(e)}).on("mouseup",function(){i.stopDrag()}),this.updateFilter()},t.prototype.setSelection=function(t){null!==this.competitorSelection&&this.competitorSelection.deregisterChangeHandler(this.handler);var e=this;this.competitorSelection=t,this.handler=function(){e.selectionChanged()},this.competitorSelection.registerChangeHandler(this.handler),this.selectionChanged()},t.prototype.getFilterText=function(){return this.filter.node().value},t.prototype.setFilterText=function(t){this.filter.node().value=t,this.updateFilterIfChanged()},t.prototype.updateFilter=function(){var e=r(this.filter.node().value);this.allCompetitorDetails.forEach(function(t){t.visible=0<=t.normedName.indexOf(e)});var s=this;this.listDiv.selectAll("div.competitor").style("display",function(t,e){return s.allCompetitorDetails[e].visible?null:"none"})},t.prototype.updateFilterIfChanged=function(){var t=this.getFilterText();t!==this.lastFilterString&&(this.updateFilter(),this.lastFilterString=t,this.fireChangeHandlers())},t.prototype.updateFilterIfChangedDelayed=function(){var t=this;setTimeout(function(){t.updateFilterIfChanged()},1)},SplitsBrowser.Controls.CompetitorList=t}(),function(){"use strict";var t=SplitsBrowser.getMessage,n=SplitsBrowser.getAllLanguages,r=SplitsBrowser.getLanguage,o=SplitsBrowser.getLanguageName,e=SplitsBrowser.setLanguage;function s(t){if(this.changeHandlers=[],this.label=null,this.dropDown=null,this.allLanguages=n(),!(this.allLanguages.length<2)){d3.select(t).append("div").classed("topRowStartSpacer",!0);var e=d3.select(t).append("div").classed("topRowStart",!0);this.label=e.append("span");var s=this;this.dropDown=e.append("select").node(),$(this.dropDown).bind("change",function(){s.onLanguageChanged()});var i=d3.select(this.dropDown).selectAll("option").data(this.allLanguages);i.enter().append("option"),(i=d3.select(this.dropDown).selectAll("option").data(this.allLanguages)).attr("value",function(t){return t}).text(function(t){return o(t)}),i.exit().remove(),this.setLanguage(r()),this.setMessages()}}s.prototype.setMessages=function(){this.label.text(t("LanguageSelectorLabel"))},s.prototype.registerChangeHandler=function(t){-1===this.changeHandlers.indexOf(t)&&this.changeHandlers.push(t)},s.prototype.setLanguage=function(t){var e=this.allLanguages.indexOf(t);0<=e&&(this.dropDown.selectedIndex=e,this.onLanguageChanged())},s.prototype.onLanguageChanged=function(){e(this.dropDown.options[this.dropDown.selectedIndex].value),this.changeHandlers.forEach(function(t){t()})},SplitsBrowser.Controls.LanguageSelector=s}(),function(){"use strict";var i=SplitsBrowser.throwInvalidData,n=SplitsBrowser.getMessage;function t(t){this.changeHandlers=[],this.otherClassesEnabled=!0;var e=d3.select(t).append("div").classed("topRowStart",!0);this.labelSpan=e.append("span");var i=this;this.dropDown=e.append("select").node(),$(this.dropDown).bind("change",function(){i.updateOtherClasses(d3.set()),i.onSelectionChanged()}),this.otherClassesContainer=d3.select(t).append("div").attr("id","otherClassesContainer").classed("topRowStart",!0).style("display","none"),this.otherClassesCombiningLabel=this.otherClassesContainer.append("span").classed("otherClassCombining",!0),this.otherClassesSelector=this.otherClassesContainer.append("div").classed("otherClassSelector",!0).style("display","inline-block"),this.otherClassesSpan=this.otherClassesSelector.append("span"),this.otherClassesList=d3.select(t).append("div").classed("otherClassList",!0).classed("transient",!0).style("position","absolute").style("display","none"),this.otherClassesSelector.on("click",function(){i.showHideClassSelector()}),this.setClasses([]),this.selectedOtherClassIndexes=d3.set(),$(document).click(function(t){var e=i.otherClassesList.node();if("none"!==e.style.display){var s=$("div.otherClassList,div.otherClassSelector");s.is(t.target)||0!==s.has(t.target).length||(e.style.display="none")}}),this.setMessages()}t.prototype.setMessages=function(){this.labelSpan.text(n("ClassSelectorLabel")),this.otherClassesCombiningLabel.text(n("AdditionalClassSelectorLabel"))},t.prototype.setOtherClassesEnabled=function(t){this.otherClassesCombiningLabel.classed("disabled",!t),this.otherClassesSelector.classed("disabled",!t),this.otherClassesEnabled=t},t.prototype.setClasses=function(t){if($.isArray(t)){var e;e=0===(this.classes=t).length?(this.dropDown.disabled=!0,[n("NoClassesLoadedPlaceholder")]):(this.dropDown.disabled=!1,t.map(function(t){return t.name}));var s=d3.select(this.dropDown).selectAll("option").data(e);s.enter().append("option"),(s=d3.select(this.dropDown).selectAll("option").data(e)).attr("value",function(t,e){return e.toString()}).text(function(t){return t}),s.exit().remove(),this.updateOtherClasses(d3.set())}else i("ClassSelector.setClasses: classes is not an array")},t.prototype.registerChangeHandler=function(t){-1===this.changeHandlers.indexOf(t)&&this.changeHandlers.push(t)},t.prototype.selectClasses=function(t){0<t.length&&t.every(function(t){return 0<=t&&t<this.dropDown.options.length},this)&&(this.dropDown.selectedIndex=t[0],this.updateOtherClasses(d3.set(t.slice(1))),this.onSelectionChanged())},t.prototype.getSelectedClasses=function(){if(this.dropDown.disabled)return[];var e=[this.dropDown.selectedIndex];return this.selectedOtherClassIndexes.each(function(t){e.push(parseInt(t,10))}),e},t.prototype.onSelectionChanged=function(){var e=this.getSelectedClasses();this.changeHandlers.forEach(function(t){t(e)})},t.prototype.updateOtherClassText=function(){var t,e=this.selectedOtherClassIndexes.values();e.sort(d3.ascending),t=0===e.length?n("NoAdditionalClassesSelectedPlaceholder"):e.map(function(t){return this.classes[t].name},this).join(", "),this.otherClassesSpan.text(t)},t.prototype.updateOtherClasses=function(e){this.otherClassesList.style("display","none"),this.selectedOtherClassIndexes=e,this.updateOtherClassText(),$("div.otherClassItem").off("click");var t,s=this;if(0<this.classes.length){var i=this.classes[this.dropDown.selectedIndex];t=i.course.getOtherClasses(i)}else t=[];var n=t.map(function(t){return this.classes.indexOf(t)},this),r=this.otherClassesList.selectAll("div").data(n);r.enter().append("div").classed("otherClassItem",!0),(r=this.otherClassesList.selectAll("div").data(n)).attr("id",function(t){return"courseClassIdx_"+t}).classed("selected",function(t){return e.has(t)}).text(function(t){return s.classes[t].name}),r.exit().remove(),0<n.length?this.otherClassesContainer.style("display",null):this.otherClassesContainer.style("display","none");var o=$(this.otherClassesSelector.node()).offset(),a=$(this.otherClassesSelector.node()).outerHeight();this.otherClassesList.style("left",o.left+"px").style("top",o.top+a+"px"),$("div.otherClassItem").each(function(t,e){$(e).on("click",function(){s.toggleOtherClass(n[t])})})},t.prototype.showHideClassSelector=function(){this.otherClassesEnabled&&this.otherClassesList.style("display","none"===this.otherClassesList.style("display")?null:"none")},t.prototype.toggleOtherClass=function(t){this.selectedOtherClassIndexes.has(t)?this.selectedOtherClassIndexes.remove(t):this.selectedOtherClassIndexes.add(t),d3.select("div#courseClassIdx_"+t).classed("selected",this.selectedOtherClassIndexes.has(t)),this.updateOtherClassText(),this.onSelectionChanged()},t.prototype.retranslate=function(){this.setMessages(),0===this.classes.length&&d3.select(this.dropDown.options[0]).text(n("NoClassesLoadedPlaceholder")),0===this.selectedOtherClassIndexes.values().length&&this.otherClassesSpan.text(n("NoAdditionalClassesSelectedPlaceholder"))},SplitsBrowser.Controls.ClassSelector=t}(),function(){"use strict";var s=SplitsBrowser.getMessage,i=SplitsBrowser.getMessageWithFormatting,o=[{nameKey:"CompareWithWinner",selector:function(t){return t.getWinnerCumTimes()},requiresWinner:!0,percentage:""},{nameKey:"CompareWithFastestTime",selector:function(t){return t.getFastestCumTimes()},requiresWinner:!1,percentage:""}];[5,25,50,100].forEach(function(e){o.push({nameKey:"CompareWithFastestTimePlusPercentage",selector:function(t){return t.getFastestCumTimesPlusPercentage(e)},requiresWinner:!1,percentage:e})}),o.push({nameKey:"CompareWithAnyRunner",selector:null,requiresWinner:!0,percentage:""});function t(t,e){this.changeHandlers=[],this.classes=null,this.currentRunnerIndex=null,this.previousCompetitorList=null,this.parent=t,this.alerter=e,this.hasWinner=!1,this.previousSelectedIndex=-1;var s=d3.select(t).append("div").classed("topRowStart",!0);this.comparisonSelectorLabel=s.append("span").classed("comparisonSelectorLabel",!0);var i=this;this.dropDown=s.append("select").attr("id","comparisonSelector").node(),$(this.dropDown).bind("change",function(){i.onSelectionChanged()}),this.optionsList=d3.select(this.dropDown).selectAll("option").data(o),this.optionsList.enter().append("option"),this.optionsList=d3.select(this.dropDown).selectAll("option").data(o),this.optionsList.attr("value",function(t,e){return e.toString()}),this.optionsList.exit().remove(),this.runnerDiv=d3.select(t).append("div").classed("topRowStart",!0).style("display","none").style("padding-left","20px"),this.runnerSpan=this.runnerDiv.append("span").classed("comparisonSelectorLabel",!0),this.runnerDropDown=this.runnerDiv.append("select").attr("id","runnerSelector").node(),$(this.runnerDropDown).bind("change",function(){i.onSelectionChanged()}),this.dropDown.selectedIndex=1,this.previousSelectedIndex=1,this.setMessages()}t.prototype.setMessages=function(){this.comparisonSelectorLabel.text(s("ComparisonSelectorLabel")),this.runnerSpan.text(s("CompareWithAnyRunnerLabel")),this.optionsList.text(function(t){return i(t.nameKey,{$$PERCENT$$:t.percentage})})},t.prototype.registerChangeHandler=function(t){-1===this.changeHandlers.indexOf(t)&&this.changeHandlers.push(t)},t.prototype.isAnyRunnerSelected=function(){return this.dropDown.selectedIndex===o.length-1},t.prototype.setCourseClassSet=function(t){this.courseClassSet=t,this.setRunners()},t.prototype.setRunners=function(){var e=this.courseClassSet.allCompetitors,s=d3.range(e.length).filter(function(t){return e[t].completed()}),t=e.filter(function(t){return t.completed()});this.hasWinner=0<t.length;var i=d3.select(this.runnerDropDown).selectAll("option").data(t);if(i.enter().append("option"),(i=d3.select(this.runnerDropDown).selectAll("option").data(t)).attr("value",function(t,e){return s[e].toString()}).text(function(t){return t.name}),i.exit().remove(),null===this.previousCompetitorList)this.currentRunnerIndex=0;else if(this.hasWinner){var n=this.previousCompetitorList[this.currentRunnerIndex],r=this.courseClassSet.allCompetitors.indexOf(n);this.currentRunnerIndex=Math.max(r,0)}else o[this.dropDown.selectedIndex].requiresWinner&&this.setComparisonType(1,null);this.runnerDropDown.selectedIndex=this.currentRunnerIndex,this.previousCompetitorList=this.courseClassSet.allCompetitors},t.prototype.setEnabled=function(t){d3.select(this.parent).selectAll("span.comparisonSelectorLabel").classed("disabled",!t),this.dropDown.disabled=!t,this.runnerDropDown.disabled=!t},t.prototype.getComparisonFunction=function(){if(this.isAnyRunnerSelected()){var e=this;return function(t){return t.getCumulativeTimesForCompetitor(e.currentRunnerIndex)}}return o[this.dropDown.selectedIndex].selector},t.prototype.getComparisonType=function(){var t=this.dropDown.selectedIndex;return{index:t,runner:t===o.length-1?(this.runnerDropDown.selectedIndex<0&&(this.runnerDropDown.selectedIndex=0),this.courseClassSet.allCompetitors[this.runnerDropDown.selectedIndex]):null}},t.prototype.setComparisonType=function(t,e){if(0<=t&&t<o.length)if(t===o.length-1){var s=this.courseClassSet.allCompetitors.indexOf(e);0<=s&&(this.dropDown.selectedIndex=t,this.runnerDropDown.selectedIndex=s,this.onSelectionChanged())}else this.dropDown.selectedIndex=t,this.onSelectionChanged()},t.prototype.onSelectionChanged=function(){var t=Math.max(this.runnerDropDown.selectedIndex,0),e=o[this.dropDown.selectedIndex];!this.hasWinner&&e.requiresWinner?(this.alerter(i("CannotCompareAsNoWinner",{$$OPTION$$:s(e.nameKey)})),this.dropDown.selectedIndex=this.previousSelectedIndex):(this.runnerDiv.style("display",this.isAnyRunnerSelected()?null:"none"),this.currentRunnerIndex=0===this.runnerDropDown.options.length?0:parseInt(this.runnerDropDown.options[t].value,10),this.previousSelectedIndex=this.dropDown.selectedIndex,this.changeHandlers.forEach(function(t){t(this.getComparisonFunction())},this))},SplitsBrowser.Controls.ComparisonSelector=t}(),function(){"use strict";var s=SplitsBrowser.getMessage,i="statisticCheckbox",n=["TotalTime","SplitTime","BehindFastest","TimeLoss"],r=["StatisticsTotalTime","StatisticsSplitTime","StatisticsBehindFastest","StatisticsTimeLoss"],o=["SplitTime","TimeLoss"];function t(t){this.div=d3.select(t).append("div").classed("topRowEnd",!0).attr("id","statisticSelector");var e=this.div.selectAll("div").data(n).enter().append("div").style("display","inline-block");e.append("input").attr("id",function(t){return i+t}).attr("type","checkbox").attr("checked",function(t){return 0<=o.indexOf(t)?"checked":null}),this.statisticLabels=e.append("label").attr("for",function(t){return i+t}).classed("statisticsSelectorLabel",!0);var s=this;$("input",this.div.node()).bind("change",function(){return s.onCheckboxChanged()}),this.handlers=[],this.setMessages()}t.prototype.setMessages=function(){this.statisticLabels.text(function(t,e){return s(r[e])})},t.prototype.clearAll=function(){this.div.selectAll("input").attr("checked",null)},t.prototype.setEnabled=function(t){this.div.selectAll("label.statisticsSelectorLabel").classed("disabled",!t),this.div.selectAll("input").attr("disabled",t?null:"disabled")},t.prototype.registerChangeHandler=function(t){-1===this.handlers.indexOf(t)&&this.handlers.push(t)},t.prototype.deregisterChangeHandler=function(t){var e=this.handlers.indexOf(t);-1!==e&&this.handlers.splice(e,1)},t.prototype.getVisibleStatistics=function(){var s={};return this.div.selectAll("input").nodes().forEach(function(t,e){s[n[e]]=t.checked}),s},t.prototype.setVisibleStatistics=function(s){this.div.selectAll("input").nodes().forEach(function(t,e){t.checked=s[n[e]]||!1}),this.onCheckboxChanged()},t.prototype.onCheckboxChanged=function(){var e=this.getVisibleStatistics();this.handlers.forEach(function(t){t(e)})},SplitsBrowser.Controls.StatisticsSelector=t}(),function(){"use strict";var e=SplitsBrowser.getMessage;function t(t,e){this.changeHandlers=[],this.chartTypes=e,this.raceGraphDisabledNotifier=null,this.lastSelectedIndex=0;var s=d3.select(t).append("div").classed("topRowStart",!0);this.labelSpan=s.append("span");var i=this;this.dropDown=s.append("select").node(),$(this.dropDown).bind("change",function(){i.onSelectionChanged()}),this.optionsList=d3.select(this.dropDown).selectAll("option").data(e),this.optionsList.enter().append("option"),this.optionsList=d3.select(this.dropDown).selectAll("option").data(e),this.optionsList.attr("value",function(t,e){return e.toString()}),this.optionsList.exit().remove(),this.setMessages()}t.prototype.setMessages=function(){this.labelSpan.text(e("ChartTypeSelectorLabel")),this.optionsList.text(function(t){return e(t.nameKey)})},t.prototype.setRaceGraphDisabledNotifier=function(t){this.raceGraphDisabledNotifier=t,null!==this.raceGraphDisabledNotifier&&this.chartTypes[this.dropDown.selectedIndex].isRaceGraph&&(this.raceGraphDisabledNotifier(),this.dropDown.selectedIndex=0,this.onSelectionChanged())},t.prototype.registerChangeHandler=function(t){-1===this.changeHandlers.indexOf(t)&&this.changeHandlers.push(t)},t.prototype.getChartType=function(){return this.chartTypes[Math.max(this.dropDown.selectedIndex,0)]},t.prototype.setChartType=function(t){var e=this.chartTypes.indexOf(t);0<=e&&(this.dropDown.selectedIndex=e,this.onSelectionChanged())},t.prototype.onSelectionChanged=function(){null!==this.raceGraphDisabledNotifier&&this.chartTypes[this.dropDown.selectedIndex].isRaceGraph&&(this.raceGraphDisabledNotifier(),this.dropDown.selectedIndex=Math.max(this.lastSelectedIndex,0)),this.changeHandlers.forEach(function(t){t(this.chartTypes[this.dropDown.selectedIndex])},this),this.lastSelectedIndex=this.dropDown.selectedIndex},SplitsBrowser.Controls.ChartTypeSelector=t}(),function(){"use strict";var t=SplitsBrowser.getMessage;function e(t){this.parent=t;var e="originalDataCheckbox";this.containerDiv=t.append("div").classed("topRowStart",!0).attr("id","originalDataSelectorContainer"),this.containerDiv.append("div").classed("topRowStartSpacer",!0);var s=this.containerDiv.append("span"),i=this;this.checkbox=s.append("input").attr("type","checkbox").attr("id",e).on("click",function(){i.fireChangeHandlers()}).node(),this.label=s.append("label").attr("for",e).classed("originalDataSelectorLabel",!0),this.handlers=[],this.setMessages()}e.prototype.setMessages=function(){this.label.text(t("ShowOriginalData")),this.containerDiv.attr("title",t("ShowOriginalDataTooltip"))},e.prototype.registerChangeHandler=function(t){-1===this.handlers.indexOf(t)&&this.handlers.push(t)},e.prototype.deregisterChangeHandler=function(t){var e=this.handlers.indexOf(t);-1!==e&&this.handlers.splice(e,1)},e.prototype.fireChangeHandlers=function(){this.handlers.forEach(function(t){t(this.checkbox.checked)},this)},e.prototype.isOriginalDataSelected=function(){return this.checkbox.checked},e.prototype.selectOriginalData=function(){this.checkbox.checked=!0,this.fireChangeHandlers()},e.prototype.setVisible=function(t){this.containerDiv.style("display",t?null:"none")},e.prototype.setEnabled=function(t){this.parent.selectAll("label.originalDataSelectorLabel").classed("disabled",!t),this.checkbox.disabled=!t},SplitsBrowser.Controls.OriginalDataSelector=e}(),function(){"use strict";var c=SplitsBrowser.formatTime,p=SplitsBrowser.getMessage,d=SplitsBrowser.getMessageWithFormatting,m=SplitsBrowser.Model.Course,t={};t.getFastestSplitsPopupData=function(t,e){var s=t.getFastestSplitsTo(10,e);return s=s.map(function(t){return{time:t.split,name:t.name,highlight:!1}}),{title:p("SelectedClassesPopupHeader"),data:s,placeholder:p("SelectedClassesPopupPlaceholder")}},t.getFastestSplitsForLegPopupData=function(t,e,s){var i=t.getCourse(),n=i.getControlCode(s-1),r=i.getControlCode(s),o=n===m.START?p("StartName"):n,a=r===m.FINISH?p("FinishName"):r,l=d("FastestLegTimePopupHeader",{$$START$$:o,$$END$$:a}),u=t.getPrimaryClassName();return{title:l,data:e.getFastestSplitsForLeg(n,r).map(function(t){return{name:t.name,className:t.className,time:t.split,highlight:t.className===u}}),placeholder:null}},t.getCompetitorsVisitingCurrentControlPopupData=function(t,e,s,i){var n,r=t.getCourse().getControlCode(s),o=Math.round(i)-120,a=Math.round(i)+120,l=e.getCompetitorsAtControlInTimeRange(r,o,a),u=t.getPrimaryClassName(),h=l.map(function(t){return{name:t.name,className:t.className,time:t.time,highlight:t.className===u}});return n=r===m.START?p("StartName"):r===m.FINISH?p("FinishName"):d("ControlName",{$$CODE$$:r}),{title:d("NearbyCompetitorsPopupHeader",{$$START$$:c(o),$$END$$:c(a),$$CONTROL$$:n}),data:h,placeholder:p("NoNearbyCompetitors")}},t.getNextControlData=function(t,e,s){var i=Math.min(s,t.controls.length),n=t.getControlCode(i),r=e.getNextControlsAfter(n);return r.sort(function(t,e){return function(t,e){if(t===e)return 0;if(""===t||""===e||t[0]!==e[0])return t<e?-1:1;var s=/^[^0-9]+/.exec(t);if(null!==s&&0<s.length){var i=s[0];if(0<i.length&&i.length<t.length&&e.substring(0,i.length)===i){var n=parseInt(t.substring(i.length),10),r=parseInt(e.substring(i.length),10);if(!isNaN(n)&&!isNaN(r))return n-r}}return t<e?-1:1}(t.course.name,e.course.name)}),{thisControl:n===m.START?p("StartName"):d("ControlName",{$$CODE$$:n}),nextControls:function(t){return t.map(function(t){var e=t.nextControls.slice(0);return e[e.length-1]===m.FINISH&&(e[e.length-1]=p("FinishName")),{course:t.course,nextControls:e.join(", ")}})}(r)}},SplitsBrowser.Model.ChartPopupData=t}(),function(){"use strict";var i=SplitsBrowser.formatTime;function t(t,e){this.shown=!1,this.mouseIn=!1,this.popupDiv=d3.select(t).append("div"),this.popupDiv.classed("chartPopup",!0).style("display","none").style("position","absolute"),this.dataHeader=this.popupDiv.append("div").classed("chartPopupHeader",!0).append("span");var s=this.popupDiv.append("div").classed("chartPopupTableContainer",!0);for(var i in this.dataTable=s.append("table"),this.popupDiv.selectAll(".nextControls").style("display","none"),e)e.hasOwnProperty(i)&&$(this.popupDiv.node()).on(i,e[i]);var n=this;$(this.popupDiv.node()).mouseenter(function(){n.mouseIn=!0}),$(this.popupDiv.node()).mouseleave(function(){n.mouseIn=!1})}t.prototype.isShown=function(){return this.shown},t.prototype.isMouseIn=function(){return this.mouseIn},t.prototype.setData=function(t,e){this.dataHeader.text(t.title);var s=this.dataTable.selectAll("tr").data(t.data);s.enter().append("tr"),(s=this.dataTable.selectAll("tr").data(t.data)).classed("highlighted",function(t){return t.highlight}),s.selectAll("td").remove(),s.append("td").text(function(t){return i(t.time)}),e&&s.append("td").text(function(t){return t.className}),s.append("td").text(function(t){return t.name}),s.exit().remove(),0===t.data.length&&null!==t.placeholder&&this.dataTable.append("tr").append("td").text(t.placeholder)},t.prototype.setNextControlData=function(t){this.dataHeader.text(t.thisControl);var e=this.dataTable.selectAll("tr").data(t.nextControls);e.enter().append("tr"),e.selectAll("td").remove(),e.classed("highlighted",!1),e.append("td").text(function(t){return t.course.name}),e.append("td").text("--\x3e"),e.append("td").text(function(t){return t.nextControls}),e.exit().remove()},t.prototype.setLocation=function(t){this.popupDiv.style("left",t.x+"px").style("top",t.y+"px")},t.prototype.show=function(t){this.popupDiv.style("display",null),this.shown=!0,this.setLocation(t)},t.prototype.hide=function(){this.popupDiv.style("display","none"),this.shown=!1},t.prototype.height=function(){return $(this.popupDiv.node()).height()},SplitsBrowser.Controls.ChartPopup=t}(),function(){"use strict";var s=18,h=0,c=18,o=53,u="\xa0\xa0\xa0\xa0",l=["#FF0000","#4444FF","#00FF00","#000000","#CC0066","#000099","#FFCC00","#884400","#9900FF","#CCCC00","#888800","#CC6699","#00DD00","#3399FF","#BB00BB","#00DDDD","#FF00FF","#0088BB","#888888","#FF99FF","#55BB33"],p=SplitsBrowser.formatTime,a=SplitsBrowser.getMessage,d=SplitsBrowser.isNotNullNorNaN,n=SplitsBrowser.isNaNStrict,t=SplitsBrowser.Model.ChartPopupData,m=SplitsBrowser.Controls.ChartPopup;function f(t,e,s){var i;return s&&null===t&&(e=t=NaN),i=null===e?"-":n(e)?"?":e.toString(),u+p(t)+" ("+i+")"}function g(t,e){return""===e?t:t+" ("+e+")"}function C(t){return t.completed()&&t.isNonCompetitive?a("NonCompetitiveShort"):t.isNonFinisher?a("DidNotFinishShort"):t.isDisqualified?a("DisqualifiedShort"):t.isOverMaxTime?a("OverMaxTimeShort"):t.completed()?"":a("MispunchedShort")}function e(t){this.parent=t,this.xScale=null,this.yScale=null,this.hasData=!1,this.overallWidth=-1,this.overallHeight=-1,this.contentWidth=-1,this.contentHeight=-1,this.numControls=-1,this.selectedIndexes=[],this.currentCompetitorData=null,this.isPopupOpen=!1,this.popupUpdateFunc=null,this.maxStartTimeLabelWidth=0,this.mouseOutTimeout=null,this.selectedIndexesOrderedByLastYValue=[],this.referenceCumTimes=[],this.referenceCumTimesSorted=[],this.referenceCumTimeIndexes=[],this.fastestCumTimes=[],this.isMouseIn=!1,this.currentControlIndex=null,this.actualControlIndex=null,this.controlLine=null,this.svg=d3.select(this.parent).append("svg").attr("id","chart"),this.svgGroup=this.svg.append("g"),this.setLeftMargin(o);function e(t){n.onMouseMove(t)}function s(t){n.onMouseUp(t)}function i(t){n.onMouseDown(t)}var n=this;$(this.svg.node()).mouseenter(function(t){n.onMouseEnter(t)}).mousemove(e).mouseleave(function(t){n.onMouseLeave(t)}).mousedown(i).mouseup(s),$(this.svg.node()).contextmenu(function(t){t.preventDefault()}),this.textSizeElement=this.svg.append("text").attr("fill","transparent").attr("id","sb-text-size-element");var r={mousemove:e,mousedown:i,mouseup:s};this.popup=new m(t,r),$(document).mouseup(function(){n.popup.hide()})}function v(t){var e=t.filter(d);return 0<e.length?d3.max(e):0}e.prototype.setLeftMargin=function(t){this.currentLeftMargin=t,this.svgGroup.attr("transform","translate("+this.currentLeftMargin+","+s+")")},e.prototype.getPopupLocation=function(t){return{x:t.pageX+10,y:Math.max(t.pageY-this.popup.height()/2,0)}},e.prototype.getFastestSplitsPopupData=function(){return t.getFastestSplitsPopupData(this.courseClassSet,this.currentControlIndex)},e.prototype.getFastestSplitsForCurrentLegPopupData=function(){return t.getFastestSplitsForLegPopupData(this.courseClassSet,this.eventData,this.currentControlIndex)},e.prototype.setCurrentChartTime=function(t){var e=t.pageY-$(this.svg.node()).offset().top-s;this.currentChartTime=Math.round(60*this.yScale.invert(e))+this.referenceCumTimes[this.currentControlIndex]},e.prototype.getCompetitorsVisitingCurrentControlPopupData=function(){return t.getCompetitorsVisitingCurrentControlPopupData(this.courseClassSet,this.eventData,this.currentControlIndex,this.currentChartTime)},e.prototype.getNextControlData=function(){return t.getNextControlData(this.courseClassSet.getCourse(),this.eventData,this.actualControlIndex)},e.prototype.onMouseEnter=function(t){null!==this.mouseOutTimeout&&(clearTimeout(this.mouseOutTimeout),this.mouseOutTimeout=null),this.isMouseIn=!0,this.hasData&&this.updateControlLineLocation(t)},e.prototype.onMouseMove=function(t){this.hasData&&this.isMouseIn&&null!==this.xScale&&this.updateControlLineLocation(t)},e.prototype.onMouseLeave=function(){var t=this;this.mouseOutTimeout=setTimeout(function(){t.popup.isMouseIn()||(t.isMouseIn=!1,t.removeControlLine())},1)},e.prototype.onMouseDown=function(t){var e=this;setTimeout(function(){e.showPopupDialog(t)},1)},e.prototype.onMouseUp=function(t){this.popup.hide(),t.preventDefault()},e.prototype.showPopupDialog=function(t){if(this.isMouseIn&&null!==this.currentControlIndex){var e=!1,s=this;!this.isRaceGraph||1!==t.which&&3!==t.which?1===t.which?(this.popupUpdateFunc=function(){s.popup.setData(s.getFastestSplitsPopupData(),!1)},e=!0):3===t.which&&this.hasControls&&(this.popupUpdateFunc=function(){s.popup.setData(s.getFastestSplitsForCurrentLegPopupData(),!0)},e=!0):this.hasControls&&(this.setCurrentChartTime(t),this.popupUpdateFunc=function(){s.popup.setData(s.getCompetitorsVisitingCurrentControlPopupData(),!0)},e=!0),e&&(this.updatePopupContents(t),this.popup.show(this.getPopupLocation(t)))}},e.prototype.updatePopupContents=function(t){var e=t.pageY-$(this.svg.node()).offset().top;this.hasControls&&e<s?this.updateNextControlInformation():this.popupUpdateFunc()},e.prototype.updateNextControlInformation=function(){this.hasControls&&this.popup.setNextControlData(this.getNextControlData())},e.prototype.drawControlLine=function(t){this.currentControlIndex=t,this.updateCompetitorStatistics();var e=this.xScale(this.referenceCumTimes[t]);this.controlLine=this.svgGroup.append("line").attr("x1",e).attr("y1",0).attr("x2",e).attr("y2",this.contentHeight).attr("class","controlLine").node()},e.prototype.updateControlLineLocation=function(t){var e=$(this.svg.node()),s=e.offset(),i=t.pageX-s.left,n=t.pageY-s.top;if(this.currentLeftMargin<=i&&i<e.width()-h&&n<e.height()-c){var r,o=this.xScale.invert(i-this.currentLeftMargin),a=d3.bisect(this.referenceCumTimesSorted,o);if(a>=this.referenceCumTimesSorted.length)r=this.referenceCumTimesSorted.length-1;else{var l=Math.abs(this.referenceCumTimesSorted[a]-o);r=Math.abs(o-this.referenceCumTimesSorted[a-1])<l?a-1:a}var u=this.referenceCumTimeIndexes[r];null!==this.actualControlIndex&&this.actualControlIndex===u||(this.removeControlLine(),this.actualControlIndex=u,this.drawControlLine(Math.max(this.minViewableControl,u))),this.popup.isShown()&&null!==this.currentControlIndex&&(this.isRaceGraph&&this.setCurrentChartTime(t),this.updatePopupContents(t),this.popup.setLocation(this.getPopupLocation(t)))}else this.removeControlLine(),this.popup.hide()},e.prototype.removeControlLine=function(){this.currentControlIndex=null,this.actualControlIndex=null,this.updateCompetitorStatistics(),null!==this.controlLine&&(d3.select(this.controlLine).remove(),this.controlLine=null)},e.prototype.getTimesBehindFastest=function(s,t){var e=t.map(function(t){return this.courseClassSet.allCompetitors[t]},this),i=this.fastestCumTimes[s]-this.fastestCumTimes[s-1];return e.map(function(t){var e=t.getSplitTimeTo(s);return null===e?null:e-i})},e.prototype.getTimeLosses=function(e,t){return t.map(function(t){return this.courseClassSet.allCompetitors[t]},this).map(function(t){return t.getTimeLossAt(e)})},e.prototype.updateCompetitorStatistics=function(){var t=this.selectedIndexesOrderedByLastYValue.map(function(t){return this.courseClassSet.allCompetitors[t]},this),
s=t.map(function(t){return g(t.name,C(t.result))});if(null!==this.currentControlIndex&&0<this.currentControlIndex){var e=t.map(function(t){return t.isOKDespiteMissingTimes});if(this.visibleStatistics.TotalTime){var i=t.map(function(t){return t.getCumulativeTimeTo(this.currentControlIndex)},this),n=t.map(function(t){return t.getCumulativeRankTo(this.currentControlIndex)},this);s=d3.zip(s,i,n,e).map(function(t){return t[0]+f(t[1],t[2],t[3])})}if(this.visibleStatistics.SplitTime){var r=t.map(function(t){return t.getSplitTimeTo(this.currentControlIndex)},this),o=t.map(function(t){return t.getSplitRankTo(this.currentControlIndex)},this);s=d3.zip(s,r,o,e).map(function(t){return t[0]+f(t[1],t[2],t[3])})}if(this.visibleStatistics.BehindFastest){var a=this.getTimesBehindFastest(this.currentControlIndex,this.selectedIndexesOrderedByLastYValue);s=d3.zip(s,a,e).map(function(t){return t[0]+u+p(t[2]&&null===t[1]?NaN:t[1])})}if(this.visibleStatistics.TimeLoss){var l=this.getTimeLosses(this.currentControlIndex,this.selectedIndexesOrderedByLastYValue);s=d3.zip(s,l).map(function(t){return t[0]+u+p(t[1])})}}this.hasData&&this.currentCompetitorData.forEach(function(t,e){t.label=s[e]}),d3.selectAll("text.competitorLabel").text(function(t){return t.label})},e.prototype.getTickFormatter=function(){var s=this;return function(t,e){return 0===e?a("StartNameShort"):e===s.numControls+1?a("FinishNameShort"):e.toString()}},e.prototype.getTextWidth=function(t){return this.textSizeElement.text(t).node().getBBox().width},e.prototype.getTextHeight=function(t){return this.textSizeElement.text(t).node().getBBox().height},e.prototype.getMaxGraphEndTextWidth=function(){if(0===this.selectedIndexes.length)return 0;var t=this.selectedIndexes.map(function(t){var e=this.courseClassSet.allCompetitors[t];return this.getTextWidth(g(e.name,C(e.result)))},this);return d3.max(t)+this.determineMaxStatisticTextWidth()},e.prototype.getMaxTimeAndRankTextWidth=function(i,n){var r=0,o=0,a=this.selectedIndexes.map(function(t){return this.courseClassSet.allCompetitors[t]},this);d3.range(1,this.numControls+2).forEach(function(e){var t=a.map(function(t){return t[i](e)});r=Math.max(r,v(t));var s=a.map(function(t){return t[n](e)});o=Math.max(o,v(s))});var t=f(r,o);return this.getTextWidth(t)},e.prototype.getMaxSplitTimeAndRankTextWidth=function(){return this.getMaxTimeAndRankTextWidth("getSplitTimeTo","getSplitRankTo")},e.prototype.getMaxCumulativeTimeAndRankTextWidth=function(){return this.getMaxTimeAndRankTextWidth("getCumulativeTimeTo","getCumulativeRankTo")},e.prototype.getMaxTimeBehindFastestWidth=function(){for(var t=0,e=1;e<=this.numControls+1;e+=1){var s=this.getTimesBehindFastest(e,this.selectedIndexes);t=Math.max(t,v(s))}return this.getTextWidth(u+p(t))},e.prototype.getMaxTimeLossWidth=function(){for(var t=0,e=0,s=1;s<=this.numControls+1;s+=1){var i=this.getTimeLosses(s,this.selectedIndexes).filter(d);0<i.length&&(t=Math.max(t,d3.max(i)),e=Math.min(e,d3.min(i)))}return Math.max(this.getTextWidth(u+p(t)),this.getTextWidth(u+p(e)))},e.prototype.determineMaxStatisticTextWidth=function(){var t=0;return this.visibleStatistics.TotalTime&&(t+=this.getMaxCumulativeTimeAndRankTextWidth()),this.visibleStatistics.SplitTime&&(t+=this.getMaxSplitTimeAndRankTextWidth()),this.visibleStatistics.BehindFastest&&(t+=this.getMaxTimeBehindFastestWidth()),this.visibleStatistics.TimeLoss&&(t+=this.getMaxTimeLossWidth()),t},e.prototype.determineMaxStartTimeLabelWidth=function(t){return 0<t.competitorNames.length?d3.max(t.competitorNames.map(function(t){return this.getTextWidth("00:00:00 "+t)},this)):0},e.prototype.createScales=function(t){this.xScale=d3.scaleLinear().domain(t.xExtent).range([0,this.contentWidth]),this.yScale=d3.scaleLinear().domain(t.yExtent).range([0,this.contentHeight]),this.xScaleMinutes=d3.scaleLinear().domain([t.xExtent[0]/60,t.xExtent[1]/60]).range([0,this.contentWidth])},e.prototype.drawBackgroundRectangles=function(){var e=this.referenceCumTimes.slice(0);e.sort(d3.ascending);for(var t=1;t<e.length;)e[t]===e[t-1]?e.splice(t,1):t+=1;var s=this,i=this.svgGroup.selectAll("rect").data(d3.range(e.length-1));i.enter().append("rect"),(i=this.svgGroup.selectAll("rect").data(d3.range(e.length-1))).attr("x",function(t){return s.xScale(e[t])}).attr("y",0).attr("width",function(t){return s.xScale(e[t+1])-s.xScale(e[t])}).attr("height",this.contentHeight).attr("class",function(t){return t%2==0?"background1":"background2"}),i.exit().remove()},e.prototype.determineYAxisTickFormatter=function(t){if(this.isRaceGraph){var s=0===t.dataColumns.length?[]:t.dataColumns[0].ys;if(0===s.length)return function(t){return p(60*t)};var i=this.yScale;return function(e){return 10<=d3.min(s.map(function(t){return Math.abs(i(t)-i(e))}))?p(Math.round(60*e)):""}}return null},e.prototype.drawAxes=function(t,e){var s=this.determineYAxisTickFormatter(e),i=d3.axisTop().scale(this.xScale).tickFormat(this.getTickFormatter()).tickValues(this.referenceCumTimes),n=d3.axisLeft().scale(this.yScale).tickFormat(s),r=d3.axisBottom().scale(this.xScaleMinutes);this.svgGroup.selectAll("g.axis").remove(),this.svgGroup.append("g").attr("class","x axis").call(i),this.svgGroup.append("g").attr("class","y axis").call(n).append("text").attr("transform","rotate(-90)").attr("x",-(this.contentHeight-6)).attr("y",6).attr("dy",".71em").style("text-anchor","start").style("fill","black").text(t),this.svgGroup.append("g").attr("class","x axis").attr("transform","translate(0,"+this.contentHeight+")").call(r).append("text").attr("x",60).attr("y",-5).style("text-anchor","start").style("fill","black").text(a("LowerXAxisChartLabel"))},e.prototype.drawChartLines=function(r){var o=this;this.svgGroup.selectAll("path.graphLine").remove(),this.svgGroup.selectAll("line.aroundOmittedTimes").remove(),d3.range(this.numLines).forEach(function(e){function s(){o.highlight(o.selectedIndexes[e])}function i(){o.unhighlight()}var n=l[this.selectedIndexes[e]%l.length];this.svgGroup.append("path").attr("d",function(e){return r.dataColumns.some(function(t){return d(t.ys[e])})?d3.line().x(function(t){return o.xScale(t.x)}).y(function(t){return o.yScale(t.ys[e])}).defined(function(t){return d(t.ys[e])}):d3.line().x(0).y(0).defined(function(t,e){return 0===e})}(e)(r.dataColumns)).attr("stroke",n).attr("class","graphLine competitor"+this.selectedIndexes[e]).on("mouseenter",s).on("mouseleave",i).append("title").text(r.competitorNames[e]),r.dubiousTimesInfo[e].forEach(function(t){this.svgGroup.append("line").attr("x1",this.xScale(r.dataColumns[t.start].x)).attr("y1",this.yScale(r.dataColumns[t.start].ys[e])).attr("x2",this.xScale(r.dataColumns[t.end].x)).attr("y2",this.yScale(r.dataColumns[t.end].ys[e])).attr("stroke",n).attr("class","aroundOmittedTimes competitor"+this.selectedIndexes[e]).on("mouseenter",s).on("mouseleave",i).append("title").text(r.competitorNames[e])},this)},this)},e.prototype.highlight=function(t){this.svg.selectAll("path.graphLine.competitor"+t).classed("selected",!0),this.svg.selectAll("line.competitorLegendLine.competitor"+t).classed("selected",!0),this.svg.selectAll("text.competitorLabel.competitor"+t).classed("selected",!0),this.svg.selectAll("text.startLabel.competitor"+t).classed("selected",!0),this.svg.selectAll("line.aroundOmittedTimes.competitor"+t).classed("selected",!0)},e.prototype.unhighlight=function(){this.svg.selectAll("path.graphLine.selected").classed("selected",!1),this.svg.selectAll("line.competitorLegendLine.selected").classed("selected",!1),this.svg.selectAll("text.competitorLabel.selected").classed("selected",!1),this.svg.selectAll("text.startLabel.selected").classed("selected",!1),this.svg.selectAll("line.aroundOmittedTimes.selected").classed("selected",!1)},e.prototype.drawCompetitorStartTimeLabels=function(s){var i=s.dataColumns[0],n=this,t=this.svgGroup.selectAll("text.startLabel").data(this.selectedIndexes);t.enter().append("text").classed("startLabel",!0),(t=this.svgGroup.selectAll("text.startLabel").data(this.selectedIndexes)).attr("x",-7).attr("y",function(t,e){return n.yScale(i.ys[e])+n.getTextHeight(s.competitorNames[e])/4}).attr("class",function(t){return"startLabel competitor"+t}).on("mouseenter",function(t){n.highlight(t)}).on("mouseleave",function(){n.unhighlight()}).text(function(t,e){return p(Math.round(60*i.ys[e]))+" "+s.competitorNames[e]}),t.exit().remove()},e.prototype.removeCompetitorStartTimeLabels=function(){this.svgGroup.selectAll("text.startLabel").remove()},e.prototype.adjustCompetitorLegendLabelsDownwardsIfNecessary=function(){for(var t=1;t<this.numLines;t+=1){var e=this.currentCompetitorData[t-1],s=this.currentCompetitorData[t];s.y<e.y+e.textHeight&&(s.y=e.y+e.textHeight)}},e.prototype.adjustCompetitorLegendLabelsUpwardsIfNecessary=function(t){if(0<this.numLines&&this.currentCompetitorData[this.numLines-1].y>this.contentHeight){this.currentCompetitorData[this.numLines-1].y=Math.max(t,this.contentHeight);for(var e=this.numLines-2;0<=e;e-=1){var s=this.currentCompetitorData[e+1],i=this.currentCompetitorData[e];if(!(i.y+i.textHeight>s.y))break;i.y=s.y-i.textHeight}}},e.prototype.drawCompetitorLegendLabels=function(t){var n=0;if(0===t.dataColumns.length)this.currentCompetitorData=[];else{var r=t.dataColumns[t.dataColumns.length-1];this.currentCompetitorData=d3.range(this.numLines).map(function(t){var e=this.selectedIndexes[t],s=this.courseClassSet.allCompetitors[e].name,i=this.getTextHeight(s);return n+=i,{label:g(s,C(this.courseClassSet.allCompetitors[e].result)),textHeight:i,y:d(r.ys[t])?this.yScale(r.ys[t]):null,colour:l[e%l.length],index:e}},this),n-=this.currentCompetitorData[this.numLines-1].textHeight;for(var e=null,s=this.numLines-1;0<=s;s-=1)null===this.currentCompetitorData[s].y&&(this.currentCompetitorData[s].y=null===e?this.contentHeight:e-this.currentCompetitorData[s].textHeight,e=this.currentCompetitorData[s].y)}this.currentCompetitorData.sort(function(t,e){return t.y-e.y}),this.selectedIndexesOrderedByLastYValue=this.currentCompetitorData.map(function(t){return t.index}),this.adjustCompetitorLegendLabelsDownwardsIfNecessary(),this.adjustCompetitorLegendLabelsUpwardsIfNecessary(n);var i=this.svgGroup.selectAll("line.competitorLegendLine").data(this.currentCompetitorData);i.enter().append("line").classed("competitorLegendLine",!0);var o=this;(i=this.svgGroup.selectAll("line.competitorLegendLine").data(this.currentCompetitorData)).attr("x1",this.contentWidth+1).attr("y1",function(t){return t.y}).attr("x2",this.contentWidth+10+1).attr("y2",function(t){return t.y}).attr("stroke",function(t){return t.colour}).attr("class",function(t){return"competitorLegendLine competitor"+t.index}).on("mouseenter",function(t){o.highlight(t.index)}).on("mouseleave",function(){o.unhighlight()}),i.exit().remove();var a=this.svgGroup.selectAll("text.competitorLabel").data(this.currentCompetitorData);a.enter().append("text").classed("competitorLabel",!0),(a=this.svgGroup.selectAll("text.competitorLabel").data(this.currentCompetitorData)).attr("x",this.contentWidth+10+2).attr("y",function(t){return t.y+t.textHeight/4}).attr("class",function(t){return"competitorLabel competitor"+t.index}).on("mouseenter",function(t){o.highlight(t.index)}).on("mouseleave",function(){o.unhighlight()}).text(function(t){return t.label}),a.exit().remove()},e.prototype.adjustContentSize=function(){var t=this.getMaxGraphEndTextWidth();this.setLeftMargin(Math.max(this.maxStartTimeLabelWidth+8,o)),this.contentWidth=Math.max(this.overallWidth-this.currentLeftMargin-h-t-12,100),this.contentHeight=Math.max(this.overallHeight-s-c,100)},e.prototype.setSize=function(t,e){this.overallWidth=t,this.overallHeight=e,$(this.svg.node()).width(t).height(e),this.adjustContentSize()},e.prototype.clearGraph=function(){this.svgGroup.selectAll("*").remove()},e.prototype.sortReferenceCumTimes=function(){var s=d3.map();this.referenceCumTimes.forEach(function(t,e){s.has(t)||s.set(t,e)}),this.referenceCumTimesSorted=this.referenceCumTimes.slice(0),this.referenceCumTimesSorted.sort(d3.ascending);for(var t=this.referenceCumTimesSorted.length-1;0<t;t-=1)this.referenceCumTimesSorted[t]===this.referenceCumTimesSorted[t-1]&&this.referenceCumTimesSorted.splice(t,1);this.referenceCumTimeIndexes=this.referenceCumTimesSorted.map(function(t){return s.get(t)})},e.prototype.drawChart=function(t,e,s,i){var n=t.chartData;this.numControls=n.numControls,this.numLines=n.competitorNames.length,this.selectedIndexes=e,this.referenceCumTimes=t.referenceCumTimes,this.fastestCumTimes=t.fastestCumTimes,this.eventData=t.eventData,this.courseClassSet=t.courseClassSet,this.hasControls=t.courseClassSet.getCourse().hasControls(),this.isRaceGraph=i.isRaceGraph,this.minViewableControl=i.minViewableControl,this.visibleStatistics=s,this.hasData=!0,this.maxStatisticTextWidth=this.determineMaxStatisticTextWidth(),this.maxStartTimeLabelWidth=this.isRaceGraph?this.determineMaxStartTimeLabelWidth(n):0,this.sortReferenceCumTimes(),this.adjustContentSize(),this.createScales(n),this.drawBackgroundRectangles(),this.drawAxes(a(i.yAxisLabelKey),n),this.drawChartLines(n),this.drawCompetitorLegendLabels(n),this.removeControlLine(),this.isRaceGraph?this.drawCompetitorStartTimeLabels(n):this.removeCompetitorStartTimeLabels()},SplitsBrowser.Controls.Chart=e}(),function(){"use strict";var u=SplitsBrowser.formatTime,h=SplitsBrowser.Model.compareCompetitors,f=SplitsBrowser.getMessage,c=SplitsBrowser.getMessageWithFormatting,g=SplitsBrowser.isNotNullNorNaN;function t(t){this.parent=t,this.courseClass=null,this.div=null,this.headerSpan=null,this.table=null,this.buildTable()}function C(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function v(t,e,s){return null===t&&s?"??:??":u(t,e)}t.prototype.buildTable=function(){this.div=d3.select(this.parent).append("div").attr("id","resultsTableContainer"),this.headerSpan=this.div.append("div").append("span").classed("resultsTableHeader",!0),this.table=this.div.append("table").classed("resultsTable",!0),this.table.append("thead").append("tr"),this.table.append("tbody")},t.prototype.populateTable=function(){var t=this.courseClass.name+", ";1===this.courseClass.numControls?t+=f("ResultsTableHeaderSingleControl"):t+=c("ResultsTableHeaderMultipleControls",{$$NUM$$:this.courseClass.numControls});var e=this.courseClass.course;null!==e.length&&(t+=", "+c("ResultsTableHeaderCourseLength",{$$DISTANCE$$:e.length.toFixed(1)})),null!==e.climb&&(t+=", "+c("ResultsTableHeaderClimb",{$$CLIMB$$:e.climb})),this.headerSpan.text(t);var s=[f("ResultsTableHeaderControlNumber"),f("ResultsTableHeaderName"),f("ResultsTableHeaderTime")],i=this.courseClass.course.controls;(s=null===i?s.concat(d3.range(1,this.courseClass.numControls+1)):s.concat(i.map(function(t,e){return e+1+"\xa0("+t+")"}))).push(f("FinishName"));var n=this.table.select("thead tr").selectAll("th").data(s);n.enter().append("th"),n.exit().remove(),(n=this.table.select("thead tr").selectAll("th").data(s)).text(function(t){return t});var r=[];function p(t,e,s){var i=[];return t&&i.push("fastest"),e&&i.push("dubious"),s&&i.push("missing"),i.join(" ")}function d(t,e,s,i,n){r.push("<td"),s&&r.push(' class="'+s+'"'),r.push("><span"),""!==i&&r.push(' class="'+i+'"'),r.push(">"),r.push(C(t)),r.push("</span><br><span"),""!==n&&r.push(' class="'+n+'"'),r.push(">"),r.push(C(e)),r.push("</span></td>\n")}var o=this.courseClass.competitors.slice(0);o.sort(h);var a=0,l=0,m=function(t){var e=0,s=1;return t.forEach(function(t){t.result.getAllOriginalCumulativeTimes().forEach(function(t){if(g(t))for(;e<2&&Math.abs(t-Math.round(t*s)/s)>1e-7*t;)e+=1,s*=10})}),e}(o);o.forEach(function(t,e){r.push("<tr><td>");var c=t.result;c.isNonCompetitive?(r.push(C(f("NonCompetitiveShort"))),a+=1):c.completed()&&(0!==e&&o[e-1].totalTime===c.totalTime||(l=e+1-a),r.push(""+l)),r.push("</td>"),d(t.name,t.club,null,"",""),d(function(t,e){return t.isNonStarter?f("DidNotStartShort"):t.isNonFinisher?f("DidNotFinishShort"):t.isDisqualified?f("DisqualifiedShort"):t.isOverMaxTime?f("OverMaxTimeShort"):t.completed()?u(t.totalTime,e):f("MispunchedShort")}(c,m),"\xa0","time","",""),d3.range(1,this.courseClass.numControls+2).forEach(function(t){var e=c.getOriginalCumulativeTimeTo(t),s=c.getOriginalSplitTimeTo(t),i=v(e,m,c.isOKDespiteMissingTimes),n=v(s,m,c.isOKDespiteMissingTimes),r=1===c.getCumulativeRankTo(t),o=1===c.getSplitRankTo(t),a=c.isCumulativeTimeDubious(t),l=c.isSplitTimeDubious(t),u=c.isOKDespiteMissingTimes&&null===e,h=c.isOKDespiteMissingTimes&&null===s;d(i,n,"time",p(r,a,u),p(o,l,h))}),r.push("</tr>\n")},this),this.table.select("tbody").node().innerHTML=r.join("")},t.prototype.setClass=function(t){this.courseClass=t,null!==this.courseClass&&this.populateTable()},t.prototype.show=function(){this.div.style("display",null)},t.prototype.hide=function(){this.div.style("display","none")},t.prototype.retranslate=function(){this.populateTable()},SplitsBrowser.Controls.ResultsTable=t}(),function(){"use strict";var n=SplitsBrowser.Model.ChartTypes,l=SplitsBrowser.Model.CourseClassSet;function r(t,e){return t.replace(new RegExp(e.source,"g"),"")}var u=/(?:^|&|\?)class=([^&]+)/;var o=/(?:^|&|\?)chartType=([^&]+)/;var a=/(?:^|&|\?)compareWith=([^&]+)/,h=["Winner","FastestTime","FastestTimePlus5","FastestTimePlus25","FastestTimePlus50","FastestTimePlus100"];var c=/(?:^|&|\?)selected=([^&]+)/;var p=/(?:^|&|\?)stats=([^&]*)/,d=["TotalTime","SplitTime","BehindFastest","TimeLoss"];var m=/(?:^|&|\?)showOriginal=([^&]*)/;var f=/(?:^|&|\?)filterText=([^&]*)/;SplitsBrowser.parseQueryString=function(t,e){var s=function(t,e){var s=u.exec(t);if(null===s)return null;for(var i=d3.map(),n=0;n<e.classes.length;n+=1)i.set(e.classes[n].name,e.classes[n]);var r=decodeURIComponent(s[1]).split(";"),o=(r=d3.set(r).values()).filter(function(t){return i.has(t)}).map(function(t){return i.get(t)});if(0===o.length)return null;var a=o[0].course;return o=o.filter(function(t){return t.course===a}),new l(o)}(t,e);return{classes:null===s?null:s.classes.map(function(t){return e.classes.indexOf(t)}),chartType:function(t){var e=o.exec(t);if(null===e)return null;var s=e[1];return n.hasOwnProperty(s)?n[s]:null}(t),compareWith:function(t,e){var s=a.exec(t);if(null===s)return null;var i=decodeURIComponent(s[1]),n=h.indexOf(i);if(1<=n)return{index:n,runner:null};if(0===n&&null!==e)return e.allCompetitors.some(function(t){return t.result.completed()})?{index:0,runner:null}:null;if(null===e)return null;for(var r=0;r<e.allCompetitors.length;r+=1){var o=e.allCompetitors[r];if(o.name===i&&o.result.completed())return{index:h.length,runner:o}}return null}(t,s),selected:function(t,e){if(null===e)return null;var s=c.exec(t);if(null===s)return null;var i=decodeURIComponent(s[1]).split(";");if(0<=i.indexOf("*"))return d3.range(0,e.allCompetitors.length);i=d3.set(i).values();var n=e.allCompetitors.map(function(t){return t.name}),r=[];return i.forEach(function(t){var e=n.indexOf(t);0<=e&&r.push(e)}),r.sort(d3.ascending),0===r.length?null:r}(t,s),stats:function(t){var e=p.exec(t);if(null===e)return null;var s=decodeURIComponent(e[1]).split(";"),i={};d.forEach(function(t){i[t]=!1});for(var n=0;n<s.length;n+=1){var r=s[n];if(i.hasOwnProperty(r))i[r]=!0;else if(""!==r)return null}return i}(t),showOriginal:function(t){var e=m.exec(t);return null!==e&&"1"===e[1]}(t),filterText:function(t){var e=f.exec(t);return null===e?"":decodeURIComponent(e[1])}(t)}},SplitsBrowser.formatQueryString=function(t,e,s,i){return t=(t=function(t,e){return t=r(t,f),""===e?t:t+"&filterText="+encodeURIComponent(e)}(t=function(t,e){return t=r(t,m),e?t+"&showOriginal=1":t}(t=function(t,e){t=r(t,p);var s=d.filter(function(t){return e.hasOwnProperty(t)&&e[t]});return t+"&stats="+encodeURIComponent(s.join(";"))}(t=function(t,e,s){t=r(t,c);var i=s.map(function(t){return e.allCompetitors[t]});if(0===i.length)return t;if(i.length===e.allCompetitors.length)return t+"&selected=*";var n=i.map(function(t){return t.name}).join(";");return t+"&selected="+encodeURIComponent(n)}(t=function(t,e,s){t=r(t,a);var i=null;return"number"==typeof e&&0<=e&&e<h.length?i=h[e]:null!==s&&(i=s.name),null===i?t:t+"&compareWith="+encodeURIComponent(i)}(t=function(t,e){for(var s in t=r(t,o),n)if(n.hasOwnProperty(s)&&n[s]===e)return t+"&chartType="+encodeURIComponent(s);return t}(t=function(t,e,s){t=r(t,u);var i=s.map(function(t){return e.classes[t].name});return t+"&class="+encodeURIComponent(i.join(";"))}(t,e,i.classes),i.chartType),i.compareWith.index,i.compareWith.runner),s,i.selected),i.stats),i.showOriginal),i.filterText)).replace(/^\??&/,"")}}(),function(){"use strict";var t=SplitsBrowser.getMessage;function e(t){this.parent=t,this.warnings=[],this.containerDiv=t.append("div").classed("topRowStart",!0).attr("id","warningViewerContainer").style("display","none"),this.containerDiv.append("div").classed("topRowStartSpacer",!0),this.warningTriangle=this.createWarningTriangle(this.containerDiv),this.warningList=t.append("div").classed("warningList",!0).classed("transient",!0).style("position","absolute").style("display","none");var s=this;$(document).click(function(t){if("none"!==s.warningList.style("display")){var e=$("div#warningTriangleContainer,div.warningList");e.is(t.target)||0!==e.has(t.target).length||s.warningList.style("display","none")}}),this.setMessages()}e.prototype.setMessages=function(){this.containerDiv.attr("title",t("WarningsTooltip"))},e.prototype.createWarningTriangle=function(){var t=this.containerDiv.append("div").attr("id","warningTriangleContainer"),e=t.append("svg");e.style("width","21px").style("height","19px").style("margin-bottom","-3px"),e.append("polygon").attr("points","1,18 10,0 19,18").style("stroke","black").style("stroke-width","1.5px").style("fill","#ffd426"),e.append("text").attr("x",10).attr("y",16).attr("text-anchor","middle").style("font-size","14px").text("!");var s=this;return t.on("click",function(){s.showHideErrorList()}),e},e.prototype.setWarnings=function(t){var e=this.warningList.selectAll("div").data(t);e.enter().append("div").classed("warning",!0),(e=this.warningList.selectAll("div").data(t)).text(function(t){return t}),e.exit().remove(),this.containerDiv.style("display",t&&0<t.length?"block":"none")},e.prototype.showHideErrorList=function(){if("none"===this.warningList.style("display")){var t=$(this.warningTriangle.node()).offset(),e=$(this.warningTriangle.node()).outerHeight(),s=$(this.warningList.node()).outerWidth();this.warningList.style("left",Math.max(t.left-s/2,0)+"px").style("top",t.top+e+5+"px").style("display","block")}else this.warningList.style("display","none")},SplitsBrowser.Controls.WarningViewer=e}(),function(){"use strict";var t=SplitsBrowser.Version,i=SplitsBrowser.getMessage,e=SplitsBrowser.tryGetMessage,n=SplitsBrowser.getMessageWithFormatting,o=SplitsBrowser.initialiseMessages,s=SplitsBrowser.Model,r=s.CompetitorSelection,a=s.CourseClassSet,l=s.ChartTypes,u=SplitsBrowser.Input.parseEventData,h=SplitsBrowser.DataRepair.repairEventData,c=SplitsBrowser.DataRepair.transferCompetitorData,p=SplitsBrowser.parseQueryString,d=SplitsBrowser.formatQueryString,m=SplitsBrowser.Controls,f=m.LanguageSelector,g=m.ClassSelector,C=m.ChartTypeSelector,v=m.ComparisonSelector,S=m.OriginalDataSelector,y=m.StatisticsSelector,T=m.WarningViewer,x=m.CompetitorList,w=m.Chart,b=m.ResultsTable;function D(){return window.d3?!(parseFloat(d3.version)<4)||(alert("D3 version "+d3.version+" was found.  SplitsBrowser requires D3 version 4 or later."),!1):(alert("D3 was not found.  SplitsBrowser requires D3 version 4 or later."),!1)}function L(t){this.options=t,this.eventData=null,this.classes=null,this.currentClasses=[],this.chartData=null,this.referenceCumTimes=null,this.fastestCumTimes=null,this.previousCompetitorList=[],this.topBarHeight=t&&t.topBar&&0<$(t.topBar).length?$(t.topBar).outerHeight(!0):0,this.selection=null,this.courseClassSet=null,this.languageSelector=null,this.classSelector=null,this.comparisonSelector=null,this.originalDataSelector=null,this.statisticsSelector=null,this.competitorList=null,this.warningViewer=null,this.chart=null,this.topPanel=null,this.mainPanel=null,this.buttonsPanel=null,this.competitorListContainer=null,this.container=null,this.currentResizeTimeout=null}function I(t){alert(t)}function N(){alert(i("RaceGraphDisabledAsStartTimesMissing"))}function O(t,e){var s=d3.select("body").append("div").classed("sbErrors",!0);s.append("h1").text(i("LoadFailedHeader")),s.append("p").text(n(t,e))}function B(t,e,s){O("LoadFailedReadError",{$$ERROR$$:s})}L.prototype.enableOrDisableRaceGraph=function(){var t=this.courseClassSet.allCompetitors.some(function(t){return t.lacksStartTime()});this.chartTypeSelector.setRaceGraphDisabledNotifier(t?N:null)},L.prototype.setEvent=function(t){this.eventData=t,this.classes=t.classes,null!==this.classSelector&&this.classSelector.setClasses(this.classes),this.warningViewer.setWarnings(t.warnings)},L.prototype.drawLogo=function(){this.logoSvg=this.topPanel.append("svg").classed("topRowStart",!0),this.logoSvg.style("width","19px").style("height","19px").style("margin-bottom","-3px"),this.logoSvg.append("rect").attr("x","0").attr("y","0").attr("width","19").attr("height","19").attr("fill","white"),this.logoSvg.append("polygon").attr("points","0,19 19,0 19,19").attr("fill","red"),this.logoSvg.append("polyline").attr("points","0.5,0.5 0.5,18.5 18.5,18.5 18.5,0.5 0.5,0.5 0.5,18.5").attr("stroke","black").attr("fill","none"),this.logoSvg.append("polyline").attr("points","1,12 5,8 8,14 17,11").attr("fill","none").attr("stroke","blue").attr("stroke-width","2"),this.logoSvg.selectAll("*").append("title"),this.setLogoMessages()},L.prototype.setLogoMessages=function(){this.logoSvg.selectAll("title").text(n("ApplicationVersion",{$$VERSION$$:t}))},L.prototype.addSpacer=function(){this.topPanel.append("div").classed("topRowStartSpacer",!0)},L.prototype.addLanguageSelector=function(){this.languageSelector=new f(this.topPanel.node())},L.prototype.addClassSelector=function(){this.classSelector=new g(this.topPanel.node()),null!==this.classes&&this.classSelector.setClasses(this.classes)},L.prototype.addChartTypeSelector=function(){var t=[l.SplitsGraph,l.RaceGraph,l.PositionAfterLeg,l.SplitPosition,l.PercentBehind,l.ResultsTable];this.chartTypeSelector=new C(this.topPanel.node(),t)},L.prototype.addComparisonSelector=function(){this.comparisonSelector=new v(this.topPanel.node(),I),null!==this.classes&&this.comparisonSelector.setClasses(this.classes)},L.prototype.addOriginalDataSelector=function(){this.originalDataSelector=new S(this.topPanel)},L.prototype.addDirectLink=function(){this.directLink=this.topPanel.append("a").classed("topRowStart",!0).attr("id","directLinkAnchor").attr("href",document.location.href),this.setDirectLinkMessages()},L.prototype.addWarningViewer=function(){this.warningViewer=new T(this.topPanel)},L.prototype.setDirectLinkMessages=function(){this.directLink.attr("title",e("DirectLinkToolTip","")).text(i("DirectLink"))},L.prototype.updateDirectLink=function(){var t={classes:this.classSelector.getSelectedClasses(),chartType:this.chartTypeSelector.getChartType(),compareWith:this.comparisonSelector.getComparisonType(),selected:this.selection.getSelectedIndexes(),stats:this.statisticsSelector.getVisibleStatistics(),showOriginal:this.courseClassSet.hasDubiousData()&&this.originalDataSelector.isOriginalDataSelected(),filterText:this.competitorList.getFilterText()},e=document.location.search,s=d(e,this.eventData,this.courseClassSet,t),i=document.location.href;this.directLink.attr("href",i.substring(0,i.length-e.length)+"?"+s.replace(/^\?+/,""))},L.prototype.addCompetitorList=function(){this.competitorList=new x(this.mainPanel.node(),I)},L.prototype.buildUi=function(){var t=d3.select("body");t.style("overflow","hidden"),this.container=t.append("div").attr("id","sbContainer"),this.topPanel=this.container.append("div"),this.drawLogo(),this.addLanguageSelector(),this.addSpacer(),this.addClassSelector(),this.addSpacer(),this.addChartTypeSelector(),this.addSpacer(),this.addComparisonSelector(),this.addOriginalDataSelector(),this.addSpacer(),this.addDirectLink(),this.addWarningViewer(),this.statisticsSelector=new y(this.topPanel.node()),this.topPanel.append("div").style("clear","both"),this.mainPanel=this.container.append("div"),this.addCompetitorList(),this.chart=new w(this.mainPanel.node()),this.resultsTable=new b(this.container.node()),this.resultsTable.hide();var e=this;$(window).resize(function(){e.handleWindowResize()}),$("input:text").bind("selectstart",function(t){t.stopPropagation()}),$(this.container.node()).bind("selectstart",function(){return!1}),$(document).keydown(function(t){27===t.which&&e.hideTransientElements()})},L.prototype.registerChangeHandlers=function(){var e=this;this.languageSelector.registerChangeHandler(function(){e.retranslate()}),this.classSelector.registerChangeHandler(function(t){e.selectClasses(t)}),this.chartTypeSelector.registerChangeHandler(function(t){e.selectChartTypeAndRedraw(t)}),this.comparisonSelector.registerChangeHandler(function(t){e.selectComparison(t)}),this.originalDataSelector.registerChangeHandler(function(t){e.showOriginalOrRepairedData(t)}),this.competitorList.registerChangeHandler(function(){e.handleFilterTextChanged()})},L.prototype.handleWindowResize=function(){null!==this.currentResizeTimeout&&clearTimeout(this.currentResizeTimeout);var t=this;this.currentResizeTimeout=setTimeout(function(){t.postResizeHook()},100)},L.prototype.postResizeHook=function(){this.currentResizeTimeout=null,this.setCompetitorListHeight(),this.setChartSize(),this.hideTransientElements(),this.redraw()},L.prototype.hideTransientElements=function(){d3.selectAll(".transient").style("display","none")},L.prototype.getHorizontalMargin=function(){var t=$("body"),e=$(this.container.node());return t.outerWidth(!0)-t.width()+(e.outerWidth()-e.width())},L.prototype.getVerticalMargin=function(){var t=$("body"),e=$(this.container.node());return t.outerHeight(!0)-t.height()+(e.outerHeight()-e.height())},L.prototype.getUsableHeight=function(){return $(window).outerHeight()-this.getVerticalMargin()-this.topBarHeight-$(this.topPanel.node()).height()},L.prototype.setCompetitorListHeight=function(){this.competitorList.setHeight(this.getUsableHeight())},L.prototype.setChartSize=function(){var t=this.getHorizontalMargin(),e=this.getVerticalMargin(),s=$(window).width()-t,i=$(window).height()-e-this.topBarHeight;$(this.container.node()).width(s).height(i);var n=s-this.competitorList.width()-2,r=this.getUsableHeight();this.chart.setSize(n,r)},L.prototype.drawChart=function(){if(!this.chartTypeSelector.getChartType().isResultsTable){this.currentVisibleStatistics=this.statisticsSelector.getVisibleStatistics(),null!==this.selectionChangeHandler&&this.selection.deregisterChangeHandler(this.selectionChangeHandler),null!==this.statisticsChangeHandler&&this.statisticsSelector.deregisterChangeHandler(this.statisticsChangeHandler);var e=this;if(this.selectionChangeHandler=function(){e.competitorList.enableOrDisableCrossingRunnersButton(),e.redraw(),e.updateDirectLink()},this.selection.registerChangeHandler(this.selectionChangeHandler),this.statisticsChangeHandler=function(t){e.currentVisibleStatistics=t,e.redraw(),e.updateDirectLink()},this.statisticsSelector.registerChangeHandler(this.statisticsChangeHandler),this.updateControlEnabledness(),0<this.classes.length){var t=this.comparisonSelector.getComparisonFunction();this.referenceCumTimes=t(this.courseClassSet),this.fastestCumTimes=this.courseClassSet.getFastestCumTimes(),this.chartData=this.courseClassSet.getChartData(this.referenceCumTimes,this.selection.getSelectedIndexes(),this.chartTypeSelector.getChartType()),this.redrawChart()}}},L.prototype.redrawChart=function(){var t={chartData:this.chartData,eventData:this.eventData,courseClassSet:this.courseClassSet,referenceCumTimes:this.referenceCumTimes,fastestCumTimes:this.fastestCumTimes};this.chart.drawChart(t,this.selection.getSelectedIndexes(),this.currentVisibleStatistics,this.chartTypeSelector.getChartType())},L.prototype.redraw=function(){var t=this.chartTypeSelector.getChartType();t.isResultsTable||(this.chartData=this.courseClassSet.getChartData(this.referenceCumTimes,this.selection.getSelectedIndexes(),t),this.redrawChart())},L.prototype.retranslate=function(){this.setLogoMessages(),this.languageSelector.setMessages(),this.classSelector.retranslate(),this.chartTypeSelector.setMessages(),this.comparisonSelector.setMessages(),this.originalDataSelector.setMessages(),this.setDirectLinkMessages(),this.statisticsSelector.setMessages(),this.warningViewer.setMessages(),this.competitorList.retranslate(),this.resultsTable.retranslate(),this.chartTypeSelector.getChartType().isResultsTable||this.redrawChart()},L.prototype.setClasses=function(t){
this.currentClasses=t.map(function(t){return this.classes[t]},this),this.courseClassSet=new a(this.currentClasses),this.comparisonSelector.setCourseClassSet(this.courseClassSet),this.resultsTable.setClass(0<this.currentClasses.length?this.currentClasses[0]:null),this.enableOrDisableRaceGraph(),this.originalDataSelector.setVisible(this.courseClassSet.hasDubiousData())},L.prototype.initClasses=function(t){this.classSelector.selectClasses(t),this.setClasses(t),this.competitorList.setCompetitorList(this.courseClassSet.allCompetitors,1<this.currentClasses.length),this.selection=new r(this.courseClassSet.allCompetitors.length),this.competitorList.setSelection(this.selection),this.previousCompetitorList=this.courseClassSet.allCompetitors},L.prototype.selectClasses=function(t){0<t.length&&0<this.currentClasses.length&&this.classes[t[0]]===this.currentClasses[0]||this.selection.selectNone(),this.setClasses(t),this.competitorList.setCompetitorList(this.courseClassSet.allCompetitors,1<this.currentClasses.length),this.selection.migrate(this.previousCompetitorList,this.courseClassSet.allCompetitors),this.competitorList.selectionChanged(),this.chartTypeSelector.getChartType().isResultsTable||(this.setChartSize(),this.drawChart()),this.previousCompetitorList=this.courseClassSet.allCompetitors,this.updateDirectLink()},L.prototype.selectComparison=function(){this.drawChart(),this.updateDirectLink()},L.prototype.selectChartType=function(t){t.isResultsTable?(this.mainPanel.style("display","none"),this.container.style("width",null).style("height",null),d3.select("body").style("overflow",null),this.resultsTable.show()):(this.resultsTable.hide(),d3.select("body").style("overflow","hidden"),this.mainPanel.style("display",null),this.setChartSize()),this.updateControlEnabledness(),this.competitorList.setChartType(t)},L.prototype.selectChartTypeAndRedraw=function(t){this.selectChartType(t),t.isResultsTable||(this.setCompetitorListHeight(),this.drawChart()),this.updateDirectLink()},L.prototype.selectOriginalOrRepairedData=function(t){t?c(this.eventData):h(this.eventData),this.eventData.determineTimeLosses()},L.prototype.showOriginalOrRepairedData=function(t){this.selectOriginalOrRepairedData(t),this.drawChart(),this.updateDirectLink()},L.prototype.handleFilterTextChanged=function(){this.setChartSize(),this.redraw(),this.updateDirectLink()},L.prototype.updateControlEnabledness=function(){var t=this.chartTypeSelector.getChartType();this.classSelector.setOtherClassesEnabled(!t.isResultsTable),this.comparisonSelector.setEnabled(!t.isResultsTable),this.statisticsSelector.setEnabled(!t.isResultsTable),this.originalDataSelector.setEnabled(!t.isResultsTable),this.competitorList.enableOrDisableCrossingRunnersButton()},L.prototype.updateFromQueryString=function(t){null===t.classes?this.setDefaultSelectedClass():this.initClasses(t.classes),null!==t.chartType&&(this.chartTypeSelector.setChartType(t.chartType),this.selectChartType(t.chartType)),null!==t.compareWith&&this.comparisonSelector.setComparisonType(t.compareWith.index,t.compareWith.runner),null!==t.selected&&this.selection.setSelectedIndexes(t.selected),null!==t.stats&&this.statisticsSelector.setVisibleStatistics(t.stats),t.showOriginal&&this.courseClassSet.hasDubiousData()&&(this.originalDataSelector.selectOriginalData(),this.selectOriginalOrRepairedData(!0)),""!==t.filterText&&this.competitorList.setFilterText(t.filterText)},L.prototype.setDefaultSelectedClass=function(){this.initClasses(0<this.classes.length?[0]:[])},SplitsBrowser.Viewer=L,SplitsBrowser.readEvent=function(t,e){if(D()){var s;try{s=u(t)}catch(t){if("InvalidData"===t.name)return void O("LoadFailedInvalidData",{$$MESSAGE$$:t.message});throw t}if(null===s)O("LoadFailedUnrecognisedData",{});else{s.needsRepair()&&h(s),"string"==typeof e&&(e={topBar:e}),s.determineTimeLosses(),e&&e.defaultLanguage&&o(e.defaultLanguage);var i=new L(e);i.buildUi(),i.setEvent(s);var n=document.location.search;if(null!==n&&0<n.length){var r=p(n,s);i.updateFromQueryString(r)}else i.setDefaultSelectedClass();i.setCompetitorListHeight(),i.setChartSize(),i.drawChart(),i.registerChangeHandlers()}}},SplitsBrowser.loadEvent=function(t,s){D()&&$.ajax({url:t,data:"",success:function(t,e){!function(t,e,s){"success"===e?SplitsBrowser.readEvent(t,s):O("LoadFailedStatusNotSuccess",{$$STATUS$$:e})}(t,e,s)},dataType:"text",error:B})}}();