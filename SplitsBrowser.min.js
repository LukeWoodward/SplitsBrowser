var SplitsBrowser={Model:{},Input:{},Controls:{}};!function(){"use strict";SplitsBrowser.isTrue=function(a){return a},SplitsBrowser.isNotNull=function(a){return null!==a},SplitsBrowser.InvalidData=function(a){this.name="InvalidData",this.message=a},SplitsBrowser.InvalidData.prototype.toString=function(){return this.name+": "+this.message},SplitsBrowser.throwInvalidData=function(a){throw new SplitsBrowser.InvalidData(a)},SplitsBrowser.formatTime=function(a){var b="";0>a&&(b="-",a=-a);var c=Math.floor(a/3600),d=Math.floor(a/60)%60,e=a%60;return c>0&&(b+=c.toString()+":"),10>d&&(b+="0"),b+=d+":",10>e&&(b+="0"),b+=e}}(),function(){"use strict";var a="competitorList",b="#"+a;SplitsBrowser.Controls.CompetitorListBox=function(b){this.parent=b,this.handler=null,this.competitorSelection=null,this.listDiv=d3.select(b).append("div").attr("id",a)},SplitsBrowser.Controls.CompetitorListBox.prototype.width=function(){return $(b).width()},SplitsBrowser.Controls.CompetitorListBox.prototype.selectionChanged=function(){var a=this;this.listDiv.selectAll("div.competitor").data(d3.range(this.competitorSelection.count)).classed("selected",function(b,c){return a.competitorSelection.isSelected(c)})},SplitsBrowser.Controls.CompetitorListBox.prototype.toggleCompetitor=function(a){this.competitorSelection.toggle(a)},SplitsBrowser.Controls.CompetitorListBox.prototype.setCompetitorList=function(a){$("div.competitor").off("click");var b=this.listDiv.selectAll("div.competitor").data(a),c=this;b.enter().append("div").classed("competitor",!0),b.text(function(a){return a.name}),b.exit().remove(),$("div.competitor").each(function(a,b){$(b).on("click",function(){c.toggleCompetitor(a)})})},SplitsBrowser.Controls.CompetitorListBox.prototype.setSelection=function(a){null!==this.competitorSelection&&this.competitorSelection.deregisterChangeHandler(this.handler);var b=this;this.competitorSelection=a,this.handler=function(a){b.selectionChanged(a)},this.competitorSelection.registerChangeHandler(this.handler),this.selectionChanged(d3.range(a.count))}}(),function(){"use strict";var a="number";SplitsBrowser.Model.CompetitorSelection=function(b){typeof b!=a?SplitsBrowser.throwInvalidData("Competitor count must be a number"):0>=b&&SplitsBrowser.throwInvalidData("Competitor count must be a positive number"),this.count=b,this.currentIndexes=[],this.changeHandlers=[]},SplitsBrowser.Model.CompetitorSelection.prototype.isSelected=function(a){return this.currentIndexes.indexOf(a)>-1},SplitsBrowser.Model.CompetitorSelection.prototype.fireChangeHandlers=function(){var a=this;this.changeHandlers.forEach(function(b){b(a.currentIndexes.slice(0))})},SplitsBrowser.Model.CompetitorSelection.prototype.selectAll=function(){this.currentIndexes=d3.range(this.count),this.fireChangeHandlers()},SplitsBrowser.Model.CompetitorSelection.prototype.selectNone=function(){this.currentIndexes=[],this.fireChangeHandlers()},SplitsBrowser.Model.CompetitorSelection.prototype.registerChangeHandler=function(a){-1==this.changeHandlers.indexOf(a)&&this.changeHandlers.push(a)},SplitsBrowser.Model.CompetitorSelection.prototype.deregisterChangeHandler=function(a){var b=this.changeHandlers.indexOf(a);b>-1&&this.changeHandlers.splice(b,1)},SplitsBrowser.Model.CompetitorSelection.prototype.toggle=function(b){if(typeof b==a)if(b>=0&&b<this.count){var c=this.currentIndexes.indexOf(b);-1==c?(this.currentIndexes.push(b),this.currentIndexes.sort(d3.ascending)):this.currentIndexes.splice(c,1),this.fireChangeHandlers()}else SplitsBrowser.throwInvalidData("Index '"+b+"' is out of range");else SplitsBrowser.throwInvalidData("Index is not a number")}}(),function(){"use strict";SplitsBrowser.getRanks=function(a){var b=a.filter(function(a){return null!==a});b.sort(d3.ascending);var c=new d3.map;b.forEach(function(a,b){c.has(a)||c.set(a,b+1)});var d=a.map(function(a){return null===a?null:c.get(a)});return d},SplitsBrowser.selectByIndexes=function(a,b){if("undefined"==typeof a)throw new TypeError("data is undefined");return b.map(function(b){return a[b]})},SplitsBrowser.Model.CompetitorSplitInfo=function(a,b){this.courseData=a,this.reference=b,this.splitsPerControl=[null],this.splitRanksPerControl=[null],this.cumulativeTimesPerControl=[null],this.cumulativeRanksPerControl=[null],this.timesBehindReferencePerControl=[null],this.computeTimesAndRanks()},SplitsBrowser.Model.CompetitorSplitInfo.prototype.computeTimesAndRanks=function(){for(var a=new Array(this.courseData.competitorData.length),b=0;b<a.length;b+=1)a[b]=0;var c=this;d3.range(1,this.courseData.numControls+2).forEach(function(b){var d=c.courseData.competitorData.map(function(a){return a.times[b-1]});c.splitsPerControl.push(d);var e=SplitsBrowser.getRanks(d);c.splitRanksPerControl.push(e),a=d3.zip(a,d).map(function(a){return a[0]+a[1]}),c.cumulativeTimesPerControl.push(a);var f=SplitsBrowser.getRanks(a);c.cumulativeRanksPerControl.push(f);var g=d.map(function(a){return a-c.reference.times[b-1]});c.timesBehindReferencePerControl.push(g)})},SplitsBrowser.Model.CompetitorSplitInfo.prototype.getSplits=function(a,b){return 0===a?null:SplitsBrowser.selectByIndexes(this.splitsPerControl[a],b)},SplitsBrowser.Model.CompetitorSplitInfo.prototype.getSplitRanks=function(a,b){return 0===a?null:SplitsBrowser.selectByIndexes(this.splitRanksPerControl[a],b)},SplitsBrowser.Model.CompetitorSplitInfo.prototype.getCumulativeTimes=function(a,b){return 0===a?null:SplitsBrowser.selectByIndexes(this.cumulativeTimesPerControl[a],b)},SplitsBrowser.Model.CompetitorSplitInfo.prototype.getCumulativeRanks=function(a,b){return 0===a?null:SplitsBrowser.selectByIndexes(this.cumulativeRanksPerControl[a],b)},SplitsBrowser.Model.CompetitorSplitInfo.prototype.getTimesBehindReference=function(a,b){return 0===a?null:SplitsBrowser.selectByIndexes(this.timesBehindReferencePerControl[a],b)}}(),function(){"use strict";SplitsBrowser.Controls.CourseSelector=function(a){this.changeHandlers=[];var b=d3.select(a).append("span");b.text("Course: ");var c=this;this.dropDown=b.append("select").node(),$(this.dropDown).bind("change",function(){c.onSelectionChanged()}),this.setCourses([])},SplitsBrowser.Controls.CourseSelector.prototype.setCourses=function(a){if($.isArray(a)){var b;0===a.length?(this.dropDown.disabled=!0,b=["[No courses loaded]"]):(this.dropDown.disabled=!1,b=a.map(function(a){return a.course}));var c=d3.select(this.dropDown).selectAll("option").data(b);c.enter().append("option"),c.attr("value",function(a,b){return b.toString()}).text(function(a){return a}),c.exit().remove()}else SplitsBrowser.throwInvalidData("CourseSelector.setCourses: courses is not an array")},SplitsBrowser.Controls.CourseSelector.prototype.registerChangeHandler=function(a){-1===this.changeHandlers.indexOf(a)&&this.changeHandlers.push(a)},SplitsBrowser.Controls.CourseSelector.prototype.onSelectionChanged=function(){var a=this;this.changeHandlers.forEach(function(b){b(a.dropDown.selectedIndex)})}}(),function(){"use strict";SplitsBrowser.Input.CSV={parseCompetitorTime:function(a){return a.match(/^\d\d:\d\d$/)?60*parseInt(a.substring(0,2),10)+parseInt(a.substring(3),10):null},parseCompetitorData:function(a,b,c){var d=b.split(",");if(d.length===c+5){var e=d.shift(),f=d.shift(),g=d.shift(),h=d.shift(),i=d.map(SplitsBrowser.Input.CSV.parseCompetitorTime);return new SplitsBrowser.Model.CompetitorData(a+1,e,f,g,h,i)}SplitsBrowser.throwInvalidData("Expected "+(c+5)+" items in row for competitor on course with "+c+" controls, got "+d.length+" instead.")},parseCourseData:function(a){var b=a.split("\r\n").filter(SplitsBrowser.isTrue);0===b.length&&SplitsBrowser.throwInvalidData("parseCourseData got an empty list of lines");var c=b.shift().split(",");if(2===c.length){var d=c.shift(),e=c.shift(),f=parseInt(e,10);if(isNaN(f))SplitsBrowser.throwInvalidData("Could not read control count: '"+e+"'");else{if(!(0>f)){var g=b.map(function(a,b){return SplitsBrowser.Input.CSV.parseCompetitorData(b,a,f)});return g.sort(SplitsBrowser.Model.compareCompetitors),new SplitsBrowser.Model.CourseData(d,f,g)}SplitsBrowser.throwInvalidData("Expected a positive control count, got "+f+" instead")}}else SplitsBrowser.throwInvalidData("Expected first line to have two parts (course name and number of controls), got "+c.length+" part(s) instead")},parseEventData:function(a){var b=a.split("\r\n\r\n").map($.trim).filter(SplitsBrowser.isTrue);return b.map(SplitsBrowser.Input.CSV.parseCourseData)}}}(),function(){"use strict";var a="number";SplitsBrowser.Model.compareCompetitors=function(a,b){return a.totalTime===b.totalTime?a.order-b.order:null===a.totalTime?null===b.totalTime?0:1:null===b.totalTime?-1:a.totalTime-b.totalTime},SplitsBrowser.Model.CompetitorData=function(b,c,d,e,f,g){if(typeof b!==a)SplitsBrowser.throwInvalidData("Competitor order must be a number, got "+typeof b+" '"+b+"' instead");else if(!$.isArray(g))throw new TypeError("times must be an array - got "+typeof g+" instead");this.order=b,this.forename=c,this.surname=d,this.club=e,this.startTime=f,this.times=g,this.name=c+" "+d,this.totalTime=g.indexOf(null)>-1?null:d3.sum(g)},SplitsBrowser.Model.CompetitorData.prototype.adjustToReference=function(a){"undefined"==typeof a.times?SplitsBrowser.throwInvalidData("Cannot adjust competitor times because reference object does not have times (is it a competitor object?)"):a.times.length!==this.times.length?SplitsBrowser.throwInvalidData("Cannot adjust competitor times because the numbers of times are different ("+this.times.length+" and "+a.times.length+")"):a.times.indexOf(null)>-1&&SplitsBrowser.throwInvalidData("Cannot adjust a competitor time by a competitor with missing times");var b=this.times.map(function(b,c){return null===b?null:b-a.times[c]});return new SplitsBrowser.Model.CompetitorData(this.order,this.forename,this.surname,this.club,this.startTime,b)},SplitsBrowser.Model.CompetitorData.prototype.getCumulativeTimes=function(){var a=0,b=new Array(this.times.length+1);b[0]=0;for(var c=0;c<this.times.length;++c)null===this.times[c]?b[c+1]=null:(a+=this.times[c],b[c+1]=a);return b},SplitsBrowser.Model.CourseData=function(a,b,c){this.course=a,this.numControls=b,this.competitorData=c},SplitsBrowser.Model.CourseData.prototype.isEmpty=function(){return 0===this.competitorData.length},SplitsBrowser.Model.CourseData.prototype.getCompetitorName=function(a){return this.competitorData[a].name},SplitsBrowser.Model.CourseData.prototype.adjustToReference=function(a){var b=this.competitorData.map(function(b){return b.adjustToReference(a)});return new SplitsBrowser.Model.CourseData(this.course,this.numControls,b)},SplitsBrowser.Model.CourseData.prototype.getWinner=function(){var a=this.competitorData.filter(function(a){return null!==a.totalTime});if(0===a.length)return null;for(var b=a[0],c=1;c<a.length;++c)a[c].totalTime<b.totalTime&&(b=a[c]);return b},SplitsBrowser.Model.CourseData.prototype.getFastestTime=function(){for(var a=new Array(this.numControls+1),b=0;b<=this.numControls;++b){for(var c=null,d=0;d<this.competitorData.length;++d){var e=this.competitorData[d].times[b];null!==e&&(null===c||c>e)&&(c=e)}if(null===c)return null;a[b]=c}return new SplitsBrowser.Model.CompetitorData(0,"Fastest time","Fastest time","","",a)},SplitsBrowser.Model.CourseData.prototype.getChartData=function(a,b){if(this.isEmpty())SplitsBrowser.throwInvalidData("Cannot return data as columns when there is no data");else if("undefined"==typeof a)throw new TypeError("referenceData object undefined or missing");var c,d,e=this.adjustToReference(a).competitorData,f=b.map(function(a){return e[a]}),g=f.map(function(a){return a.getCumulativeTimes()}),h=d3.sum(a.times);if(0===b.length){var i=e[0].getCumulativeTimes();c=d3.min(i),d=d3.max(i)}else c=d3.min(g.map(function(a){return d3.min(a)})),d=d3.max(g.map(function(a){return d3.max(a)}));d===c&&(d=c+1);var j=d3.transpose(g),k=d3.zip(a.getCumulativeTimes(),j);return{dataColumns:k.map(function(a){return{x:a[0],ys:a[1]}}),competitorNames:f.map(function(a){return a.name}),numControls:this.numControls,xExtent:[0,h],yExtent:[c,d]}}}(),function(){"use strict";var a="statisticSelector",b="statisticCheckbox",c=["Total time","Split time","Behind fastest"];SplitsBrowser.Controls.StatisticsSelector=function(d){this.span=d3.select(d).append("span").attr("id",a);var e=this.span.selectAll("span").data(c).enter().append("span");e.append("input").attr("type","checkbox").attr("id",function(a,c){return b+c}),e.append("label").attr("for",function(a,c){return b+c}).text(function(a){return a});var f=this;$("input",this.span.node()).bind("change",function(){return f.onCheckboxChanged()}),this.handlers=[]},SplitsBrowser.Controls.StatisticsSelector.prototype.registerChangeHandler=function(a){-1===this.handlers.indexOf(a)&&this.handlers.push(a)},SplitsBrowser.Controls.StatisticsSelector.prototype.deregisterChangeHandler=function(a){var b=this.handlers.indexOf(a);-1!==b&&this.handlers.splice(b,1)},SplitsBrowser.Controls.StatisticsSelector.prototype.getVisibleStatistics=function(){return this.span.selectAll("input")[0].map(function(a){return a.checked})},SplitsBrowser.Controls.StatisticsSelector.prototype.onCheckboxChanged=function(){var a=this.getVisibleStatistics();this.handlers.forEach(function(b){b(a)})}}(),function(){"use strict";var a=[{name:"Fastest time",selector:function(a){return a.getFastestTime()}},{name:"Winner",selector:function(a){return a.getWinner()}}];SplitsBrowser.Controls.ComparisonSelector=function(b){this.changeHandlers=[];var c=d3.select(b).append("span");c.text("Compare with ");var d=this;this.dropDown=c.append("select").node(),$(this.dropDown).bind("change",function(){d.onSelectionChanged()});var e=d3.select(this.dropDown).selectAll("option").data(a);e.enter().append("option"),e.attr("value",function(a,b){return b.toString()}).text(function(a){return a.name}),e.exit().remove()},SplitsBrowser.Controls.ComparisonSelector.prototype.getComparisonFunction=function(){return a[this.dropDown.selectedIndex].selector},SplitsBrowser.Controls.ComparisonSelector.prototype.registerChangeHandler=function(a){-1===this.changeHandlers.indexOf(a)&&this.changeHandlers.push(a)},SplitsBrowser.Controls.ComparisonSelector.prototype.onSelectionChanged=function(){var a=this;this.changeHandlers.forEach(function(b){b(a.getComparisonFunction())})}}(),function(){"use strict";function a(a,b){return h+SplitsBrowser.formatTime(a)+" ("+b+")"}var b="sb-text-size-element",c="#"+b,d="chart",e="#"+d,f={top:20,right:20,bottom:30,left:50},g=10,h="    ",i=["red","blue","green","black","#CC0066","#000099","#FFCC00","#996600","#9900FF","#CCCC00","#FFFF66","#CC6699","#99FF33","#3399FF","#CC33CC","#33FFFF","#FF00FF"],j="#EEEEEE",k="#DDDDDD";SplitsBrowser.Controls.Chart=function(a){this.parent=a,this.xScale=null,this.yScale=null,this.yScaleMinutes=null,this.overallWidth=-1,this.overallHeight=-1,this.contentWidth=-1,this.contentHeight=-1,this.numControls=-1,this.selectedIndexes=[],this.names=[],this.cumTimes=[],this.isMouseIn=!1,this.currentControlIndex=null,this.controlLine=null,this.svg=d3.select(this.parent).append("svg").attr("id",d),this.svgGroup=this.svg.append("g").attr("transform","translate("+f.left+","+f.top+")");var c=this;$(this.svg.node()).mouseenter(function(a){c.onMouseEnter(a)}).mousemove(function(a){c.onMouseMove(a)}).mouseleave(function(a){c.onMouseLeave(a)}),this.svg.append("text").attr("fill","transparent").attr("id",b)},SplitsBrowser.Controls.Chart.prototype.onMouseEnter=function(){this.isMouseIn=!0},SplitsBrowser.Controls.Chart.prototype.onMouseMove=function(a){if(this.isMouseIn&&null!==this.xScale){var b=$(this.svg.node()),c=b.offset(),d=a.pageX-c.left,e=a.pageY-c.top;if(f.left<=d&&d<b.width()-f.right&&f.top<=e&&e<b.height()-f.bottom){var g,h=this.xScale.invert(d-f.left),i=d3.bisect(this.cumTimes,h);if(i>=this.cumTimes.length)g=this.numControls+1;else{var j=Math.abs(this.cumTimes[i]-h),k=Math.abs(h-this.cumTimes[i-1]);g=j>k?i-1:i}(null===this.currentControlIndex||this.currentControlIndex!==g)&&(this.removeControlLine(),this.drawControlLine(g))}else this.removeControlLine()}},SplitsBrowser.Controls.Chart.prototype.onMouseLeave=function(){this.isMouseIn=!1,this.removeControlLine()},SplitsBrowser.Controls.Chart.prototype.drawControlLine=function(a){this.currentControlIndex=a,this.updateCompetitorStatistics();var b=this.xScale(this.cumTimes[a]);this.controlLine=this.svgGroup.append("line").attr("x1",b).attr("y1",0).attr("x2",b).attr("y2",this.contentHeight).attr("class","controlLine").node()},SplitsBrowser.Controls.Chart.prototype.removeControlLine=function(){this.currentControlIndex=null,this.updateCompetitorStatistics(),null!==this.controlLine&&(d3.select(this.controlLine).remove(),this.controlLine=null)},SplitsBrowser.Controls.Chart.prototype.updateCompetitorStatistics=function(){var b=this.names;if(null!==this.currentControlIndex&&this.currentControlIndex>0){if(this.visibleStatistics[0]){var c=this.splitInfo.getCumulativeTimes(this.currentControlIndex,this.selectedIndexes),d=this.splitInfo.getCumulativeRanks(this.currentControlIndex,this.selectedIndexes);b=d3.zip(b,c,d).map(function(b){return b[0]+a(b[1],b[2])})}if(this.visibleStatistics[1]){var e=this.splitInfo.getSplits(this.currentControlIndex,this.selectedIndexes),f=this.splitInfo.getSplitRanks(this.currentControlIndex,this.selectedIndexes);b=d3.zip(b,e,f).map(function(b){return b[0]+a(b[1],b[2])})}if(this.visibleStatistics[2]){var g=this.splitInfo.getTimesBehindReference(this.currentControlIndex,this.selectedIndexes);b=d3.zip(b,g).map(function(a){return a[0]+h+SplitsBrowser.formatTime(a[1])})}}d3.selectAll("text.competitorLabel").data(b).text(function(a){return a})},SplitsBrowser.Controls.Chart.prototype.getTickFormatter=function(){var a=this;return function(b,c){return 0===c?"S":c===a.numControls+1?"F":c.toString()}},SplitsBrowser.Controls.Chart.prototype.getTextWidth=function(a){return d3.select(c).text(a).node().getBBox().width},SplitsBrowser.Controls.Chart.prototype.getTextHeight=function(a){return d3.select(c).text(a).node().getBBox().height},SplitsBrowser.Controls.Chart.prototype.getMaxGraphEndTextWidth=function(){if(0===this.selectedIndexes.length||0===this.names.length)return 0;var a=this,b=this.names.map(function(b){return a.getTextWidth(b)});return d3.max(b)+this.determineMaxStatisticTextWidth()},SplitsBrowser.Controls.Chart.prototype.getMaxTimeAndRankTextWidth=function(b,c){for(var d=0,e=0,f=1;f<=this.numControls+1;f+=1){var g=this.splitInfo[b](f,this.selectedIndexes);d=Math.max(d,d3.max(g.filter(SplitsBrowser.isNotNull)));var h=this.splitInfo[c](f,this.selectedIndexes);e=Math.max(e,d3.max(h.filter(SplitsBrowser.isNotNull)))}var i=a(d,e);return this.getTextWidth(i)},SplitsBrowser.Controls.Chart.prototype.getMaxSplitTimeAndRankTextWidth=function(){return this.getMaxTimeAndRankTextWidth("getSplits","getSplitRanks")},SplitsBrowser.Controls.Chart.prototype.getMaxCumulativeTimeAndRankTextWidth=function(){return this.getMaxTimeAndRankTextWidth("getCumulativeTimes","getCumulativeRanks")},SplitsBrowser.Controls.Chart.prototype.getMaxTimeBehindFastestWidth=function(){for(var a=0,b=1;b<=this.numControls+1;b+=1){var c=this.splitInfo.getTimesBehindReference(b,this.selectedIndexes);a=Math.max(a,d3.max(c.filter(SplitsBrowser.isNotNull)))}return this.getTextWidth(h+SplitsBrowser.formatTime(a))},SplitsBrowser.Controls.Chart.prototype.determineMaxStatisticTextWidth=function(){var a=0;return this.visibleStatistics[0]&&(a+=this.getMaxCumulativeTimeAndRankTextWidth()),this.visibleStatistics[1]&&(a+=this.getMaxSplitTimeAndRankTextWidth()),this.visibleStatistics[2]&&(a+=this.getMaxTimeBehindFastestWidth()),a},SplitsBrowser.Controls.Chart.prototype.createScales=function(a){this.xScale=d3.scale.linear().domain(a.xExtent).range([0,this.contentWidth]),this.yScale=d3.scale.linear().domain(a.yExtent).range([0,this.contentHeight]),this.xScaleMinutes=d3.scale.linear().domain([a.xExtent[0]/60,a.xExtent[1]/60]).range([0,this.contentWidth]),this.yScaleMinutes=d3.scale.linear().domain([a.yExtent[0]/60,a.yExtent[1]/60]).range([0,this.contentHeight])},SplitsBrowser.Controls.Chart.prototype.drawBackgroundRectangles=function(){var a=this.svgGroup.selectAll("rect").data(d3.range(this.numControls+1)),b=this;a.enter().append("rect"),a.attr("x",function(a){return b.xScale(b.cumTimes[a])}).attr("y",0).attr("width",function(a){return b.xScale(b.cumTimes[a+1]-b.cumTimes[a])}).attr("height",this.contentHeight).attr("fill",function(a){return 0===a%2?j:k}),a.exit().remove()},SplitsBrowser.Controls.Chart.prototype.drawAxes=function(){var a=d3.svg.axis().scale(this.xScale).orient("top").tickFormat(this.getTickFormatter()).tickValues(this.cumTimes),b=d3.svg.axis().scale(this.yScaleMinutes).orient("left"),c=d3.svg.axis().scale(this.xScaleMinutes).orient("bottom");this.svgGroup.selectAll("g.axis").remove(),this.svgGroup.append("g").attr("class","x axis").call(a),this.svgGroup.append("g").attr("class","y axis").call(b).append("text").attr("transform","rotate(-90)").attr("x",-(this.contentHeight-6)).attr("y",6).attr("dy",".71em").style("text-anchor","start").text("Time loss (min)"),this.svgGroup.append("g").attr("class","x axis").attr("transform","translate(0,"+this.contentHeight+")").call(c).append("text").attr("x",60).attr("y",-5).style("text-anchor","start").text("Time (min)")},SplitsBrowser.Controls.Chart.prototype.drawChartLines=function(a){var b=this,c=function(a){return d3.svg.line().x(function(a){return b.xScale(a.x)}).y(function(c){return b.yScale(c.ys[a])}).interpolate("linear")},d=this.svgGroup.selectAll("path.graphLine").data(d3.range(this.numLines));d.enter().append("path").attr("class","graphLine").attr("stroke-width",2).attr("fill","none"),d.attr("d",function(b){return c(b)(a.dataColumns)}).attr("stroke",function(a){return i[b.selectedIndexes[a]%i.length]}),d.exit().remove()},SplitsBrowser.Controls.Chart.prototype.drawCompetitorLegendLabels=function(a){for(var b=a.dataColumns[a.dataColumns.length-1],c=this,d=d3.range(this.numLines).map(function(a){return{name:c.names[a],textHeight:c.getTextHeight(c.names[a]),y:c.yScale(b.ys[a]),colour:i[c.selectedIndexes[a]%i.length]}}),e=1;e<d.length;++e)d[e].y<d[e-1].y+d[e-1].textHeight&&(d[e].y=d[e-1].y+d[e-1].textHeight);var f=this.svgGroup.selectAll("line.competitorLegendLine").data(d);f.enter().append("line").attr("class","competitorLegendLine").attr("stroke-width",2),f.attr("x1",this.contentWidth+1).attr("y1",function(a){return a.y}).attr("x2",this.contentWidth+g+1).attr("y2",function(a){return a.y}).attr("stroke",function(a){return a.colour}),f.exit().remove();var h=this.svgGroup.selectAll("text.competitorLabel").data(d);h.enter().append("text").attr("class","competitorLabel"),h.text(function(a){return a.name}).attr("x",this.contentWidth+g+2).attr("y",function(a){return a.y+a.textHeight/4}),h.exit().remove()},SplitsBrowser.Controls.Chart.prototype.adjustContentSize=function(){var a=this.getMaxGraphEndTextWidth();this.contentWidth=Math.max(this.overallWidth-f.left-f.right-a-(g+2),100),this.contentHeight=Math.max(this.overallHeight-f.top-f.bottom,100)},SplitsBrowser.Controls.Chart.prototype.setSize=function(a,b){this.overallWidth=a,this.overallHeight=b,$(e).width(a).height(b),this.adjustContentSize()},SplitsBrowser.Controls.Chart.prototype.drawChart=function(a,b,c,d,e){this.numControls=a.numControls,this.names=a.competitorNames,this.numLines=this.names.length,this.selectedIndexes=d,this.cumTimes=c,this.splitInfo=b,this.visibleStatistics=e,this.maxStatisticTextWidth=this.determineMaxStatisticTextWidth(),this.adjustContentSize(),this.createScales(a),this.drawBackgroundRectangles(),this.drawAxes(),this.drawChartLines(a),this.drawCompetitorLegendLabels(a)}}(),function(){"use strict";function a(a,b){if("success"===b){var c=SplitsBrowser.Input.CSV.parseEventData(a);j.setCourses(c),j.selectCourse(0)}else alert("Got status "+b+". :(")}function b(b){$.ajax({url:b,data:"",success:a,dataType:"text"})}var c=100,d="topPanel",e="#"+d,f="competitorListContainer",g="#"+f,h="allOrNoneButtonsPanel",i="#"+h;SplitsBrowser.Viewer=function(){this.courses=null,this.currentResult=null,this.currentIndexes=null,this.reference=null,this.chartData=null,this.splitInfo=null,this.cumTimes=null,this.selection=null,this.courseSelector=null,this.statisticsSelector=null,this.competitorListBox=null,this.chart=null,this.topPanel=null,this.mainPanel=null,this.currentResizeTimeout=null},SplitsBrowser.Viewer.prototype.setCourses=function(a){this.courses=a,null!==this.courseSelector&&this.courseSelector.setCourses(this.courses)},SplitsBrowser.Viewer.prototype.buildUi=function(){var a=d3.select("body"),b=a.append("div").attr("id",d),c=this;this.courseSelector=new SplitsBrowser.Controls.CourseSelector(b.node()),this.courseSelector.registerChangeHandler(function(a){c.selectCourse(a)}),null!==this.courses&&this.courseSelector.setCourses(this.courses),b.append("span").style("padding","0px 30px 0px 30px"),this.comparisonSelector=new SplitsBrowser.Controls.ComparisonSelector(b.node()),this.comparisonSelector.registerChangeHandler(function(a){c.selectComparison(a)}),this.comparisonFunction=this.comparisonSelector.getComparisonFunction(),this.statisticsSelector=new SplitsBrowser.Controls.StatisticsSelector(b.node());var e=a.append("div"),g=e.append("div").attr("id",f),i=g.append("div").attr("id",h);i.append("button").text("All").on("click",function(){c.selectAll()}),i.append("button").text("None").on("click",function(){c.selectNone()}),this.competitorListBox=new SplitsBrowser.Controls.CompetitorListBox(g.node()),this.chart=new SplitsBrowser.Controls.Chart(e.node()),$(window).resize(function(){c.handleWindowResize()})},SplitsBrowser.Viewer.prototype.selectAll=function(){this.selection.selectAll()},SplitsBrowser.Viewer.prototype.selectNone=function(){this.selection.selectNone()},SplitsBrowser.Viewer.prototype.handleWindowResize=function(){null!==this.currentResizeTimeout&&clearTimeout(this.currentResizeTimeout);var a=this;this.currentResizeTimeout=setTimeout(function(){a.postResizeHook()},c)},SplitsBrowser.Viewer.prototype.postResizeHook=function(){this.currentResizeTimeout=null,this.drawChart()},SplitsBrowser.Viewer.prototype.drawChart=function(){this.reference=this.comparisonFunction(this.currentResult),this.chartData=this.currentResult.getChartData(this.reference,this.currentIndexes),this.cumTimes=this.reference.getCumulativeTimes(),this.splitInfo=new SplitsBrowser.Model.CompetitorSplitInfo(this.currentResult,this.reference);var a=$(window).width(),b=$(window).height();this.currentVisibleStatistics=this.statisticsSelector.getVisibleStatistics(),this.competitorListBox.setCompetitorList(this.currentResult.competitorData);var c=$(e).height(),d=a-18-this.competitorListBox.width()-40,f=b-19-c;this.chart.setSize(d,f),this.chart.drawChart(this.chartData,this.splitInfo,this.cumTimes,this.currentIndexes,this.currentVisibleStatistics);var h=this;null!==this.selectionChangeHandler&&this.selection.deregisterChangeHandler(this.selectionChangeHandler),null!==this.statisticsChangeHandler&&this.statisticsSelector.deregisterChangeHandler(this.statisticsChangeHandler),this.selectionChangeHandler=function(a){h.currentIndexes=a,h.redraw()},this.selection.registerChangeHandler(this.selectionChangeHandler),this.statisticsChangeHandler=function(a){h.currentVisibleStatistics=a,h.redraw()},this.statisticsSelector.registerChangeHandler(this.statisticsChangeHandler),$("body").height(b-19-c),$(g).height(b-19-$(i).height()-c)},SplitsBrowser.Viewer.prototype.redraw=function(){this.chartData=this.currentResult.getChartData(this.reference,this.currentIndexes),this.chart.drawChart(this.chartData,this.splitInfo,this.cumTimes,this.currentIndexes,this.currentVisibleStatistics)},SplitsBrowser.Viewer.prototype.selectCourse=function(a){a>=0&&a<this.courses.length&&(null!==this.selection&&this.selection.selectNone(),this.currentIndexes=[],this.currentResult=this.courses[a],this.selection=new SplitsBrowser.Model.CompetitorSelection(this.currentResult.competitorData.length),this.competitorListBox.setSelection(this.selection),this.drawChart())},SplitsBrowser.Viewer.prototype.selectComparison=function(a){this.comparisonFunction=a,this.drawChart()};var j=new SplitsBrowser.Viewer;$(document).ready(function(){j.buildUi(),b("data/eventdata")})}();